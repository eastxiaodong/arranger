<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline';">
  <title>Minimal Test</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-foreground);
      background-color: var(--vscode-editor-background);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }

    .agent-empty-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(2px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .agent-empty-overlay.hidden {
      display: none;
    }

    .agent-empty-card {
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 12px;
      width: 360px;
      padding: 24px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
      text-align: center;
      pointer-events: auto;
    }

    .agent-empty-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .agent-empty-desc {
      font-size: 13px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 18px;
      line-height: 1.5;
    }

    .agent-empty-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .agent-empty-button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }

    .agent-empty-button.primary {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .agent-empty-button.secondary {
      background: none;
      color: var(--vscode-textLink-foreground);
    }

    .panel-link-button {
      border: none;
      background: none;
      color: var(--vscode-textLink-foreground);
      cursor: pointer;
      font-size: 12px;
      margin-left: 6px;
      text-decoration: underline;
      padding: 0;
    }

    /* 三栏布局容器 */
    .container {
      display: flex;
      height: 100vh;
      width: 100%;
    }

    /* 侧边栏通用样式 */
    .sidebar {
      display: flex;
      flex-direction: column;
      background-color: var(--vscode-sideBar-background);
      border-right: 1px solid var(--vscode-panel-border);
      transition: width 0.3s ease;
      overflow: hidden;
      position: relative;
    }

    .sidebar.left {
      width: 340px;
      border-right: 1px solid var(--vscode-panel-border);
    }

    .sidebar.right {
      width: 340px;
      border-left: 1px solid var(--vscode-panel-border);
      border-right: none;
    }

    /* 收起状态 */
    .sidebar.collapsed {
      width: 32px;
    }

    .sidebar.collapsed .sidebar-content {
      display: none;
    }

    /* 侧边栏收放按钮 - 固定在垂直中间 */
    .collapse-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 100;
      background-color: var(--vscode-sideBarSectionHeader-background);
      color: var(--vscode-foreground);
      border: 1px solid var(--vscode-panel-border);
      padding: 24px 8px;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.7;
      transition: opacity 0.2s, background-color 0.2s;
      border-radius: 4px;
    }

    .collapse-btn:hover {
      opacity: 1;
      background-color: var(--vscode-list-hoverBackground);
    }

    /* 左侧边栏的按钮在右边缘 */
    .sidebar.left .collapse-btn {
      right: -18px;
    }

    /* 右侧边栏的按钮在左边缘 */
    .sidebar.right .collapse-btn {
      left: -18px;
    }

    /* 侧边栏内容 */
    .sidebar-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* 面板样式 */
    .panel {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 100px;
      background-color: var(--vscode-sideBar-background);
    }

    .panel.collapsed {
      flex: 0 0 28px !important;
      min-height: 28px;
      height: 28px !important;
      order: 999;
    }

    .panel.collapsed .panel-body {
      display: none;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px;
      background-color: var(--vscode-sideBarSectionHeader-background);
      border-bottom: 1px solid var(--vscode-panel-border);
      cursor: pointer;
      user-select: none;
    }

    .panel-header:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .panel-title {
      font-weight: 600;
      font-size: 11px;
      color: var(--vscode-sideBarTitle-foreground);
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-title-text {
      /* 主标题文字 */
    }

    .panel-title-badge {
      font-size: 10px;
      font-weight: 400;
      opacity: 0.7;
      background-color: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
      padding: 2px 6px;
      border-radius: 10px;
    }

    /* 面板操作按钮组 */
    .panel-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .panel-action-btn {
      background: transparent;
      color: var(--vscode-foreground);
      border: none;
      padding: 0;
      cursor: pointer;
      font-size: 16px;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      border-radius: 3px;
    }

    .panel-action-btn:hover {
      opacity: 1;
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .orchestration-filter-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .orchestration-filter-btn {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 11px;
      background: transparent;
      color: var(--vscode-foreground);
      cursor: pointer;
    }

  .orchestration-filter-btn.active {
    background: var(--vscode-button-background);
    border-color: var(--vscode-button-background);
    color: var(--vscode-button-foreground);
  }

  .orchestration-summary {
    border: 1px solid var(--vscode-panel-border);
    border-radius: 8px;
    padding: 8px 12px;
    margin-bottom: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    font-size: 11px;
    background: rgba(255,255,255,0.02);
  }

  .orchestration-summary span {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

    .orchestration-event-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow-y: auto;
      padding: 4px 2px;
      flex: 1;
    }

    .orch-event {
      border: 1px solid var(--vscode-panel-border);
      border-left-width: 4px;
      border-radius: 6px;
      padding: 8px 10px;
      background-color: var(--vscode-editorWidget-background);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
    }

    .orch-event-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
    }

    .orch-event-source {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .orch-event-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .orch-event-meta {
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .orch-event-meta span {
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      padding: 1px 6px;
      border-radius: 999px;
    }

    .orch-event.severity-info {
      border-left-color: var(--vscode-editorInfo-foreground, #62a0ea);
    }

    .orch-event.severity-success {
      border-left-color: var(--vscode-testing-iconPassed, #4caf50);
    }

    .orch-event.severity-warning {
      border-left-color: var(--vscode-editorWarning-foreground, #f1c21b);
    }

    .orch-event.severity-critical {
      border-left-color: var(--vscode-editorError-foreground, #e53935);
    }

    .panel-collapse-btn {
      background: transparent;
      color: var(--vscode-foreground);
      border: none;
      padding: 0;
      cursor: pointer;
      font-size: 12px;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
    }

    .panel-collapse-btn:hover {
      opacity: 1;
    }

    #panel-orchestration-events .panel-body {
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .task-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }

    .task-detail-label {
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.08em;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 4px;
    }

    .task-detail-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--vscode-editor-foreground);
    }

    .task-detail-subtitle {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    .task-detail-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
    }

    .task-detail-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .task-detail-meta-item {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .task-detail-meta-item .label {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .task-detail-meta-item .value {
      font-size: 13px;
      color: var(--vscode-editor-foreground);
      word-break: break-word;
    }

    .task-detail-section {
      margin-bottom: 16px;
    }

    .task-detail-section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--vscode-descriptionForeground);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .task-detail-section-body {
      font-size: 13px;
      line-height: 1.6;
      color: var(--vscode-editor-foreground);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.02);
    }

    .task-detail-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .task-tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--vscode-panel-border);
      background: rgba(255, 255, 255, 0.02);
    }

    .task-detail-timeline {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .task-detail-timeline-item {
      border-left: 3px solid var(--vscode-editorHoverWidget-border);
      padding-left: 10px;
      font-size: 12px;
    }

    .task-detail-timeline-item .label {
      display: block;
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .task-detail-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .task-detail-empty {
      color: var(--vscode-descriptionForeground);
      font-size: 12px;
    }

    .vote-type-badge {
      background-color: rgba(33, 150, 243, 0.15);
      border-color: rgba(33, 150, 243, 0.3);
      color: #2196f3;
    }

    .vote-deadline-badge {
      border-style: dashed;
    }

    .vote-deadline-badge.ok {
      color: #4caf50;
      background-color: rgba(76, 175, 80, 0.1);
      border-color: rgba(76, 175, 80, 0.35);
    }

    .vote-deadline-badge.warning {
      color: #ff9800;
      background-color: rgba(255, 152, 0, 0.12);
      border-color: rgba(255, 152, 0, 0.4);
    }

    .vote-deadline-badge.expired {
      color: #e64a19;
      background-color: rgba(230, 74, 25, 0.12);
      border-color: rgba(230, 74, 25, 0.4);
    }

    .vote-deadline-badge.done {
      color: #9e9e9e;
      background-color: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.2);
    }

    .vote-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }

    .vote-stats-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: rgba(255, 255, 255, 0.02);
    }

    .vote-stats-card.approve {
      border-color: rgba(76, 175, 80, 0.4);
    }

    .vote-stats-card.reject {
      border-color: rgba(244, 67, 54, 0.4);
    }

    .vote-stats-card.abstain {
      border-color: rgba(158, 158, 158, 0.4);
    }

    .vote-stats-card.progress {
      border-color: rgba(33, 150, 243, 0.35);
    }

    .vote-stats-label {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .vote-stats-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--vscode-editor-foreground);
      line-height: 1.2;
    }

    .vote-stats-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .vote-log {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      max-height: 260px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.02);
    }

    .vote-log-entry {
      border-left: 3px solid rgba(255, 255, 255, 0.1);
      padding-left: 10px;
    }

    .vote-log-header {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      font-weight: 600;
    }

    .vote-log-agent {
      color: var(--vscode-editor-foreground);
    }

    .vote-log-choice {
      color: var(--vscode-descriptionForeground);
    }

    .vote-log-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 2px;
    }

    .vote-log-comment {
      font-size: 12px;
      margin-top: 4px;
      line-height: 1.5;
      color: var(--vscode-editor-foreground);
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    #panel-orchestration-events .panel-body {
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .lock-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .lock-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.02);
      font-size: 12px;
    }

    .lock-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .lock-resource {
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .lock-meta {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      color: var(--vscode-descriptionForeground);
      font-size: 11px;
    }

    .lock-actions {
      display: flex;
      justify-content: flex-end;
      margin-top: 6px;
    }

    .panel-inline-hint {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
    }
    .global-info-banner {
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid rgba(56, 189, 248, 0.35);
      background: rgba(56, 189, 248, 0.12);
      color: var(--vscode-descriptionForeground);
      font-size: 12px;
      line-height: 1.6;
    }
    .global-info-banner strong {
      color: var(--vscode-textLink-foreground);
    }
    .workflow-user-note-section {
      margin-top: 12px;
      border-top: 1px solid var(--vscode-panel-border);
      padding-top: 8px;
    }
    .workflow-user-note-section .section-title {
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--vscode-foreground);
    }
    .workflow-user-note-card {
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 6px;
      background: rgba(255, 255, 255, 0.02);
    }
    .workflow-user-note-card.pending {
      border-color: rgba(255, 193, 7, 0.4);
    }
    .workflow-user-note-card.resolved {
      opacity: 0.7;
    }
    .workflow-user-note-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }
    .workflow-user-note-content {
      font-size: 13px;
      line-height: 1.4;
      color: var(--vscode-foreground);
      white-space: pre-wrap;
    }
    .workflow-user-note-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      gap: 8px;
      flex-wrap: wrap;
    }
    .workflow-user-note-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .note-status-pill {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      color: #fff;
    }
    .note-status-pill.pending {
      background: rgba(255, 193, 7, 0.8);
    }
    .note-status-pill.resolved {
      background: rgba(76, 175, 80, 0.8);
    }
    .note-action-btn,
    .note-link {
      border: none;
      background: rgba(255, 255, 255, 0.08);
      color: var(--vscode-textLink-foreground);
      cursor: pointer;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .note-action-btn:hover,
    .note-link:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .panel-link-button {
      border: none;
      background: none;
      color: var(--vscode-textLink-foreground);
      cursor: pointer;
      font-size: 11px;
      margin-left: 4px;
      text-decoration: underline;
      padding: 0;
    }

    /* 列表项样式 */
    .list-item {
      padding: 8px 12px;
      border-bottom: 1px solid var(--vscode-panel-border);
      cursor: pointer;
      transition: background-color 0.1s;
    }

    .list-item:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .list-item-title {
      font-size: 13px;
      color: var(--vscode-foreground);
      margin-bottom: 4px;
    }

    .list-item-description {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .file-change-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
      align-items: center;
    }

    .file-change-filter-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease, color 0.15s ease;
    }

    .file-change-filter-btn.active {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border-color: var(--vscode-button-background);
    }

    .file-change-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .file-change-filter-input {
      border: 1px solid var(--vscode-panel-border);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .file-change-view-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .file-change-view-toggle span {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .file-change-view-btn {
      border: 1px solid transparent;
      background: transparent;
      color: var(--vscode-foreground);
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .file-change-view-btn.active {
      border-color: var(--vscode-button-background);
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .file-change-view-btn:hover {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .mcp-toolbar {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .mcp-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-textLink-foreground);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .mcp-btn:hover {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .mcp-server-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mcp-server-card,
    .agent-config-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 12px;
      background-color: var(--vscode-sideBar-background);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .agent-config-card.agent-disabled,
    .agent-config-card.agent-config-card-disabled {
      opacity: 0.6;
    }

    .mcp-server-card.disabled {
      opacity: 0.65;
    }

    .mcp-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .mcp-card-title {
      font-size: 13px;
      font-weight: 600;
    }

    .mcp-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      margin-left: 6px;
      border: 1px solid transparent;
    }

    .mcp-badge.enabled {
      color: #2e7d32;
      border-color: rgba(46, 125, 50, 0.4);
      background-color: rgba(46, 125, 50, 0.12);
    }

    .mcp-badge.disabled {
      color: var(--vscode-descriptionForeground);
      border-color: rgba(255, 255, 255, 0.1);
      background-color: rgba(255, 255, 255, 0.03);
    }

    .mcp-badge.default {
      color: #fbc02d;
      border-color: rgba(251, 192, 45, 0.4);
      background-color: rgba(251, 192, 45, 0.12);
    }

    .mcp-card-body {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      line-height: 1.4;
      margin-bottom: 8px;
      word-break: break-all;
    }

    .mcp-card-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .mcp-card-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-textLink-foreground);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .mcp-card-btn:hover:not(:disabled) {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .mcp-card-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .mcp-card-btn.ghost {
      color: var(--vscode-foreground);
    }

    .mcp-card-btn.danger {
      border-color: rgba(244, 67, 54, 0.5);
      color: #f44336;
    }

    .mcp-empty-cta {
      margin-top: 12px;
    }

    .file-change-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .file-change-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .file-change-action-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }

    .file-change-action-btn:hover {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .file-change-detail {
      margin-top: 8px;
      border-top: 1px solid var(--vscode-panel-border);
      padding-top: 8px;
    }

    .file-change-diff {
      font-family: var(--vscode-editor-font-family, monospace);
      font-size: 11px;
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 8px;
      overflow-x: auto;
    }

    .diff-line {
      white-space: pre-wrap;
    }

    .diff-line-add {
      background-color: rgba(76, 175, 80, 0.1);
      color: #4caf50;
    }

    .diff-line-remove {
      background-color: rgba(244, 67, 54, 0.1);
      color: #f44336;
    }

    .diff-line-hunk {
      background-color: rgba(33, 150, 243, 0.1);
      color: #2196f3;
      font-weight: 600;
    }

    .file-change-task-group {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px;
      background-color: rgba(255, 255, 255, 0.02);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .task-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .task-group-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .task-group-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .task-group-agent {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .task-group-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .task-group-more {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      border-top: 1px dashed var(--vscode-panel-border);
      padding-top: 4px;
    }

    /* 空状态 */
    .empty-state {
      padding: 24px 12px;
      text-align: center;
      color: var(--vscode-descriptionForeground);
      font-size: 12px;
    }

    /* Main Tab Navigation */
    .main-tab-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
      background-color: var(--vscode-editor-background);
    }

    .main-tab-buttons {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .main-tab-button {
      padding: 6px 16px;
      background: none;
      border: none;
      color: var(--vscode-foreground);
      cursor: pointer;
      border-radius: 2px;
      font-size: 13px;
      font-weight: 500;
    }

    .main-tab-button:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .main-tab-button.active {
      background-color: var(--vscode-list-activeSelectionBackground);
      color: var(--vscode-list-activeSelectionForeground);
    }

    .main-tab-content {
      display: none;
      flex: 1;
      min-height: 0;
      flex-direction: column;
    }

    .main-tab-content.active {
      display: flex;
    }

    .session-tab-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .session-current-label {
      min-width: 80px;
      text-align: left;
      color: var(--vscode-foreground);
    }

    .session-scenario-label {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      min-width: 120px;
    }

    .session-select {
      min-width: 160px;
      padding: 4px 8px;
      border: 1px solid var(--vscode-input-border);
      border-radius: 4px;
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      font-size: 12px;
    }

    .session-action-btn {
      border: 1px solid var(--vscode-panel-border);
      background: var(--vscode-toolbar-inactiveForeground);
      color: var(--vscode-toolbar-hoverForeground);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    .session-action-btn:hover {
      background: var(--vscode-toolbar-hoverBackground);
    }

    .session-action-btn.danger {
      color: var(--vscode-errorForeground);
    }

    .global-config-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px;
      overflow-y: auto;
    }

    .global-config-body {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 12px;
      background-color: rgba(255, 255, 255, 0.01);
    }

    .global-config-tabs {
      display: flex;
      gap: 4px;
      padding: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
      background-color: var(--vscode-editor-background);
    }

    .global-config-tab {
      padding: 6px 16px;
      background: none;
      border: none;
      color: var(--vscode-foreground);
      cursor: pointer;
      border-radius: 2px;
      font-size: 13px;
      font-weight: 500;
    }

    .global-config-tab:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .global-config-tab.active {
      background-color: var(--vscode-list-activeSelectionBackground);
      color: var(--vscode-list-activeSelectionForeground);
    }

    .global-section {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 12px 14px;
      background-color: rgba(255, 255, 255, 0.02);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .global-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .global-section-title {
      font-size: 14px;
      font-weight: 600;
    }

    .global-section-desc {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    .global-section-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .global-section-body {
      display: flex;
      flex-direction: column;
    }

    .global-tab-content {
      display: none;
    }

    .global-tab-content.active {
      display: block;
    }

    .global-agent-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .agent-config-card .agent-card-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .agent-config-card .agent-card-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .global-agent-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .global-agent-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .agent-status-badge {
      font-size: 11px;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      line-height: 1.2;
    }

    .agent-status-badge.agent-status-online {
      color: #2e7d32;
      border-color: rgba(46, 125, 50, 0.35);
      background: rgba(46, 125, 50, 0.15);
    }

    .agent-status-badge.agent-status-busy {
      color: #ef6c00;
      border-color: rgba(239, 108, 0, 0.35);
      background: rgba(239, 108, 0, 0.15);
    }

    .agent-status-badge.agent-status-offline {
      color: #c62828;
      border-color: rgba(198, 40, 40, 0.35);
      background: rgba(198, 40, 40, 0.15);
    }

    .agent-config-card .agent-card-body {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px 16px;
      font-size: 12px;
      color: var(--vscode-foreground);
    }

    .agent-config-card .agent-card-section {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .agent-config-card .agent-card-section-title {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .global-agent-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .global-config-notice {
      margin-top: 12px;
      padding: 12px;
      border: 1px dashed var(--vscode-panel-border);
      border-radius: 8px;
      background: rgba(0, 0, 0, 0.05);
      font-size: 12px;
      line-height: 1.5;
    }

    .global-config-notice button {
      margin-top: 8px;
      padding: 4px 12px;
      font-size: 12px;
    }


    .mcp-tool-item {
      font-size: 12px;
      color: var(--vscode-foreground);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chip-group {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      border: 1px solid var(--vscode-panel-border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--vscode-foreground);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .chip:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .tag-input {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }

    .tag-list {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      min-height: 20px;
    }

    .tag-chip {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--vscode-panel-border);
      color: var(--vscode-foreground);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .tag-chip button {
      background: none;
      border: none;
      color: var(--vscode-descriptionForeground);
      cursor: pointer;
      font-size: 11px;
      padding: 0;
    }

    /* Sub-tab Navigation (for Blackboard) */
    .sub-tab-nav {
      display: flex;
      gap: 4px;
      padding: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .sub-tab-button {
      padding: 4px 12px;
      background: none;
      border: none;
      color: var(--vscode-foreground);
      cursor: pointer;
      border-radius: 2px;
      font-size: 12px;
    }

    .sub-tab-button:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .sub-tab-button.active {
      background-color: var(--vscode-list-activeSelectionBackground);
      color: var(--vscode-list-activeSelectionForeground);
    }

    .sub-tab-content {
      display: none;
      flex: 1;
      min-height: 0;
    }

    .sub-tab-content.active {
      display: flex;
      flex-direction: column;
    }

    .message-template-row {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .message-template-btn {
      border: 1px solid var(--vscode-panel-border);
      background: none;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      color: var(--vscode-textLink-foreground);
    }

    .message-template-btn:hover {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .message-role-badge {
      display: inline-flex;
      align-items: center;
      padding: 0 8px;
      border-radius: 999px;
      font-size: 10px;
      margin-left: 6px;
      border: 1px solid var(--vscode-panel-border);
      color: var(--vscode-foreground);
      background: rgba(255, 255, 255, 0.08);
    }

    .message-role-badge.persona-lead {
      border-color: #4fc3f7;
      color: #4fc3f7;
    }

    .message-role-badge.persona-reviewer {
      border-color: #ba68c8;
      color: #ba68c8;
    }

    .message-role-badge.persona-executor {
      border-color: #81c784;
      color: #81c784;
    }

    .message-role-badge.persona-moderator {
      border-color: #ffb74d;
      color: #ffb74d;
    }

    .message-role-badge.persona-user {
      border-color: var(--vscode-descriptionForeground);
      color: var(--vscode-descriptionForeground);
    }

    .message-direct-badge {
      border: 1px solid #ff922b;
      color: #ff922b;
      background: rgba(255, 146, 43, 0.15);
      border-radius: 999px;
      font-size: 10px;
      padding: 0 6px;
      margin-left: 6px;
      cursor: pointer;
    }

    .message-instance-badge {
      display: inline-flex;
      align-items: center;
      border-radius: 10px;
      font-size: 10px;
      padding: 0 6px;
      margin-left: 6px;
      border: 1px solid var(--instance-color, #5c7cfa);
      color: var(--instance-color, #5c7cfa);
      background: rgba(255, 255, 255, 0.04);
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s;
    }

    .message-instance-badge:hover {
      background: var(--instance-color, #5c7cfa);
      color: #0f1117;
    }

    .message-reference-cards {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }

    .message-reference-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 6px;
      font-size: 11px;
      background: rgba(255,255,255,0.02);
    }

    .message-reference-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
      color: var(--vscode-descriptionForeground);
    }

    .message-reference-card-title {
      font-size: 12px;
      color: var(--vscode-foreground);
    }

    .message-reference-card button {
      border: none;
      background: none;
      color: var(--vscode-textLink-foreground);
      cursor: pointer;
      font-size: 11px;
      padding: 0;
    }

    /* Message Styles */
    .message-item {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 0 8px;
    }

    /* User message (right-aligned) */
    .message-item.user-message {
      flex-direction: row-reverse;
    }

    .message-item.user-message .message-content {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .message-item.user-message .message-header {
      flex-direction: row-reverse;
    }

    .message-item.user-message .message-bubble {
      background-color: rgba(0, 122, 204, 0.15);
      border: 1px solid rgba(0, 122, 204, 0.3);
    }

    .message-item.user-message .message-text {
      color: var(--vscode-foreground);
    }

    .message-item.user-message .message-quoted {
      background-color: rgba(0, 0, 0, 0.15);
      border-left-color: rgba(0, 122, 204, 0.6);
    }

    .message-item.user-message .message-quoted-author {
      color: rgba(0, 122, 204, 1);
    }

    .message-item.user-message .message-quoted-content {
      color: var(--vscode-descriptionForeground);
      opacity: 0.9;
    }

    .message-item.user-message .message-actions {
      justify-content: flex-end;
    }

    .message-avatar {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
    }

    .message-avatar-blue {
      background-color: rgba(33, 150, 243, 0.2);
      color: rgb(33, 150, 243);
    }

    .message-avatar-green {
      background-color: rgba(76, 175, 80, 0.2);
      color: rgb(76, 175, 80);
    }

    .message-avatar-purple {
      background-color: rgba(156, 39, 176, 0.2);
      color: rgb(156, 39, 176);
    }

    .message-avatar-orange {
      background-color: rgba(255, 152, 0, 0.2);
      color: rgb(255, 152, 0);
    }

    .message-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .message-author {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .message-time {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .message-bubble {
      background-color: var(--vscode-editor-inactiveSelectionBackground);
      border-radius: 8px;
      padding: 10px 12px;
      max-width: 70%;
      width: fit-content;
      border: 1px solid transparent;
    }

    /* Agent color-coded message bubbles */
    .message-bubble-blue {
      background-color: rgba(33, 150, 243, 0.12);
      border-color: rgba(33, 150, 243, 0.3);
    }

    .message-bubble-green {
      background-color: rgba(76, 175, 80, 0.12);
      border-color: rgba(76, 175, 80, 0.3);
    }

    .message-bubble-purple {
      background-color: rgba(156, 39, 176, 0.12);
      border-color: rgba(156, 39, 176, 0.3);
    }

    .message-bubble-orange {
      background-color: rgba(255, 152, 0, 0.12);
      border-color: rgba(255, 152, 0, 0.3);
    }

    /* 回复样式 */
    .message-reply {
      border-left: 3px solid rgba(76, 175, 80, 0.8);
      background-color: rgba(76, 175, 80, 0.1);
      padding: 6px 8px;
      margin-bottom: 8px;
      font-size: 12px;
      border-radius: 4px;
    }

    .message-reply-author {
      font-weight: 600;
      color: rgba(76, 175, 80, 1);
      margin-bottom: 2px;
    }

    .message-reply-content {
      color: var(--vscode-foreground);
      opacity: 0.85;
    }

    /* 引用样式 */
    .message-quoted {
      border-left: 3px solid rgba(33, 150, 243, 0.8);
      background-color: rgba(33, 150, 243, 0.1);
      padding: 6px 8px;
      margin-bottom: 8px;
      font-size: 12px;
      border-radius: 4px;
    }

    .message-quoted-author {
      font-weight: 600;
      color: rgba(33, 150, 243, 1);
      margin-bottom: 2px;
    }

    .message-quoted-content {
      color: var(--vscode-foreground);
      opacity: 0.85;
    }

    .message-text {
      font-size: 13px;
      line-height: 1.5;
      color: var(--vscode-foreground);
      word-wrap: break-word;
    }

    .message-actions {
      display: flex;
      gap: 12px;
      margin-top: 6px;
    }

    .message-action-btn {
      font-size: 11px;
      color: var(--vscode-textLink-foreground);
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }

    .message-action-btn:hover {
      text-decoration: underline;
    }

    /* 输入框上方的回复/引用指示器 */
    .reply-indicator {
      border-radius: 4px;
      padding: 8px 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 3px solid;
    }

    .reply-indicator.is-reply {
      background-color: rgba(76, 175, 80, 0.15);
      border-left-color: rgba(76, 175, 80, 0.8);
    }

    .reply-indicator.is-quote {
      background-color: rgba(33, 150, 243, 0.15);
      border-left-color: rgba(33, 150, 243, 0.8);
    }

    .reply-indicator-text {
      font-size: 12px;
      font-weight: 500;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .reply-indicator.is-reply .reply-indicator-text {
      color: rgba(76, 175, 80, 1);
    }

    .reply-indicator.is-quote .reply-indicator-text {
      color: rgba(33, 150, 243, 1);
    }

    .reply-indicator-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 8px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .reply-indicator-close:hover {
      opacity: 1;
    }

    .reply-indicator.is-reply .reply-indicator-close {
      color: rgba(76, 175, 80, 1);
    }

    .reply-indicator.is-quote .reply-indicator-close {
      color: rgba(33, 150, 243, 1);
    }

    /* Agent Card Styles */
    .agent-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      background-color: var(--vscode-editor-background);
      transition: background-color 0.15s;
      cursor: pointer;
      position: relative;
    }

    .agent-card:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .agent-card.selected {
      background-color: var(--vscode-list-activeSelectionBackground);
      border-color: var(--vscode-focusBorder);
    }

    .agent-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .agent-card-name {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .agent-card-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: none;
      gap: 4px;
      background-color: var(--vscode-editor-background);
      padding: 2px;
      border-radius: 2px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .agent-card:hover .agent-card-actions {
      display: flex;
    }

    .agent-action-btn {
      width: 24px;
      height: 24px;
      padding: 0;
      border: none;
      background: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 2px;
      color: var(--vscode-foreground);
    }

    .agent-action-btn:hover {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .agent-action-btn svg {
      width: 14px;
      height: 14px;
    }

    .agent-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .agent-status-dot.agent-status-online {
      background-color: #4caf50;
    }

    .agent-status-dot.agent-status-offline {
      background-color: var(--vscode-descriptionForeground);
    }

    .agent-status-dot.agent-status-busy {
      background-color: #ff9800;
    }

    .agent-name-text {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .agent-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .agent-heartbeat {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .agent-role-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    /* Badge Styles */
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
      line-height: 1.2;
    }

    .badge-default {
      background-color: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
    }

    .badge-pending {
      background-color: rgba(255, 152, 0, 0.2);
      color: #ff9800;
    }

    .badge-running {
      background-color: rgba(33, 150, 243, 0.2);
      color: #2196f3;
    }

    .badge-completed {
      background-color: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .badge-failed {
      background-color: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }

    .badge-info {
      background-color: rgba(33, 150, 243, 0.2);
      color: #2196f3;
    }

    .badge-success {
      background-color: rgba(76, 175, 80, 0.2);
      color: #4caf50;
    }

    .badge-warning {
      background-color: rgba(255, 152, 0, 0.2);
      color: #ff9800;
    }

    .badge-error {
      background-color: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }

    /* Task Item Styles */
    .task-item {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      background-color: var(--vscode-editor-background);
      transition: background-color 0.15s;
      cursor: pointer;
    }

    .task-progress-summary {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 8px;
    }

    .task-progress-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.02);
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .task-progress-card.active {
      border-color: var(--vscode-focusBorder);
      box-shadow: 0 0 0 1px var(--vscode-focusBorder);
    }

    .task-progress-card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .task-progress-card-title {
      color: var(--vscode-foreground);
    }

    .task-group-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }

    .task-group-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.01);
    }

    .task-group-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .task-group-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .task-group-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 2px;
    }

    .task-group-meter {
      margin: 8px 0;
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.05);
      overflow: hidden;
    }

    .task-group-meter span {
      display: block;
      height: 100%;
      background: var(--vscode-focusBorder);
    }

    .task-group-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .task-row {
      padding: 8px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .task-row:first-child {
      border-top: none;
    }

    .task-row-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
    }

    .task-row-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--vscode-foreground);
    }

    .task-row-status {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--vscode-descriptionForeground);
    }

    .task-row-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    .task-row-automation {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(92, 124, 250, 0.12);
      color: #5c7cfa;
      font-size: 10px;
      font-weight: 600;
    }

    .task-progress-count {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .task-progress-meter {
      position: relative;
      height: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      overflow: hidden;
    }

    .task-progress-meter span {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      background: var(--vscode-progressBar-background, #0e639c);
    }

    .task-progress-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .task-progress-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 11px;
    }

    .task-progress-actions button {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      border-radius: 4px;
      padding: 2px 8px;
      cursor: pointer;
      font-size: 11px;
    }

    .task-progress-actions button.ghost {
      color: var(--vscode-descriptionForeground);
    }

    .task-item-nested {
      border-left: 2px solid var(--vscode-panel-border);
      padding-left: 12px;
    }

    .task-item:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .task-item.file-change-highlight {
      border-color: var(--vscode-focusBorder);
      box-shadow: 0 0 0 1px var(--vscode-focusBorder);
    }

    .task-item.dependency-focus {
      border-color: var(--vscode-focusBorder);
      box-shadow: 0 0 0 1px var(--vscode-focusBorder);
      animation: flash-border 1s ease;
    }

    @keyframes flash-border {
      0% { box-shadow: 0 0 0 1px transparent; }
      50% { box-shadow: 0 0 0 1px var(--vscode-focusBorder); }
      100% { box-shadow: 0 0 0 1px transparent; }
    }

    .task-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }

    .task-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--vscode-foreground);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .task-body {
      margin-top: 8px;
    }

    .task-description {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .task-item-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .task-item-detail {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    /* Task Badge Styles */
    .task-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      line-height: 1.2;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    /* Status Badges */
    .task-badge-status {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .task-badge-status.status-running {
      color: #2196f3;
      background-color: rgba(33, 150, 243, 0.15);
      border-color: rgba(33, 150, 243, 0.3);
    }

    .task-badge-status.status-pending {
      color: #ff9800;
      background-color: rgba(255, 152, 0, 0.15);
      border-color: rgba(255, 152, 0, 0.3);
    }

    .task-badge-status.status-blocked {
      color: #f44336;
      background-color: rgba(244, 67, 54, 0.15);
      border-color: rgba(244, 67, 54, 0.3);
    }

    .task-badge-status.status-paused {
      color: #9e9e9e;
      background-color: rgba(158, 158, 158, 0.15);
      border-color: rgba(158, 158, 158, 0.3);
    }

    .task-badge-status.status-completed {
      color: #4caf50;
      background-color: rgba(76, 175, 80, 0.15);
      border-color: rgba(76, 175, 80, 0.3);
    }

    .task-badge-status.status-failed {
      color: #f44336;
      background-color: rgba(244, 67, 54, 0.15);
      border-color: rgba(244, 67, 54, 0.3);
    }

    .task-badge-status.status-approved {
      color: #4caf50;
      background-color: rgba(76, 175, 80, 0.15);
      border-color: rgba(76, 175, 80, 0.3);
    }

    .task-badge-status.status-rejected {
      color: #d32f2f;
      background-color: rgba(211, 47, 47, 0.15);
      border-color: rgba(211, 47, 47, 0.35);
    }

    .task-badge-status.status-timeout {
      color: #ff9800;
      background-color: rgba(255, 152, 0, 0.15);
      border-color: rgba(255, 152, 0, 0.35);
    }

    .task-badge-status.status-cancelled {
      color: #9e9e9e;
      background-color: rgba(158, 158, 158, 0.12);
      border-color: rgba(158, 158, 158, 0.25);
    }

    /* Assignee Badge */
    .task-badge-assignee {
      color: #9c27b0;
      background-color: rgba(156, 39, 176, 0.12);
      border-color: rgba(156, 39, 176, 0.25);
    }

    .task-badge-assignee.unassigned {
      color: var(--vscode-descriptionForeground);
      background-color: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }

    /* Priority Badges */
    .task-badge-priority {
      font-weight: 600;
    }

    .task-badge-priority.priority-critical {
      color: #d32f2f;
      background-color: rgba(211, 47, 47, 0.15);
      border-color: rgba(211, 47, 47, 0.35);
    }

    .task-badge-priority.priority-high {
      color: #f57c00;
      background-color: rgba(245, 124, 0, 0.15);
      border-color: rgba(245, 124, 0, 0.3);
    }

    .task-badge-priority.priority-medium {
      color: #fbc02d;
      background-color: rgba(251, 192, 45, 0.15);
      border-color: rgba(251, 192, 45, 0.3);
    }

    .task-badge-priority.priority-low {
      color: #7cb342;
      background-color: rgba(124, 179, 66, 0.15);
      border-color: rgba(124, 179, 66, 0.3);
    }

    .task-badge-priority.priority-none {
      color: var(--vscode-descriptionForeground);
      background-color: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .task-item-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .task-action-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-textLink-foreground);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .task-action-btn:hover {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .governance-alert-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .governance-alert-action {
      border: 1px solid var(--vscode-focusBorder);
      background-color: var(--vscode-button-background, var(--vscode-focusBorder));
      color: var(--vscode-button-foreground, var(--vscode-editor-foreground));
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      transition: filter 0.15s ease;
    }

    .governance-alert-action:hover {
      filter: brightness(1.1);
    }

    .governance-focus {
      animation: governancePulse 1.4s ease;
      box-shadow: 0 0 0 2px var(--vscode-focusBorder);
      border-radius: 6px;
    }

    @keyframes governancePulse {
      0% {
        box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.6);
      }
      100% {
        box-shadow: 0 0 0 12px rgba(33, 150, 243, 0);
      }
    }

    .governance-summary {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
      background-color: rgba(255, 255, 255, 0.02);
    }

    .gov-summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      width: 100%;
    }

    .inline-governance-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-bottom: 12px;
    }

    .quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0 12px;
    }

    .quick-action-btn {
      border: 1px solid var(--vscode-panel-border);
      background-color: rgba(255, 255, 255, 0.04);
      color: var(--vscode-foreground);
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.15s ease, border-color 0.15s ease;
    }

    .quick-action-btn:hover {
      background-color: rgba(255, 255, 255, 0.08);
      border-color: var(--vscode-focusBorder);
    }

    .quick-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .summary-tile {
      flex: 1;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background-color: var(--vscode-sideBar-background);
      transition: border-color 0.15s;
    }

    .summary-tile[data-action] {
      cursor: pointer;
    }

    .summary-tile:hover {
      border-color: var(--vscode-focusBorder);
    }

    .summary-tile-title {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .summary-tile-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .summary-tile-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .gov-polling-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 10px;
      background-color: var(--vscode-sideBar-background);
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: border-color 0.15s;
    }

    .gov-polling-card.active {
      border-color: var(--vscode-focusBorder);
    }

    .gov-polling-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .polling-meta-item {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .polling-meta-label {
      color: var(--vscode-descriptionForeground);
    }

    .polling-meta-value {
      color: var(--vscode-foreground);
      font-weight: 500;
    }

    .governance-alert {
      margin: 0 8px 8px;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 12px;
      display: none;
      border: 1px solid transparent;
    }

    .governance-alert.show {
      display: block;
    }

    .governance-alert.info {
      border-color: rgba(33, 150, 243, 0.3);
      background-color: rgba(33, 150, 243, 0.12);
      color: #2196f3;
    }

    .governance-alert.warning {
      border-color: rgba(255, 152, 0, 0.4);
      background-color: rgba(255, 152, 0, 0.14);
      color: #ff9800;
    }

    .governance-alert.inline {
      margin: 0 0 12px;
    }

    .panel.collapsed {
      flex: 0 !important;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .panel.collapsed .panel-body {
      display: none;
    }

    .panel.collapsed .panel-collapse-btn {
      transform: none;
    }

    .governance-history-body {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .governance-history-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .governance-history-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }

    .governance-history-filters select,
    .governance-history-filters input {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid var(--vscode-panel-border);
      background-color: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      font-size: 12px;
    }

    .governance-history-pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 8px;
      border-top: 1px solid var(--vscode-panel-border);
      padding-top: 8px;
    }

    .history-page-indicator {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .policies-wrapper {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .policy-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 10px;
      padding: 12px 14px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.02);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
    }

    .policy-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .policy-name {
      font-size: 13px;
      font-weight: 600;
      flex: 1;
    }

    .policy-type-tag {
      font-size: 11px;
      border-radius: 12px;
      padding: 2px 8px;
      border: 1px solid transparent;
      text-transform: none;
    }

    .policy-type-auto {
      border-color: rgba(76, 175, 80, 0.4);
      color: #4caf50;
      background: rgba(76, 175, 80, 0.1);
    }

    .policy-type-require {
      border-color: rgba(255, 152, 0, 0.4);
      color: #ff9800;
      background: rgba(255, 152, 0, 0.1);
    }

    .policy-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 8px 0;
    }

    .policy-meta-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.03);
    }

    .policy-section {
      margin-top: 8px;
    }

    .policy-section-title {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .policy-summary-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .policy-summary-item {
      font-size: 11px;
      border-radius: 8px;
      padding: 4px 8px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      background: rgba(255, 255, 255, 0.02);
    }

    .policy-json-preview {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px;
      font-family: var(--vscode-editor-font-family);
      font-size: 11px;
      background: var(--vscode-editor-background);
      white-space: pre-wrap;
    }

    .form-section {
      margin-bottom: 12px;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .form-section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-section-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px 16px;
    }

    .form-group.inline {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 4px 12px;
      padding: 4px 0;
    }

    .checkbox-group .checkbox {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--vscode-foreground);
    }

    .checkbox-group input[type="checkbox"] {
      margin: 0;
    }

    .input-with-suffix {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .input-with-suffix .suffix {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .multi-select {
      min-height: 64px;
    }

    .analytics-filter-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 12px;
    }

    .analytics-filter-group {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .analytics-range-select {
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
    }

    .analytics-type-toggle {
      display: flex;
      gap: 6px;
    }

    .analytics-type-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .analytics-type-btn.active {
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border-color: var(--vscode-button-background);
    }

    .analytics-status {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 8px;
    }

    .analytics-status.error {
      color: var(--vscode-inputValidation-errorBorder);
    }

    .analytics-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .analytics-summary-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
      min-height: 110px;
    }

    .analytics-summary-title {
      font-size: 13px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
    }

    .analytics-summary-value {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .analytics-summary-detail {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 4px;
    }

    .analytics-summary-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .analytics-section {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .analytics-panel {
      flex: 1;
      min-width: 260px;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.02);
      padding: 12px;
    }

    .analytics-panel-header {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .analytics-timeline {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      min-height: 120px;
    }

    .analytics-bar-item {
      flex: 1;
      text-align: center;
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
    }

    .analytics-bar {
      height: 100px;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 4px;
      padding: 2px;
      background: rgba(255, 255, 255, 0.03);
      margin-bottom: 4px;
    }

    .analytics-bar-segment {
      width: 10px;
      border-radius: 2px;
      display: inline-block;
    }

    .analytics-bar-segment.votes {
      background: #4caf50;
    }

    .analytics-bar-segment.approvals {
      background: #03a9f4;
    }

    .analytics-hotspot-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .analytics-hotspot-item {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .workspace-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 12px;
    }

    .workspace-panel {
      background: rgba(0, 0, 0, 0.15);
      border-radius: 12px;
      border: 1px solid var(--vscode-panel-border);
      overflow: hidden;
    }

    .workspace-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 18px;
      border-bottom: 1px solid var(--vscode-panel-border);
      background: rgba(255, 255, 255, 0.02);
    }

    .workspace-agent-meta {
      display: flex;
      flex-direction: column;
    }

    .workspace-agent-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .workspace-agent-name .workspace-agent-id {
      margin-left: 8px;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      font-weight: 400;
    }

    .workspace-agent-subtitle {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-top: 2px;
    }

    .workspace-header-actions {
      display: flex;
      gap: 8px;
    }

    .workspace-header-actions button {
      padding: 6px 12px;
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .workspace-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .workspace-empty {
      padding: 24px;
      color: var(--vscode-descriptionForeground);
      text-align: center;
    }

    .workspace-panel.hidden {
      display: none;
    }

    .workspace-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      margin-bottom: 12px;
    }

    .workspace-summary-stat {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.02);
    }

    .workspace-summary-value {
      font-size: 18px;
      font-weight: 600;
    }

    .workspace-summary-label {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 2px;
    }

    .workspace-tab-nav {
      display: flex;
      border-bottom: 1px solid var(--vscode-panel-border);
      background: rgba(255, 255, 255, 0.01);
    }

    .workspace-tab-button {
      padding: 10px 18px;
      border: none;
      background: transparent;
      color: var(--vscode-foreground);
      font-size: 12px;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: border-color 0.15s;
    }

    .workspace-tab-button.active {
      border-color: var(--vscode-focusBorder);
      font-weight: 600;
    }

    .workspace-tab-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .workspace-section {
      margin-bottom: 16px;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.02);
    }

    .workspace-section-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--vscode-panel-border);
      font-size: 13px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .workspace-section-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .workspace-section-actions .link-button[disabled] {
      opacity: 0.4;
      pointer-events: none;
    }

    .workspace-section-body {
      padding: 12px 14px;
    }

    .workspace-thinking-columns {
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }

    .workspace-thinking-column {
      flex: 1.4;
      min-width: 0;
    }

    .workspace-external-column {
      flex: 1;
      min-width: 0;
      border-left: 1px solid var(--vscode-panel-border);
      padding-left: 12px;
    }

    .workspace-external-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      font-size: 12px;
      font-weight: 600;
    }

    .workspace-external-header small {
      font-weight: 400;
      color: var(--vscode-descriptionForeground);
      font-size: 11px;
    }

    .workspace-external-stack {
      margin-top: 16px;
      color: var(--vscode-descriptionForeground);
    }

    .workspace-external-stack summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--vscode-foreground);
      margin-bottom: 8px;
    }

    .workspace-external-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .workspace-external-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .workspace-external-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 4px;
    }

    .workspace-external-meta .author {
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .workspace-external-body {
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .workspace-key-value {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 6px 12px;
      font-size: 12px;
    }

    .workspace-key-value span:first-child {
      color: var(--vscode-descriptionForeground);
    }

    .workspace-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .workspace-table th,
    .workspace-table td {
      padding: 6px 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
      text-align: left;
    }

    .workspace-table th {
      color: var(--vscode-descriptionForeground);
      font-weight: 500;
    }

    .workspace-table tr:last-child td {
      border-bottom: none;
    }

    .thinking-log-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .thinking-log-entry {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .thinking-log-body {
      margin-top: 8px;
    }

    .thinking-log-entry.collapsed .thinking-log-body {
      display: none;
    }

    .thinking-log-entry.type-file_change {
      border-left: 3px solid #4fc3f7;
    }

    .thinking-log-entry.type-governance {
      border-left: 3px solid #ffd54f;
    }

    .thinking-log-entry.type-user_feedback {
      border-left: 3px solid #80cbc4;
    }

    .thinking-log-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      cursor: pointer;
    }

    .thinking-log-header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .thinking-log-toggle-icon {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .thinking-log-entry:not(.collapsed) .thinking-log-toggle-icon {
      color: var(--vscode-foreground);
    }

    .thinking-log-type {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-right: 6px;
    }

    .thinking-log-task {
      font-size: 12px;
      font-weight: 500;
      color: var(--vscode-descriptionForeground);
    }

    .thinking-log-task.active {
      color: var(--vscode-focusBorder);
    }

    .thinking-log-content {
      margin-top: 8px;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
      font-family: var(--vscode-editor-font-family, monospace);
    }

    .thinking-log-meta {
      margin-top: 6px;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .thinking-log-tool {
      margin-top: 10px;
      padding: 8px;
      border-radius: 6px;
      border: 1px dashed var(--vscode-panel-border);
      background: rgba(255, 255, 255, 0.02);
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .thinking-log-tool-title {
      font-weight: 600;
      color: var(--vscode-foreground);
      margin-bottom: 6px;
    }

    .thinking-log-code-block {
      margin-top: 6px;
    }

    .thinking-log-code-label {
      font-weight: 500;
      margin-bottom: 4px;
    }

    .thinking-log-code {
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 6px;
      font-family: var(--vscode-editor-font-family, monospace);
      font-size: 11px;
      max-height: 200px;
      overflow: auto;
      white-space: pre;
    }

    .thinking-chat-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .thinking-chat-entry {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 10px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .thinking-chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
    }

    .thinking-chat-bubble {
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .thinking-chat-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 6px;
    }

    .thinking-chat-note {
      padding: 2px 6px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
    }

    .workspace-thinking-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }

    .thinking-chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .thinking-chip-label {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-right: 4px;
    }

    .thinking-chip {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }

    .thinking-chip:hover:not(:disabled) {
      border-color: var(--vscode-button-background);
    }

    .thinking-chip.active {
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border-color: var(--vscode-button-background);
    }

    .thinking-chip:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .thinking-chip.ghost {
      border-style: dashed;
      color: var(--vscode-descriptionForeground);
    }

    .workspace-thinking-searchbox {
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 4px 8px;
      background: var(--vscode-input-background);
      flex: 1;
      min-width: 160px;
    }

    .workspace-thinking-searchbox input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--vscode-input-foreground);
      width: 100%;
      font-size: 12px;
    }

    .workspace-thinking-searchbox input::placeholder {
      color: var(--vscode-descriptionForeground);
    }

    .workspace-thinking-search-icon {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .workspace-thinking-summary {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
    }

    .workspace-thinking-summary strong {
      color: var(--vscode-foreground);
    }

    .workspace-thinking-stream {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .workspace-thinking-stream-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
    }

    .workspace-thinking-stream-content {
      font-size: 12px;
      line-height: 1.5;
      color: var(--vscode-foreground);
      max-height: 160px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: var(--vscode-editor-font-family, monospace);
    }

    .workspace-thinking-stream .spinner {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid var(--vscode-descriptionForeground);
      border-top-color: transparent;
      animation: stream-rotate 0.8s linear infinite;
    }

    @keyframes stream-rotate {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    .hotspot-rank {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    .hotspot-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .analytics-recent-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .analytics-recent-item {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 8px;
    }

    .analytics-recent-title {
      font-size: 13px;
      font-weight: 500;
    }

    .analytics-recent-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .gov-history-item {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 10px 12px;
      background-color: rgba(255, 255, 255, 0.02);
      cursor: pointer;
      transition: border-color 0.15s ease, background-color 0.15s ease;
    }

    .gov-history-item:hover {
      border-color: var(--vscode-focusBorder);
      background-color: rgba(255, 255, 255, 0.05);
    }

    .gov-history-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 4px;
      gap: 8px;
    }

    .gov-history-type {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .gov-history-type.vote {
      background-color: rgba(103, 166, 255, 0.15);
      color: #67a6ff;
    }

    .gov-history-type.approval {
      background-color: rgba(143, 238, 185, 0.15);
      color: #59d39a;
    }

    .gov-history-summary {
      font-size: 13px;
      font-weight: 500;
      color: var(--vscode-foreground);
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .gov-history-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .gov-history-payload {
      margin-top: 6px;
      padding: 6px;
      border-radius: 4px;
      font-size: 11px;
      background-color: rgba(255, 255, 255, 0.03);
      color: var(--vscode-descriptionForeground);
      border: 1px dashed var(--vscode-panel-border);
      white-space: pre-wrap;
      word-break: break-all;
    }

    .task-dependency-summary {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .dependency-badge {
      font-size: 11px;
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid var(--vscode-panel-border);
      background-color: rgba(255, 255, 255, 0.02);
      color: var(--vscode-descriptionForeground);
    }

    .dependency-badge.success {
      color: #4caf50;
      border-color: rgba(76, 175, 80, 0.4);
      background-color: rgba(76, 175, 80, 0.08);
    }

    .dependency-badge.warning {
      color: #ff9800;
      border-color: rgba(255, 152, 0, 0.4);
      background-color: rgba(255, 152, 0, 0.08);
    }

    .dependency-badge.info {
      color: #2196f3;
      border-color: rgba(33, 150, 243, 0.4);
      background-color: rgba(33, 150, 243, 0.08);
    }

    .dependency-badge.neutral {
      color: var(--vscode-descriptionForeground);
      border-color: var(--vscode-panel-border);
      background-color: rgba(255, 255, 255, 0.02);
    }

    .dependency-editor {
      margin-top: 16px;
      padding: 12px;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.02);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .dependency-editor-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .dependency-editor-select {
      width: 100%;
      min-height: 140px;
      border: 1px solid var(--vscode-input-border);
      border-radius: 4px;
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      padding: 6px;
      font-size: 12px;
    }

    .dependency-editor-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* 消息过滤按钮 */
    .message-filter-btn {
      padding: 6px 14px;
      background: none;
      border: 1px solid var(--vscode-panel-border);
      color: var(--vscode-foreground);
      cursor: pointer;
      font-size: 12px;
      border-radius: 3px;
      transition: all 0.15s ease;
      font-weight: 400;
    }

    .message-filter-btn:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .message-filter-btn.active {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border-color: var(--vscode-button-background);
      font-weight: 600;
    }

    /* 消息列表项 */
    .message-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--vscode-panel-border);
      cursor: pointer;
      transition: background-color 0.15s ease;
      background-color: transparent;
    }

    .message-item:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .message-item:last-child {
      border-bottom: none;
    }

    .message-item-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .message-item-sender {
      font-weight: 600;
      color: var(--vscode-foreground);
      font-size: 12px;
    }

    .message-item-type {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .message-item-type.request {
      background-color: #0066cc;
      color: #ffffff;
    }

    .message-item-type.response {
      background-color: #008000;
      color: #ffffff;
    }

    .message-item-type.notification {
      background-color: #ff9900;
      color: #000000;
    }

    .message-item-type.message {
      background-color: #666666;
      color: #ffffff;
    }

    .message-item-time {
      margin-left: auto;
      color: var(--vscode-descriptionForeground);
      font-size: 11px;
    }

    .message-item-content {
      color: var(--vscode-foreground);
      font-size: 12px;
      line-height: 1.5;
      word-break: break-word;
      margin-top: 4px;
    }

    /* 消息输入框 */
    #message-input {
      padding: 10px;
      background-color: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border);
      border-radius: 3px;
      font-family: var(--vscode-font-family);
      font-size: 12px;
      resize: none;
      height: 60px;
      transition: all 0.15s ease;
      outline: none;
    }

    #message-input:focus {
      border-color: var(--vscode-focusBorder);
      box-shadow: 0 0 0 1px var(--vscode-focusBorder);
    }

    /* 模态弹窗 */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-overlay.show {
      display: flex;
      opacity: 1;
    }

    .modal-container {
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      width: 700px;
      max-width: 90%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      transform: scale(0.9);
      transition: transform 0.2s ease;
    }

    .modal-overlay.show .modal-container {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--vscode-foreground);
      margin: 0;
    }

    .modal-close-btn {
      background: transparent;
      color: var(--vscode-foreground);
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 20px;
      opacity: 0.7;
      line-height: 1;
    }

    .modal-close-btn:hover {
      opacity: 1;
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .modal-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      padding: 16px 20px;
      border-top: 1px solid var(--vscode-panel-border);
    }

    /* 表单样式 */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--vscode-foreground);
      margin-bottom: 6px;
    }

    .form-label.required::after {
      content: ' *';
      color: var(--vscode-errorForeground);
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 6px 8px;
      font-size: 13px;
      color: var(--vscode-input-foreground);
      background-color: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border);
      border-radius: 2px;
      outline: none;
      font-family: var(--vscode-font-family);
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      border-color: var(--vscode-focusBorder);
    }

    .form-textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-hint {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    /* 按钮样式 */
    .btn {
      padding: 6px 14px;
      font-size: 13px;
      border: none;
      border-radius: 2px;
      cursor: pointer;
      transition: background-color 0.1s;
    }

    .btn-primary {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .btn-primary:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    .btn-secondary {
      background-color: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
    }

    .btn-secondary:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    .btn-danger {
      background-color: rgba(244, 67, 54, 0.18);
      color: #f44336;
    }

    .btn-danger:hover {
      background-color: rgba(244, 67, 54, 0.3);
    }

    .link-button {
      background: none;
      border: none;
      color: var(--vscode-textLink-foreground);
      font-size: 11px;
      cursor: pointer;
      padding: 0;
    }

    .link-button:hover {
      text-decoration: underline;
    }

    .detail-section {
      margin-bottom: 12px;
    }

    .detail-section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--vscode-foreground);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .detail-label {
      color: var(--vscode-descriptionForeground);
    }

    .detail-value {
      color: var(--vscode-foreground);
      text-align: right;
    }

    .detail-list {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 6px;
      max-height: 220px;
      overflow-y: auto;
    }

    .detail-list-item {
      padding: 6px 4px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .detail-list-item:last-child {
      border-bottom: none;
    }

    .detail-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 2px;
    }

    /* 标签云样式 */
    .tag-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      line-height: 1.5;
    }

    .tag-chip {
      padding: 6px 14px;
      border: 1px solid var(--vscode-input-border);
      border-radius: 3px;
      background: var(--vscode-input-background);
      color: var(--vscode-foreground);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      user-select: none;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .tag-chip:hover {
      border-color: var(--vscode-focusBorder);
      box-shadow: 0 0 0 1px var(--vscode-focusBorder);
    }

    .tag-chip.selected {
      background: var(--vscode-button-background);
      border-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      font-weight: 500;
    }

    .tag-chip.selected:hover {
      background: var(--vscode-button-hoverBackground);
      border-color: var(--vscode-button-hoverBackground);
    }

    .tag-chip.role {
      min-width: 80px;
      text-align: center;
    }

    .tag-chip.capability {
      min-width: 60px;
      text-align: center;
      font-size: 12px;
    }

    .tag-chip.tool {
      min-width: 90px;
      border-color: #f6a640;
      color: #8a4b01;
    }

    .tag-chip.tool.selected {
      background: #f6a640;
      border-color: #f6a640;
      color: #1a1a1a;
    }



    .card-footer-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 6px;
    }

    /* 面板分割线 */
    .panel-resizer {
      height: 4px;
      background-color: var(--vscode-panel-border);
      cursor: ns-resize;
      flex-shrink: 0;
      position: relative;
      order: 0;
    }

    .panel-resizer:hover {
      background-color: var(--vscode-focusBorder);
    }

    .panel-resizer.dragging {
      background-color: var(--vscode-focusBorder);
    }

    /* 隐藏折叠面板后面的分割线 */
    .panel.collapsed + .panel-resizer {
      display: none;
    }

    /* 输入区域调整手柄 */
    .input-resize-handle {
      height: 4px;
      background-color: var(--vscode-panel-border);
      cursor: ns-resize;
      flex-shrink: 0;
      position: relative;
    }

    .input-resize-handle:hover {
      background-color: var(--vscode-focusBorder);
    }

    .input-resize-handle.dragging {
      background-color: var(--vscode-focusBorder);
    }

    .message-input-area {
      padding: 8px;
      border-top: 1px solid var(--vscode-panel-border);
      min-height: 140px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: var(--vscode-editor-background);
      position: relative;
    }

    .mention-suggestion-list {
      position: absolute;
      bottom: 110px;
      right: 16px;
      width: 280px;
      background: var(--vscode-sideBar-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.45);
      max-height: 220px;
      overflow-y: auto;
      display: none;
      z-index: 25;
    }

    .mention-suggestion-header {
      font-size: 11px;
      padding: 6px 10px;
      color: var(--vscode-descriptionForeground);
      border-bottom: 1px solid var(--vscode-panel-border);
      background: rgba(255, 255, 255, 0.02);
    }

    .mention-suggestion-item {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 12px;
      background: transparent;
      color: var(--vscode-foreground);
      border: none;
      text-align: left;
    }

    .mention-suggestion-item strong {
      font-size: 12px;
      margin-bottom: 2px;
    }

    .mention-suggestion-item:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .mention-suggestion-role {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .message-textarea-wrapper {
      position: relative;
      min-height: 100px;
      max-height: 360px;
      height: 140px;
    }

    #message-input {
      width: 100%;
      height: 100%;
      padding: 6px 48px 6px 8px;
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border);
      border-radius: 2px;
      resize: none;
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      box-sizing: border-box;
    }

    /* Vote Card Styles */
    .vote-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      background-color: var(--vscode-editor-background);
    }

    .vote-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .vote-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
      flex: 1;
    }

    .vote-description {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .vote-progress-bar {
      height: 6px;
      background-color: var(--vscode-panel-border);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 4px;
    }

    .vote-progress-fill {
      height: 100%;
      background-color: var(--vscode-button-background);
      transition: width 0.3s;
    }

    .vote-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .vote-btn {
      flex: 1;
      padding: 6px 12px;
      font-size: 12px;
      border: 1px solid var(--vscode-button-border);
      background-color: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
      cursor: pointer;
      border-radius: 2px;
    }

    .vote-btn:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    .vote-btn-approve {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .vote-btn-approve:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    /* Approval Card Styles */
    .approval-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      background-color: var(--vscode-editor-background);
    }

    .approval-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .approval-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
      flex: 1;
    }

    .approval-description {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .approval-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .approval-btn {
      flex: 1;
      padding: 6px 12px;
      font-size: 12px;
      border: 1px solid var(--vscode-button-border);
      background-color: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
      cursor: pointer;
      border-radius: 2px;
    }

    .approval-btn:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    .approval-btn-approve {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .approval-btn-approve:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    /* Notification Card Styles */
    .notification-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background-color 0.15s;
    }

    .notification-card.unread {
      background-color: rgba(33, 150, 243, 0.1);
      border-color: rgba(33, 150, 243, 0.3);
    }

    .notification-card:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .notification-filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .notification-filter-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .notification-filter-btn {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 11px;
      background: transparent;
      color: var(--vscode-foreground);
      cursor: pointer;
    }

    .notification-filter-btn.active {
      background: var(--vscode-button-background);
      border-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .notification-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      cursor: pointer;
    }

    .notification-toggle input {
      margin: 0;
    }

    .tool-run-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .tool-run-filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }

    .tool-run-filter-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      padding: 2px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 11px;
    }

    .tool-run-filter-btn.active {
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .tool-run-list {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: var(--vscode-editorWidget-background);
      min-height: 160px;
    }

    .tool-run-card {
      border: 1px solid var(--vscode-panel-border);
      border-left: 4px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: var(--vscode-editor-background);
    }

    .tool-run-card.status-running {
      border-left-color: #4da3ff;
    }

    .tool-run-card.status-failed {
      border-left-color: #ff6b6b;
    }

    .tool-run-card.status-succeeded {
      border-left-color: #50c878;
    }

    .tool-run-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .tool-run-name {
      font-weight: 600;
      font-size: 13px;
    }

    .tool-run-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-left: 8px;
    }

    .tool-run-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tool-run-body {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 4px 12px;
    }

    .tool-run-log {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 6px;
      font-family: var(--vscode-editor-font-family, monospace);
      font-size: 11px;
      max-height: 160px;
      overflow: auto;
      background: rgba(255,255,255,0.02);
      display: none;
      white-space: pre-wrap;
    }

    .tool-run-log.visible {
      display: block;
    }

    .notification-header {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
    }

    .notification-unread-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #2196f3;
      flex-shrink: 0;
      margin-top: 4px;
    }

    .notification-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
      flex: 1;
    }

    .notification-message {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
      line-height: 1.4;
    }

    .notification-time {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    /* 主内容区 */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--vscode-editor-background);
      overflow: hidden;
    }

    .main-header {
      padding: 12px 16px;
      background-color: var(--vscode-editorGroupHeader-tabsBackground);
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .main-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    .workflow-instance-panel {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 12px;
        background-color: var(--vscode-editorWidget-background);
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .workflow-instance-panel-header {
      display: flex;
      justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .workflow-instance-panel-title {
        font-size: 15px;
        font-weight: 600;
      }

      .workflow-instance-panel-subtitle {
        font-size: 12px;
        color: var(--vscode-descriptionForeground);
        margin-top: 4px;
      }

      .workflow-instance-filters {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .workflow-instance-filter-btn {
        border: 1px solid var(--vscode-panel-border);
        background: transparent;
        color: var(--vscode-foreground);
        border-radius: 999px;
        font-size: 11px;
        padding: 4px 12px;
        cursor: pointer;
      }

    .workflow-instance-filter-btn.active {
      background: var(--vscode-button-background);
      border-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .workflow-instance-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .workflow-instance-stat-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.02);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .workflow-instance-stat-label {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .workflow-instance-stat-value {
      font-size: 18px;
      font-weight: 600;
    }

    .workflow-instance-scenarios {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .workflow-instance-scenario-chip {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 11px;
      background: transparent;
      color: var(--vscode-foreground);
      cursor: pointer;
    }

    .workflow-instance-scenario-chip.active {
      background: var(--vscode-button-background);
      border-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .workflow-instance-participants {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .workflow-instance-participant-chip {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 11px;
      background: transparent;
      color: var(--vscode-foreground);
      cursor: pointer;
    }

    .workflow-instance-participant-chip.active {
      background: var(--vscode-button-background);
      border-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

      .workflow-instance-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 10px;
      }

      .workflow-instance-card {
        border: 1px solid var(--vscode-panel-border);
        border-radius: 8px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.02);
        display: flex;
        flex-direction: column;
        gap: 6px;
        text-align: left;
        cursor: pointer;
        min-height: 100px;
        transition: border-color 0.2s, background-color 0.2s;
      }

      .workflow-instance-card.selected {
        border-color: var(--instance-color, #5c7cfa);
        background: rgba(92, 124, 250, 0.1);
      }

      .workflow-instance-card-head {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
      }

      .workflow-instance-card-title {
        font-size: 13px;
        font-weight: 600;
      }

      .workflow-instance-status {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid var(--vscode-panel-border);
      }

      .workflow-instance-status.running {
        border-color: #5c7cfa;
        color: #5c7cfa;
      }

      .workflow-instance-status.completed {
        border-color: #20c997;
        color: #20c997;
      }

      .workflow-instance-status.blocked {
        border-color: #ff922b;
        color: #ff922b;
      }

      .workflow-instance-status.failed {
        border-color: #f03e3e;
        color: #f03e3e;
      }

      .workflow-instance-card-meta {
        font-size: 11px;
        color: var(--vscode-descriptionForeground);
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

    .workflow-instance-card-meta span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .workflow-instance-progress {
      margin-top: 6px;
    }

    .workflow-instance-progress-bar {
      position: relative;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    .workflow-instance-progress-bar span {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      border-radius: 999px;
      background: var(--instance-color, #5c7cfa);
      transition: width 0.2s ease;
    }

    .workflow-instance-progress-meta {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    .workflow-instance-detail-panel {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 10px;
      padding: 12px 14px;
      background: rgba(255,255,255,0.02);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
    }

    .workflow-instance-detail-panel .detail-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 8px 10px;
      background: rgba(0,0,0,0.08);
    }

    .workflow-instance-detail-panel .detail-label {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .workflow-instance-detail-panel .detail-value {
      font-size: 13px;
      margin-top: 4px;
    }

    .workflow-detail-hint {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 2px;
    }

    .workflow-note-panel {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 10px;
      padding: 10px;
      margin-top: 10px;
      background: rgba(255,255,255,0.02);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .workflow-note-panel textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
      background: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border);
      color: var(--vscode-input-foreground);
      border-radius: 4px;
      padding: 6px 8px;
      font-size: 12px;
    }

    .workflow-note-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .workflow-note-actions button {
      padding: 6px 14px;
      border: none;
      border-radius: 4px;
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      cursor: pointer;
    }

      .workflow-stage-panel {
        border-bottom: 1px solid var(--vscode-panel-border);
        border-top: 1px solid var(--vscode-panel-border);
        padding: 12px 16px;
        display: flex;
      flex-direction: column;
      gap: 12px;
      background: linear-gradient(
        90deg,
        rgba(33, 150, 243, 0.08),
        rgba(156, 39, 176, 0.08)
      );
      border-radius: 0 0 12px 12px;
      box-shadow: inset 0 -1px 0 rgba(255, 255, 255, 0.04);
    }

    .workflow-instance-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 4px 0;
    }

    .workflow-instance-placeholder {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .workflow-instance-pill {
      border: 1px solid var(--instance-color, rgba(255,255,255,0.15));
      background: rgba(255, 255, 255, 0.02);
      color: var(--vscode-foreground);
      border-radius: 12px;
      padding: 6px 10px;
      min-width: 140px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
      cursor: pointer;
      transition: border-color 0.2s, background-color 0.2s, color 0.2s;
    }

    .workflow-instance-pill.active {
      background: var(--instance-color, rgba(92, 124, 250, 0.15));
      color: #0f1117;
      font-weight: 600;
    }

    .workflow-instance-pill .pill-title {
      font-size: 12px;
    }

    .workflow-instance-pill .pill-meta {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.7);
    }

    .workflow-instance-pill.active .pill-meta {
      color: rgba(15, 17, 23, 0.65);
    }

    .workflow-stage-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }

    .workflow-stage-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .workflow-stage-subtitle {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .workflow-stage-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .workflow-stage-meta-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    .workflow-template-pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.16);
      font-size: 11px;
      color: var(--vscode-foreground);
      max-width: 220px;
      text-overflow: ellipsis;
      white-space: nowrap;
      overflow: hidden;
    }

    .workflow-stage-timeline {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .workflow-stage-node {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 70px;
      padding: 6px;
      border-radius: 8px;
      border: 1px solid var(--vscode-panel-border);
      background-color: var(--vscode-sideBar-background);
      position: relative;
      flex: 1;
      transition: transform 0.15s ease, border-color 0.2s ease;
    }

    .workflow-stage-node:hover {
      transform: translateY(-2px);
      border-color: var(--vscode-button-background);
    }

    .workflow-stage-node::before {
      content: '';
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--vscode-panel-border);
      margin-bottom: 6px;
      background-color: var(--vscode-editor-background);
    }
    .workflow-stage-node-spotlight {
      position: absolute;
      top: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: var(--vscode-button-background);
      border: 2px solid var(--vscode-button-background);
      transition: transform 0.2s ease, background-color 0.2s ease;
    }

    .workflow-stage-node.status-completed::before {
      background-color: var(--vscode-testing-iconPassed, #4caf50);
      border-color: var(--vscode-testing-iconPassed, #4caf50);
    }

    .workflow-stage-node.status-active::before {
      background-color: var(--vscode-button-background);
      border-color: var(--vscode-button-background);
    }

    .workflow-stage-node.status-blocked::before {
      background-color: var(--vscode-editorWarning-foreground, #f1c21b);
      border-color: var(--vscode-editorWarning-foreground, #f1c21b);
    }

    .workflow-stage-node.status-active {
      border-color: var(--vscode-button-background);
    }

    .workflow-stage-node.status-blocked {
      border-color: var(--vscode-editorWarning-foreground, #f1c21b);
    }

    .workflow-stage-node-label {
      font-size: 12px;
      font-weight: 600;
    }

    .workflow-stage-node-meta {
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
      text-align: center;
      min-height: 14px;
    }

    .workflow-stage-detail {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      max-height: 360px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .workflow-stage-detail-card {
      flex: 1;
      min-width: 200px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 10px;
      padding: 12px 14px;
      background-color: rgba(0, 0, 0, 0.25);
      backdrop-filter: blur(4px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }

    .workflow-stage-detail-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .workflow-stage-detail-desc {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
    }

    .workflow-stage-detail-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      line-height: 1.6;
    }

    .workflow-todo-panel {
      padding: 12px 16px;
      border-bottom: 1px solid var(--vscode-panel-border);
      display: flex;
      gap: 16px;
      background-color: var(--vscode-editor-background);
      flex-wrap: wrap;
    }

    .workflow-todo-column {
      flex: 1;
      min-width: 260px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .workflow-todo-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      font-weight: 600;
    }

    .workflow-todo-list,
    .workflow-proof-list {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 8px;
      min-height: 80px;
      background-color: var(--vscode-editorWidget-background);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .workflow-todo-card,
    .workflow-proof-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 10px 12px;
      background-color: var(--vscode-editor-background);
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .workflow-proof-card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .workflow-proof-entry-list {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .workflow-proof-entry {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px 10px;
      background: rgba(255,255,255,0.02);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .workflow-proof-entry-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .workflow-proof-pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 1px 6px;
      font-size: 10px;
      font-weight: 600;
    }

    .workflow-proof-pill.type-work {
      background: rgba(64, 160, 255, 0.15);
      color: #4da3ff;
    }

    .workflow-proof-pill.type-agreement {
      background: rgba(255, 153, 0, 0.15);
      color: #ffad33;
    }

    .workflow-proof-pill.status-pending {
      background: rgba(255, 193, 7, 0.2);
      color: #cc8a00;
    }

    .workflow-proof-pill.status-approved {
      background: rgba(76, 175, 80, 0.2);
      color: #3a9d40;
    }

    .workflow-proof-pill.status-rejected {
      background: rgba(244, 67, 54, 0.2);
      color: #d6453c;
    }

    .workflow-proof-entry-body {
      font-size: 12px;
      color: var(--vscode-foreground);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .workflow-proof-entry-title {
      font-weight: 600;
      font-size: 12px;
    }

    .workflow-proof-entry-meta-line {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .workflow-proof-entry-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .workflow-proof-entry-actions .proof-action {
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      background: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
    }

    .workflow-proof-entry-actions .proof-action.ghost {
      background: transparent;
      color: var(--vscode-descriptionForeground);
      border: 1px solid var(--vscode-panel-border);
    }

    .workflow-proof-more {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      padding-left: 2px;
    }

    .workflow-proof-header-meta {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .workflow-proof-header-actions {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .workflow-proof-export {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      border-radius: 4px;
      padding: 2px 8px;
      font-size: 11px;
      cursor: pointer;
    }

    .workflow-proof-export:hover {
      background: var(--vscode-button-secondaryHoverBackground);
    }

    .workflow-todo-card.severity-warning {
      border-color: var(--vscode-editorWarning-foreground, #f1c21b);
    }

    .workflow-todo-card.severity-critical {
      border-color: var(--vscode-editorError-foreground, #e53935);
    }

    .workflow-todo-badge {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .workflow-todo-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .workflow-todo-action {
      border: 1px solid var(--vscode-panel-border);
      background: none;
      font-size: 10px;
      padding: 2px 6px;
      cursor: pointer;
      border-radius: 4px;
      color: var(--vscode-textLink-foreground);
    }

    /* 按钮样式 */
    button {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 2px;
      font-size: 13px;
    }

    button:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 36px;
      height: 20px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border);
      transition: .3s;
      border-radius: 20px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 2px;
      bottom: 2px;
      background-color: var(--vscode-foreground);
      transition: .3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked + .toggle-slider {
      background-color: var(--vscode-button-background);
      border-color: var(--vscode-button-background);
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(16px);
      background-color: var(--vscode-button-foreground);
    }
  </style>
</head>
<body>
  <div id="agent-empty-overlay" class="agent-empty-overlay hidden">
    <div class="agent-empty-card">
      <div class="agent-empty-title">尚未配置任何 Agent</div>
      <div class="agent-empty-desc">请先在左侧“Agent 管理”中添加至少一个 Agent，从而开始需求认领与任务执行。</div>
      <div class="agent-empty-actions">
        <button id="agent-empty-add-btn" class="agent-empty-button primary">立即添加 Agent</button>
        <button id="agent-empty-refresh-btn" class="agent-empty-button secondary">已配置？刷新列表</button>
      </div>
    </div>
  </div>
  <div class="container">
    <!-- 左侧边栏 -->
    <div class="sidebar left" id="left-sidebar">
      <button class="collapse-btn" data-action="toggleLeftSidebar">◀</button>
      <div class="sidebar-content">
        <!-- Agents 面板 -->
        <div class="panel" id="panel-agents" style="flex: 1;">
          <div class="panel-header" data-action="togglePanel" data-panel="panel-agents">
            <span class="panel-title">
              <span class="panel-title-text">Agent 状态</span>
              <span class="panel-title-badge" id="agent-stats"></span>
            </span>
            <div class="panel-actions">
              <button class="panel-collapse-btn" data-action="togglePanel" data-panel="panel-agents">▼</button>
            </div>
          </div>
          <div class="panel-body" id="agents-list">
            <div class="panel-inline-hint">
              提示：Agent 配置入口已迁至「全局配置」页签。
              <button class="panel-link-button" data-action="openGlobalAgentTab">前往管理</button>
            </div>
            <div class="empty-state">暂无 Agent 数据</div>
          </div>
        </div>

        <!-- 分割线 -->
        <div class="panel-resizer" data-target="panel-agents"></div>

        <!-- Tasks 面板 -->
        <div class="panel" id="panel-tasks" style="flex: 1;">
          <div class="panel-header" data-action="togglePanel" data-panel="panel-tasks">
            <span class="panel-title">
              <span class="panel-title-text">任务列表</span>
              <span class="panel-title-badge" id="task-stats"></span>
            </span>
            <div class="panel-actions">
              <button class="panel-collapse-btn" data-action="togglePanel" data-panel="panel-tasks">▼</button>
            </div>
          </div>
          <div class="panel-body" id="tasks-list">
            <div class="empty-state">暂无任务数据</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
      <!-- Main Tab Navigation -->
      <div class="main-tab-nav">
        <div class="main-tab-buttons">
          <button class="main-tab-button active" data-main-tab="blackboard" onclick="switchMainTab('blackboard', event)">黑板系统</button>
          <button class="main-tab-button" data-main-tab="workspace" onclick="switchMainTab('workspace', event)">Agent工作台</button>
          <button class="main-tab-button" data-main-tab="global" onclick="switchMainTab('global', event)">全局配置</button>
        </div>
        <div class="session-tab-controls">
          <span>当前会话</span>
          <select id="session-select" class="session-select" disabled>
            <option value="">加载中...</option>
          </select>
          <span id="blackboard-current-session" class="session-current-label">--</span>
          <span id="blackboard-session-scenario" class="session-scenario-label">场景：--</span>
          <button class="session-action-btn" data-action="openCreateSessionModal" title="新建会话">＋</button>
          <button class="session-action-btn danger" data-action="openDeleteSessionModal" title="删除当前会话">🗑</button>
        </div>
      </div>

      <div class="main-body">
        <!-- Tab 1: Blackboard System -->
        <div id="main-tab-blackboard" class="main-tab-content active">
          <!-- Sub Tab Navigation -->
          <div class="sub-tab-nav">
            <button class="sub-tab-button active" onclick="switchBlackboardView('discussion')">协作对话</button>
            <button class="sub-tab-button" onclick="switchBlackboardView('workflow')">流程概览</button>
            <button class="sub-tab-button" onclick="switchBlackboardView('governance')">治理历史</button>
            <button class="sub-tab-button" onclick="switchBlackboardView('governance-analytics')">治理分析</button>
            <button class="sub-tab-button" onclick="switchBlackboardView('notifications')">通知中心</button>
            <button class="sub-tab-button" onclick="switchBlackboardView('tools')">工具执行</button>
          </div>

          <!-- Discussion View -->
          <div id="blackboard-discussion" class="sub-tab-content active">
            <!-- Message Search -->
            <div style="padding: 8px; border-bottom: 1px solid var(--vscode-panel-border); flex-shrink: 0;">
              <input type="text" id="message-search" placeholder="🔍 搜索消息..." style="width: 100%; padding: 4px 8px; background: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 2px; font-size: 12px;">
            </div>

            <!-- Messages List Container (scrollable) -->
            <div style="flex: 1; position: relative; min-height: 0;">
              <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow-y: auto; padding: 8px;" id="messages-list">
                <div class="empty-state">暂无消息</div>
              </div>

              <!-- New Message Indicator Button (outside messages content) -->
              <button id="new-message-indicator"
                      style="display: none; position: absolute; bottom: 20px; right: 20px;
                             z-index: 100; padding: 8px 16px; border-radius: 20px;
                             background: var(--vscode-button-background);
                             color: var(--vscode-button-foreground);
                             border: none; cursor: pointer;
                             box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                             font-size: 12px;
                             transition: opacity 0.2s;"
                      onclick="scrollToBottomAndHide()">
                有新消息 ↓
              </button>
            </div>

            <!-- Message Input Area (fixed at bottom) -->
            <div id="message-input-area" class="message-input-area">
              <div class="message-template-row" id="message-template-row"></div>
              <div id="mention-suggestions" class="mention-suggestion-list"></div>
              <!-- Reply/Quote Indicator -->
              <div id="reply-indicator"></div>
              <!-- Input Area Resize Handle -->
              <div class="input-resize-handle" id="input-resize-handle"></div>
              <!-- Text Input -->
              <div class="message-textarea-wrapper" id="message-textarea-wrapper">
                <textarea id="message-input" placeholder="输入消息... (Enter 发送, Shift+Enter 换行)"></textarea>
                <button onclick="sendMessage()" style="position: absolute; bottom: 8px; right: 8px; padding: 6px; width: 32px; height: 32px; background: var(--vscode-button-background); color: var(--vscode-button-foreground); border: none; border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                  <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                    <path d="M1 2L15 8L1 14V9L11 8L1 7V2Z"/>
                  </svg>
                </button>
              </div>
              <!-- Hint Text -->
              <div style="display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--vscode-descriptionForeground); padding-top: 4px;">
                <span class="badge badge-info" style="font-size: 10px;">提示</span>
                <span>你可以随时参与对话，提问、给建议、做决策</span>
              </div>
            </div>
          </div>

          <!-- Workflow Overview -->
          <div id="blackboard-workflow" class="sub-tab-content">
            <div class="workflow-instance-panel">
              <div class="workflow-instance-panel-header">
                <div>
                  <div class="workflow-instance-panel-title">流程实例</div>
                  <div class="workflow-instance-panel-subtitle" id="workflow-instance-summary">等待选择会话</div>
                </div>
                <div class="workflow-instance-filters" id="workflow-instance-filters">
                  <button class="workflow-instance-filter-btn active" data-filter="all" onclick="setWorkflowInstanceFilter('all')">全部</button>
                  <button class="workflow-instance-filter-btn" data-filter="running" onclick="setWorkflowInstanceFilter('running')">进行中</button>
                  <button class="workflow-instance-filter-btn" data-filter="completed" onclick="setWorkflowInstanceFilter('completed')">已完成</button>
                  <button class="workflow-instance-filter-btn" data-filter="blocked" onclick="setWorkflowInstanceFilter('blocked')">阻塞/失败</button>
                </div>
              </div>
              <div class="workflow-instance-stats" id="workflow-instance-stats"></div>
              <div class="workflow-instance-scenarios" id="workflow-instance-scenario-filter"></div>
              <div class="workflow-instance-participants" id="workflow-instance-participant-filter"></div>
              <div class="workflow-instance-list" id="workflow-instance-list">
                <div class="workflow-instance-placeholder">请选择会话以加载实例列表</div>
              </div>
            </div>
            <div class="workflow-stage-panel" id="workflow-stage-panel">
              <div class="workflow-stage-header">
                <div>
                  <div class="workflow-stage-title">流程阶段概览</div>
                  <div class="workflow-stage-subtitle" id="workflow-stage-subtitle">等待选择会话</div>
                </div>
                <div class="workflow-stage-meta-group">
                  <div class="workflow-template-pill" id="workflow-template-pill">模板：加载中</div>
                  <div class="workflow-stage-meta" id="workflow-stage-meta"></div>
                </div>
              </div>
              <div class="workflow-instance-selector" id="workflow-instance-selector"></div>
              <div class="workflow-stage-timeline" id="workflow-stage-timeline">
                <div class="empty-state">暂无流程实例</div>
              </div>
              <div class="workflow-stage-detail" id="workflow-stage-detail"></div>
            </div>

            <div class="workflow-todo-panel" id="workflow-todo-panel">
              <div class="workflow-todo-column">
                <div class="workflow-todo-header">
                  <span>阶段待办</span>
                  <span id="workflow-todo-count" class="workflow-todo-badge"></span>
                </div>
                <div class="workflow-todo-list" id="workflow-todo-list">
                  <div class="empty-state">暂无待办</div>
                </div>
              </div>
              <div class="workflow-todo-column">
                <div class="workflow-todo-header">
                  <div class="workflow-proof-header-meta">
                    <span>证据 / 缺陷</span>
                    <span id="workflow-proof-count" class="workflow-todo-badge"></span>
                  </div>
                  <div class="workflow-proof-header-actions">
                    <button class="workflow-proof-export" onclick="exportProofReport()">导出报告</button>
                  </div>
                </div>
                <div class="workflow-proof-list" id="workflow-proof-list">
                  <div class="empty-state">暂无证据数据</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Governance Overview -->
          <div id="blackboard-governance" class="sub-tab-content">
            <div class="panel" style="flex: 1;">
              <div class="panel-header">
                <span class="panel-title">
                  <span class="panel-title-text">治理概览</span>
                  <span class="panel-title-badge" id="governance-history-stats"></span>
                </span>
                <div class="panel-actions">
                  <button class="panel-action-btn" data-action="refreshGovernanceHistory" title="刷新历史">⟳</button>
                </div>
              </div>
              <div class="panel-body governance-history-body">
                <div class="inline-governance-summary">
                  <div class="summary-tile" id="board-summary-votes">
                    <div class="summary-tile-title">待投票</div>
                    <div class="summary-tile-value" id="board-summary-votes-value">0</div>
                    <div class="summary-tile-meta" id="board-summary-votes-meta">无超时风险</div>
                  </div>
                  <div class="summary-tile" id="board-summary-approvals">
                    <div class="summary-tile-title">待审批</div>
                    <div class="summary-tile-value" id="board-summary-approvals-value">0</div>
                    <div class="summary-tile-meta" id="board-summary-approvals-meta">暂无审批压力</div>
                  </div>
                  <div class="summary-tile" id="board-summary-notifications">
                    <div class="summary-tile-title">未读通知</div>
                    <div class="summary-tile-value" id="board-summary-notifications-value">0</div>
                    <div class="summary-tile-meta" id="board-summary-notifications-meta">全部已读</div>
                  </div>
                </div>
                <div class="governance-alert inline" id="gov-alert-board"></div>
                <div class="quick-actions">
                  <button class="quick-action-btn" data-action="openCreateVoteModal" title="征询 Agent 意见">征询 Agent 意见</button>
                  <button class="quick-action-btn" data-action="openMcpAddModal">添加 MCP Server</button>
                </div>
                <div class="governance-history-filters">
                  <select id="history-type-filter">
                    <option value="all">全部类型</option>
                    <option value="vote">投票</option>
                    <option value="approval">审批</option>
                    <option value="task">任务</option>
                  </select>
                  <select id="history-action-filter">
                    <option value="all">全部动作</option>
                  </select>
                  <input type="text" id="history-entity-filter" placeholder="关联 ID / 任务 / 主题">
                  <input type="text" id="history-search-filter" placeholder="关键词（摘要/备注）">
                  <button class="quick-action-btn" data-action="applyGovernanceHistoryFilters">筛选</button>
                  <button class="quick-action-btn" data-action="resetGovernanceHistoryFilters">重置</button>
                </div>
                <div class="governance-history-list" id="governance-history-list">
                  <div class="empty-state">暂无治理历史</div>
                </div>
                <div class="governance-history-pagination">
                  <button class="quick-action-btn" data-action="governanceHistoryPrev">上一页</button>
                  <span class="history-page-indicator" id="governance-history-page-indicator">第 1 页</span>
                  <button class="quick-action-btn" data-action="governanceHistoryNext">下一页</button>
                </div>
              </div>
            </div>
          </div>
          <!-- Governance Analytics View -->
          <div id="blackboard-governance-analytics" class="sub-tab-content">
            <div class="panel" style="flex: 1;">
              <div class="panel-header">
                <span class="panel-title">
                  <span class="panel-title-text">治理分析</span>
                  <span class="panel-title-badge" id="governance-analytics-updated"></span>
                </span>
                <div class="panel-actions">
                  <button class="panel-action-btn" data-action="refreshGovernanceAnalytics" title="刷新分析">⟳</button>
                </div>
              </div>
              <div class="panel-body">
                <div class="analytics-filter-bar">
                  <div class="analytics-filter-group">
                    <span>时间范围</span>
                    <select id="governance-analytics-range" class="analytics-range-select">
                      <option value="7d">近 7 天</option>
                      <option value="30d">近 30 天</option>
                      <option value="90d">近 90 天</option>
                      <option value="all">全部数据</option>
                    </select>
                  </div>
                  <div class="analytics-filter-group">
                    <span>分析对象</span>
                    <div class="analytics-type-toggle">
                      <button class="analytics-type-btn active" data-action="setGovernanceAnalyticsType" data-analytics-type="all">全部</button>
                      <button class="analytics-type-btn" data-action="setGovernanceAnalyticsType" data-analytics-type="vote">投票</button>
                      <button class="analytics-type-btn" data-action="setGovernanceAnalyticsType" data-analytics-type="approval">审批</button>
                    </div>
                  </div>
                  <button class="quick-action-btn" data-action="refreshGovernanceAnalytics">刷新</button>
                </div>
                <div class="analytics-status" id="governance-analytics-status">等待加载</div>
                <div class="analytics-summary-grid">
                  <div class="analytics-summary-card" id="analytics-vote-summary">
                    <div class="empty-state">暂无投票数据</div>
                  </div>
                  <div class="analytics-summary-card" id="analytics-approval-summary">
                    <div class="empty-state">暂无审批数据</div>
                  </div>
                </div>
                <div class="analytics-section">
                  <div class="analytics-panel">
                    <div class="analytics-panel-header">趋势（最近 10 段）</div>
                    <div class="analytics-timeline" id="governance-analytics-timeline">
                      <div class="empty-state">暂无趋势数据</div>
                    </div>
                  </div>
                  <div class="analytics-panel">
                    <div class="analytics-panel-header">治理热点任务</div>
                    <div class="analytics-hotspot-list" id="governance-analytics-hotspots">
                      <div class="empty-state">暂无热点任务</div>
                    </div>
                  </div>
                </div>
                <div class="analytics-panel">
                  <div class="analytics-panel-header">最新治理动作</div>
                  <div class="analytics-recent-list" id="governance-analytics-recent">
                    <div class="empty-state">暂无治理动作</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Notifications View -->
          <div id="blackboard-notifications" class="sub-tab-content">
            <div class="panel" style="flex: 1;">
              <div class="panel-header">
                <span class="panel-title">
                  <span class="panel-title-text">通知中心</span>
                  <span class="panel-title-badge" id="notification-stats"></span>
                </span>
              </div>
              <div class="panel-body">
                <div class="notification-filter-bar">
                  <div class="notification-filter-group" id="notification-level-filters">
                    <button class="notification-filter-btn" data-level="info" onclick="toggleNotificationLevel('info')">信息</button>
                    <button class="notification-filter-btn" data-level="success" onclick="toggleNotificationLevel('success')">成功</button>
                    <button class="notification-filter-btn active" data-level="warning" onclick="toggleNotificationLevel('warning')">警告</button>
                    <button class="notification-filter-btn active" data-level="error" onclick="toggleNotificationLevel('error')">错误</button>
                  </div>
                  <label class="notification-toggle" onclick="toggleNotificationUnread()">
                    <input type="checkbox" id="notification-unread-toggle" checked />
                    <span>仅未读</span>
                  </label>
                </div>
                <div id="notifications-list">
                  <div class="empty-state">暂无通知</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tool Runs View -->
          <div id="blackboard-tools" class="sub-tab-content">
            <div class="panel" style="flex: 1;">
              <div class="panel-header">
                <span class="panel-title">
                  <span class="panel-title-text">工具执行日志</span>
                  <span class="panel-title-badge" id="tool-run-stats"></span>
                </span>
                <div class="panel-actions">
                  <button class="panel-action-btn" data-action="refreshToolRuns" title="刷新" onclick="requestToolRunsSnapshot()">⟳</button>
                </div>
              </div>
              <div class="panel-body">
                <div class="tool-run-panel">
                  <div class="tool-run-filters">
                    <button class="tool-run-filter-btn active" data-status="all" onclick="setToolRunStatusFilter('all')">全部</button>
                    <button class="tool-run-filter-btn" data-status="running" onclick="setToolRunStatusFilter('running')">执行中</button>
                    <button class="tool-run-filter-btn" data-status="succeeded" onclick="setToolRunStatusFilter('succeeded')">成功</button>
                    <button class="tool-run-filter-btn" data-status="failed" onclick="setToolRunStatusFilter('failed')">失败</button>
                  </div>
                  <div class="tool-run-list" id="tool-run-list">
                    <div class="empty-state">暂无工具执行记录</div>
                  </div>
                </div>
              </div>
            </div>
          </div>


        </div>

        <!-- Tab 2: Agent Workspace -->
        <div id="main-tab-workspace" class="main-tab-content">
          <div class="workspace-container">
            <div id="workspace-empty" class="workspace-empty">
              <div>请选择一个 Agent 查看工作台</div>
              <div style="margin-top: 6px; font-size: 12px;">选中左侧 Agent 卡片后，将在此展示任务概览与思考过程</div>
            </div>
            <div id="workspace-panel" class="workspace-panel hidden">
              <div class="workspace-header">
                <div class="workspace-agent-meta">
                  <div class="workspace-agent-name" id="workspace-agent-name">Agent</div>
                  <div class="workspace-agent-subtitle" id="workspace-agent-meta">角色、能力与状态</div>
                </div>
                <div class="workspace-header-actions">
                  <button data-action="refreshWorkspace">刷新</button>
                </div>
              </div>
              <div class="workspace-tab-nav">
                <button class="workspace-tab-button active" data-action="switchWorkspaceTab" data-workspace-tab="overview">概览</button>
                <button class="workspace-tab-button" data-action="switchWorkspaceTab" data-workspace-tab="thinking">思考过程</button>
              </div>
              <div class="workspace-tab-content" id="workspace-overview">
                <div class="workspace-section">
                  <div class="workspace-section-header">任务概览</div>
                  <div class="workspace-section-body">
                    <div class="empty-state">后续步骤将注入任务数据。</div>
                  </div>
                </div>
              </div>
              <div class="workspace-tab-content" id="workspace-thinking" style="display: none;">
                <div class="workspace-section">
                  <div class="workspace-section-header">思考过程</div>
                  <div class="workspace-section-body">
                    <div class="empty-state">后续步骤将展示思考轨迹。</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab 3: Global Configuration -->
        <div id="main-tab-global" class="main-tab-content">
          <div class="global-config-panel">
            <div class="global-config-tabs">
              <button class="global-config-tab active" data-global-tab="agents" onclick="switchGlobalConfigTab('agents')">Agent 管理</button>
              <button class="global-config-tab" data-global-tab="mcp" onclick="switchGlobalConfigTab('mcp')">MCP 配置</button>
              <button class="global-config-tab" data-global-tab="integration" onclick="switchGlobalConfigTab('integration')">外部集成</button>
            </div>
            <div class="global-config-body">
              <div id="global-tab-agents" class="global-tab-content active">
                <div class="global-section">
                  <div class="global-section-header">
                    <div>
                      <div class="global-section-title">Agent 管理</div>
                      <div class="global-section-desc">统一维护 Agent LLM 配置与能力标签，跨项目共享</div>
                    </div>
                    <div class="global-section-actions">
                      <button class="quick-action-btn" type="button" data-action="addAgent" onclick="addAgent()">＋ 新增 Agent</button>
                    </div>
                  </div>
                  <div class="global-section-body">
                    <div class="panel-inline-hint">提示：此处展示的是全局 Agent 配置，所有项目共用。</div>
                    <div class="global-agent-list" id="global-agent-list">
                      <div class="empty-state">暂无 Agent 数据</div>
                    </div>
                  </div>
                </div>
              </div>
              <div id="global-tab-mcp" class="global-tab-content">
                <section class="global-section">
                  <div class="global-section-header">
                    <div>
                      <div class="global-section-title">MCP 配置</div>
                      <div class="global-section-desc">统一维护标准 MCP Server，启用后自动参与所有 Agent 调用</div>
                    </div>
                    <div class="global-section-actions">
                      <button class="quick-action-btn" data-action="openMcpAddModal">＋ 添加 MCP Server</button>
                    </div>
                  </div>
                  <div class="global-section-body">
                    <div class="global-info-banner">
                      <strong>ACE / MCP 即将启用：</strong>系统已预置 ACE、thinking、context7 占位配置，等待后续版本接入真实服务。目前可在此查看状态，无需手动添加。
                    </div>
                    <div class="panel" style="flex: 1;">
                      <div class="panel-header">
                        <span class="panel-title">
                          <span class="panel-title-text">MCP 服务列表</span>
                          <span class="panel-title-badge" id="mcp-server-stats"></span>
                        </span>
                      </div>
                      <div class="panel-body" style="display: flex; flex-direction: column;">
                        <div class="mcp-server-list" id="mcp-server-list">
                          <div class="empty-state">
                            暂无 MCP Server 配置
                            <div class="mcp-empty-cta">
                              <button class="mcp-btn" data-action="openMcpAddModal">立即配置</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
              <div id="global-tab-integration" class="global-tab-content">
                <section class="global-section">
                  <div class="global-section-header">
                    <div>
                      <div class="global-section-title">外部集成</div>
                      <div class="global-section-desc">按需为 workflow/sentinel/proof 事件配置 Webhook，同步外部系统</div>
                    </div>
                  </div>
                  <div class="global-section-body">
                    <div class="global-info-banner">
                      <strong>按需启用：</strong>IntegrationBridge 默认处于待命状态，只有在配置 `.arranger/integrations.json` 后才会启动并推送事件，可随时热加载。
                    </div>
                    <div class="panel" style="flex: 1;">
                      <div class="panel-header">
                        <span class="panel-title">
                          <span class="panel-title-text">Webhook 配置</span>
                        </span>
                      </div>
                      <div class="panel-body">
                        <div class="panel-inline-hint">
                          配置文件位于 <code>.arranger/integrations.json</code>，支持 <code>workflow_event</code> / <code>sentinel_event</code> / <code>proof_attested</code> 三类事件，保存后立即生效。
                        </div>
                        <div class="panel-inline-hint" id="integration-template-hint"></div>
                        <div class="empty-state">
                          通过下方按钮快速打开配置文件，新增或编辑 Webhook。
                          <div class="mcp-empty-cta" style="margin-top: 8px;">
                            <button class="mcp-btn" data-action="openIntegrationConfig">打开配置文件</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 右侧边栏 -->
    <div class="sidebar right" id="right-sidebar">
      <button class="collapse-btn" data-action="toggleRightSidebar">▶</button>
      <div class="sidebar-content">
        <div class="governance-summary">
          <div class="gov-summary-grid">
            <div class="summary-tile" id="gov-summary-pending-votes" title="当前会话的投票待办">
              <div class="summary-tile-title">待投票</div>
              <div class="summary-tile-value">0</div>
              <div class="summary-tile-meta">0 条即将超时</div>
            </div>
            <div class="summary-tile" data-action="showApprovalsPanel" id="gov-summary-pending-approvals" title="查看审批列表">
              <div class="summary-tile-title">待审批</div>
              <div class="summary-tile-value">0</div>
              <div class="summary-tile-meta">实时同步</div>
            </div>
            <div class="summary-tile" id="gov-summary-task-health" title="任务运行状态">
              <div class="summary-tile-title">任务状态</div>
              <div class="summary-tile-value">--</div>
              <div class="summary-tile-meta">等待更新</div>
            </div>
          </div>
          <div class="gov-polling-card" id="gov-summary-polling">
            <div class="gov-polling-title">治理轮询</div>
            <div class="polling-meta-item">
              <span class="polling-meta-label">上次更新</span>
              <span class="polling-meta-value" id="gov-summary-polling-updated">尚未同步</span>
            </div>
            <div class="polling-meta-item">
              <span class="polling-meta-label">状态</span>
              <span class="polling-meta-value" id="gov-summary-polling-status">尚未开始</span>
            </div>
          </div>
        </div>
        <div class="governance-alert" id="gov-alert"></div>
        <!-- 投票中心面板 -->
        <div class="panel" id="panel-votes" style="flex: 1;">
          <div class="panel-header" data-action="togglePanel" data-panel="panel-votes">
            <span class="panel-title">
              <span class="panel-title-text">投票中心</span>
              <span class="panel-title-badge" id="vote-stats"></span>
            </span>
            <div class="panel-actions">
              <button class="panel-action-btn" data-action="openCreateVoteModal" title="发起投票">＋</button>
              <button class="panel-collapse-btn" data-action="togglePanel" data-panel="panel-votes">▼</button>
            </div>
          </div>
          <div class="panel-body" id="votes-list">
            <div class="empty-state">暂无投票数据</div>
          </div>
        </div>

        <!-- 分割线 -->
        <div class="panel-resizer" data-target="panel-votes"></div>

        <!-- 审批列表面板 -->
        <div class="panel collapsed" id="panel-approvals" style="flex: 1;">
          <div class="panel-header" data-action="togglePanel" data-panel="panel-approvals">
            <span class="panel-title">
              <span class="panel-title-text">审批列表</span>
              <span class="panel-title-badge" id="approval-stats"></span>
            </span>
            <div class="panel-actions">
              <button class="panel-collapse-btn" data-action="togglePanel" data-panel="panel-approvals">▶</button>
            </div>
          </div>
          <div class="panel-body" id="approvals-list">
            <div class="empty-state">暂无审批数据</div>
          </div>
        </div>

        <!-- 分割线 -->
        <div class="panel-resizer" data-target="panel-approvals"></div>

        <!-- 调度与巡检事件 -->
        <div class="panel" id="panel-orchestration-events" style="flex: 1;">
          <div class="panel-header" data-action="togglePanel" data-panel="panel-orchestration-events">
            <span class="panel-title">
              <span class="panel-title-text">调度 & 巡检事件</span>
              <span class="panel-title-badge" id="orchestration-event-count"></span>
            </span>
            <div class="panel-actions">
              <button class="panel-action-btn" data-action="clearOrchestrationEvents" title="清空事件">🧹</button>
              <button class="panel-collapse-btn" data-action="togglePanel" data-panel="panel-orchestration-events">▼</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="orchestration-summary" id="orchestration-summary"></div>
            <div class="orchestration-filter-group" id="orchestration-filter-group">
              <button class="orchestration-filter-btn active" data-filter="scheduler" onclick="toggleOrchestrationFilter('scheduler')">调度</button>
              <button class="orchestration-filter-btn active" data-filter="sentinel" onclick="toggleOrchestrationFilter('sentinel')">巡检</button>
              <button class="orchestration-filter-btn active" data-filter="system" onclick="toggleOrchestrationFilter('system')">系统</button>
            </div>
            <div class="orchestration-event-list" id="orchestration-event-list">
              <div class="empty-state">暂无调度/巡检事件</div>
            </div>
          </div>
        </div>

        <!-- 分割线 -->
        <div class="panel-resizer" data-target="panel-orchestration-events"></div>

        <!-- 文件变更面板 -->
        <div class="panel collapsed" id="panel-file-changes" style="flex: 1;">
          <div class="panel-header" data-action="togglePanel" data-panel="panel-file-changes">
            <span class="panel-title">
              <span class="panel-title-text">文件变更</span>
              <span class="panel-title-badge" id="file-change-stats"></span>
            </span>
            <div class="panel-actions">
              <button class="panel-collapse-btn" data-action="togglePanel" data-panel="panel-file-changes">▶</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="file-change-filters">
              <button class="file-change-filter-btn active" data-action="setFileChangeFilter" data-filter="all">全部</button>
              <button class="file-change-filter-btn" data-action="setFileChangeFilter" data-filter="create">新增</button>
              <button class="file-change-filter-btn" data-action="setFileChangeFilter" data-filter="modify">修改</button>
              <button class="file-change-filter-btn" data-action="setFileChangeFilter" data-filter="delete">删除</button>
              <input type="text" class="file-change-filter-input" id="file-change-task-filter" placeholder="任务 ID" />
              <input type="text" class="file-change-filter-input" id="file-change-agent-filter" placeholder="Agent ID" />
            </div>
            <div class="file-change-view-toggle">
              <span>视图</span>
              <button class="file-change-view-btn active" data-action="setFileChangeView" data-view="timeline">按时间</button>
              <button class="file-change-view-btn" data-action="setFileChangeView" data-view="task">按任务</button>
            </div>
            <div class="file-change-list" id="file-changes-list">
              <div class="empty-state">暂无文件变更记录</div>
            </div>
          </div>
        </div>

        <!-- 分割线 -->
        <div class="panel-resizer" data-target="panel-file-changes"></div>

        <!-- 锁监控面板 -->
        <div class="panel collapsed" id="panel-locks" style="flex: 0.8;">
          <div class="panel-header" data-action="togglePanel" data-panel="panel-locks">
            <span class="panel-title">
              <span class="panel-title-text">并发锁监控</span>
              <span class="panel-title-badge" id="lock-stats"></span>
            </span>
            <div class="panel-actions">
              <button class="panel-action-btn" data-action="refreshLocks" title="刷新锁列表">⟳</button>
              <button class="panel-action-btn" data-action="cleanupLocks" title="清理过期锁">🧹</button>
              <button class="panel-collapse-btn" data-action="togglePanel" data-panel="panel-locks">▶</button>
            </div>
          </div>
          <div class="panel-body" id="lock-list">
            <div class="empty-state">暂无活跃锁</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- 模态弹窗：添加 Agent -->
  <div class="modal-overlay" id="modal-add-agent">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">添加 Agent</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <form id="form-add-agent">
          <div class="form-group">
            <label class="form-label required">Agent ID</label>
            <input type="text" class="form-input" id="agent-id" name="id" required placeholder="例如：agent-developer-1">
            <div class="form-hint">唯一标识符，建议使用英文和数字</div>
          </div>
          <div class="form-group">
            <label class="form-label required">显示名称</label>
            <input type="text" class="form-input" id="agent-display-name" name="display_name" required placeholder="例如：开发助手">
          </div>
          <div class="form-group">
            <label class="form-label required">角色（点击选择，可多选）</label>
            <div class="tag-cloud" id="agent-roles-cloud">
              <button type="button" class="tag-chip role" data-role="developer">开发者</button>
              <button type="button" class="tag-chip role" data-role="tester">测试者</button>
              <button type="button" class="tag-chip role" data-role="reviewer">审查者</button>
              <button type="button" class="tag-chip role" data-role="architect">架构师</button>
              <button type="button" class="tag-chip role" data-role="documenter">文档专家</button>
              <button type="button" class="tag-chip role" data-role="devops">DevOps</button>
              <button type="button" class="tag-chip role" data-role="security">安全专家</button>
              <button type="button" class="tag-chip role" data-role="coordinator">协调者</button>
            </div>
            <div class="form-hint">至少选择一个角色</div>
          </div>
          <div class="form-group">
            <label class="form-label">能力标签（点击选择，可多选）</label>
            <div class="tag-cloud" id="agent-capabilities-cloud">
              <button type="button" class="tag-chip capability" data-capability="coding">编码</button>
              <button type="button" class="tag-chip capability" data-capability="analysis">分析</button>
              <button type="button" class="tag-chip capability" data-capability="planning">规划</button>
              <button type="button" class="tag-chip capability" data-capability="testing">测试</button>
              <button type="button" class="tag-chip capability" data-capability="review">审查</button>
              <button type="button" class="tag-chip capability" data-capability="security">安全</button>
              <button type="button" class="tag-chip capability" data-capability="documentation">文档</button>
              <button type="button" class="tag-chip capability" data-capability="devops">DevOps</button>
              <button type="button" class="tag-chip capability" data-capability="automation">自动化</button>
              <button type="button" class="tag-chip capability" data-capability="monitoring">监控</button>
              <button type="button" class="tag-chip capability" data-capability="design">设计</button>
              <button type="button" class="tag-chip capability" data-capability="coordination">协调</button>
              <button type="button" class="tag-chip capability" data-capability="refactoring">重构</button>
              <button type="button" class="tag-chip capability" data-capability="debugging">调试</button>
              <button type="button" class="tag-chip capability" data-capability="optimization">优化</button>
              <button type="button" class="tag-chip capability" data-capability="deployment">部署</button>
            </div>
            <div class="form-hint">可多选，用于描述 Agent 的特长</div>
          </div>
          <div class="form-group">
            <label class="form-label">工具权限（点击选择，可多选）</label>
            <div class="tag-cloud" id="agent-tools-cloud">
              <button type="button" class="tag-chip tool" data-tool="terminal_exec">终端脚本</button>
              <button type="button" class="tag-chip tool" data-tool="workspace_write">工作区写入</button>
              <button type="button" class="tag-chip tool" data-tool="mcp_tools">MCP 工具</button>
              <button type="button" class="tag-chip tool" data-tool="web_fetch">Web 获取</button>
              <button type="button" class="tag-chip tool" data-tool="context_engine">上下文引擎</button>
              <button type="button" class="tag-chip tool" data-tool="custom_tool">自定义工具</button>
            </div>
            <div class="form-hint">这些权限决定 Agent 是否可直接调度系统工具。默认可空，即仅使用基础能力。</div>
          </div>
          <div class="form-group">
            <label class="form-label required">LLM Provider</label>
            <select class="form-select" id="agent-llm-provider" name="llm_provider" required>
              <option value="claude">Claude (Anthropic)</option>
              <option value="openai">OpenAI</option>
              <option value="gemini">Gemini (Google)</option>
              <option value="glm">GLM (智谱AI)</option>
              <option value="custom">自定义 (OpenAI 兼容)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label required">LLM Model</label>
            <input type="text" class="form-input" id="agent-llm-model" name="llm_model" required placeholder="例如：claude-3-5-sonnet-20241022">
            <div class="form-hint" id="model-hint"></div>
            <div class="chip-group" id="model-suggestion-chips"></div>
          </div>
          <div class="form-group" id="base-url-group">
            <label class="form-label">LLM Base URL</label>
            <input type="text" class="form-input" id="agent-llm-base-url" name="llm_base_url" placeholder="https://api.openai.com/v1">
            <div class="form-hint" id="base-url-hint">默认使用 Provider 推荐地址，可按需修改</div>
          </div>
          <div class="form-group">
            <label class="form-label">LLM API Key</label>
            <input type="password" class="form-input" id="agent-llm-api-key" name="llm_api_key" placeholder="请输入对应 Provider 的 API Key">
            <div class="form-hint" id="api-key-hint">必填：用于调用 LLM API</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">取消</button>
        <button class="btn btn-primary" data-action="submitAddAgent">确定</button>
      </div>
    </div>
  </div>

  <!-- Add Policy Modal -->
  <!-- Create Vote Modal -->
  <div class="modal-overlay" id="modal-create-vote">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">发起投票</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <form id="form-create-vote">
          <div class="form-group">
            <label class="form-label required">投票标题</label>
            <input type="text" class="form-input" id="vote-title" name="title" required placeholder="例如：是否合入安全修复">
          </div>
          <div class="form-group">
            <label class="form-label">投票描述</label>
            <textarea class="form-input form-textarea" id="vote-description" name="description" rows="3" placeholder="说明需要决策的背景、影响..."></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">关联任务</label>
            <select class="form-select" id="vote-task-select" name="task_id">
              <option value="">不关联任务</option>
            </select>
            <div class="form-hint">选择后可自动关联任务上下文与文件变更</div>
          </div>
          <div class="form-group">
            <label class="form-label required">投票类型</label>
            <select class="form-select" id="vote-type-select" name="vote_type" required>
              <option value="simple_majority">简单多数</option>
              <option value="absolute_majority">绝对多数</option>
              <option value="unanimous">全员同意</option>
              <option value="veto">否决权</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label required">超时时间（分钟）</label>
            <input type="number" min="1" class="form-input" id="vote-timeout" name="timeout_minutes" value="10" required>
          </div>
          <div class="form-group">
            <label class="form-label">需要参与的角色</label>
            <select class="form-select" id="vote-required-roles" name="required_roles" multiple size="6">
              <option value="developer">Developer（开发者）</option>
              <option value="reviewer">Reviewer（审查员）</option>
              <option value="tester">Tester（测试员）</option>
              <option value="security">Security（安全员）</option>
              <option value="documenter">Documenter（文档员）</option>
              <option value="coordinator">Coordinator（协调员）</option>
              <option value="analyzer">Analyzer（分析员）</option>
              <option value="admin">Admin（管理员）</option>
            </select>
            <div class="form-hint">留空表示所有人可投票，按住 Ctrl/Command 可多选</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">取消</button>
        <button class="btn btn-primary" data-action="submitCreateVote">发起投票</button>
      </div>
    </div>
  </div>

  <!-- Create Approval Modal -->
  <div class="modal-overlay" id="modal-create-approval">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">发起审批</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <form id="form-create-approval">
          <div class="form-group">
            <label class="form-label required">目标任务</label>
            <select class="form-select" id="approval-task-select" name="task_id" required>
              <option value="">请选择任务</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label required">审批人</label>
            <select class="form-select" id="approval-approver-select" name="approver_id" required>
              <option value="">请选择审批人</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">审批说明</label>
            <textarea class="form-input form-textarea" id="approval-reason" name="comment" rows="3" placeholder="告诉审批人为什么需要他们确认"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">取消</button>
        <button class="btn btn-primary" data-action="submitCreateApproval">发起审批</button>
      </div>
    </div>
  </div>

  <!-- MCP Config Modal -->
  <div class="modal-overlay" id="modal-mcp-config">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title" id="mcp-config-title">配置 MCP Server</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <form id="form-mcp-config">
          <div class="form-group">
            <label class="form-label">配置 JSON</label>
            <textarea class="form-input form-textarea" id="mcp-config-json" rows="12" spellcheck="false" placeholder="输入或粘贴 MCP Server 的 JSON 配置，如 { &quot;name&quot;: &quot;my-mcp&quot;, ... }"></textarea>
            <div class="form-hint">可直接粘贴完整 JSON；必填字段包含 name / command / args</div>
            <div class="form-hint" id="mcp-config-error" style="color: #f44336;"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">取消</button>
        <button class="btn btn-primary" data-action="submitMcpConfig">保存</button>
      </div>
    </div>
  </div>

  <!-- Create Session Modal -->
  <div class="modal-overlay" id="modal-create-session">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">新建会话</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <p>系统将创建一个新的会话 ID：</p>
        <div class="global-section" style="margin-top:12px;">
          <div id="session-create-preview" style="font-weight:600;"></div>
          <div class="form-hint">点击“创建”后，该 ID 将立即生效。</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">取消</button>
        <button class="btn btn-primary" data-action="confirmCreateSession">创建</button>
      </div>
    </div>
  </div>

  <!-- Delete Session Modal -->
  <div class="modal-overlay" id="modal-delete-session">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">删除会话</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <p>确定要删除会话 <strong id="session-delete-preview">--</strong> 吗？</p>
        <p class="form-hint">该操作将清除该会话下的任务、黑板消息、投票/审批、文件变更等所有历史数据，且不可恢复。</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">取消</button>
        <button class="btn btn-danger" data-action="confirmDeleteSession">删除</button>
      </div>
    </div>
  </div>

  <!-- Vote Detail Modal -->
  <div class="modal-overlay" id="modal-vote-detail">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">投票详情</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <div id="vote-detail-body" class="detail-section">
          <div class="empty-state">请选择一个投票</div>
        </div>
        <div class="form-group" id="vote-comment-wrapper">
          <label class="form-label">我的意见（可选）</label>
          <textarea class="form-input form-textarea" id="vote-comment-input" rows="3" placeholder="可补充理由或参考信息，提交后会记录在投票中"></textarea>
        </div>
      </div>
      <div class="modal-footer" data-role="vote-actions">
        <button class="btn btn-primary" data-action="submitVoteDecision" data-choice="approve">一票通过</button>
        <button class="btn btn-danger" data-action="submitVoteDecision" data-choice="reject">一票否决</button>
      </div>
    </div>
  </div>

  <!-- Approval Detail Modal -->
  <div class="modal-overlay" id="modal-approval-detail">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">审批详情</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <div id="approval-detail-body" class="detail-section">
          <div class="empty-state">请选择一个审批请求</div>
        </div>
        <div class="form-group" id="approval-comment-wrapper">
          <label class="form-label">审批意见</label>
          <textarea class="form-input form-textarea" id="approval-comment-input" rows="3" placeholder="审批结论及理由"></textarea>
        </div>
      </div>
      <div class="modal-footer" data-role="approval-actions">
        <button class="btn btn-primary" data-action="submitApprovalDecision" data-decision="approved">批准</button>
        <button class="btn btn-danger" data-action="submitApprovalDecision" data-decision="rejected">拒绝</button>
      </div>
    </div>
  </div>

  <!-- Task Detail Modal -->
  <div class="modal-overlay" id="modal-task-detail">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">任务详情</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <div id="task-detail-body" class="detail-section">
          <div class="empty-state">请选择一个任务查看详情</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">关闭</button>
      </div>
    </div>
  </div>

  <!-- Task Dependency Modal -->
  <div class="modal-overlay" id="modal-task-dependency">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">任务依赖详情</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <div id="task-dependency-body" class="detail-section">
          <div class="empty-state">请选择一个任务查看依赖关系</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">关闭</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      console.log('[MinimalPanel] 脚本开始执行');

      const vscode = (typeof acquireVsCodeApi === 'function')
        ? acquireVsCodeApi()
        : {
            postMessage(message) {
              console.warn('[MinimalPanel] VSCode API 不可用，已丢弃消息：', message);
            },
            getState() {
              return undefined;
            },
            setState() {
              // noop
            }
          };
      console.log('[MinimalPanel] VSCode API 已准备就绪');

      const agentEmptyOverlay = document.getElementById('agent-empty-overlay');
      const agentEmptyAddBtn = document.getElementById('agent-empty-add-btn');
      const agentEmptyRefreshBtn = document.getElementById('agent-empty-refresh-btn');
      const sessionSelectEl = document.getElementById('session-select');
      let currentActivePhaseId = null;
      let currentMessageTypeGuess = null;


      function setAgentEmptyOverlay(isEmpty) {
        if (!agentEmptyOverlay) {
          return;
        }
        if (isEmpty) {
          agentEmptyOverlay.classList.remove('hidden');
        } else {
          agentEmptyOverlay.classList.add('hidden');
        }
      }

      function deriveMessageTaskBacklog(message) {
        if (!message || !Array.isArray(taskBacklogSummaries)) {
          return null;
        }
        const payloadPlanId = message.payload?.source_task_id;
        if (payloadPlanId) {
          const match = taskBacklogSummaries.find(summary =>
            summary.source_task_id === payloadPlanId && summary.session_id === message.session_id
          );
          if (match) {
            return match;
          }
        }
        const references = parseMessageReferences(message);
        const taskRef = references.find(ref => ref.type === 'task');
        if (taskRef) {
          const link = taskBacklogSummaries.find(summary => summary.session_id === message.session_id && summary.id === `plan_source:${taskRef.id}`);
          if (link) {
            return link;
          }
        }
        return null;
      }

      function buildBacklogSummarySnippet(summary) {
        if (!summary || !summary.total) {
          return '';
        }
        const remaining = Math.max(summary.total - summary.completed, 0);
        const blockedLabel = summary.blocked ? ` · 阻塞 ${summary.blocked}` : '';
        return `
          <div class="task-progress-card" style="margin-top: 8px;">
            <div class="task-progress-card-head">
              <span class="task-progress-card-title">${escapeHtml(summary.title)}</span>
              <span class="task-progress-count">${summary.completed}/${summary.total}</span>
            </div>
            <div class="task-progress-meter"><span style="width:${summary.total ? Math.min(100, Math.round((summary.completed / summary.total) * 100)) : 0}%"></span></div>
            <div class="task-progress-meta">剩余 ${remaining}${blockedLabel}</div>
            <div class="task-progress-actions">
              <button data-action="focusBacklogSummary" data-summary-id="${summary.id}">查看任务</button>
            </div>
          </div>
        `;
      }

      function focusBacklogSummary(summaryId) {
        if (summaryId) {
          taskSummaryFilter = summaryId;
        } else {
          taskSummaryFilter = null;
        }
        renderTasks(allTasks);
        const tasksPanel = document.getElementById('panel-tasks');
        if (tasksPanel) {
          tasksPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      function rerenderSessionPanels() {
        renderTasks(allTasks);
        renderMessages(allMessages);
        renderVotes(allVotes);
        renderApprovals(allApprovals);
        renderNotifications(allNotifications);
        renderFileChanges(allFileChanges);
        renderLocks(allLocks);
        const agent = selectedAgentId ? allAgents.find(a => a.id === selectedAgentId) : null;
        renderWorkspace(agent || null);
      }

      function requestTaskMetrics(options = {}) {
        if (options.showLoading) {
          resetTaskMetricsTile('同步中...');
        }
        if (currentSessionId) {
          vscode.postMessage({ type: 'get_task_metrics', data: { session_id: currentSessionId } });
        } else {
          vscode.postMessage({ type: 'get_task_metrics' });
        }
      }

      function scheduleTaskMetricsRefresh(delay = 800) {
        if (taskMetricsRefreshTimer) {
          clearTimeout(taskMetricsRefreshTimer);
        }
        taskMetricsRefreshTimer = window.setTimeout(() => {
          taskMetricsRefreshTimer = null;
          requestTaskMetrics();
        }, delay);
      }

      function resetSessionScopedState(nextSessionId) {
        allTasks = [];
        sessionTasks = [];
        workflowProofRecords = [];
        allMessages = [];
        allVotes = [];
        allApprovals = [];
        allNotifications = [];
        allFileChanges = [];
        allLocks = [];
        allThinkingLogs = [];
        taskDependencyGraph = buildTaskDependencyGraph([]);
        latestTaskMetrics = null;
        latestTaskMetricsSessionId = null;
        governanceSummary.pendingVotes = 0;
        governanceSummary.timeoutVotes = 0;
        governanceSummary.pendingApprovals = 0;
        governanceSummary.nextPendingVoteId = null;
        governanceSummary.nextTimeoutVoteId = null;
        governanceSummary.nextPendingApprovalId = null;
        governanceSummary.unreadNotifications = 0;
        governanceSummary.pollingActive = false;
        updateGovernanceSummaryUI();
        resetTaskMetricsTile(nextSessionId ? '等待任务数据' : '请选择一个会话');
        currentMessageTypeGuess = null;
        updateMessageTemplates();
        currentWorkflowInstanceId = nextSessionId ? (workflowInstanceSelections.get(nextSessionId) || null) : null;
        renderWorkflowStagePanel();
        renderWorkflowTodos();
        workflowInstanceScenarioFilter = null;
      }

      function refreshSessionScopedData(options = {}) {
        if (!currentSessionId) {
          console.log('[MinimalPanel] Skip refreshing session data: no active session');
          rerenderSessionPanels();
          return;
        }
        console.log('[MinimalPanel] Refreshing data for session:', currentSessionId, options.reason || '');
        const payload = { session_id: currentSessionId };
        const showLoading = options.showLoading !== false;
        vscode.postMessage({ type: 'get_tasks', data: payload });
        vscode.postMessage({ type: 'get_messages', data: payload });
        vscode.postMessage({ type: 'get_votes', data: payload });
        vscode.postMessage({ type: 'get_approvals', data: payload });
        vscode.postMessage({ type: 'get_notifications', data: payload });
        vscode.postMessage({ type: 'get_tool_runs', data: payload });
        vscode.postMessage({ type: 'get_file_changes', data: payload });
        vscode.postMessage({ type: 'get_locks', data: payload });
        vscode.postMessage({
          type: 'get_thinking_logs',
          data: { filters: { session_id: currentSessionId, limit: WORKSPACE_THINKING_LIMIT } }
        });
        vscode.postMessage({ type: 'get_workflow_instances' });
        requestTaskMetrics({ showLoading });
        fetchGovernanceHistory({ resetPage: true });
        fetchGovernanceAnalytics();
      }

      function requestMessagesSnapshot(reason = 'manual') {
        if (!currentSessionId) {
          console.warn('[MinimalPanel] Skip requesting messages snapshot:', reason, '- no active session');
          return;
        }
        console.log('[MinimalPanel] Requesting messages snapshot:', currentSessionId, reason);
        vscode.postMessage({
          type: 'get_messages',
          data: { session_id: currentSessionId }
        });
      }

      function requestToolRunsSnapshot() {
        if (!currentSessionId) {
          console.warn('[MinimalPanel] Skip requesting tool runs - no active session');
          return;
        }
        vscode.postMessage({
          type: 'get_tool_runs',
          data: { session_id: currentSessionId }
        });
      }

      function setCurrentSession(nextSessionId, options = {}) {
        const normalized = typeof nextSessionId === 'string' && nextSessionId.trim().length > 0
          ? nextSessionId.trim()
          : null;
        const changed = normalized !== currentSessionId;
        if (!changed && !options.forceRender) {
          if (options.forceFetch && normalized) {
            refreshSessionScopedData({
              reason: options.reason || 'session-refresh',
              showLoading: options.showLoading !== false
            });
          }
          return false;
        }
        if (changed) {
          resetSessionScopedState(normalized);
        }
        currentSessionId = normalized;
        renderBlackboardSessions(blackboardSessions);
        rerenderSessionPanels();
        if (!normalized) {
          fetchGovernanceHistory({ resetPage: true });
          fetchGovernanceAnalytics();
          requestTaskMetrics({ showLoading: true });
        }
        if (!options.skipFetch && normalized) {
          refreshSessionScopedData({
            reason: options.reason || 'session-change',
            showLoading: true
          });
        }
        return changed;
      }

      function ensureActiveSession() {
        if (currentSessionId) {
          return currentSessionId;
        }
        const autoId = `session-${Date.now()}`;
        console.log('[MinimalPanel] Auto creating session:', autoId);
        sessionIdToAutoSelect = autoId;
        setCurrentSession(autoId, { skipFetch: true, reason: 'auto-create', forceRender: true });
        vscode.postMessage({ type: 'create_session', data: { id: autoId } });
        updateStatus(`已自动创建会话 ${autoId}`);
        return autoId;
      }

      function applySessionsPayload(sessions) {
        const normalizedSessions = Array.isArray(sessions) ? sessions : [];
        const previousSessionId = currentSessionId;
        blackboardSessions = normalizedSessions;
        const hasSessions = normalizedSessions.length > 0;
        let targetSessionId = currentSessionId;

        if (sessionIdToAutoSelect && normalizedSessions.some(item => item.id === sessionIdToAutoSelect)) {
          targetSessionId = sessionIdToAutoSelect;
          sessionIdToAutoSelect = null;
        }

        if (targetSessionId && !normalizedSessions.some(item => item.id === targetSessionId)) {
          targetSessionId = hasSessions ? normalizedSessions[0].id : null;
        } else if (!targetSessionId && hasSessions) {
          targetSessionId = normalizedSessions[0].id;
        } else if (!hasSessions) {
          targetSessionId = null;
        }

        const shouldFetch = !!targetSessionId && targetSessionId !== previousSessionId;
        const changed = setCurrentSession(targetSessionId, {
          skipFetch: !shouldFetch,
          forceRender: true,
          reason: 'sessions-update'
        });

        if (!targetSessionId) {
          console.log('[MinimalPanel] No sessions available, waiting for creation');
          return;
        }

        if (!changed && !shouldFetch && !previousSessionId && targetSessionId) {
          refreshSessionScopedData({ reason: 'sessions-init', showLoading: true });
        }
      }

      if (agentEmptyAddBtn) {
        agentEmptyAddBtn.addEventListener('click', () => {
          window.openGlobalAgentTab();
          if (typeof window.addAgent === 'function') {
            window.addAgent();
          }
        });
      }

      if (agentEmptyRefreshBtn) {
        agentEmptyRefreshBtn.addEventListener('click', () => {
          vscode.postMessage({ type: 'get_agents' });
        });
      }

      if (sessionSelectEl) {
        sessionSelectEl.addEventListener('change', (event) => {
          const target = event.target;
          const value = target ? target.value : '';
          window.switchBlackboardSession(value || null);
        });
      }

      const proofListContainer = document.getElementById('workflow-proof-list');
      if (proofListContainer) {
        proofListContainer.addEventListener('click', handleProofActionClick);
      }

      function handleProofActionClick(event) {
        const target = event.target;
        if (!(target instanceof HTMLElement)) {
          return;
        }
        const actionEl = target.closest('[data-action="attestProof"]');
        if (!actionEl) {
          return;
        }
        const proofId = actionEl.getAttribute('data-proof-id');
        const status = actionEl.getAttribute('data-status');
        if (!proofId || !status) {
          return;
        }
        vscode.postMessage({
          type: 'attest_proof',
          data: {
            proof_id: proofId,
            status,
            session_id: currentSessionId
          }
        });
      }

      document.querySelectorAll('.file-change-filter-btn').forEach(btn => {
        btn.addEventListener('click', (event) => {
          const target = event.currentTarget;
          if (!(target instanceof HTMLElement)) {
            return;
          }
          const filter = target.getAttribute('data-filter') || 'all';
          window.setFileChangeFilter(filter);
        });
      });

      const taskFilterInput = document.getElementById('file-change-task-filter');
      if (taskFilterInput) {
        taskFilterInput.addEventListener('input', (event) => {
          const target = event.target;
          const value = target && target.value ? target.value.trim() : '';
          window.setFileChangeTaskFilter(value, { skipInputSync: true });
        });
      }

      const agentFilterInput = document.getElementById('file-change-agent-filter');
      if (agentFilterInput) {
        agentFilterInput.addEventListener('input', (event) => {
          const target = event.target;
          const value = target && target.value ? target.value.trim() : '';
          window.setFileChangeAgentFilter(value);
        });
      }

      // ✅ 初始化管理器 - 防御性编程
      // LLM Presets 配置
      const LLM_PRESETS = {
        claude: {
          name: 'Claude (Anthropic)',
          models: ['claude-4.5-sonnet', 'claude-4.5-haiku', 'claude-3.5-sonnet', 'claude-3.5-haiku', 'claude-3-opus'],
          defaultModel: 'claude-4.5-sonnet',
          requiresApiKey: true,
          baseURL: 'https://api.anthropic.com'
        },
        openai: {
          name: 'OpenAI',
          models: ['gpt-5', 'gpt-5-codex', 'gpt-4o', 'gpt-4-turbo'],
          defaultModel: 'gpt-5',
          requiresApiKey: true,
          baseURL: 'https://api.openai.com/v1'
        },
        glm: {
          name: 'GLM (智谱AI)',
          models: ['glm-4.6', 'glm-4-Long', 'glm-4-Air'],
          defaultModel: 'glm-4.6',
          requiresApiKey: true,
          baseURL: ' https://open.bigmodel.cn/api/coding/paas/v4'
        },
        gemini: {
          name: 'Gemini (Google)',
          models: ['gemini-2.5-pro', 'gemini-1.5-flash', 'gemini-1.5-flash-8b'],
          defaultModel: 'gemini-2.5-pro',
          requiresApiKey: true,
          baseURL: 'https://generativelanguage.googleapis.com/v1beta/openai/'
        },
        custom: {
          name: '自定义 (OpenAI 兼容)',
          models: [],
          defaultModel: '',
          requiresApiKey: true,
          baseURL: ''
        }
      };

      function updateStatus(text) {
        console.log('[MinimalPanel] Status:', text);
      }

      // Global state
      let allAgents = [];
      let allTasks = [];
      let sessionTasks = [];
      let taskBacklogSummaries = [];
      let workflowProofRecords = [];
      let taskSummaryFilter = null;
      let workflowTemplateInfo = null;
      let allMessages = [];
      let allThinkingLogs = [];
      const llmStreamStates = new Map();
      const THINKING_TYPE_OPTIONS = [
        { key: 'thought', label: '思考' },
        { key: 'tool', label: '工具' },
        { key: 'file', label: '文件' },
        { key: 'governance', label: '治理' },
        { key: 'feedback', label: '反馈' }
      ];
      const DEFAULT_THINKING_TYPE_KEYS = THINKING_TYPE_OPTIONS.map(opt => opt.key);
      let workspaceThinkingTypeFilters = new Set(DEFAULT_THINKING_TYPE_KEYS);
      let allLocks = [];
      let allFileChanges = [];
      let selectedAgentId = null;
      let taskFilter = 'all';
      let currentMainTab = 'blackboard';
      let currentBlackboardView = 'discussion';
      let currentWorkspaceTab = 'overview';
      let workspaceThinkingScope = 'all';
      let workspaceThinkingSearch = '';
      let replyToMessage = null;
      let quotedMessage = null;
      let taskDependencyGraph = buildTaskDependencyGraph([]);
      let currentTaskDependencyDetail = null;
  const orchestrationEvents = [];
  let blackboardEventEntries = [];
  const MAX_ORCHESTRATION_EVENTS = 40;
  const ORCHESTRATION_EVENT_FILTERS = ['scheduler', 'sentinel', 'system'];
  let orchestrationEventFilter = new Set(ORCHESTRATION_EVENT_FILTERS);
  const notificationLevelFiltersDefault = ['warning', 'error'];
  let notificationLevelFilters = new Set(notificationLevelFiltersDefault);
  let notificationUnreadOnly = true;
      const mentionState = {
        active: false,
        startIndex: -1,
        prefix: '',
        hideTimer: null
      };
      const MESSAGE_TEMPLATES = [
        {
          id: 'clarify-context',
          stage: 'clarify',
          label: '澄清上下文',
          type: 'question',
          content: '我需要补充以下背景信息：\n1.\n2.\n请帮忙提供相关细节。'
        },
        {
          id: 'plan-decision',
          stage: 'plan',
          label: '方案建议',
          type: 'decision',
          content: '建议采用如下方案：\n- 目标：\n- 关键步骤：\n- 风险与依赖：\n如无异议，请确认。'
        },
        {
          id: 'build-progress',
          stage: 'build',
          label: '进展同步',
          type: 'discussion',
          content: '进展同步：\n- 已完成：\n- 进行中：\n- 风险/需求支持：'
        },
        {
          id: 'verify-proof',
          stage: 'verify',
          label: '提交验证结果',
          type: 'warning',
          content: '验证结果如下：\n- 测试范围：\n- 结论：\n- 需要关注的问题：'
        },
        {
          id: 'delivery-summary',
          stage: 'delivery',
          label: '交付总结',
          type: 'decision',
          content: '交付说明：\n- 内容/链接：\n- 验收要点：\n请确认无误后关闭流程。'
        },
        {
          id: 'general-followup',
          stage: null,
          label: '通用跟进',
          type: 'discussion',
          content: '我这边有如下更新：\n- \n- \n请协助确认或进一步指示。'
        }
      ];
      const DEFAULT_WORKFLOW_PHASES = [
        { id: 'clarify', title: '需求澄清', description: '确认背景、上下文与验收标准' },
        { id: 'plan', title: '方案拆解', description: '输出技术方案与任务拆解' },
        { id: 'build', title: '实现迭代', description: '完成开发、联调与产物' },
        { id: 'verify', title: '验证论证', description: '执行测试、生成验证证据' },
        { id: 'delivery', title: '交付总结', description: '发布结果并生成验收材料' }
      ];

      function getWorkflowPhases() {
        const phases = workflowTemplateInfo?.metadata?.phases;
        if (Array.isArray(phases) && phases.length > 0) {
          return phases;
        }
        return DEFAULT_WORKFLOW_PHASES;
      }

      function getPhaseMeta(phaseId) {
        return getWorkflowPhases().find(phase => phase.id === phaseId) || null;
      }

      function getPhaseIndexPosition(phaseId) {
        if (!phaseId) {
          return Number.MAX_SAFE_INTEGER;
        }
        const phases = getWorkflowPhases();
        const idx = phases.findIndex(phase => phase.id === phaseId);
        return idx >= 0 ? idx : Number.MAX_SAFE_INTEGER;
      }

      function phaseRequiresArtifacts(phaseId) {
        const meta = getPhaseMeta(phaseId);
        if (!meta) {
          return false;
        }
        if (typeof meta.requireArtifacts === 'boolean') {
          return meta.requireArtifacts;
        }
        return false;
      }
      const WORKFLOW_PERSONA_LABELS = {
        lead: '主持',
        reviewer: '评审',
        executor: '执行',
        moderator: '主持',
        user: '用户'
      };
      const ROLE_PERSONA_MAP = {
        coordinator: 'lead',
        product: 'lead',
        architect: 'lead',
        admin: 'lead',
        reviewer: 'reviewer',
        tester: 'reviewer',
        security: 'reviewer',
        qa: 'reviewer',
        developer: 'executor',
        documenter: 'executor',
        analyzer: 'executor',
        scribe: 'executor',
        implementer: 'executor'
      };
      const ROLE_DISPLAY_LABELS = {
        coordinator: '协调',
        product: '产品',
        architect: '架构',
        admin: '管理',
        reviewer: '评审',
        tester: '测试',
        security: '安全',
        developer: '研发',
        documenter: '文档',
        analyzer: '分析',
        scribe: '记录',
        qa: '测试',
        implementer: '执行'
      };
      const PROOF_STATUS_LABELS = {
        pending: '待签署',
        approved: '已签署',
        rejected: '已驳回'
      };
      const TASK_INTENT_LABELS = {
        clarify_requirement: '需求澄清',
        create_architecture_plan: '方案设计',
        implement_requirement: '需求实现',
        implement_ui: '界面实现',
        implement_backend: '接口实现',
        deliver_requirement: '联调交付',
        compile_release_note: '交付总结',
        respond_to_command: '指令处理',
        answer_question: '问题处理',
        evaluate_suggestion: '建议评估',
        handle_warning: '告警处理',
        qa_signoff: '测试验收',
        submit_verify_evidence: '提交验证结果',
        release_approval: '交付审批',
        architecture_plan: '方案设计'
      };
      const TASK_SCOPE_LABELS = {
        session: '当前会话',
        workspace: '工作区',
        project: '项目',
        feature: '功能模块',
        requirement: '需求',
        iteration: '迭代',
        global: '全局',
        file: '文件'
      };
      const VOTE_STATUS_LABELS = {
        pending: '待投票',
        completed: '已完成',
        approved: '已通过',
        rejected: '已否决',
        timeout: '已超时',
        expired: '已超时',
        cancelled: '已取消',
        failed: '失败'
      };
      const VOTE_DEADLINE_STATE_LABELS = {
        ok: '剩余充足',
        warning: '即将超时',
        expired: '已超时',
        done: '已结束'
      };
      const WORKFLOW_STATUS_LABELS = {
        pending: '未开始',
        active: '进行中',
        completed: '已完成',
        blocked: '已阻塞',
        paused: '已暂停',
        failed: '失败'
      };
      const SCENARIO_LABELS = {
        new_feature: '新功能',
        bug_fix: '缺陷',
        doc_work: '文档',
        ops_hotfix: '运维',
        optimization: '优化',
        refactor: '重构',
        test_request: '测试',
        discussion: '讨论'
      };
      const PRIORITY_LABELS = {
        high: '高',
        medium: '中',
      low: '低'
    };
    let workflowInstanceSummaries = [];
    let workflowInstanceDetails = [];
    let workflowSnapshotTimer = null;
    const workflowInstanceSelections = new Map();
    const INSTANCE_COLOR_PALETTE = ['#5c7cfa', '#ff922b', '#20c997', '#f06595', '#9775fa', '#ffd43b'];
    const workflowInstanceColorMap = new Map();
    let currentWorkflowInstanceId = null;
    let workflowInstanceFilter = 'all';
    let workflowInstanceScenarioFilter = null;
    let workflowInstanceParticipantFilter = null;
    let pendingWorkflowFocusId = null;
    let pendingTaskFocusId = null;
    let pendingGovernanceFocus = null;
    let lastThinkingSnapshot = { entries: [], agentId: null, agentName: '', generatedAt: 0 };
    let allToolRuns = [];
    let toolRunStatusFilter = 'all';
  const DEFAULT_SCENARIO_LABEL = '默认流程';

      function hasChineseText(text) {
        return /[\u4e00-\u9fff]/.test(text || '');
      }

      function buildDescriptionSnippet(text, max = 24) {
        if (!text) {
          return '';
        }
        const sanitized = text.replace(/\s+/g, ' ').trim();
        if (!sanitized) {
          return '';
        }
        return sanitized.length > max ? sanitized.slice(0, max) + '…' : sanitized;
      }

      function getTaskDisplayTitle(task) {
        if (!task) {
          return '任务';
        }
        const rawTitle = (task.title || '').trim();
        if (rawTitle && hasChineseText(rawTitle)) {
          return rawTitle;
        }
        const intent = (task.intent || '').trim().toLowerCase();
        const mapped = TASK_INTENT_LABELS[intent];
        if (mapped) {
          const snippet = buildDescriptionSnippet(task.description || task.intent || '');
          return snippet ? `${mapped}：${snippet}` : mapped;
        }
        if (rawTitle) {
          return rawTitle;
        }
        if (intent) {
          return mapped || intent;
        }
        return task.id || '任务';
      }

      function getTaskPhaseId(task) {
        if (!task) {
          return null;
        }
        if (task.phase_id) {
          return task.phase_id;
        }
        const labels = Array.isArray(task.labels) ? task.labels : [];
        const marker = labels.find(label => typeof label === 'string' && label.startsWith('workflow_phase:'));
        if (!marker) {
          return null;
        }
        const [, phaseId] = marker.split(':');
        return phaseId || null;
      }

  function getWorkflowPhaseStatusText(status) {
    if (!status) {
      return WORKFLOW_STATUS_LABELS.pending;
    }
    return WORKFLOW_STATUS_LABELS[status.toLowerCase()] || status;
  }

  function computeInstanceProgress(instance) {
    if (!instance) {
      return { total: 0, completed: 0, active: 0, percent: 0 };
    }
    const phaseState = instance.phaseState ? Object.values(instance.phaseState) : [];
    const total = phaseState.length || getWorkflowPhases().length;
    const completed = phaseState.filter(state => state.status === 'completed').length;
    const active = phaseState.filter(state => state.status === 'active').length;
    const percent = total > 0 ? Math.min(100, Math.round((completed / total) * 100)) : 0;
    return { total, completed, active, percent };
  }

  function getInstanceParticipants(instanceId, limit = 5) {
    if (!instanceId) {
      return [];
    }
    const participants = new Map();
    (sessionTasks || []).forEach(task => {
      if (!task.assigned_to) {
        return;
      }
      if (Array.isArray(task.labels) && task.labels.includes(`workflow_instance:${instanceId}`)) {
        if (!participants.has(task.assigned_to)) {
          participants.set(task.assigned_to, {
            id: task.assigned_to,
            name: getAgentName(task.assigned_to)
          });
        }
      }
    });
    return Array.from(participants.values()).slice(0, limit);
  }

  function determineActivePhaseId(summary) {
    const templatePhases = getWorkflowPhases();
    if (!templatePhases.length) {
      return null;
    }
    if (summary.activePhases && summary.activePhases.length > 0) {
      return summary.activePhases[0];
    }
    if (summary.status === 'completed') {
      return templatePhases[templatePhases.length - 1].id;
    }
    return templatePhases[0].id;
  }

  function getTaskIdsForInstance(instanceId) {
    if (!instanceId) {
      return [];
    }
    return (sessionTasks || [])
      .filter(task => Array.isArray(task.labels) && task.labels.includes(`workflow_instance:${instanceId}`))
      .map(task => task.id);
  }

  function getInstanceApprovalStats(instanceId) {
    const taskIds = new Set(getTaskIdsForInstance(instanceId));
    if (taskIds.size === 0) {
      return { total: 0, pending: 0 };
    }
    const approvals = (allApprovals || []).filter(approval => taskIds.has(approval.task_id));
    const pending = approvals.filter(approval => approval.decision === 'pending').length;
    return { total: approvals.length, pending };
  }

  function getInstanceProofStats(instanceId) {
    const records = workflowProofRecords.filter(record => record.workflow_instance_id === instanceId);
    const pending = records.filter(record => record.attestation_status === 'pending').length;
    return { total: records.length, pending };
  }

  function renderWorkflowInstanceDetailPanel(instance, summary) {
    const detailEl = document.getElementById('workflow-stage-detail');
    if (!detailEl) {
      return;
    }
    const activePhaseId = determineActivePhaseId(summary);
    currentActivePhaseId = activePhaseId || null;
    const scenarioTags = getInstanceScenarioTags(instance);
    const participantEntries = getInstanceParticipants(instance.id);
    const participantNames = participantEntries.map(entry => entry.name || entry.id);
    const progress = computeInstanceProgress(instance);
    const approvalStats = getInstanceApprovalStats(instance.id);
    const proofStats = getInstanceProofStats(instance.id);
    const blockedCount = summary.blockedPhases ? summary.blockedPhases.length : 0;
    const summaryCards = `
      <div class="workflow-instance-detail-panel">
        <div class="detail-card">
          <div class="detail-label">场景</div>
          <div class="detail-value">${scenarioTags.map(tag => `<span class="badge badge-default">${escapeHtml(tag)}</span>`).join(' ') || '默认流程'}</div>
        </div>
        <div class="detail-card">
          <div class="detail-label">参与者</div>
          <div class="detail-value">${participantNames.length ? participantNames.join('、') : '自动调度'}</div>
        </div>
        <div class="detail-card">
          <div class="detail-label">阶段进度</div>
          <div class="detail-value">${progress.completed}/${progress.total}</div>
        </div>
        <div class="detail-card">
          <div class="detail-label">激活阶段</div>
          <div class="detail-value">${summary.activePhases && summary.activePhases.length ? summary.activePhases.join(', ') : '—'}</div>
        </div>
      </div>
    `;
    const governanceSection = `
      <div class="workflow-instance-detail-panel governance">
        <div class="detail-card">
          <div class="detail-label">审批</div>
          <div class="detail-value">${approvalStats.total ? `${approvalStats.pending} / ${approvalStats.total} 待处理` : '暂无审批'}</div>
          ${approvalStats.pending ? '<div class="workflow-detail-hint"><button class="link-button" data-action="showApprovalsPanel">查看审批</button></div>' : ''}
        </div>
        <div class="detail-card">
          <div class="detail-label">Proof / 签署</div>
          <div class="detail-value">${proofStats.total ? `证据 ${proofStats.total}` : '暂无'}</div>
          <div class="workflow-detail-hint">${proofStats.pending ? `待签署 ${proofStats.pending}` : '全部已签署'}</div>
        </div>
        <div class="detail-card">
          <div class="detail-label">阻塞</div>
          <div class="detail-value">${blockedCount ? `${blockedCount} 个阶段` : '无阻塞'}</div>
          ${blockedCount ? `<div class="workflow-detail-hint">${summary.blockedPhases.map(phaseId => escapeHtml(getPhaseTitle(phaseId) || phaseId)).join('、')}</div>` : ''}
        </div>
      </div>
    `;
    const phaseSection = activePhaseId
      ? buildWorkflowPhaseDetailSection(instance, activePhaseId)
      : '<div class="empty-state">模板未提供阶段详情</div>';
    const noteSection = buildWorkflowNotePanel(instance, scenarioTags);
    detailEl.innerHTML = summaryCards + governanceSection + phaseSection + noteSection;
  }

  function buildWorkflowPhaseDetailSection(instance, phaseId) {
    const phaseInfo = getPhaseMeta(phaseId) || { id: phaseId, title: phaseId, description: '' };
    const runtime = getPhaseRuntime(instance, phaseInfo.id);
    const blockers = runtime?.blockers || [];
    const blockerHint = blockers.length ? blockers[blockers.length - 1].reason : '';
    const tasksInPhase = getTasksForPhase(phaseInfo.id);
    const proofsCount = runtime?.proofs?.length ?? 0;
    const defectCount = runtime?.openDefects ? Object.keys(runtime.openDefects).length : 0;
    const statusLabel = getWorkflowPhaseStatusText(runtime?.status || 'pending');
    const userNotes = Array.isArray(runtime?.metadata?.user_notes) ? runtime.metadata.user_notes : [];
    const userNoteSection = buildUserNoteSection(userNotes, phaseInfo.id, instance.id);
    return `
      <div class="workflow-stage-detail-card">
        <div class="workflow-stage-detail-title">${escapeHtml(phaseInfo.title)}（${escapeHtml(statusLabel)}）</div>
        <div class="workflow-stage-detail-desc">${escapeHtml(phaseInfo.description || '')}</div>
        <div class="workflow-stage-detail-meta">
          任务 ${tasksInPhase.length} · 证据 ${proofsCount} · 缺陷 ${defectCount}${blockerHint ? ' · 阻塞：' + escapeHtml(blockerHint) : ''}
        </div>
        ${userNoteSection}
      </div>
    `;
  }

  function buildWorkflowNotePanel(instance, scenarioTags) {
    return `
      <div class="workflow-note-panel">
        <label>插话 / 备注</label>
        <textarea id="workflow-note-input" placeholder="向所有 Agent 广播此实例的最新信息..."></textarea>
        <div class="workflow-note-actions">
          <span>实例：${escapeHtml(instance.id)} · 场景：${escapeHtml(scenarioTags.join(' / ') || '默认流程')}</span>
          <button data-action="sendWorkflowNote">提交插话</button>
        </div>
      </div>
    `;
  }

      function formatTaskScopeLabel(scope) {
        if (!scope) {
          return '未指定';
        }
        const normalized = scope.toLowerCase();
        return TASK_SCOPE_LABELS[normalized] || scope;
      }

      function getVoteStatusText(status) {
        if (!status) {
          return VOTE_STATUS_LABELS.pending;
        }
        const normalized = status.toLowerCase();
        return VOTE_STATUS_LABELS[normalized] || status;
      }

      function getVoteStatusClass(status) {
        if (!status) {
          return 'pending';
        }
        const normalized = status.toLowerCase();
        if (normalized === 'completed' || normalized === 'approved' || normalized === 'passed') {
          return 'approved';
        }
        if (normalized === 'rejected' || normalized === 'failed') {
          return 'rejected';
        }
        if (normalized === 'timeout' || normalized === 'expired') {
          return 'timeout';
        }
        if (normalized === 'cancelled' || normalized === 'canceled') {
          return 'cancelled';
        }
        return normalized;
      }

      function getVoteDeadlineState(vote) {
        if (!vote || !vote.timeout_at) {
          return 'ok';
        }
        if (vote.status && vote.status !== 'pending') {
          return 'done';
        }
        const diff = vote.timeout_at - Date.now();
        if (diff <= 0) {
          return 'expired';
        }
        if (diff <= VOTE_TIMEOUT_WARNING_THRESHOLD) {
          return 'warning';
        }
        return 'ok';
      }

      function formatPriorityLabel(priority) {
        if (!priority) {
          return PRIORITY_LABELS.medium;
        }
        const normalized = String(priority).toLowerCase();
        return PRIORITY_LABELS[normalized] || priority.toString().toUpperCase();
      }

      function formatPriorityClass(priority) {
        if (typeof priority === 'string') {
          const normalized = priority.toLowerCase();
          if (normalized === 'critical' || normalized === 'urgent') {
            return 'priority-critical';
          }
          if (normalized === 'high') {
            return 'priority-high';
          }
          if (normalized === 'medium') {
            return 'priority-medium';
          }
          if (normalized === 'low') {
            return 'priority-low';
          }
        }
        const numeric = Number(priority);
        if (!Number.isFinite(numeric) || numeric <= 0) {
          return 'priority-none';
        }
        if (numeric >= 9) {
          return 'priority-critical';
        }
        if (numeric >= 7) {
          return 'priority-high';
        }
        if (numeric >= 4) {
          return 'priority-medium';
        }
        return 'priority-low';
      }

      function handleMentionInputEvent() {
        const input = document.getElementById('message-input');
        if (!input) {
          return;
        }
        const caret = input.selectionStart || 0;
        const beforeText = input.value.slice(0, caret);
        const match = beforeText.match(/@([a-zA-Z0-9_\-]*)$/);
        if (match) {
          mentionState.active = true;
          mentionState.startIndex = caret - match[0].length;
          mentionState.prefix = (match[1] || '').toLowerCase();
          showMentionSuggestions(mentionState.prefix);
        } else {
          hideMentionSuggestions();
        }
      }

      function showMentionSuggestions(prefix) {
        const container = document.getElementById('mention-suggestions');
        if (!container) {
          return;
        }
        if (mentionState.hideTimer) {
          clearTimeout(mentionState.hideTimer);
          mentionState.hideTimer = null;
        }
        const normalizedPrefix = (prefix || '').toLowerCase();
        const filtered = (allAgents || [])
          .filter(agent => agent.is_enabled !== false)
          .filter(agent => {
            const id = (agent.id || '').toLowerCase();
            const name = (agent.display_name || '').toLowerCase();
            if (!normalizedPrefix) {
              return true;
            }
            return id.includes(normalizedPrefix) || name.includes(normalizedPrefix);
          }).slice(0, 6);

        if (!filtered.length) {
          hideMentionSuggestions();
          return;
        }

        const items = filtered.map(agent => {
          const displayName = escapeHtml(agent.display_name || agent.id);
          const agentId = escapeHtml(agent.id);
          const name = `${displayName} (${agentId})`;
          const roles = Array.isArray(agent.roles) && agent.roles.length
            ? escapeHtml(agent.roles.join(', '))
            : '未分配';
          return `
            <button type="button" class="mention-suggestion-item" onclick="insertMention('${agentId}')">
              <strong>${name}</strong>
              <span class="mention-suggestion-role">${roles}</span>
            </button>
          `;
        }).join('');
        container.innerHTML = '<div class="mention-suggestion-header">选择要 @ 的 Agent</div>' + items;
        container.style.display = 'block';
      }

      function hideMentionSuggestions() {
        const container = document.getElementById('mention-suggestions');
        mentionState.active = false;
        mentionState.startIndex = -1;
        mentionState.prefix = '';
        if (container) {
          container.style.display = 'none';
          container.innerHTML = '';
        }
      }

      window.insertMention = function(agentId) {
        const input = document.getElementById('message-input');
        if (!input) {
          return;
        }
        const caret = input.selectionStart || 0;
        const start = mentionState.active && mentionState.startIndex >= 0
          ? mentionState.startIndex
          : caret;
        const before = input.value.slice(0, start);
        const after = input.value.slice(caret);
        const insertion = '@' + agentId + ' ';
        input.value = before + insertion + after;
        const newCaret = before.length + insertion.length;
        input.setSelectionRange(newCaret, newCaret);
        input.focus();
        hideMentionSuggestions();
      };

      function initMentionInput() {
        const input = document.getElementById('message-input');
        const container = document.getElementById('mention-suggestions');
        if (!input || !container) {
          return;
        }
        input.addEventListener('keyup', handleMentionInputEvent);
        input.addEventListener('click', handleMentionInputEvent);
        input.addEventListener('blur', () => {
          mentionState.hideTimer = window.setTimeout(() => hideMentionSuggestions(), 150);
        });
        container.addEventListener('mousedown', (event) => {
          event.preventDefault();
        });
      }
      let blackboardSessions = [];
      let currentSessionId = null;
      const GOVERNANCE_POLL_INTERVAL = 20000;
      const SESSION_SCENARIO_LABELS = {
        new_feature: '新功能/迭代',
        bug_fix: '缺陷修复',
        doc_work: '文档交付',
        optimization: '性能/优化',
        refactor: '重构/架构',
        ops_hotfix: '运维/Hotfix',
        test_request: '测试/验证',
        discussion: '讨论/咨询'
      };
      const VOTE_TIMEOUT_WARNING_THRESHOLD = 60000;
      let governancePollTimer = null;
      const governanceSummary = {
        pendingVotes: 0,
        timeoutVotes: 0,
        pendingApprovals: 0,
        nextPendingVoteId: null,
        nextTimeoutVoteId: null,
        nextPendingApprovalId: null,
        pollingActive: false,
        lastPolledAt: null,
        unreadNotifications: 0
      };
      let allMcpServers = [];
      const mcpToolsCache = new Map();
      const mcpServerStatus = new Map();
      const pendingAgentRefresh = new Set();
      const pendingMcpRefresh = new Set();
      let currentMcpServerEditId = null;
      let currentVoteDetail = null;
      let currentApprovalDetail = null;
      let governanceHistoryPage = 1;
      let governanceHistoryHasMore = false;
      const GOVERNANCE_HISTORY_PAGE_SIZE = 50;
      const WORKSPACE_THINKING_LIMIT = 120;
      let pendingCreateSessionId = null;
      let pendingDeleteSessionId = null;
      let sessionIdToAutoSelect = null;
      let latestTaskMetrics = null;
      let latestTaskMetricsSessionId = null;
      let taskMetricsRefreshTimer = null;
      const governanceHistoryFilters = {
        type: 'all',
        action: 'all',
        entityQuery: '',
        search: ''
      };
      const GOVERNANCE_ACTION_LABELS = {
        topic_created: '发起投票',
        vote_cast: '投票',
        topic_closed: '投票结束',
        topic_timeout: '投票超时',
        approval_created: '发起审批',
        approval_approved: '审批通过',
        approval_rejected: '审批拒绝',
        task_timeout_requeued: '任务超时重试',
        task_timeout_failed: '任务超时失败',
        task_failed: '任务失败'
      };
      let governanceAnalyticsRange = '7d';
      let governanceAnalyticsType = 'all';
      let governanceAnalyticsData = null;

      const messageInputEl = document.getElementById('message-input');
      if (messageInputEl) {
        messageInputEl.addEventListener('input', handleMessageInputChange);
        messageInputEl.addEventListener('blur', handleMessageInputChange);
      }
      updateMessageTemplates();

      scheduleWorkflowSnapshot(0);
      renderWorkflowTemplateBadge();
      vscode.postMessage({ type: 'request_workflow_template' });

      function getSessionScenarioLabel(session) {
        if (!session || !session.metadata) {
          return '';
        }
        const raw = session.metadata.scenario;
        const list = Array.isArray(raw) ? raw : raw ? [raw] : [];
        if (!list.length) {
          return '';
        }
        return list
          .map(id => SESSION_SCENARIO_LABELS[id] || id)
          .join('、');
      }

      function renderBlackboardSessions(sessions) {
        const select = document.getElementById('session-select');
        const currentLabel = document.getElementById('blackboard-current-session');
        const scenarioLabelEl = document.getElementById('blackboard-session-scenario');
        if (!select || !currentLabel) {
          return;
        }

        if (!sessions || sessions.length === 0) {
          select.innerHTML = '<option value="">暂无会话</option>';
          select.disabled = true;
          currentLabel.textContent = '--';
          if (scenarioLabelEl) {
            scenarioLabelEl.textContent = '场景：--';
          }
          return;
        }
        select.disabled = false;
        const activeSessionId = currentSessionId && sessions.some(session => session.id === currentSessionId)
          ? currentSessionId
          : sessions[0].id;
        select.innerHTML = sessions.map(session => {
          const label = escapeHtml(session.id);
          const scenarioText = getSessionScenarioLabel(session);
          const displayLabel = scenarioText ? `${label} · ${scenarioText}` : label;
          const selected = session.id === activeSessionId ? ' selected' : '';
          return '<option value="' + label + '"' + selected + '>' + displayLabel + '</option>';
        }).join('');
        select.value = activeSessionId || '';
        currentLabel.textContent = activeSessionId ? escapeHtml(activeSessionId) : '--';
        const activeSession = sessions.find(session => session.id === activeSessionId) || null;
        const activeScenario = getSessionScenarioLabel(activeSession);
        if (scenarioLabelEl) {
          scenarioLabelEl.textContent = activeScenario ? `场景：${activeScenario}` : '场景：--';
        }
      }

      function clampText(value, max = 40) {
        if (!value) {
          return '';
        }
        const next = String(value).trim();
        return next.length > max ? next.slice(0, max) + '…' : next;
      }

      function resetTaskMetricsTile(hintText = '等待任务数据') {
        const tile = document.getElementById('gov-summary-task-health');
        if (!tile) {
          return;
        }
        const valueEl = tile.querySelector('.summary-tile-value');
        const metaEl = tile.querySelector('.summary-tile-meta');
        if (valueEl) valueEl.textContent = '--';
        if (metaEl) metaEl.textContent = hintText;
      }

      function renderTaskMetrics(metrics) {
        const tile = document.getElementById('gov-summary-task-health');
        if (!tile) {
          return;
        }
        const valueEl = tile.querySelector('.summary-tile-value');
        const metaEl = tile.querySelector('.summary-tile-meta');
        const activeSession = currentSessionId || null;

        if (!metrics) {
          latestTaskMetrics = null;
          latestTaskMetricsSessionId = null;
          if (valueEl) valueEl.textContent = '--';
          if (metaEl) metaEl.textContent = activeSession ? '等待任务数据' : '等待任务数据';
          return;
        }

        const metricSessionId = metrics.session_id ?? null;
        const metricScope = metrics.scope || (metricSessionId ? 'session' : 'global');

        if (activeSession) {
          if (!metricSessionId) {
            return;
          }
          if (metricSessionId !== activeSession) {
            return;
          }
        } else if (metricSessionId && metricScope === 'session') {
          return;
        }

        latestTaskMetrics = metrics;
        latestTaskMetricsSessionId = metricSessionId;

        if (valueEl) {
          valueEl.textContent = `${metrics.running}/${metrics.total}`;
        }
        if (metaEl) {
          if (metrics.last_timeout) {
            metaEl.textContent = clampText(metrics.last_timeout.message, 48);
          } else {
            metaEl.textContent = `排队 ${metrics.queued} · 阻塞 ${metrics.blocked}`;
          }
        }
      }

      window.switchBlackboardSession = function(sessionId) {
        setCurrentSession(sessionId || null, { reason: 'manual-switch' });
      };

      // Utility functions
      function padTimeUnit(value) {
        return value < 10 ? '0' + value : String(value);
      }

      function formatAbsoluteTime(timestamp) {
        if (!timestamp) {
          return '未知';
        }
        const date = new Date(timestamp);
        if (Number.isNaN(date.getTime())) {
          return '未知';
        }
        const year = date.getFullYear();
        const month = padTimeUnit(date.getMonth() + 1);
        const day = padTimeUnit(date.getDate());
        const hours = padTimeUnit(date.getHours());
        const minutes = padTimeUnit(date.getMinutes());
        const seconds = padTimeUnit(date.getSeconds());
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      }

      function formatAbsoluteWithRelative(timestamp, emptyText = '未设置') {
        if (!timestamp) {
          return emptyText;
        }
        const absolute = formatAbsoluteTime(timestamp);
        const relative = formatTime(timestamp);
        return `${absolute} · ${relative}`;
      }

      function formatTime(timestamp) {
        if (!timestamp) return '未知';
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return days + '天前';
        if (hours > 0) return hours + '小时前';
        if (minutes > 0) return minutes + '分钟前';
        return '刚刚';
      }

      function syncBlackboardEventEntries(messages) {
        const scoped = Array.isArray(messages) ? messages : [];
        blackboardEventEntries = scoped
          .filter(msg => getMessageVisibilityValue(msg) === 'event_log')
          .map(msg => ({
            id: msg.id,
            sourceLabel: getAgentName(msg.agent_id),
            severity: deriveEventSeverityFromMessage(msg),
            title: clampText(msg.content || '', 96),
            metaParts: buildEventMetaPartsFromMessage(msg),
            timestamp: msg.created_at || Date.now(),
            category: 'system'
          }));
        renderOrchestrationEvents();
      }

      function addOrchestrationEvent(entry) {
        if (!entry) {
          return;
        }
        const normalized = {
          category: entry.category || 'system',
          ...entry
        };
        orchestrationEvents.unshift(normalized);
        if (orchestrationEvents.length > MAX_ORCHESTRATION_EVENTS) {
          orchestrationEvents.pop();
        }
        renderOrchestrationEvents();
      }

      function renderOrchestrationEvents() {
        const container = document.getElementById('orchestration-event-list');
        const badge = document.getElementById('orchestration-event-count');
        const summaryEl = document.getElementById('orchestration-summary');
        if (!container) {
          return;
        }
        const combinedEvents = [
          ...blackboardEventEntries,
          ...orchestrationEvents
        ].sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
         .slice(0, MAX_ORCHESTRATION_EVENTS);
        const filteredEvents = combinedEvents.filter(event => {
          if (!event.category) {
            return true;
          }
          return orchestrationEventFilter.has(event.category);
        });
        const schedulerCount = filteredEvents.filter(event => event.category === 'scheduler').length;
        const sentinelCount = filteredEvents.filter(event => event.category === 'sentinel').length;
        const systemCount = filteredEvents.filter(event => event.category === 'system').length;
        const warningCount = filteredEvents.filter(event => event.severity === 'warning' || event.severity === 'critical').length;
        const lastEvent = filteredEvents[0];
        if (summaryEl) {
          summaryEl.innerHTML = filteredEvents.length
            ? `
                <span>调度事件 <strong>${schedulerCount}</strong></span>
                <span>巡检事件 <strong>${sentinelCount}</strong></span>
                <span>系统消息 <strong>${systemCount}</strong></span>
                <span>高危/警告 <strong>${warningCount}</strong></span>
                <span>最近更新 ${lastEvent ? formatTime(lastEvent.timestamp || Date.now()) : '—'}</span>
              `
            : '<span>暂无事件汇总</span>';
        }
        if (filteredEvents.length === 0) {
          container.innerHTML = '<div class="empty-state">暂无调度/巡检事件</div>';
        } else {
          container.innerHTML = filteredEvents.map(event => `
            <div class="orch-event severity-${event.severity}">
              <div class="orch-event-head">
                <span class="orch-event-source">${escapeHtml(event.sourceLabel)}</span>
                <span class="orch-event-time">${formatTime(event.timestamp)}</span>
              </div>
              <div class="orch-event-title">${escapeHtml(event.title)}</div>
              <div class="orch-event-meta">
                ${event.metaParts.map(part => `<span>${escapeHtml(part)}</span>`).join('')}
              </div>
            </div>
          `).join('');
        }
        if (badge) {
          badge.textContent = combinedEvents.length ? String(combinedEvents.length) : '';
        }
        updateOrchestrationFilterUI();
      }

      function updateOrchestrationFilterUI() {
        const group = document.getElementById('orchestration-filter-group');
        if (!group) {
          return;
        }
        group.querySelectorAll('.orchestration-filter-btn').forEach(btn => {
          const filter = btn.getAttribute('data-filter');
          if (!filter) {
            return;
          }
          if (orchestrationEventFilter.has(filter)) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
      }

      window.toggleOrchestrationFilter = function(filter) {
        if (!filter) {
          return;
        }
        if (orchestrationEventFilter.has(filter)) {
          if (orchestrationEventFilter.size === 1) {
            return;
          }
          orchestrationEventFilter.delete(filter);
        } else {
          orchestrationEventFilter.add(filter);
        }
        renderOrchestrationEvents();
      };

      function scheduleWorkflowSnapshot(delay = 200) {
        if (workflowSnapshotTimer) {
          clearTimeout(workflowSnapshotTimer);
        }
        workflowSnapshotTimer = window.setTimeout(() => {
          workflowSnapshotTimer = null;
          vscode.postMessage({ type: 'get_workflow_instances' });
        }, delay);
      }

      function handleWorkflowInstancesUpdate(payload) {
        workflowInstanceSummaries = Array.isArray(payload) ? payload : [];
        scheduleWorkflowSnapshot(120);
      }

      function handleWorkflowInstancesData(payload) {
        workflowInstanceDetails = Array.isArray(payload) ? payload : [];
        ensureWorkflowInstanceSelection();
        renderWorkflowStagePanel();
        renderWorkflowTodos();
        requestProofRecordsSnapshot();
      }

      function getWorkflowInstancesForSession(sessionId) {
        if (!sessionId) {
          return [];
        }
        return workflowInstanceDetails.filter(instance => (instance.sessionId || null) === sessionId);
      }

      function getWorkflowInstanceDetailById(instanceId) {
        if (!instanceId) {
          return null;
        }
        return workflowInstanceDetails.find(instance => instance.id === instanceId) || null;
      }

      function ensureWorkflowInstanceSelection() {
        if (!currentSessionId) {
          currentWorkflowInstanceId = null;
          return;
        }
        const candidates = getWorkflowInstancesForSession(currentSessionId);
        if (!candidates.length) {
          currentWorkflowInstanceId = null;
          workflowInstanceSelections.delete(currentSessionId);
          return;
        }
        if (currentWorkflowInstanceId && candidates.some(instance => instance.id === currentWorkflowInstanceId)) {
          return;
        }
        const preferred = pickPreferredWorkflowInstance(candidates);
        currentWorkflowInstanceId = preferred?.id || null;
        if (currentWorkflowInstanceId) {
          workflowInstanceSelections.set(currentSessionId, currentWorkflowInstanceId);
        }
      }

      function pickPreferredWorkflowInstance(instances) {
        if (!Array.isArray(instances) || instances.length === 0) {
          return null;
        }
        const running = instances.find(instance => instance.status === 'running' || (instance.activePhases && instance.activePhases.length > 0));
        if (running) {
          return running;
        }
        return [...instances].sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0))[0] || instances[0];
      }

      function applyProofRecords(records) {
        workflowProofRecords = Array.isArray(records) ? records : [];
        renderWorkflowTodos();
      }

      function requestProofRecordsSnapshot() {
        if (!currentSessionId) {
          return;
        }
        const instance = getCurrentWorkflowInstanceDetail();
        const payload = {
          session_id: currentSessionId
        };
        if (instance?.id) {
          payload.workflow_instance_id = instance.id;
        }
        vscode.postMessage({
          type: 'get_proof_records',
          data: payload
        });
      }

      function getCurrentWorkflowInstanceDetail() {
        if (!currentSessionId) {
          return null;
        }
        ensureWorkflowInstanceSelection();
        if (currentWorkflowInstanceId) {
          const targeted = getWorkflowInstanceDetailById(currentWorkflowInstanceId);
          if (targeted) {
            return targeted;
          }
        }
        const fallback = getWorkflowInstancesForSession(currentSessionId)[0] || null;
        if (fallback) {
          currentWorkflowInstanceId = fallback.id;
          workflowInstanceSelections.set(currentSessionId, fallback.id);
        }
        return fallback;
      }

      function getCurrentWorkflowSummary(instanceId) {
        return workflowInstanceSummaries.find(item => item.id === instanceId) || null;
      }

      function extractInstanceScenario(instance) {
        if (!instance) {
          return [];
        }
        const collected = [];
        const summary = getCurrentWorkflowSummary(instance.id);
        if (Array.isArray(summary?.scenario)) {
          collected.push(...summary.scenario);
        }
        if (Array.isArray(instance.metadata?.scenario)) {
          collected.push(...instance.metadata.scenario);
        }
        if (Array.isArray(instance.metadata?.scenario_tags)) {
          collected.push(...instance.metadata.scenario_tags);
        }
        if (typeof instance.metadata?.scenario === 'string' && instance.metadata.scenario.trim()) {
          collected.push(instance.metadata.scenario.trim());
        }
        return collected.filter(Boolean);
      }

      const WORKFLOW_INSTANCE_STATUS_LABELS = {
        running: '进行中',
        completed: '已完成',
        failed: '失败',
        blocked: '阻塞',
        pending: '待启动'
      };

      const WORKFLOW_INSTANCE_STATUS_CLASS = {
        running: 'running',
        completed: 'completed',
        failed: 'failed',
        blocked: 'blocked'
      };

      const WORKFLOW_INSTANCE_FILTER_LABELS = {
        all: '全部',
        running: '进行中',
        completed: '已完成',
        blocked: '阻塞/失败'
      };

      function getWorkflowInstanceStatusLabel(status) {
        if (!status) {
          return WORKFLOW_INSTANCE_STATUS_LABELS.pending;
        }
        return WORKFLOW_INSTANCE_STATUS_LABELS[status] || status;
      }

      function getWorkflowInstanceStatusClass(status) {
        if (!status) {
          return 'pending';
        }
        return WORKFLOW_INSTANCE_STATUS_CLASS[status] || status;
      }

      function formatInstanceScenarioLabel(instance) {
        const scenarios = extractInstanceScenario(instance);
        if (scenarios.length > 0) {
          return Array.from(new Set(scenarios)).slice(0, 2).join(' / ');
        }
        return null;
      }

  function formatInstanceDisplayName(instance, fallbackIndex = 0) {
    const scenarioLabel = formatInstanceScenarioLabel(instance);
    if (scenarioLabel) {
      return scenarioLabel;
    }
    return `实例 ${fallbackIndex + 1}`;
  }

  function getInstanceScenarioTags(instance) {
    const extracted = extractInstanceScenario(instance);
    const tags = Array.isArray(extracted)
      ? extracted.map(value => String(value).trim()).filter(Boolean)
      : [];
    const unique = Array.from(new Set(tags));
    if (unique.length === 0) {
      unique.push(DEFAULT_SCENARIO_LABEL);
    }
    return unique;
  }

      function getInstanceColor(instanceId) {
        if (!instanceId) {
          return INSTANCE_COLOR_PALETTE[0];
        }
        if (!workflowInstanceColorMap.has(instanceId)) {
          const color = INSTANCE_COLOR_PALETTE[workflowInstanceColorMap.size % INSTANCE_COLOR_PALETTE.length];
          workflowInstanceColorMap.set(instanceId, color);
        }
        return workflowInstanceColorMap.get(instanceId);
      }

      function renderWorkflowInstanceSelector(instances, activeInstanceId) {
        const container = document.getElementById('workflow-instance-selector');
        if (!container) {
          return;
        }
        if (!currentSessionId) {
          container.innerHTML = '<div class="workflow-instance-placeholder">请选择会话以查看 Workflow 实例</div>';
          return;
        }
        if (!instances || instances.length === 0) {
          container.innerHTML = '<div class="workflow-instance-placeholder">等待 Workflow Kernel 创建实例</div>';
          return;
        }
        container.innerHTML = instances.map((instance, index) => {
          const isActive = instance.id === activeInstanceId;
          const color = getInstanceColor(instance.id);
          const title = formatInstanceDisplayName(instance, index);
          const statusLabel = getWorkflowInstanceStatusLabel(instance.status || 'running');
          return `
            <button class="workflow-instance-pill ${isActive ? 'active' : ''}"
              style="--instance-color:${color}"
              data-instance-id="${instance.id}"
              onclick="selectWorkflowInstance('${instance.id}')">
              <span class="pill-title">${escapeHtml(title)}</span>
              <span class="pill-meta">#${escapeHtml(instance.id.slice(-4))} · ${escapeHtml(statusLabel)}</span>
            </button>
          `;
        }).join('');
      }

      function renderWorkflowInstanceList() {
        const listEl = document.getElementById('workflow-instance-list');
        const summaryEl = document.getElementById('workflow-instance-summary');
        const statsEl = document.getElementById('workflow-instance-stats');
        const scenarioEl = document.getElementById('workflow-instance-scenario-filter');
        const participantEl = document.getElementById('workflow-instance-participant-filter');
        const filterBar = document.getElementById('workflow-instance-filters');
        if (filterBar) {
          filterBar.querySelectorAll('.workflow-instance-filter-btn').forEach(btn => {
            const filter = btn.getAttribute('data-filter');
            if (filter === workflowInstanceFilter) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });
        }
        if (!listEl) {
          return;
        }
        if (!currentSessionId) {
          listEl.innerHTML = '<div class="workflow-instance-placeholder">请选择会话以加载实例列表</div>';
          if (summaryEl) summaryEl.textContent = '等待选择会话';
          if (statsEl) statsEl.innerHTML = '';
          if (scenarioEl) scenarioEl.innerHTML = '';
          if (participantEl) participantEl.innerHTML = '<div class="workflow-instance-placeholder">等待选择会话</div>';
          return;
        }
        const instances = getWorkflowInstancesForSession(currentSessionId);
        if (!instances.length) {
          listEl.innerHTML = '<div class="workflow-instance-placeholder">尚未创建 Workflow 实例</div>';
          if (summaryEl) summaryEl.textContent = '无实例 · 等待流程启动';
          if (statsEl) statsEl.innerHTML = '<div class="workflow-instance-placeholder">暂无实例数据</div>';
          if (scenarioEl) scenarioEl.innerHTML = '<div class="workflow-instance-placeholder">暂无场景标签</div>';
          if (participantEl) participantEl.innerHTML = '<div class="workflow-instance-placeholder">暂无负责人</div>';
          workflowInstanceScenarioFilter = null;
          workflowInstanceParticipantFilter = null;
          return;
        }
        const runningCount = instances.filter(instance => instance.status === 'running').length;
        const completedCount = instances.filter(instance => {
          const summary = getCurrentWorkflowSummary(instance.id) || instance;
          return summary.status === 'completed';
        }).length;
        const blockedCount = instances.filter(instance => {
          const summary = getCurrentWorkflowSummary(instance.id) || instance;
          const blocked = summary.blockedPhases ? summary.blockedPhases.length : 0;
          return summary.status === 'failed' || blocked > 0;
        }).length;

        if (summaryEl) {
          summaryEl.textContent = `${instances.length} 个实例 · 进行中 ${runningCount}`;
        }
        if (statsEl) {
          statsEl.innerHTML = `
            <div class="workflow-instance-stat-card">
              <span class="workflow-instance-stat-label">进行中</span>
              <span class="workflow-instance-stat-value">${runningCount}</span>
            </div>
            <div class="workflow-instance-stat-card">
              <span class="workflow-instance-stat-label">阻塞 / 失败</span>
              <span class="workflow-instance-stat-value">${blockedCount}</span>
            </div>
            <div class="workflow-instance-stat-card">
              <span class="workflow-instance-stat-label">已完成</span>
              <span class="workflow-instance-stat-value">${completedCount}</span>
            </div>
          `;
        }

        const scenarioCounts = new Map();
        instances.forEach(instance => {
          const tags = getInstanceScenarioTags(instance);
          tags.forEach(tag => {
            scenarioCounts.set(tag, (scenarioCounts.get(tag) || 0) + 1);
          });
        });
        if (scenarioEl) {
          if (!scenarioCounts.size) {
            scenarioEl.innerHTML = '<div class="workflow-instance-placeholder">暂无场景标签</div>';
          } else {
            const chips = [];
            chips.push(`
              <button class="workflow-instance-scenario-chip ${!workflowInstanceScenarioFilter ? 'active' : ''}"
                data-scenario=""
                onclick="setWorkflowScenarioFilter(null)">全部</button>
            `);
            const sortedScenarios = Array.from(scenarioCounts.entries())
              .sort((a, b) => b[1] - a[1])
              .slice(0, 8);
            sortedScenarios.forEach(([label, count]) => {
              const isActive = workflowInstanceScenarioFilter === label;
              const serialized = JSON.stringify(label);
              chips.push(`
                <button class="workflow-instance-scenario-chip ${isActive ? 'active' : ''}"
                  data-scenario="${escapeHtml(label)}"
                  onclick="setWorkflowScenarioFilter(${serialized})">
                  ${escapeHtml(label)} (${count})
                </button>
              `);
            });
            scenarioEl.innerHTML = chips.join('');
          }
        }

        if (participantEl) {
          const participantCounts = new Map();
          instances.forEach(instance => {
            getInstanceParticipants(instance.id, Number.POSITIVE_INFINITY).forEach(participant => {
              if (!participant || !participant.id) {
                return;
              }
              if (!participantCounts.has(participant.id)) {
                participantCounts.set(participant.id, {
                  count: 0,
                  name: participant.name || participant.id
                });
              }
              participantCounts.get(participant.id).count += 1;
            });
          });
          if (!participantCounts.size) {
            participantEl.innerHTML = '<div class="workflow-instance-placeholder">暂无负责人</div>';
          } else {
            const chips = [];
            chips.push(`
              <button class="workflow-instance-participant-chip ${!workflowInstanceParticipantFilter ? 'active' : ''}"
                data-participant=""
                onclick="setWorkflowParticipantFilter('')">全部</button>
            `);
            Array.from(participantCounts.entries())
              .sort((a, b) => b[1].count - a[1].count)
              .slice(0, 10)
              .forEach(([id, meta]) => {
                const active = workflowInstanceParticipantFilter === id;
                const serializedId = JSON.stringify(id);
                chips.push(`
                  <button class="workflow-instance-participant-chip ${active ? 'active' : ''}"
                    data-participant="${escapeHtml(id)}"
                    onclick="setWorkflowParticipantFilter(${serializedId})">
                    ${escapeHtml(meta.name)} (${meta.count})
                  </button>
                `);
              });
            participantEl.innerHTML = chips.join('');
          }
        }

        const filtered = instances.filter(instance => {
          const summary = getCurrentWorkflowSummary(instance.id) || instance;
          const blockedCount = summary.blockedPhases ? summary.blockedPhases.length : 0;
          switch (workflowInstanceFilter) {
            case 'running':
              return summary.status === 'running' || (summary.activePhases && summary.activePhases.length > 0);
            case 'completed':
              return summary.status === 'completed';
            case 'blocked':
              return summary.status === 'failed' || blockedCount > 0;
            default:
              return true;
          }
        }).filter(instance => {
          if (!workflowInstanceScenarioFilter) {
            return true;
          }
          const tags = getInstanceScenarioTags(instance).map(tag => tag.toLowerCase());
          return tags.includes(workflowInstanceScenarioFilter.toLowerCase());
        }).filter(instance => {
          if (!workflowInstanceParticipantFilter) {
            return true;
          }
          const participants = getInstanceParticipants(instance.id, Number.POSITIVE_INFINITY);
          return participants.some(entry => entry.id === workflowInstanceParticipantFilter);
        });
        if (!filtered.length) {
          listEl.innerHTML = `<div class="workflow-instance-placeholder">当前筛选（${WORKFLOW_INSTANCE_FILTER_LABELS[workflowInstanceFilter] || workflowInstanceFilter}）无匹配实例</div>`;
          return;
        }
        listEl.innerHTML = filtered.map((instance, index) => {
          const summary = getCurrentWorkflowSummary(instance.id) || instance;
          const title = formatInstanceDisplayName(instance, index);
          const statusLabel = getWorkflowInstanceStatusLabel(summary.status || instance.status || 'running');
          const statusClass = getWorkflowInstanceStatusClass(summary.status || instance.status || 'running');
          const color = getInstanceColor(instance.id);
          const activePhases = summary.activePhases && summary.activePhases.length
            ? summary.activePhases.map(phaseId => getPhaseMeta(phaseId)?.title || phaseId).filter(Boolean).join('、')
            : null;
          const blockedCount = summary.blockedPhases ? summary.blockedPhases.length : 0;
          const scenario = formatInstanceScenarioLabel(instance) || '默认流程';
          const updated = formatTime(summary.updatedAt || instance.updatedAt || instance.createdAt);
          const isSelected = currentWorkflowInstanceId === instance.id;
          const progress = computeInstanceProgress(instance);
          return `
            <button class="workflow-instance-card ${isSelected ? 'selected' : ''}"
              style="--instance-color:${color}"
              data-instance-id="${instance.id}"
              onclick="selectWorkflowInstance('${instance.id}')">
              <div class="workflow-instance-card-head">
                <span class="workflow-instance-card-title">${escapeHtml(title)}</span>
                <span class="workflow-instance-status ${statusClass}">${escapeHtml(statusLabel)}</span>
              </div>
              <div class="workflow-instance-card-meta">
                <span>场景：${escapeHtml(scenario)}</span>
                <span>${activePhases ? `活跃阶段：${escapeHtml(activePhases)}` : '活跃阶段：—'}</span>
                <span>${blockedCount ? `阻塞阶段：${blockedCount}` : '阻塞阶段：—'}</span>
                <span>更新：${escapeHtml(updated)}</span>
              </div>
              <div class="workflow-instance-progress">
                <div class="workflow-instance-progress-bar"><span style="width:${progress.percent}%;"></span></div>
                <div class="workflow-instance-progress-meta">
                  <span>阶段 ${progress.completed}/${progress.total}</span>
                  <span>激活 ${progress.active}</span>
                </div>
              </div>
            </button>
          `;
        }).join('');

        if (pendingWorkflowFocusId) {
          const targetId = pendingWorkflowFocusId;
          const existsInSession = instances.some(instance => instance.id === targetId);
          if (existsInSession) {
            pendingWorkflowFocusId = null;
            setTimeout(() => focusWorkflowInstance(targetId), 0);
          }
        }
      }

      function getPhaseRuntime(instance, phaseId) {
        return instance?.phaseState ? instance.phaseState[phaseId] : undefined;
      }

      function getPhaseTitle(phaseId) {
        const phase = getPhaseMeta(phaseId);
        if (phase) {
          return phase.title || phase.id;
        }
        return phaseId || '未知阶段';
      }

      function getTasksForPhase(phaseId) {
        if (!Array.isArray(sessionTasks)) {
          return [];
        }
        const marker = `workflow_phase:${phaseId}`;
        return sessionTasks.filter(task => Array.isArray(task.labels) && task.labels.includes(marker));
      }

      function getProofRecordsForPhase(instanceId, phaseId) {
        if (!instanceId) {
          return [];
        }
        return workflowProofRecords.filter(record =>
          record.workflow_instance_id === instanceId && record.phase_id === phaseId
        );
      }

      function buildProofEntryList(records, emptyMessage = '暂无待处理证据') {
        if (!records || records.length === 0) {
          return `<div class="workflow-proof-entry-list"><div class="empty-state">${escapeHtml(emptyMessage)}</div></div>`;
        }
        return `
          <div class="workflow-proof-entry-list">
            ${records.map(record => buildProofEntry(record)).join('')}
          </div>
        `;
      }

      function buildProofEntry(record) {
        const statusLabel = PROOF_STATUS_LABELS[record.attestation_status] || record.attestation_status;
        const evidenceLink = record.evidence_uri
          ? `<a href="${escapeHtml(record.evidence_uri)}" target="_blank">查看</a>`
          : '暂无';
        const submittedAt = formatTime(record.created_at);
        const hashLine = record.hash ? `<div class="workflow-proof-entry-meta-line">哈希：${escapeHtml(record.hash)}</div>` : '';
        const actions = record.attestation_status === 'pending'
          ? `
              <div class="workflow-proof-entry-actions">
                <button class="proof-action approve" data-action="attestProof" data-proof-id="${record.id}" data-status="approved">签署</button>
                <button class="proof-action ghost" data-action="attestProof" data-proof-id="${record.id}" data-status="rejected">驳回</button>
              </div>
            `
          : `<div class="workflow-proof-entry-meta-line">签署：${escapeHtml(record.attestor_id || '—')} · ${record.attested_at ? formatTime(record.attested_at) : '时间待定'}</div>`;

        return `
          <div class="workflow-proof-entry">
            <div class="workflow-proof-entry-head">
              <span class="workflow-proof-pill type-${record.proof_type}">${record.proof_type === 'agreement' ? 'Agreement' : 'Work'}</span>
              <span class="workflow-proof-pill status-${record.attestation_status}">
                ${escapeHtml(statusLabel)}
              </span>
            </div>
            <div class="workflow-proof-entry-body">
              <div class="workflow-proof-entry-title">${escapeHtml(record.description || record.task_id || record.id)}</div>
              <div class="workflow-proof-entry-meta-line">证据：${evidenceLink}</div>
              ${hashLine}
              <div class="workflow-proof-entry-meta-line">提交：${submittedAt} · 责任人：${escapeHtml(record.created_by || '—')}</div>
            </div>
            ${actions}
          </div>
        `;
      }

      function renderWorkflowStagePanel() {
        const panel = document.getElementById('workflow-stage-panel');
        if (!panel) {
          return;
        }
        currentActivePhaseId = null;
        const subtitleEl = document.getElementById('workflow-stage-subtitle');
        const metaEl = document.getElementById('workflow-stage-meta');
        const timelineEl = document.getElementById('workflow-stage-timeline');
        const detailEl = document.getElementById('workflow-stage-detail');
        const sessionInstances = getWorkflowInstancesForSession(currentSessionId);
        renderWorkflowInstanceSelector(sessionInstances, currentWorkflowInstanceId);
        renderWorkflowInstanceList();
        if (!currentSessionId) {
          if (subtitleEl) subtitleEl.textContent = '请选择一个会话以查看流程进度';
          if (metaEl) metaEl.innerHTML = '';
          if (timelineEl) timelineEl.innerHTML = '<div class="empty-state">暂无流程实例</div>';
          if (detailEl) detailEl.innerHTML = '';
          updateMessageTemplates();
          return;
        }
        const instance = getCurrentWorkflowInstanceDetail();
        if (!instance) {
          if (subtitleEl) subtitleEl.textContent = '当前会话尚未进入标准流程';
          if (metaEl) metaEl.innerHTML = '';
          if (timelineEl) timelineEl.innerHTML = '<div class="empty-state">等待 Workflow Kernel 创建实例</div>';
          if (detailEl) detailEl.innerHTML = '';
          updateMessageTemplates();
          return;
        }
        const summary = getCurrentWorkflowSummary(instance.id) || instance;
        const templatePhases = getWorkflowPhases();
        if (subtitleEl) {
          subtitleEl.textContent = `实例 ${instance.id} · 状态 ${summary.status}`;
        }
        if (metaEl) {
          const infoParts = [];
          if (summary.activePhases?.length) {
            infoParts.push(`激活阶段：${summary.activePhases.join(', ')}`);
          }
          if (summary.blockedPhases?.length) {
            infoParts.push(`阻塞：${summary.blockedPhases.length}`);
          }
          metaEl.innerHTML = infoParts.map(part => `<span>${escapeHtml(part)}</span>`).join('');
        }
        if (timelineEl) {
          if (!templatePhases.length) {
            timelineEl.innerHTML = '<div class="empty-state">模板未提供阶段信息</div>';
          } else {
            timelineEl.innerHTML = templatePhases.map(phase => {
              const runtime = getPhaseRuntime(instance, phase.id);
              const status = runtime?.status ?? 'pending';
              const proofsCount = runtime?.proofs?.length ?? 0;
            const defectCount = runtime?.openDefects ? Object.keys(runtime.openDefects).length : 0;
            const metaParts = [];
            if (proofsCount > 0) {
              metaParts.push(`证据 ${proofsCount}`);
            }
            if (defectCount > 0) {
              metaParts.push(`缺陷 ${defectCount}`);
            }
              return `
              <div class="workflow-stage-node status-${status}">
                <div class="workflow-stage-node-spotlight"></div>
                <div class="workflow-stage-node-label">${escapeHtml(phase.title)}</div>
                <div class="workflow-stage-node-meta">${metaParts.join(' · ') || '&nbsp;'}</div>
              </div>
            `;
            }).join('');
          }
        }
        renderWorkflowInstanceDetailPanel(instance, summary);
        updateMessageTemplates();
      }

      function getPriorityWeightValue(priority) {
        if (priority === 'high') return 3;
        if (priority === 'medium') return 2;
        return 1;
      }

      function renderWorkflowTodos() {
        const todoContainer = document.getElementById('workflow-todo-list');
        const proofContainer = document.getElementById('workflow-proof-list');
        const todoCountEl = document.getElementById('workflow-todo-count');
        const proofCountEl = document.getElementById('workflow-proof-count');
        if (!todoContainer || !proofContainer) {
          return;
        }
        if (!currentSessionId) {
          todoContainer.innerHTML = '<div class="empty-state">请选择会话</div>';
          proofContainer.innerHTML = '<div class="empty-state">暂无证据数据</div>';
          if (todoCountEl) todoCountEl.textContent = '';
          if (proofCountEl) proofCountEl.textContent = '';
          return;
        }
        const instance = getCurrentWorkflowInstanceDetail();
        if (!instance) {
          todoContainer.innerHTML = '<div class="empty-state">尚未创建 Workflow 实例</div>';
          proofContainer.innerHTML = '<div class="empty-state">等待 Workflow 实例</div>';
          if (todoCountEl) todoCountEl.textContent = '';
          if (proofCountEl) proofCountEl.textContent = '';
          return;
        }
        const todoEntries = [];
        const instanceId = instance.id;
        const phases = getWorkflowPhases();
        phases.forEach(phase => {
          const runtime = getPhaseRuntime(instance, phase.id);
          if (!runtime) {
            return;
          }
          const storedProofs = getProofRecordsForPhase(instanceId, phase.id);
          if (runtime.status === 'blocked') {
            todoEntries.push({
              severity: 'warning',
              title: `${phase.title} 阶段阻塞`,
              detail: runtime.blockers?.length ? runtime.blockers[runtime.blockers.length - 1].reason || '阻塞待处理' : '阻塞待处理',
              phaseId: phase.id
            });
          }
          const needProof = phaseRequiresArtifacts(phase.id);
          const proofCount = storedProofs.length;
          if (needProof && runtime.status === 'active' && proofCount === 0) {
            todoEntries.push({
              severity: 'info',
              title: `${phase.title} 缺少证据`,
              detail: '请上传验证材料或执行测试',
              phaseId: phase.id
            });
          }
          const defectCount = runtime.openDefects ? Object.keys(runtime.openDefects).length : 0;
          if (defectCount > 0) {
            todoEntries.push({
              severity: 'critical',
              title: `${phase.title} 缺陷 ${defectCount} 个`,
              detail: '缺陷未闭环，需修复后出站',
              phaseId: phase.id
            });
          }
          const userNotes = Array.isArray(runtime?.metadata?.user_notes) ? runtime.metadata.user_notes : [];
          const pendingNotes = userNotes.filter(note => note.status !== 'resolved');
          if (pendingNotes.length > 0) {
            todoEntries.push({
              severity: 'info',
              title: `${phase.title} 用户补充 ${pendingNotes.length} 个`,
              detail: '请处理用户插话并同步结论',
              phaseId: phase.id
            });
          }
        });
        const manualTasks = (sessionTasks || [])
          .filter(task => ['pending', 'blocked', 'paused', 'running'].includes(normalizeTaskStatus(task.status)))
          .slice(0, 5);
        manualTasks.forEach(task => {
          const phaseId = (task.labels || []).find(label => label.startsWith('workflow_phase:'));
          todoEntries.push({
            severity: normalizeTaskStatus(task.status) === 'blocked' ? 'warning' : 'info',
            title: getTaskDisplayTitle(task),
            detail: `优先级 ${formatPriorityLabel(task.priority)} · ${task.assigned_to ? `负责人 ${getAgentName(task.assigned_to)}` : '未指派'}`,
            phaseId: phaseId ? phaseId.replace('workflow_phase:', '') : undefined
          });
        });
        const severityWeight = { critical: 0, warning: 1, info: 2, neutral: 3 };
        todoEntries.sort((a, b) => {
          const severityDiff = (severityWeight[a.severity || 'info'] ?? 3) - (severityWeight[b.severity || 'info'] ?? 3);
          if (severityDiff !== 0) {
            return severityDiff;
          }
          const priorityA = a.priority ? getPriorityWeightValue(a.priority) : 0;
          const priorityB = b.priority ? getPriorityWeightValue(b.priority) : 0;
          if (priorityA !== priorityB) {
            return priorityA - priorityB;
          }
          if (!a.phaseId || !b.phaseId) {
            return 0;
          }
          return getPhaseIndexPosition(a.phaseId) - getPhaseIndexPosition(b.phaseId);
        });
        if (todoContainer) {
          todoContainer.innerHTML = todoEntries.length
            ? todoEntries.map(entry => buildTodoCard(entry)).join('')
            : '<div class="empty-state">暂无阶段待办</div>';
        }
        if (todoCountEl) {
          todoCountEl.textContent = todoEntries.length ? `${todoEntries.length} 项` : '';
        }
        const proofCards = [];
        let totalProofs = 0;
        let totalPendingProofs = 0;
        let totalDefects = 0;
        phases.forEach(phase => {
          const runtime = getPhaseRuntime(instance, phase.id);
          if (!runtime) {
            return;
          }
          const proofs = getProofRecordsForPhase(instanceId, phase.id);
          const defectCount = runtime.openDefects ? Object.keys(runtime.openDefects).length : 0;
          if (!proofs.length && defectCount === 0 && !phaseRequiresArtifacts(phase.id)) {
            return;
          }
          totalProofs += proofs.length;
          totalDefects += defectCount;
          const pendingCount = proofs.filter(record => record.attestation_status === 'pending').length;
          totalPendingProofs += pendingCount;
          const actionableRecords = proofs.filter(record => record.attestation_status === 'pending');
          const displayPool = actionableRecords.length ? actionableRecords : proofs;
          const limitedRecords = displayPool.slice(0, 2);
          const remaining = displayPool.length - limitedRecords.length;
          const summaryParts = [];
          if (proofs.length) summaryParts.push(`证据 ${proofs.length}`);
          if (pendingCount) summaryParts.push(`待签署 ${pendingCount}`);
          if (defectCount) summaryParts.push(`缺陷 ${defectCount}`);
          const summaryText = summaryParts.length ? summaryParts.join(' · ') : '暂无数据';
          proofCards.push(`
            <div class="workflow-proof-card">
              <div class="workflow-proof-card-head">
                <div><strong>${escapeHtml(phase.title)}</strong> · 状态 ${escapeHtml(getWorkflowPhaseStatusText(runtime.status || 'pending'))}</div>
                <div class="workflow-stage-detail-meta">${summaryText}</div>
              </div>
              ${buildProofEntryList(limitedRecords, actionableRecords.length ? '暂无待签署记录' : '暂无证据')}
              ${remaining > 0 ? `<div class="workflow-proof-more">还有 ${remaining} 条记录，请前往治理面板查看</div>` : ''}
            </div>
          `);
        });
        proofContainer.innerHTML = proofCards.length
          ? proofCards.join('')
          : '<div class="empty-state">暂无证据 / 缺陷数据</div>';
        if (proofCountEl) {
          const parts = [];
          if (totalProofs) {
            parts.push(`证据 ${totalProofs}`);
          }
          if (totalPendingProofs) {
            parts.push(`待签署 ${totalPendingProofs}`);
          }
          if (totalDefects) {
            parts.push(`缺陷 ${totalDefects}`);
          }
          proofCountEl.textContent = parts.join(' · ');
        }
      }

      window.exportProofReport = function() {
        if (!currentSessionId) {
          updateStatus('请选择会话后再导出证据报告');
          return;
        }
        const instance = getCurrentWorkflowInstanceDetail();
        vscode.postMessage({
          type: 'export_proof_report',
          session_id: currentSessionId,
          data: {
            session_id: currentSessionId,
            workflow_instance_id: instance?.id
          }
        });
      };

      function buildTodoCard(entry) {
        return `
          <div class="workflow-todo-card severity-${entry.severity || 'info'}">
            <div><strong>${escapeHtml(entry.title)}</strong>${entry.phaseId ? ' · ' + escapeHtml(getPhaseTitle(entry.phaseId)) : ''}</div>
            <div class="workflow-stage-detail-meta">${escapeHtml(entry.detail || '')}</div>
          </div>
        `;
      }

      function buildUserNoteSection(notes, phaseId, instanceId) {
        if (!Array.isArray(notes) || notes.length === 0) {
          return `
            <div class="workflow-user-note-section">
              <div class="section-title">用户插话</div>
              <div class="empty-state">暂无用户插话</div>
            </div>
          `;
        }
        return `
          <div class="workflow-user-note-section">
            <div class="section-title">用户插话（${notes.length}）</div>
            ${notes.map(note => buildUserNoteCard(note, phaseId, instanceId)).join('')}
          </div>
        `;
      }

      function buildUserNoteCard(note, phaseId, instanceId) {
        if (!note) {
          return '';
        }
        const content = typeof note.content === 'string' ? note.content : '';
        const status = (note.status || 'pending').toLowerCase();
        const createdLabel = formatAbsoluteWithRelative(note.createdAt, '刚刚');
        const followupTask = note.followupTaskId ? getTaskById(note.followupTaskId) : null;
        const followupHtml = followupTask
          ? `<button class="note-link" data-action="focusTaskInList" data-task-id="${followupTask.id}">查看任务 ${escapeHtml(followupTask.id)}</button>`
          : '';
        const resolveButton = status !== 'resolved'
          ? `<button class="note-action-btn" data-action="resolveUserNote" data-note-id="${note.id}" data-phase-id="${phaseId}" data-instance-id="${instanceId}">标记已处理</button>`
          : '';
        return `
          <div class="workflow-user-note-card ${status}">
            <div class="workflow-user-note-header">
              <span>${createdLabel}</span>
              <span class="note-status-pill ${status}">${status === 'resolved' ? '已处理' : '待处理'}</span>
            </div>
            <div class="workflow-user-note-content">${escapeHtml(content)}</div>
            <div class="workflow-user-note-footer">
              <div class="workflow-user-note-actions">
                ${followupHtml}
                ${resolveButton}
              </div>
              ${note.followupTaskId ? `<span>跟进任务：${escapeHtml(note.followupTaskId)}</span>` : ''}
            </div>
          </div>
        `;
      }

      function renderWorkflowTemplateBadge() {
        const pill = document.getElementById('workflow-template-pill');
        if (!pill) {
          return;
        }
        if (!workflowTemplateInfo) {
          pill.textContent = '模板：加载中';
          pill.title = '等待模板信息';
          renderIntegrationTemplateHint();
          return;
        }
        pill.textContent = `模板：${escapeHtml(workflowTemplateInfo.name || workflowTemplateInfo.id)}`;
        pill.title = workflowTemplateInfo.description || workflowTemplateInfo.name || workflowTemplateInfo.id;
        renderIntegrationTemplateHint();
      }

      function renderIntegrationTemplateHint() {
        const hint = document.getElementById('integration-template-hint');
        if (!hint) {
          return;
        }
        const targets = Array.isArray(workflowTemplateInfo?.metadata?.integration_targets)
          ? workflowTemplateInfo.metadata.integration_targets
          : [];
        if (!targets.length) {
          hint.textContent = '当前模板未声明默认同步事件，可按需自定义 Webhook。';
          return;
        }
        const labels = targets.map(labelIntegrationEvent).join('、');
        hint.innerHTML = `当前模板建议同步：<strong>${labels}</strong>`;
      }

      function labelIntegrationEvent(value) {
        switch (value) {
          case 'workflow_event':
            return '流程阶段事件 (workflow_event)';
          case 'sentinel_event':
            return '巡检/告警事件 (sentinel_event)';
          case 'proof_attested':
            return 'Proof 签署事件 (proof_attested)';
          default:
            return value;
        }
      }

      function updateMessageTemplates() {
        const row = document.getElementById('message-template-row');
        if (!row) {
          return;
        }
        let templates = MESSAGE_TEMPLATES;
        if (currentActivePhaseId) {
          const phaseTemplates = MESSAGE_TEMPLATES.filter(template => template.stage === currentActivePhaseId);
          if (phaseTemplates.length) {
            templates = phaseTemplates;
          } else {
            templates = MESSAGE_TEMPLATES.filter(template => !template.stage);
          }
        } else {
          templates = MESSAGE_TEMPLATES.filter(template => !template.stage);
        }
        if (!templates.length) {
          row.innerHTML = '<span class="workflow-stage-detail-meta">暂无推荐模板</span>';
          return;
        }
        row.innerHTML = templates.map(template => `
          <button class="message-template-btn" data-action="applyMessageTemplate" data-template-id="${template.id}">
            ${escapeHtml(template.label)}
          </button>
        `).join('');
      }

      function handleMessageInputChange() {
        const input = document.getElementById('message-input');
      if (!input) {
        return;
      }
      currentMessageTypeGuess = inferMessageTypeFromContent(input.value);
    }

      function handleSchedulerEvent(payload) {
        if (!payload) {
          return;
        }
        const sessionId = payload.sessionId ?? payload.session_id ?? null;
        const taskId = payload.taskId ?? payload.task_id ?? null;
        const agentId = payload.agentId ?? payload.agent_id ?? null;
        const metadata = payload.metadata || {};
        const parts = [];
        if (sessionId) {
          parts.push(`会话 ${sessionId}`);
        }
        if (taskId) {
          parts.push(`任务 ${taskId}`);
        }
        if (agentId) {
          parts.push(`Agent ${agentId}`);
        }
        if (payload.reason) {
          parts.push(payload.reason);
        }
        if (metadata.degraded) {
          parts.push('降级模式');
        }
        const title = formatSchedulerTitle(payload);
        addOrchestrationEvent({
          id: `scheduler-${payload.timestamp || Date.now()}-${taskId || Math.random()}`,
          sourceLabel: 'Scheduler',
          severity: mapSchedulerSeverity(payload.type),
          title,
          metaParts: parts.length ? parts : ['系统事件'],
          timestamp: payload.timestamp || Date.now(),
          category: 'scheduler'
        });
      }

      function mapSchedulerSeverity(type) {
        switch (type) {
          case 'assigned':
            return 'success';
          case 'queued':
            return 'info';
          case 'reassigned':
          case 'skipped':
            return 'warning';
          case 'agent_offline':
            return 'critical';
          case 'assist_required':
            return 'warning';
          case 'human_required':
            return 'critical';
          default:
            return 'info';
        }
      }

      function formatSchedulerTitle(payload) {
        switch (payload?.type) {
          case 'assigned':
            if (payload.metadata?.degraded) {
              return '降级指派';
            }
            return '已分配任务';
          case 'reassigned':
            return '重新分配任务';
          case 'queued':
            return '等待可用 Agent';
          case 'agent_offline':
            return '检测到 Agent 离线';
          case 'assist_required':
            return '任务等待协助';
          case 'human_required':
            return '需要人工接管';
          case 'skipped':
          default:
            return '调度器更新';
        }
      }

      function handleSentinelEvent(payload) {
        if (!payload) {
          return;
        }
        const workflowInstanceId = payload.workflowInstanceId ?? payload.workflow_instance_id ?? null;
        const phaseId = payload.phaseId ?? payload.phase_id ?? null;
        const taskId = payload.taskId ?? payload.task_id ?? null;
        const agentId = payload.agentId ?? payload.agent_id ?? null;
        const parts = [];
        if (workflowInstanceId) {
          parts.push(`实例 ${workflowInstanceId}`);
        }
        if (phaseId) {
          parts.push(`阶段 ${phaseId}`);
        }
        if (taskId) {
          parts.push(`任务 ${taskId}`);
        }
        if (agentId) {
          parts.push(`Agent ${agentId}`);
        }
        addOrchestrationEvent({
          id: `sentinel-${payload.timestamp || Date.now()}-${payload.type}`,
          sourceLabel: 'Sentinel',
          severity: mapSentinelSeverity(payload.severity),
          title: payload.message || formatSentinelTitle(payload.type),
          metaParts: parts.length ? parts : ['系统巡检'],
          timestamp: payload.timestamp || Date.now(),
          category: 'sentinel'
        });
      }

      function mapSentinelSeverity(level) {
        if (level === 'warning') {
          return 'warning';
        }
        if (level === 'critical') {
          return 'critical';
        }
        return 'info';
      }

      function formatSentinelTitle(type) {
        switch (type) {
          case 'phase_timeout':
            return '阶段运行超时';
          case 'proof_missing':
            return '缺少证据';
          case 'task_stalled':
            return '任务超时';
          case 'defect_loop':
            return '缺陷未闭环';
          case 'agent_offline':
            return 'Agent 离线';
          case 'human_required':
            return '需要人工接管';
          case 'assist_required':
            return '任务需要协助';
          default:
            return '巡检提醒';
        }
      }

      renderOrchestrationEvents();

      function escapeHtml(value) {
        if (value === undefined || value === null) {
          return '';
        }
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      const ROLE_OPTIONS = [
        { value: 'admin', label: '管理员' },
        { value: 'developer', label: '开发者' },
        { value: 'reviewer', label: '审查者' },
        { value: 'tester', label: '测试者' },
        { value: 'security', label: '安全' },
        { value: 'documenter', label: '文档' },
        { value: 'coordinator', label: '协调者' },
        { value: 'analyzer', label: '分析者' }
      ];

      const CAPABILITY_OPTIONS = [
        { value: 'coding', label: 'Coding（编码）' },
        { value: 'analysis', label: 'Analysis（分析）' },
        { value: 'planning', label: 'Planning（规划）' },
        { value: 'testing', label: 'Testing（测试）' },
        { value: 'review', label: 'Review（审查）' },
        { value: 'security', label: 'Security（安全）' },
        { value: 'documentation', label: 'Documentation（文档）' },
        { value: 'devops', label: 'DevOps' }
      ];

      const TOOL_PERMISSION_OPTIONS = [
        { value: 'terminal_exec', label: '终端脚本' },
        { value: 'workspace_write', label: '工作区写入' },
        { value: 'mcp_tools', label: 'MCP 工具' },
        { value: 'web_fetch', label: 'Web 获取' },
        { value: 'context_engine', label: '上下文引擎' },
        { value: 'custom_tool', label: '自定义工具' }
      ];

      const ROLE_LABEL_MAP = ROLE_OPTIONS.reduce((map, item) => {
        map[item.value] = item.label;
        return map;
      }, {});

      const CAPABILITY_LABEL_MAP = CAPABILITY_OPTIONS.reduce((map, item) => {
        map[item.value] = item.label;
        return map;
      }, {});

      const TOOL_PERMISSION_LABEL_MAP = TOOL_PERMISSION_OPTIONS.reduce((map, item) => {
        map[item.value] = item.label;
        return map;
      }, {});

      const MESSAGE_TYPE_LABELS = {
        discussion: '讨论',
        requirement: '需求',
        warning: '告警',
        suggestion: '建议',
        question: '问题',
        decision: '决策'
      };

      const MESSAGE_TYPE_KEYWORDS = {
        requirement: ['需求', '实现', '开发', '完成', '功能', 'feature', '请实现', '帮我做', '新增', '修复'],
        warning: ['告警', '报警', '警告', '异常', '失败', '报错', 'error', '紧急', '崩溃', '故障'],
        suggestion: ['建议', '优化', '改进', 'idea', '推荐', '可否考虑'],
        question: ['怎么', '如何', '吗', '是否', '能否', '?', '？']
      };

      function getRoleText(role) {
        return ROLE_LABEL_MAP[role] || role;
      }

      function getCapabilityText(capability) {
        return CAPABILITY_LABEL_MAP[capability] || capability;
      }

      function getToolPermissionText(tool) {
        return TOOL_PERMISSION_LABEL_MAP[tool] || tool;
      }

      function getSelectedRoles(form) {
        const chips = form.querySelectorAll('#agent-roles-cloud .tag-chip.selected');
        if (!chips) return [];
        return Array.from(chips).map(chip => chip.dataset.role);
      }

      function setSelectedRoles(form, roles) {
        const roleSet = new Set(roles || []);
        const chips = form.querySelectorAll('#agent-roles-cloud .tag-chip');
        chips.forEach(chip => {
          if (roleSet.has(chip.dataset.role)) {
            chip.classList.add('selected');
          } else {
            chip.classList.remove('selected');
          }
        });
      }

      function getSelectedCapabilities(form) {
        const chips = form.querySelectorAll('#agent-capabilities-cloud .tag-chip.selected');
        return chips ? Array.from(chips).map(chip => chip.dataset.capability) : [];
      }

      function setSelectedCapabilities(form, capabilities) {
        const capabilitySet = new Set(capabilities || []);
        const chips = form.querySelectorAll('#agent-capabilities-cloud .tag-chip');

        chips.forEach(chip => {
          const capability = chip.dataset.capability;
          if (capabilitySet.has(capability)) {
            chip.classList.add('selected');
          } else {
            chip.classList.remove('selected');
          }
        });
      }

      function getSelectedToolPermissions(form) {
        const chips = form.querySelectorAll('#agent-tools-cloud .tag-chip.selected');
        return chips ? Array.from(chips).map(chip => chip.dataset.tool) : [];
      }

      function setSelectedToolPermissions(form, permissions) {
        const permissionSet = new Set(permissions || []);
        const chips = form.querySelectorAll('#agent-tools-cloud .tag-chip');
        chips.forEach(chip => {
          const tool = chip.dataset.tool;
          if (permissionSet.has(tool)) {
            chip.classList.add('selected');
          } else {
            chip.classList.remove('selected');
          }
        });
      }



      function normalizeTaskStatus(status) {
        if (status === 'pending' || status === 'queued' || status === 'assigned') {
          return 'running';
        }
        return status;
      }

      function getStatusText(status) {
        const normalized = normalizeTaskStatus(status);
        const taskMap = {
          'running': '运行中',
          'blocked': '阻塞',
          'paused': '已暂停',
          'completed': '已完成',
          'failed': '失败'
        };
        if (taskMap[normalized]) {
          return taskMap[normalized];
        }
        const map = {
          'pending': '待处理',
          'queued': '排队中',
          'assigned': '已分配',
          'online': '在线',
          'offline': '离线',
          'busy': '忙碌'
        };
        return map[status] || status;
      }

      function getVoteTypeText(type) {
        const map = {
          'simple_majority': '简单多数',
          'absolute_majority': '绝对多数',
          'unanimous': '全员同意',
          'veto': '否决权'
        };
        return map[type] || type;
      }

      function getVoteChoiceText(choice) {
        const map = {
          'approve': '赞成',
          'reject': '反对',
          'abstain': '弃权'
        };
        return map[choice] || choice;
      }

      function getThinkingStepTypeText(type) {
        const map = {
          'thought': '思考',
          'tool_call': '工具调用',
          'observation': '观察',
          'result': '结论'
        };
        return map[type] || type;
      }

      function getThinkingStepTypeClass(type) {
        if (type === 'tool_call' || type === 'observation' || type === 'result') {
          return type;
        }
        return 'thought';
      }

      function formatMultilineText(value) {
        if (value === undefined || value === null) {
          return '';
        }
        const normalized = String(value).replace(/\r\n/g, '\n').replace(/\t/g, '  ');
        return normalized.split('\n').map((line) => {
          let prefix = '';
          let idx = 0;
          while (idx < line.length && (line[idx] === ' ' || line[idx] === '\t')) {
            prefix += line[idx] === '\t' ? '&nbsp;&nbsp;' : '&nbsp;';
            idx += 1;
          }
          const rest = line.slice(idx);
          return prefix + escapeHtml(rest);
        }).join('<br>');
      }

      function stringifyPayload(value) {
        if (value === null || value === undefined) {
          return '';
        }
        if (typeof value === 'string') {
          return value;
        }
        try {
          return JSON.stringify(value, null, 2);
        } catch (error) {
          return String(value);
        }
      }

      function formatThinkingPayload(value, limit = 1200) {
      const raw = stringifyPayload(value);
      if (!raw) {
        return '';
      }
      return raw.length > limit ? raw.slice(0, limit) + '…' : raw;
    }

      function inferMessageTypeFromContent(value) {
        if (!value) {
          return null;
        }
        const text = String(value).trim();
        if (!text) {
          return null;
        }
        const normalized = text.toLowerCase();
        const includesKeyword = (keywords = []) => {
          return keywords.some(keyword => {
            const lower = keyword.toLowerCase();
            return normalized.includes(lower) || text.includes(keyword);
          });
        };
        if (includesKeyword(MESSAGE_TYPE_KEYWORDS.requirement)) {
          return 'requirement';
        }
        if (includesKeyword(MESSAGE_TYPE_KEYWORDS.warning)) {
          return 'warning';
        }
        if (includesKeyword(MESSAGE_TYPE_KEYWORDS.suggestion)) {
          return 'suggestion';
        }
      if (includesKeyword(MESSAGE_TYPE_KEYWORDS.question) || text.includes('?') || text.includes('？')) {
        return 'question';
      }
      return null;
    }

      function getMessageTypeLabel(type) {
        if (!type) {
          return '讨论';
        }
        return MESSAGE_TYPE_LABELS[type] || type;
      }

      function getApprovalDecisionText(decision) {
        const map = {
          'pending': '待审批',
          'approved': '已批准',
          'rejected': '已拒绝'
        };
        return map[decision] || decision;
      }

      function isVoteTimeoutSoon(vote) {
        if (!vote || vote.status !== 'pending' || !vote.timeout_at) {
          return false;
        }
        const now = Date.now();
        const diff = vote.timeout_at - now;
        return diff > 0 && diff <= VOTE_TIMEOUT_WARNING_THRESHOLD;
      }

      function getTaskById(taskId) {
        if (!taskId) {
          return null;
        }
        const pool = sessionTasks && sessionTasks.length > 0 ? sessionTasks : allTasks;
        return pool.find(task => task.id === taskId) || null;
      }

      function getLabelValue(labels, prefix) {
        if (!Array.isArray(labels)) {
          return null;
        }
        const match = labels.find(label => typeof label === 'string' && label.startsWith(prefix));
        return match ? match.replace(prefix, '') : null;
      }

      function formatInstanceTitle(instanceId, detail) {
        if (!detail) {
          return instanceId === 'ad_hoc' ? '临时任务' : `实例 ${instanceId}`;
        }
        const summary = (detail.metadata?.requirementContent || '').split('\n')[0]?.trim();
        return summary || `实例 ${instanceId}`;
      }

      function formatScenarioLabel(raw) {
        if (!raw) {
          return '';
        }
        const list = Array.isArray(raw) ? raw : [raw];
        return list
          .map(value => SCENARIO_LABELS[value] || value)
          .join(' / ');
      }

      function getTaskStatusLabel(status) {
        const normalized = normalizeTaskStatus(status);
        const map = {
          pending: '待办',
          queued: '排队',
          assigned: '已分配',
          running: '进行中',
          completed: '已完成',
          failed: '失败',
          blocked: '阻塞',
          paused: '已暂停'
        };
        return map[normalized] || normalized || '未知状态';
      }

      function getFileChangeById(changeId) {
        if (!changeId) {
          return null;
        }
        return allFileChanges.find(change => String(change.id) === String(changeId)) || null;
      }

      function getProofRecordById(proofId) {
        if (!proofId) {
          return null;
        }
        return workflowProofRecords.find(record => String(record.id) === String(proofId)) || null;
      }

      function formatTaskLabel(taskId) {
        if (!taskId) {
          return '未关联任务';
        }
        const task = getTaskById(taskId);
        if (!task) {
          return taskId;
        }
        const title = getTaskDisplayTitle(task);
        return `${title} (${task.id})`;
      }

      function formatGovernanceAction(action) {
        return GOVERNANCE_ACTION_LABELS[action] || action || '治理动作';
      }

      function getThinkingTypeKey(entry) {
        if (!entry) {
          return 'thought';
        }
        if (entry.type === 'thinking') {
          return entry.stepType === 'tool_call' ? 'tool' : 'thought';
        }
        if (entry.type === 'file_change') {
          return 'file';
        }
        if (entry.type === 'governance') {
          return 'governance';
        }
        if (entry.type === 'user_feedback') {
          return 'feedback';
        }
        return 'thought';
      }

      function matchesThinkingTypeFilters(entry) {
        if (!entry) {
          return false;
        }
        if (!workspaceThinkingTypeFilters || workspaceThinkingTypeFilters.size === 0 || workspaceThinkingTypeFilters.size === THINKING_TYPE_OPTIONS.length) {
          return true;
        }
        return workspaceThinkingTypeFilters.has(getThinkingTypeKey(entry));
      }

      function buildThinkingStream(agent, agentLogs, agentTasks) {
        const stream = [];
        const messages = Array.isArray(allMessages) ? allMessages : [];
        const messageById = new Map(messages.map(msg => [msg.id, msg]));
        const fileChanges = Array.isArray(allFileChanges) ? allFileChanges : [];
        const governanceEntries = Array.isArray(governanceHistoryEntries) ? governanceHistoryEntries : [];

        const pushEntry = (entry) => {
          entry.searchText = (entry.searchText || '').toLowerCase();
          stream.push(entry);
        };

        (agentLogs || []).forEach(log => {
          pushEntry({
            id: 'thinking-' + log.id,
            type: 'thinking',
            timestamp: log.created_at || Date.now(),
            taskId: log.task_id || null,
            stepType: log.step_type,
            content: log.content || '',
            tool: log.tool_name ? {
              name: log.tool_name,
              input: log.tool_input,
              output: log.tool_output
            } : null,
            searchText: [
              log.content,
              log.tool_name,
              stringifyPayload(log.tool_input),
              stringifyPayload(log.tool_output),
              log.task_id
            ].filter(Boolean).join(' ')
          });
        });

        fileChanges.forEach(change => {
          if (change.agent_id !== agent.id) {
            return;
          }
          pushEntry({
            id: 'file-' + change.id,
            type: 'file_change',
            timestamp: change.created_at || Date.now(),
            taskId: change.task_id || null,
            fileChange: change,
            searchText: [
              change.file_path,
              change.change_type,
              change.reason,
              change.diff,
              change.task_id
            ].filter(Boolean).join(' ')
          });
        });

        governanceEntries.forEach(entry => {
          if (entry.actor_id !== agent.id) {
            return;
          }
          pushEntry({
            id: 'gov-' + entry.id,
            type: 'governance',
            timestamp: entry.created_at || Date.now(),
            taskId: entry.entity_id || null,
            governance: entry,
            searchText: [
              entry.summary,
              entry.action,
              stringifyPayload(entry.payload),
              entry.entity_id
            ].filter(Boolean).join(' ')
          });
        });

        messages.forEach(msg => {
          if (msg.agent_id !== 'user' || !msg.reply_to) {
            return;
          }
          const replied = messageById.get(msg.reply_to);
          if (!replied || replied.agent_id !== agent.id) {
            return;
          }
          pushEntry({
            id: 'user-reply-' + msg.id,
            type: 'user_feedback',
            timestamp: msg.created_at || Date.now(),
            taskId: replied.task_id || null,
            userMessage: msg,
            replyTo: replied,
            searchText: [
              msg.content,
              replied.content
            ].filter(Boolean).join(' ')
          });
        });

        stream.sort((a, b) => {
          const at = a.timestamp || 0;
          const bt = b.timestamp || 0;
          return bt - at;
        });
        return stream;
      }


      function normalizeDependencyList(value) {
        if (!value) {
          return [];
        }
        if (Array.isArray(value)) {
          return value.map(item => String(item).trim()).filter(Boolean);
        }
        if (typeof value === 'string') {
          try {
            const parsed = JSON.parse(value);
            if (Array.isArray(parsed)) {
              return parsed.map(item => String(item).trim()).filter(Boolean);
            }
          } catch (error) {
            return value.split(',').map(item => item.trim()).filter(Boolean);
          }
        }
        return [];
      }

      function getDependencyNodeKey(taskId) {
        if (taskId === undefined || taskId === null) {
          return '';
        }
        return String(taskId);
      }

      function buildTaskDependencyGraph(tasks) {
        const dependencies = new Map();
        const dependents = new Map();
        const children = new Map();

        (tasks || []).forEach(task => {
          const depList = normalizeDependencyList(task.dependencies);
          dependencies.set(task.id, depList);
          depList.forEach(depId => {
            if (!dependents.has(depId)) {
              dependents.set(depId, []);
            }
            dependents.get(depId).push(task.id);
          });
          if (task.parent_task_id) {
            if (!children.has(task.parent_task_id)) {
              children.set(task.parent_task_id, []);
            }
            children.get(task.parent_task_id).push(task.id);
          }
        });

        return { dependencies, dependents, children };
      }

      function getTaskDependencies(taskId) {
        const ids = taskDependencyGraph.dependencies.get(taskId) || [];
        return ids
          .map(id => getTaskById(id))
          .filter(Boolean);
      }

      function getTaskDependents(taskId) {
        const ids = taskDependencyGraph.dependents.get(taskId) || [];
        return ids
          .map(id => getTaskById(id))
          .filter(Boolean);
      }

      function getChildTasks(taskId) {
        const ids = taskDependencyGraph.children.get(taskId) || [];
        return ids
          .map(id => getTaskById(id))
          .filter(Boolean);
      }

      function ensurePanelExpanded(panelId) {
        if (!panelId) {
          return false;
        }
        const panel = document.getElementById(panelId);
        if (!panel) {
          return false;
        }
        if (panel.classList.contains('collapsed')) {
          panel.classList.remove('collapsed');
          panel.style.flex = '1';
          panel.style.height = '';
          const btn = panel.querySelector('.panel-collapse-btn');
          if (btn) {
            btn.textContent = '▼';
          }
        }
        return true;
      }

      function highlightGovernanceCard(selector) {
        if (!selector) {
          return false;
        }
        const element = document.querySelector(selector);
        if (!element) {
          return false;
        }
        element.classList.add('governance-focus');
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => element.classList.remove('governance-focus'), 1500);
        return true;
      }

      function focusVoteCard(voteId, options = {}) {
        if (!voteId) {
          return false;
        }
        ensurePanelExpanded('panel-votes');
        highlightGovernanceCard('.vote-card[data-vote-id="' + voteId + '"]');
        if (options.openDetail !== false && typeof window.openVoteDetail === 'function') {
          window.openVoteDetail(voteId);
        }
        return true;
      }

      function focusApprovalCard(approvalId, options = {}) {
        if (!approvalId) {
          return false;
        }
        ensurePanelExpanded('panel-approvals');
        const selector = '.approval-card[data-approval-id="' + approvalId + '"]';
        highlightGovernanceCard(selector);
        if (options.openDetail !== false && typeof window.openApprovalDetail === 'function') {
          window.openApprovalDetail(approvalId);
        }
        return true;
      }

      window.showApprovalsPanel = function() {
        ensurePanelExpanded('panel-approvals');
        if (governanceSummary.nextPendingApprovalId) {
          focusApprovalCard(governanceSummary.nextPendingApprovalId);
        }
      };

      function updateGovernanceSummaryUI() {
        const votesTile = document.getElementById('gov-summary-pending-votes');
        if (votesTile) {
          const valueEl = votesTile.querySelector('.summary-tile-value');
          const metaEl = votesTile.querySelector('.summary-tile-meta');
          if (valueEl) valueEl.textContent = governanceSummary.pendingVotes.toString();
          if (metaEl) {
            metaEl.textContent = governanceSummary.timeoutVotes > 0
              ? governanceSummary.timeoutVotes + ' 条即将超时'
              : '无超时风险';
          }
        }

        const approvalsTile = document.getElementById('gov-summary-pending-approvals');
        if (approvalsTile) {
          const valueEl = approvalsTile.querySelector('.summary-tile-value');
          const metaEl = approvalsTile.querySelector('.summary-tile-meta');
          if (valueEl) valueEl.textContent = governanceSummary.pendingApprovals.toString();
          if (metaEl) {
            metaEl.textContent = governanceSummary.pendingApprovals > 0
              ? '等待用户确认'
              : '暂无审批压力';
          }
        }

        const pollingStatusEl = document.getElementById('gov-summary-polling-status');
        if (pollingStatusEl) {
          pollingStatusEl.textContent = governanceSummary.pollingActive ? '运行中' : '已停止';
        }
        const pollingUpdatedEl = document.getElementById('gov-summary-polling-updated');
        if (pollingUpdatedEl) {
          pollingUpdatedEl.textContent = governanceSummary.lastPolledAt
            ? formatTime(governanceSummary.lastPolledAt)
            : '尚未同步';
        }
        const pollingCard = document.getElementById('gov-summary-polling');
        if (pollingCard) {
          if (governanceSummary.pollingActive) {
            pollingCard.classList.add('active');
          } else {
            pollingCard.classList.remove('active');
          }
        }

        const boardVotesValue = document.getElementById('board-summary-votes-value');
        const boardVotesMeta = document.getElementById('board-summary-votes-meta');
        if (boardVotesValue) {
          boardVotesValue.textContent = governanceSummary.pendingVotes.toString();
        }
        if (boardVotesMeta) {
          boardVotesMeta.textContent = governanceSummary.timeoutVotes > 0
            ? governanceSummary.timeoutVotes + ' 条即将超时'
            : '无超时风险';
        }

        const boardApprovalsValue = document.getElementById('board-summary-approvals-value');
        const boardApprovalsMeta = document.getElementById('board-summary-approvals-meta');
        if (boardApprovalsValue) {
          boardApprovalsValue.textContent = governanceSummary.pendingApprovals.toString();
        }
        if (boardApprovalsMeta) {
          boardApprovalsMeta.textContent = governanceSummary.pendingApprovals > 0
            ? '等待用户确认'
            : '暂无审批压力';
        }

        const boardNotificationsValue = document.getElementById('board-summary-notifications-value');
        const boardNotificationsMeta = document.getElementById('board-summary-notifications-meta');
        if (boardNotificationsValue) {
          boardNotificationsValue.textContent = governanceSummary.unreadNotifications.toString();
        }
        if (boardNotificationsMeta) {
          boardNotificationsMeta.textContent = governanceSummary.unreadNotifications > 0
            ? governanceSummary.unreadNotifications + ' 条待查看'
            : '全部已读';
        }

        let alertConfig = null;
        if (governanceSummary.timeoutVotes > 0 && governanceSummary.nextTimeoutVoteId) {
          alertConfig = {
            className: 'warning',
            message: governanceSummary.timeoutVotes + ' 个投票即将超时，请尽快处理。',
            actions: [{ label: '立即处理', target: 'timeoutVote' }]
          };
        } else if (governanceSummary.pendingVotes > 0 || governanceSummary.pendingApprovals > 0) {
          const parts = [];
          const actions = [];
          if (governanceSummary.pendingVotes > 0) {
            parts.push(governanceSummary.pendingVotes + ' 个投票待决策');
            if (governanceSummary.nextPendingVoteId) {
              actions.push({ label: '查看投票', target: 'pendingVote' });
            }
          }
          if (governanceSummary.pendingApprovals > 0) {
            parts.push(governanceSummary.pendingApprovals + ' 个审批待确认');
            if (governanceSummary.nextPendingApprovalId) {
              actions.push({ label: '查看审批', target: 'pendingApproval' });
            }
          }
          alertConfig = {
            className: 'info',
            message: parts.join('，'),
            actions
          };
        }

        renderGovernanceAlert(alertConfig, 'gov-alert');
        renderGovernanceAlert(alertConfig, 'gov-alert-board');
        updateGovernanceHistoryPaginationUI();
      }

      function renderGovernanceAlert(alertConfig, elementId) {
        const alertBox = document.getElementById(elementId);
        if (!alertBox) {
          return;
        }
        const baseClass = alertBox.classList.contains('inline')
          ? 'governance-alert inline'
          : 'governance-alert';
        if (!alertConfig) {
          alertBox.className = baseClass;
          alertBox.innerHTML = '';
          return;
        }
        const actionsHtml = (alertConfig.actions || []).length > 0
          ? '<div class="governance-alert-actions">' + alertConfig.actions
              .map(action => '<button class="governance-alert-action" data-action="governanceAlertAction" data-gov-target="' + action.target + '">' + action.label + '</button>')
              .join('') + '</div>'
          : '';
        alertBox.innerHTML = '<div>' + alertConfig.message + '</div>' + actionsHtml;
        alertBox.className = baseClass + ' show ' + alertConfig.className;
      }

      function updateGovernanceHistoryPaginationUI() {
        const indicator = document.getElementById('governance-history-page-indicator');
        if (indicator) {
          indicator.textContent = '第 ' + governanceHistoryPage + ' 页';
        }
        const prevBtn = document.querySelector('[data-action="governanceHistoryPrev"]');
        if (prevBtn) {
          prevBtn.disabled = governanceHistoryPage <= 1;
        }
        const nextBtn = document.querySelector('[data-action="governanceHistoryNext"]');
        if (nextBtn) {
          nextBtn.disabled = !governanceHistoryHasMore;
        }
      }

      updateGovernanceSummaryUI();

      function populateTaskSelect(selectId, options = {}) {
        const select = document.getElementById(selectId);
        if (!select) {
          return;
        }
        const { allowEmpty = false, placeholder = '请选择任务', defaultValue = '' } = options;
        const tasks = Array.isArray(allTasks) ? allTasks : [];
        const html = [];

        if (allowEmpty) {
          html.push(`<option value="">${escapeHtml(placeholder)}</option>`);
        } else if (tasks.length === 0) {
          html.push('<option value="" disabled selected>暂无可用任务</option>');
        }

        tasks.slice(0, 80).forEach(task => {
          const title = getTaskDisplayTitle(task);
          html.push(`<option value="${task.id}">${escapeHtml(`${title} (${task.id})`)}</option>`);
        });

        select.innerHTML = html.join('');

        if (defaultValue) {
          select.value = defaultValue;
        } else if (!allowEmpty && select.options.length > 0) {
          select.selectedIndex = 0;
        }
      }

      function populateVoteTaskSelect(defaultTaskId = '') {
        populateTaskSelect('vote-task-select', {
          allowEmpty: true,
          placeholder: '不关联任务',
          defaultValue: defaultTaskId || ''
        });
      }

      function populateApprovalTaskSelect(defaultTaskId = '') {
        populateTaskSelect('approval-task-select', {
          allowEmpty: false,
          placeholder: '请选择任务',
          defaultValue: defaultTaskId || ''
        });
      }

      function populateApprovalAgentSelect(defaultAgentId = '') {
        const select = document.getElementById('approval-approver-select');
        if (!select) {
          return;
        }
        if (!allAgents || allAgents.length === 0) {
          select.innerHTML = '<option value="" disabled selected>请先配置 Agent</option>';
          return;
        }
        const html = ['<option value="">请选择审批人</option>'];
        allAgents.forEach(agent => {
          const label = agent.display_name || agent.id;
          html.push(`<option value="${agent.id}">${escapeHtml(label)}</option>`);
        });
        select.innerHTML = html.join('');
        if (defaultAgentId) {
          select.value = defaultAgentId;
        }
      }

      function renderVoteDetail() {
        const container = document.getElementById('vote-detail-body');
        const actions = document.querySelector('#modal-vote-detail [data-role="vote-actions"]');
        const commentWrapper = document.getElementById('vote-comment-wrapper');
        if (!container) {
          return;
        }
        if (!currentVoteDetail) {
          container.innerHTML = '<div class="empty-state">请选择一个投票</div>';
          if (actions) actions.style.display = 'none';
          if (commentWrapper) commentWrapper.style.display = 'none';
          return;
        }
        const vote = currentVoteDetail;
        const voteTitle = vote.title || `投票 ${vote.id}`;
        const voteTypeText = getVoteTypeText(vote.vote_type);
        const statusClass = getVoteStatusClass(vote.status);
        const statusBadge = `<span class="task-badge task-badge-status status-${statusClass}">${escapeHtml(getVoteStatusText(vote.status))}</span>`;
        const typeBadge = `<span class="task-badge vote-type-badge">${escapeHtml(voteTypeText)}</span>`;
        const deadlineState = getVoteDeadlineState(vote);
        const deadlineBadge = vote.timeout_at
          ? `<span class="task-badge vote-deadline-badge ${deadlineState}">${VOTE_DEADLINE_STATE_LABELS[deadlineState] || ''}</span>`
          : '';
        const requiredRolesText = Array.isArray(vote.required_roles) && vote.required_roles.length > 0
          ? vote.required_roles.map(getRoleText).join('、')
          : '未限制';
        const descriptionContent = vote.description
          ? formatMultilineText(vote.description)
          : '<span class="task-detail-empty">暂无描述</span>';
        const votesList = Array.isArray(vote.votes) ? vote.votes : [];
        const approveCount = votesList.filter(entry => entry.choice === 'approve').length;
        const rejectCount = votesList.filter(entry => entry.choice === 'reject').length;
        const abstainCount = votesList.filter(entry => entry.choice === 'abstain').length;
        const totalVotes = votesList.length;
        const percent = (count) => (totalVotes ? Math.round((count / totalVotes) * 100) : 0);
        const participantSet = new Set(votesList.map(entry => entry.agent_id));
        const participantCount = participantSet.size;
        const requiredCount = Array.isArray(vote.required_roles) ? vote.required_roles.length : null;
        const progressValue = requiredCount ? `${participantCount}/${requiredCount}` : `${participantCount} 人`;
        const progressMeta = requiredCount ? '目标角色数' : '参与人数';
        const requiredRolesValue = escapeHtml(requiredRolesText);
        const creatorName = escapeHtml(getAgentName(vote.created_by || 'user'));
        const voteIdValue = vote.id ? `<code>${escapeHtml(String(vote.id))}</code>` : '<span class="task-detail-empty">未知</span>';
        const sessionValue = vote.session_id
          ? `<code>${escapeHtml(vote.session_id)}</code>`
          : '<span class="task-detail-empty">未关联</span>';
        const taskLabel = escapeHtml(formatTaskLabel(vote.task_id));
        const timelineEntries = [
          vote.created_at ? { label: '创建', value: formatAbsoluteWithRelative(vote.created_at, '未知') } : null,
          vote.timeout_at ? { label: '截止', value: formatAbsoluteWithRelative(vote.timeout_at, '未设置') } : null
        ].filter(Boolean);
        const timelineBlock = timelineEntries.length
          ? `<div class="task-detail-timeline">
              ${timelineEntries.map(entry => `
                <div class="task-detail-timeline-item">
                  <span class="label">${entry.label}</span>
                  <div>${entry.value}</div>
                </div>
              `).join('')}
            </div>`
          : '<div class="task-detail-empty">暂无时间线记录</div>';
        const statsBlock = `
          <div class="vote-stats-grid">
            <div class="vote-stats-card approve">
              <div class="vote-stats-label">赞成</div>
              <div class="vote-stats-value">${approveCount}</div>
              <div class="vote-stats-meta">${percent(approveCount)}%</div>
            </div>
            <div class="vote-stats-card reject">
              <div class="vote-stats-label">反对</div>
              <div class="vote-stats-value">${rejectCount}</div>
              <div class="vote-stats-meta">${percent(rejectCount)}%</div>
            </div>
            <div class="vote-stats-card abstain">
              <div class="vote-stats-label">弃权</div>
              <div class="vote-stats-value">${abstainCount}</div>
              <div class="vote-stats-meta">${percent(abstainCount)}%</div>
            </div>
            <div class="vote-stats-card progress">
              <div class="vote-stats-label">参与情况</div>
              <div class="vote-stats-value">${progressValue}</div>
              <div class="vote-stats-meta">${progressMeta}</div>
            </div>
          </div>
        `;
        const voteLogEntries = votesList.length
          ? votesList.map(entry => `
              <div class="vote-log-entry">
                <div class="vote-log-header">
                  <span class="vote-log-agent">${escapeHtml(getAgentName(entry.agent_id))}</span>
                  <span class="vote-log-choice">${getVoteChoiceText(entry.choice)}</span>
                </div>
                <div class="vote-log-meta">${formatAbsoluteWithRelative(entry.created_at, '未知')}</div>
                ${entry.comment ? `<div class="vote-log-comment">${formatMultilineText(entry.comment)}</div>` : ''}
              </div>
            `).join('')
          : '';
        const voteLogBlock = voteLogEntries
          ? `<div class="vote-log">${voteLogEntries}</div>`
          : '<div class="task-detail-empty">暂未收到投票</div>';
        const resultSection = vote.result
          ? `
            <div class="task-detail-section">
              <div class="task-detail-section-title">投票结论</div>
              <div class="task-detail-section-body">
                ${formatMultilineText(vote.result)}
              </div>
            </div>
          `
          : '';
        const metaItems = [
          { label: '投票类型', value: escapeHtml(voteTypeText) },
          { label: '投票 ID', value: voteIdValue },
          { label: '关联任务', value: taskLabel },
          { label: '需要角色', value: requiredRolesValue },
          { label: '发起人', value: creatorName },
          { label: '所属会话', value: sessionValue },
          { label: '发起时间', value: formatAbsoluteWithRelative(vote.created_at, '未知') },
          { label: '截止时间', value: formatAbsoluteWithRelative(vote.timeout_at, '未设置') }
        ];
        const metaHtml = `
          <div class="task-detail-meta-grid">
            ${metaItems.map(item => `
              <div class="task-detail-meta-item">
                <span class="label">${item.label}</span>
                <span class="value">${item.value}</span>
              </div>
            `).join('')}
          </div>
        `;

        container.innerHTML = `
          <div class="task-detail-header">
            <div>
              <div class="task-detail-label">投票 #${escapeHtml(String(vote.id))}</div>
              <div class="task-detail-title">${escapeHtml(voteTitle)}</div>
              <div class="task-detail-subtitle">发起人：${creatorName} · 类型：${escapeHtml(voteTypeText)}</div>
            </div>
            <div class="task-detail-badges">
              ${statusBadge}
              ${typeBadge}
              ${deadlineBadge}
            </div>
          </div>
          ${metaHtml}
          <div class="task-detail-section">
            <div class="task-detail-section-title">时间线</div>
            ${timelineBlock}
          </div>
          <div class="task-detail-section">
            <div class="task-detail-section-title">投票描述</div>
            <div class="task-detail-section-body">
              ${descriptionContent}
            </div>
          </div>
          ${resultSection}
          <div class="task-detail-section">
            <div class="task-detail-section-title">投票统计</div>
            ${statsBlock}
          </div>
          <div class="task-detail-section">
            <div class="task-detail-section-title">投票记录</div>
            ${voteLogBlock}
          </div>
        `;

        if (actions) {
          actions.style.display = vote.status === 'pending' ? 'flex' : 'none';
        }
        if (commentWrapper) {
          commentWrapper.style.display = vote.status === 'pending' ? 'block' : 'none';
        }
        const commentInput = document.getElementById('vote-comment-input');
        if (commentInput) {
          commentInput.value = '';
        }
      }

      function renderApprovalDetail() {
        const container = document.getElementById('approval-detail-body');
        const actions = document.querySelector('#modal-approval-detail [data-role="approval-actions"]');
        const commentWrapper = document.getElementById('approval-comment-wrapper');
        if (!container) {
          return;
        }
        if (!currentApprovalDetail) {
          container.innerHTML = '<div class="empty-state">请选择一个审批请求</div>';
          if (actions) actions.style.display = 'none';
          if (commentWrapper) commentWrapper.style.display = 'none';
          return;
        }
        const approval = currentApprovalDetail;
        container.innerHTML = `
          <div class="detail-section">
            <div class="detail-section-title">目标任务</div>
            <div>${escapeHtml(formatTaskLabel(approval.task_id))}</div>
          </div>
          <div class="detail-section">
            <div class="detail-row"><span class="detail-label">当前状态</span><span class="detail-value">${getApprovalDecisionText(approval.decision)}</span></div>
            <div class="detail-row"><span class="detail-label">审批人</span><span class="detail-value">${escapeHtml(getAgentName(approval.approver_id))}</span></div>
            <div class="detail-row"><span class="detail-label">发起人</span><span class="detail-value">${escapeHtml(getAgentName(approval.created_by || 'user'))}</span></div>
            <div class="detail-row"><span class="detail-label">发起时间</span><span class="detail-value">${formatTime(approval.created_at)}</span></div>
          </div>
          ${approval.comment ? `
            <div class="detail-section">
              <div class="detail-section-title">审批说明</div>
              <div class="detail-list-item">${escapeHtml(approval.comment)}</div>
            </div>
          ` : ''}
        `;

        if (actions) {
          actions.style.display = approval.decision === 'pending' ? 'flex' : 'none';
        }
        if (commentWrapper) {
          commentWrapper.style.display = approval.decision === 'pending' ? 'block' : 'none';
        }
        const commentInput = document.getElementById('approval-comment-input');
        if (commentInput) {
          commentInput.value = '';
        }
      }

      window.openCreateVoteModal = function(taskId = '') {
        const form = document.getElementById('form-create-vote');
        if (form) {
          form.reset();
        }
        populateVoteTaskSelect(taskId);
        window.openModal('modal-create-vote');
      };

      window.submitCreateVote = function() {
        const form = document.getElementById('form-create-vote');
        if (!form) {
          return;
        }
        if (!currentSessionId) {
          updateStatus('请先创建或选择一个会话');
          return;
        }
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        const title = form.querySelector('#vote-title').value.trim();
        const description = form.querySelector('#vote-description').value.trim();
        const voteType = form.querySelector('#vote-type-select').value;
        const taskId = form.querySelector('#vote-task-select').value;
        const timeoutInput = form.querySelector('#vote-timeout').value;
        const requiredRolesSelect = document.getElementById('vote-required-roles');
        const requiredRoles = requiredRolesSelect
          ? Array.from(requiredRolesSelect.selectedOptions || []).map(option => option.value).filter(Boolean)
          : [];
        const timeout = Math.max(parseInt(timeoutInput, 10) || 5, 1);
        vscode.postMessage({
          type: 'create_vote',
          data: {
            title,
            description: description || null,
            vote_type: voteType || 'simple_majority',
            timeout_minutes: timeout,
            required_roles: requiredRoles,
            task_id: taskId || null,
            session_id: currentSessionId
          }
        });
        window.closeModal();
      };

      window.submitCreateApproval = function() {
        const form = document.getElementById('form-create-approval');
        if (!form) {
          return;
        }
        if (!currentSessionId) {
          updateStatus('请先创建或选择一个会话');
          return;
        }
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        const taskId = form.querySelector('#approval-task-select').value;
        const approverId = form.querySelector('#approval-approver-select').value;
        const comment = form.querySelector('#approval-reason').value.trim();
        vscode.postMessage({
          type: 'create_approval',
          data: {
            task_id: taskId,
            approver_id: approverId,
            comment: comment || null,
            session_id: currentSessionId
          }
        });
        window.closeModal();
      };

      window.openVoteDetail = function(topicId) {
        if (!topicId) {
          vscode.postMessage({ type: 'show_info', message: '未找到投票 ID' });
          return;
        }
        const vote = allVotes.find(item => item.id === topicId);
        if (!vote) {
          vscode.postMessage({ type: 'show_info', message: `未找到投票 ${topicId}` });
          return;
        }
        currentVoteDetail = vote;
        renderVoteDetail();
        window.openModal('modal-vote-detail');
      };

      window.openApprovalDetail = function(approvalId) {
        const numericId = Number(approvalId);
        if (Number.isNaN(numericId)) {
          vscode.postMessage({ type: 'show_info', message: '无效的审批 ID' });
          return;
        }
        const approval = allApprovals.find(item => item.id === numericId);
        if (!approval) {
          vscode.postMessage({ type: 'show_info', message: `未找到审批 ${approvalId}` });
          return;
        }
        currentApprovalDetail = approval;
        renderApprovalDetail();
        window.openModal('modal-approval-detail');
      };

      window.submitVoteDecision = function(choice) {
        if (!currentVoteDetail || !choice) {
          return;
        }
        const commentInput = document.getElementById('vote-comment-input');
        const comment = commentInput ? commentInput.value.trim() : '';
        window.castVote(currentVoteDetail.id, choice, { comment });
        window.closeModal();
      };

      window.submitApprovalDecision = function(decision) {
        if (!currentApprovalDetail || !decision) {
          return;
        }
        const commentInput = document.getElementById('approval-comment-input');
        const comment = commentInput ? commentInput.value.trim() : '';
        window.approveRequest(currentApprovalDetail.id, decision, comment);
        window.closeModal();
      };

      // Task Detail Modal
      let currentTaskDetail = null;

      window.openTaskDetailModal = function(taskId) {
        if (!taskId) {
          vscode.postMessage({ type: 'show_info', message: '未找到任务 ID' });
          return;
        }
        const task = getTaskById(taskId);
        if (!task) {
          vscode.postMessage({ type: 'show_info', message: '未找到任务 ' + taskId });
          return;
        }
        currentTaskDetail = task;
        renderTaskDetail();
        window.openModal('modal-task-detail');
      };

      function renderTaskDetail() {
        const container = document.getElementById('task-detail-body');
        if (!container) {
          return;
        }
        if (!currentTaskDetail) {
          container.innerHTML = '<div class="empty-state">请选择一个任务</div>';
          return;
        }
        const task = currentTaskDetail;
        const agentName = task.assigned_to ? getAgentName(task.assigned_to) : '未分配';
        const normalizedStatus = normalizeTaskStatus(task.status);
        const statusBadgeClass = `task-badge task-badge-status status-${normalizedStatus}`;
        const statusBadge = `<span class="${statusBadgeClass}">${escapeHtml(getStatusText(task.status))}</span>`;
        const priorityBadgeClass = `task-badge task-badge-priority ${formatPriorityClass(task.priority)}`;
        const priorityBadge = `<span class="${priorityBadgeClass}">${escapeHtml(formatPriorityLabel(task.priority))}</span>`;
        const phaseId = getTaskPhaseId(task);
        const phaseTitle = phaseId ? getPhaseTitle(phaseId) : '未标记阶段';
        const scopeLabel = formatTaskScopeLabel(task.scope);
        const rawIntent = (task.intent || '').trim();
        const intentLabel = rawIntent ? (TASK_INTENT_LABELS[rawIntent.toLowerCase()] || rawIntent) : '未指定';
        const dependencies = getTaskDependencies(task.id);
        const dependents = getTaskDependents(task.id);
        const childTasks = getChildTasks(task.id);
        const labelList = Array.isArray(task.labels)
          ? task.labels.filter(label => typeof label === 'string' && label.trim().length > 0)
          : [];
        const labelsBlock = labelList.length
          ? labelList.map(label => `<span class="task-tag">${escapeHtml(label)}</span>`).join('')
          : '<span class="task-detail-empty">暂无标签</span>';
        const descriptionHtml = formatMultilineText(task.description || '');
        const descriptionContent = descriptionHtml || '<span class="task-detail-empty">暂无描述</span>';
        const resultContent = task.result_summary
          ? (formatMultilineText(task.result_summary) || '<span class="task-detail-empty">暂无结果</span>')
          : '';
        const timelineEntries = [];
        if (task.created_at) {
          timelineEntries.push({ label: '创建', value: escapeHtml(formatTime(task.created_at)) });
        }
        if (task.last_started_at) {
          timelineEntries.push({ label: '最近启动', value: escapeHtml(formatTime(task.last_started_at)) });
        }
        if (task.updated_at) {
          timelineEntries.push({ label: '最近更新', value: escapeHtml(formatTime(task.updated_at)) });
        }
        if (task.completed_at) {
          timelineEntries.push({ label: '完成', value: escapeHtml(formatTime(task.completed_at)) });
        }
        if (task.due_at) {
          timelineEntries.push({ label: '截止', value: escapeHtml(formatTime(task.due_at)) });
        }
        const timelineBlock = timelineEntries.length
          ? `<div class="task-detail-timeline">
              ${timelineEntries.map(entry => `
                <div class="task-detail-timeline-item">
                  <span class="label">${entry.label}</span>
                  <div>${entry.value}</div>
                </div>
              `).join('')}
            </div>`
          : '<div class="task-detail-empty">暂无时间线记录</div>';
        const agentDisplay = escapeHtml(agentName);
        const phaseDisplay = escapeHtml(phaseTitle);
        const scopeDisplay = escapeHtml(scopeLabel);
        const intentDisplay = escapeHtml(intentLabel);
        const sessionValue = task.session_id
          ? `<code>${escapeHtml(task.session_id)}</code>`
          : '<span class="task-detail-empty">未关联</span>';
        const dueValue = task.due_at
          ? escapeHtml(formatTime(task.due_at))
          : '<span class="task-detail-empty">未设置</span>';
        const dependencySummary = escapeHtml(`${dependencies.length} / ${dependents.length}`);
        const childSummary = escapeHtml(`${childTasks.length} 个`);
        const subtitleParts = [];
        subtitleParts.push(`负责人：${agentDisplay}`);
        subtitleParts.push(`阶段：${phaseDisplay}`);
        subtitleParts.push(`范围：${scopeDisplay}`);
        const subtitleText = subtitleParts.filter(Boolean).join(' · ') || '暂无更多上下文';
        const metaItems = [
          { label: '负责人', value: agentDisplay },
          { label: '所属会话', value: sessionValue },
          { label: '当前阶段', value: phaseDisplay },
          { label: '任务范围', value: scopeDisplay },
          { label: '任务意图', value: intentDisplay },
          { label: '依赖 / 被依赖', value: dependencySummary },
          { label: '子任务', value: childSummary },
          { label: '截止时间', value: dueValue }
        ];
        const metaHtml = metaItems.map(item => `
          <div class="task-detail-meta-item">
            <span class="label">${item.label}</span>
            <span class="value">${item.value}</span>
          </div>
        `).join('');
        const taskIdAttr = String(task.id || '');
        const actionButtons = [
          `<button class="task-action-btn" data-action="focusTaskInList" data-task-id="${taskIdAttr}">定位任务</button>`,
          `<button class="task-action-btn" data-action="openTaskDependencyModal" data-task-id="${taskIdAttr}">查看依赖关系</button>`,
          `<button class="task-action-btn" data-action="filterFileChangesByTask" data-task-id="${taskIdAttr}">查看关联变更</button>`
        ];
        if (normalizedStatus === 'paused') {
          actionButtons.push(`<button class="task-action-btn" data-action="resumeTask" data-task-id="${taskIdAttr}">重新启动</button>`);
        } else if (normalizedStatus !== 'completed' && normalizedStatus !== 'failed') {
          actionButtons.push(`<button class="task-action-btn" data-action="pauseTask" data-task-id="${taskIdAttr}">暂停任务</button>`);
        }
        container.innerHTML = `
          <div class="task-detail-header">
            <div>
              <div class="task-detail-label">任务 ${escapeHtml(task.id)}</div>
              <div class="task-detail-title">${escapeHtml(getTaskDisplayTitle(task))}</div>
              <div class="task-detail-subtitle">${subtitleText}</div>
            </div>
            <div class="task-detail-badges">
              ${statusBadge}
              ${priorityBadge}
            </div>
          </div>
          <div class="task-detail-meta-grid">
            ${metaHtml}
          </div>
          <div class="task-detail-section">
            <div class="task-detail-section-title">时间线</div>
            ${timelineBlock}
          </div>
          <div class="task-detail-section">
            <div class="task-detail-section-title">任务描述</div>
            <div class="task-detail-section-body">
              ${descriptionContent}
            </div>
          </div>
          ${task.result_summary ? `
            <div class="task-detail-section">
              <div class="task-detail-section-title">执行结果</div>
              <div class="task-detail-section-body">
                ${resultContent}
              </div>
            </div>
          ` : ''}
          <div class="task-detail-section">
            <div class="task-detail-section-title">任务标签</div>
            <div class="task-detail-tags">
              ${labelsBlock}
            </div>
          </div>
          <div class="task-detail-section">
            <div class="task-detail-section-title">任务操作</div>
            <div class="task-detail-actions">
              ${actionButtons.length ? actionButtons.join('') : '<span class="task-detail-empty">暂无可用操作</span>'}
            </div>
          </div>
        `;
      }

      window.openTaskDependencyModal = function(taskId) {
        if (!taskId) {
          vscode.postMessage({ type: 'show_info', message: '未找到任务 ID' });
          return;
        }
        const task = getTaskById(taskId);
        if (!task) {
          vscode.postMessage({ type: 'show_info', message: '未找到任务 ' + taskId });
          return;
        }
        currentTaskDependencyDetail = task;
        renderTaskDependencyDetail();
        window.openModal('modal-task-dependency');
      };

      window.focusTaskInList = function(taskId) {
        if (!taskId) {
          return;
        }
        const row = document.querySelector('.task-row[data-task-id="' + taskId + '"]');
        if (row) {
          row.classList.add('dependency-focus');
          row.scrollIntoView({ behavior: 'smooth', block: 'center' });
          setTimeout(() => row.classList.remove('dependency-focus'), 1200);
        } else {
          vscode.postMessage({
            type: 'show_info',
            message: '任务列表中未找到任务 ' + taskId
          });
        }
      };

      window.pauseTask = function(taskId) {
        if (!taskId) {
          return;
        }
        vscode.postMessage({
          type: 'pause_task',
          data: { id: taskId }
        });
      };

      window.resumeTask = function(taskId) {
        if (!taskId) {
          return;
        }
        vscode.postMessage({
          type: 'resume_task',
          data: { id: taskId }
        });
      };

      window.handleGovernanceAlertAction = function(target) {
        if (!target) {
          return;
        }
        if (target === 'timeoutVote' && governanceSummary.nextTimeoutVoteId) {
          focusVoteCard(governanceSummary.nextTimeoutVoteId);
          return;
        }
        if (target === 'pendingVote' && governanceSummary.nextPendingVoteId) {
          focusVoteCard(governanceSummary.nextPendingVoteId);
          return;
        }
        if (target === 'pendingApproval' && governanceSummary.nextPendingApprovalId) {
          focusApprovalCard(governanceSummary.nextPendingApprovalId);
        }
      };

      function renderTaskDependencyDetail() {
        const container = document.getElementById('task-dependency-body');
        if (!container) {
          return;
        }
        if (!currentTaskDependencyDetail) {
          container.innerHTML = '<div class="empty-state">请选择一个任务</div>';
          return;
        }
        const task = currentTaskDependencyDetail;
        const dependencies = getTaskDependencies(task.id);
        const dependents = getTaskDependents(task.id);
        const childTasks = getChildTasks(task.id);
        const dependencyList = dependencies.length > 0
          ? dependencies.map(dep => {
              const statusBadge = '<span class="dependency-badge ' +
                (dep.status === 'completed' ? 'success' : dep.status === 'blocked' ? 'warning' : 'info') +
                '">状态 ' + getStatusText(dep.status) + '</span>';
              return '<div class="detail-list-item">' +
                '<div>' + escapeHtml(getTaskDisplayTitle(dep)) + ' (' + dep.id + ')</div>' +
                '<div class="detail-meta">负责人: ' + escapeHtml(getAgentName(dep.assigned_to || '未分配')) + '</div>' +
                statusBadge +
              '</div>';
            }).join('')
          : '<div class="detail-meta">无依赖</div>';

        const dependentsList = dependents.length > 0
          ? dependents.map(dep => {
              return '<div class="detail-list-item">' +
                '<div>' + escapeHtml(getTaskDisplayTitle(dep)) + ' (' + dep.id + ')</div>' +
                '<div class="detail-meta">状态: ' + getStatusText(dep.status) + '</div>' +
              '</div>';
            }).join('')
          : '<div class="detail-meta">暂无任务依赖此任务</div>';

        const childList = childTasks.length > 0
          ? childTasks.map(child => {
              return '<div class="detail-list-item">' +
                '<div>' + escapeHtml(getTaskDisplayTitle(child)) + ' (' + child.id + ')</div>' +
                '<div class="detail-meta">状态: ' + getStatusText(child.status) + '</div>' +
              '</div>';
            }).join('')
          : '<div class="detail-meta">无子任务</div>';

        container.innerHTML = '' +
          '<div class="detail-section">' +
            '<div class="detail-section-title">任务信息</div>' +
            '<div class="detail-row"><span class="detail-label">名称</span><span class="detail-value">' + escapeHtml(getTaskDisplayTitle(task)) + '</span></div>' +
            '<div class="detail-row"><span class="detail-label">状态</span><span class="detail-value">' + getStatusText(task.status) + '</span></div>' +
            '<div class="detail-row"><span class="detail-label">负责人</span><span class="detail-value">' + escapeHtml(getAgentName(task.assigned_to || '未分配')) + '</span></div>' +
          '</div>' +
          '<div class="detail-section">' +
            '<div class="detail-section-title">依赖任务</div>' +
            '<div class="detail-list">' + dependencyList + '</div>' +
          '</div>' +
          '<div class="detail-section">' +
            '<div class="detail-section-title">等待此任务的任务</div>' +
            '<div class="detail-list">' + dependentsList + '</div>' +
          '</div>' +
          '<div class="detail-section">' +
            '<div class="detail-section-title">子任务</div>' +
            '<div class="detail-list">' + childList + '</div>' +
          '</div>' +
          (function() {
            const normalizedStatus = normalizeTaskStatus(task.status);
            const controls = [];
            if (normalizedStatus === 'running') {
              controls.push('<button class="task-action-btn" data-action="pauseTask" data-task-id="' + task.id + '">暂停任务</button>');
            }
            if (normalizedStatus === 'blocked' || normalizedStatus === 'paused') {
              controls.push('<button class="task-action-btn" data-action="resumeTask" data-task-id="' + task.id + '">重新启动</button>');
            }
            return controls.length
              ? '<div class="detail-section"><div class="detail-section-title">任务控制</div><div class="detail-list">' + controls.join('') + '</div></div>'
              : '';
          })() +
          '<div class="detail-section">' +
            '<button class="task-action-btn" data-action="filterFileChangesByTask" data-task-id="' + task.id + '">查看关联变更</button>' +
          '</div>';
      }

      function startGovernancePolling() {
        stopGovernancePolling();
        governancePollTimer = setInterval(() => {
          if (!currentSessionId) {
            return;
          }
          const payload = { session_id: currentSessionId };
          vscode.postMessage({ type: 'get_votes', data: payload });
          vscode.postMessage({ type: 'get_approvals', data: payload });
        }, GOVERNANCE_POLL_INTERVAL);
        governanceSummary.pollingActive = true;
        governanceSummary.lastPolledAt = Date.now();
        updateGovernanceSummaryUI();
        console.log('[MinimalPanel] Governance polling started');
      }

      function stopGovernancePolling() {
        if (governancePollTimer) {
          clearInterval(governancePollTimer);
          governancePollTimer = null;
          console.log('[MinimalPanel] Governance polling stopped');
        }
        governanceSummary.pollingActive = false;
        updateGovernanceSummaryUI();
      }

      function getTaskBadgeClass(status) {
        const normalized = normalizeTaskStatus(status);
        const map = {
          'running': 'running',
          'blocked': 'warning',
          'paused': 'warning',
          'completed': 'completed',
          'failed': 'failed'
        };
        return map[normalized] || 'default';
      }

      function getMessageTypeText(type) {
        if (type === 'fact') {
          return '讨论';
        }
        const map = {
          'discussion': '讨论',
          'decision': '决策',
          'question': '问题',
          'warning': '警告',
          'suggestion': '建议',
          'system': '系统',
          'requirement': '需求'
        };
        return map[type] || type;
      }

      function getMessageBadgeClass(type) {
        const map = {
          'warning': 'warning',
          'system': 'info',
          'decision': 'completed'
        };
        return map[type] || 'default';
      }

      function getMessageVisibilityValue(message) {
        if (!message) {
          return 'blackboard';
        }
        if (message.visibility) {
          return message.visibility;
        }
        if (message.message_type === 'system' || (message.agent_id || '').toLowerCase() === 'workflow_orchestrator') {
          return 'event_log';
        }
        return 'blackboard';
      }

      function getMessageCategoryValue(message) {
        if (message?.category) {
          return message.category;
        }
        const agentId = (message?.agent_id || '').toLowerCase();
        if (agentId === 'user' || agentId.startsWith('human')) {
          return 'user';
        }
        if (message?.message_type === 'system') {
          return 'system_event';
        }
        return 'agent_summary';
      }

      function deriveEventSeverityFromMessage(message) {
        if (!message) {
          return 'info';
        }
        if (message.priority === 'high') {
          return 'critical';
        }
        switch (message.message_type) {
          case 'warning':
            return 'warning';
          case 'decision':
            return 'success';
          case 'question':
            return 'info';
          default:
            return 'info';
        }
      }

      function buildEventMetaPartsFromMessage(message) {
        const meta = [];
        if (message?.reference_type === 'task' && message.reference_id) {
          meta.push(`任务 ${message.reference_id}`);
        }
        if (Array.isArray(message?.tags) && message.tags.length > 0) {
          meta.push(...message.tags);
        }
        return meta.length ? meta : ['系统事件'];
      }

      function buildMessageDirectBadge(message) {
        const mentions = Array.isArray(message?.mentions) ? message.mentions.filter(Boolean) : [];
        if (!mentions.length) {
          return '';
        }
        const displayMentions = mentions.slice(0, 2).map(id => getAgentName(id));
        const overflow = mentions.length > 2 ? ` +${mentions.length - 2}` : '';
        const title = `直达：${mentions.map(id => getAgentName(id)).join('、')}`;
        return `<span class="message-direct-badge" title="${escapeHtml(title)}">@${escapeHtml(displayMentions.join('、'))}${overflow}</span>`;
      }

      function deriveMessageInstanceId(message) {
        if (!message) {
          return null;
        }
        const payloadInstanceId = typeof message.payload?.workflow_instance_id === 'string'
          ? message.payload.workflow_instance_id.trim()
          : '';
        if (payloadInstanceId) {
          return payloadInstanceId;
        }
        const tagMarker = Array.isArray(message.tags)
          ? message.tags.find(label => typeof label === 'string' && label.startsWith('workflow_instance:'))
          : null;
        if (tagMarker) {
          const [, instanceId] = tagMarker.split(':');
          return instanceId || null;
        }
        return null;
      }

      function buildMessageInstanceBadge(instanceId) {
        if (!instanceId) {
          return '';
        }
        const detail = getWorkflowInstanceDetailById(instanceId) || getCurrentWorkflowSummary(instanceId);
        const label = detail ? formatInstanceScenarioLabel(detail) : null;
        const titleParts = [];
        if (label) {
          titleParts.push(label);
        }
        if (detail?.status) {
          titleParts.push(getWorkflowInstanceStatusLabel(detail.status));
        }
        const title = titleParts.length ? titleParts.join(' · ') : `实例 ${instanceId}`;
        const displayLabel = label || `实例 ${instanceId.slice(-4)}`;
        const color = getInstanceColor(instanceId);
        return `<button class="message-instance-badge" style="--instance-color:${color}" title="${escapeHtml(title)}" onclick="focusWorkflowInstance('${instanceId}')">${escapeHtml(displayLabel)}</button>`;
      }

      function getAgentAvatarColor(agentId) {
        const colors = ['blue', 'green', 'purple', 'orange'];
        if (!agentId) {
          return colors[0];
        }
        const index = allAgents.findIndex(a => a.id === agentId);
        return colors[Math.abs(index) % colors.length];
      }

      function getAgentName(agentId) {
        if (!agentId) {
          return '系统';
        }
        const normalized = String(agentId).toLowerCase();
        if (normalized === 'user' || normalized === 'customer') {
          return '用户';
        }
        if (normalized === 'system' || normalized === 'workflow_orchestrator') {
          return '系统';
        }
        const agent = allAgents.find(a => a.id === agentId);
        return agent ? agent.display_name : agentId;
      }

      // Message scrolling state
      let isUserScrolling = false;
      let hasNewMessages = false;

      // Check if messages container is at bottom
      function isAtBottom(container) {
        if (!container) return false;
        const threshold = 50; // 50px tolerance
        return container.scrollHeight - container.scrollTop - container.clientHeight < threshold;
      }

      // Scroll to bottom of messages
      function scrollToBottom(container, smooth = true) {
        if (!container) return;
        container.scrollTo({
          top: container.scrollHeight,
          behavior: smooth ? 'smooth' : 'auto'
        });
      }

      // Show new message indicator
      function showNewMessageButton() {
        const btn = document.getElementById('new-message-indicator');
        if (btn) btn.style.display = 'block';
      }

      // Hide new message indicator
      function hideNewMessageButton() {
        const btn = document.getElementById('new-message-indicator');
        if (btn) btn.style.display = 'none';
      }

      // Scroll to bottom and hide indicator (called by button click)
      window.scrollToBottomAndHide = function() {
        const container = document.getElementById('messages-list');
        scrollToBottom(container, true);
        isUserScrolling = false;
        hasNewMessages = false;
        hideNewMessageButton();
      };

      function setWorkspaceEmptyState(isEmpty) {
        const panel = document.getElementById('workspace-panel');
        const empty = document.getElementById('workspace-empty');
        if (!panel || !empty) {
          return;
        }
        if (isEmpty) {
          panel.classList.add('hidden');
          empty.style.display = 'block';
        } else {
          panel.classList.remove('hidden');
          empty.style.display = 'none';
        }
      }

      function switchWorkspaceTabInternal(tab) {
        const nextTab = tab === 'thinking' ? 'thinking' : 'overview';
        currentWorkspaceTab = nextTab;
        const buttons = document.querySelectorAll('.workspace-tab-button');
        buttons.forEach(btn => {
          const value = btn.getAttribute('data-workspace-tab');
          btn.classList.toggle('active', value === nextTab);
        });
        const overview = document.getElementById('workspace-overview');
        const thinking = document.getElementById('workspace-thinking');
        if (overview) {
          overview.style.display = nextTab === 'overview' ? 'block' : 'none';
        }
        if (thinking) {
          thinking.style.display = nextTab === 'thinking' ? 'block' : 'none';
        }
      }

      function renderWorkspaceOverview(agent, agentTasks) {
        const overview = document.getElementById('workspace-overview');
        if (!overview) {
          return;
      }

      if (!agent) {
          overview.innerHTML = [
            '<div class="workspace-section">',
              '<div class="workspace-section-header">任务概览</div>',
              '<div class="workspace-section-body">',
                '<div class="empty-state">请选择一个 Agent 查看任务概况。</div>',
              '</div>',
            '</div>'
          ].join('');
          return;
        }

        const totalTasks = agentTasks.length;
        const runningCount = agentTasks.filter(task => task.status === 'running').length;
        const pendingCount = agentTasks.filter(task => task.status === 'pending' || task.status === 'queued' || task.status === 'assigned').length;
        const recentCompleted = agentTasks
          .filter(task => task.status === 'completed')
          .sort((a, b) => (b.completed_at || b.updated_at || b.created_at) - (a.completed_at || a.updated_at || a.created_at))
          .slice(0, 5);

        const summaryHtml = [
          '<div class="workspace-summary">',
            '<div class="workspace-summary-stat"><div class="workspace-summary-value">' + runningCount + '</div><div class="workspace-summary-label">运行中</div></div>',
            '<div class="workspace-summary-stat"><div class="workspace-summary-value">' + pendingCount + '</div><div class="workspace-summary-label">待处理</div></div>',
            '<div class="workspace-summary-stat"><div class="workspace-summary-value">' + recentCompleted.length + '</div><div class="workspace-summary-label">最近完成</div></div>',
            '<div class="workspace-summary-stat"><div class="workspace-summary-value">' + totalTasks + '</div><div class="workspace-summary-label">任务总数</div></div>',
          '</div>'
        ].join('');

        const activeTask = agentTasks.find(task => task.status === 'running')
          || agentTasks.find(task => task.status === 'assigned')
          || null;

        const currentTaskHtml = activeTask
          ? [
              '<div class="workspace-key-value">',
                '<span>标题</span><span>' + escapeHtml(getTaskDisplayTitle(activeTask)) + '</span>',
                '<span>状态</span><span>' + getStatusText(activeTask.status) + '</span>',
                '<span>范围</span><span>' + escapeHtml(activeTask.scope || '未指定') + '</span>',
                '<span>依赖</span><span>' + ((activeTask.dependencies && activeTask.dependencies.length > 0) ? activeTask.dependencies.join(', ') : '无') + '</span>',
                '<span>创建时间</span><span>' + formatTime(activeTask.created_at) + '</span>',
              '</div>'
            ].join('')
          : '<div class="empty-state">该 Agent 当前没有运行中的任务。</div>';

        const recentTasks = agentTasks
          .filter(task => task.status !== 'completed')
          .sort((a, b) => (b.updated_at || b.created_at) - (a.updated_at || a.created_at))
          .slice(0, 5);

        const recentTable = recentTasks.length > 0
          ? [
              '<table class="workspace-table">',
                '<thead>',
                  '<tr><th>任务</th><th>状态</th><th>更新时间</th></tr>',
                '</thead>',
                '<tbody>',
                  recentTasks.map(task => (
                    '<tr>' +
                      '<td>' + escapeHtml(getTaskDisplayTitle(task)) + '</td>' +
                      '<td>' + getStatusText(task.status) + '</td>' +
                      '<td>' + formatTime(task.updated_at || task.created_at) + '</td>' +
                    '</tr>'
                  )).join(''),
                '</tbody>',
              '</table>'
            ].join('')
          : '<div class="empty-state">暂无待处理的任务。</div>';

        const completedList = recentCompleted.length > 0
          ? [
              '<ul style="margin:0;padding-left:18px;font-size:12px;">',
              recentCompleted.map(task => (
                '<li>' +
                  escapeHtml(getTaskDisplayTitle(task)) +
                  ' · ' + formatTime(task.completed_at || task.updated_at || task.created_at) +
                '</li>'
              )).join(''),
              '</ul>'
            ].join('')
          : '<div class="empty-state">最近还没有完成任务。</div>';

        overview.innerHTML = [
          summaryHtml,
          '<div class="workspace-section">',
            '<div class="workspace-section-header">当前任务</div>',
            '<div class="workspace-section-body">',
              currentTaskHtml,
            '</div>',
          '</div>',
          '<div class="workspace-section">',
            '<div class="workspace-section-header">近期任务</div>',
            '<div class="workspace-section-body">',
              recentTable,
            '</div>',
          '</div>',
          '<div class="workspace-section">',
            '<div class="workspace-section-header">最近完成</div>',
            '<div class="workspace-section-body">',
              completedList,
            '</div>',
          '</div>'
        ].join('');
      }

      function getExternalInputsForAgent(agent, limit = 12) {
        if (!agent) {
          return [];
        }
        const agentId = agent.id;
        const scopedMessages = currentSessionId
          ? allMessages.filter(msg => (msg.session_id || null) === currentSessionId)
          : allMessages;
        const inputs = scopedMessages.filter(msg => {
          if (!msg) return false;
          if (msg.agent_id && msg.agent_id === agentId) {
            return false;
          }
          const mentions = Array.isArray(msg.mentions) ? msg.mentions.map(id => String(id).trim()) : [];
          if (mentions.includes(agentId)) {
            return true;
          }
          if (msg.payload && Array.isArray(msg.payload?.mentions)) {
            const payloadMentions = msg.payload.mentions.map(id => String(id).trim());
            if (payloadMentions.includes(agentId)) {
              return true;
            }
          }
          return false;
        }).sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
        return limit ? inputs.slice(0, limit) : inputs;
      }

      function renderExternalInputCard(message) {
        const author = getAgentName(message.agent_id);
        const createdAt = formatTime(message.created_at);
        const instanceBadge = buildMessageInstanceBadge(deriveMessageInstanceId(message));
        const typeLabel = getMessageTypeText(message.message_type);
        const contentText = typeof message.content === 'string' ? message.content : '';
        const snippet = contentText.length > 160 ? contentText.slice(0, 160) + '…' : contentText;
        return `
          <div class="workspace-external-card">
            <div class="workspace-external-meta">
              <span class="author">${escapeHtml(author)}</span>
              <span>${escapeHtml(createdAt)}</span>
            </div>
            <div style="margin-bottom:4px;">
              <span class="badge badge-${getMessageBadgeClass(message.message_type)}">${escapeHtml(typeLabel)}</span>
              ${instanceBadge}
            </div>
            <div class="workspace-external-body">${escapeHtml(snippet)}</div>
          </div>
        `;
      }

      function renderThinkingStreamEntry(entry, activeTask) {
        const entryKey = encodeURIComponent(entry.entryId || entry.id || entry.timestamp || Math.random().toString(36).slice(2, 7));
        const typeLabel = getThinkingStepTypeText(entry.stepType || entry.type);
        const timestamp = entry.timestamp ? formatTime(entry.timestamp) : '—';
        const content = entry.content
          ? formatMultilineText(entry.content)
          : entry.tool?.output
            ? formatMultilineText(entry.tool.output)
            : '—';
        const metaNotes = [];
        if (entry.taskId) {
          metaNotes.push(`<span class="thinking-chat-note">任务 ${escapeHtml(entry.taskId)}</span>`);
        }
        if (entry.tool?.name) {
          metaNotes.push(`<span class="thinking-chat-note">工具 ${escapeHtml(entry.tool.name)}</span>`);
        }
        if (entry.fileChange?.file_path) {
          metaNotes.push(`<span class="thinking-chat-note">文件 ${escapeHtml(entry.fileChange.file_path)}</span>`);
        }
        if (entry.userMessage) {
          metaNotes.push('<span class="thinking-chat-note">用户补充</span>');
        }
        if (activeTask && entry.taskId && entry.taskId === activeTask.id) {
          metaNotes.push('<span class="thinking-chat-note">当前任务</span>');
        }
        return `
          <div class="thinking-log-entry thinking-chat-entry" data-entry-key="${entryKey}" data-entry-id="${entryKey}" data-action="toggleThinkingEntry">
            <div class="thinking-chat-header">
              <span>${escapeHtml(typeLabel)}</span>
              <span>${escapeHtml(timestamp)}</span>
            </div>
            <div class="thinking-chat-bubble">${content}</div>
            <div class="thinking-chat-meta">${metaNotes.join('')}</div>
          </div>
        `;
      }

      function renderWorkspaceThinking(agent, agentTasks, agentLogs) {
        const thinking = document.getElementById('workspace-thinking');
        if (!thinking) {
          return;
        }

        if (!agent) {
          thinking.innerHTML = [
            '<div class="workspace-section">',
              '<div class="workspace-section-header">思考过程</div>',
              '<div class="workspace-section-body">',
                '<div class="empty-state">请选择 Agent 后查看思考过程。</div>',
              '</div>',
            '</div>'
          ].join('');
          return;
        }

        const activeTask = agentTasks.find(task => task.status === 'running')
          || agentTasks.find(task => task.status === 'assigned')
          || null;
        const stream = buildThinkingStream(agent, agentLogs || [], agentTasks || []);

        const filterTaskId = workspaceThinkingScope === 'current' && activeTask ? activeTask.id : null;
        let filteredStream = stream;
        if (filterTaskId) {
          filteredStream = filteredStream.filter(entry => entry.taskId === filterTaskId);
        } else if (workspaceThinkingScope === 'current' && !activeTask) {
          filteredStream = [];
        }

        filteredStream = filteredStream.filter(entry => matchesThinkingTypeFilters(entry));

        const searchKeyword = workspaceThinkingSearch.trim().toLowerCase();
        if (searchKeyword) {
          filteredStream = filteredStream.filter(entry => entry.searchText && entry.searchText.includes(searchKeyword));
        }

        const displayStream = filteredStream.slice(0, WORKSPACE_THINKING_LIMIT);
        syncThinkingEntryState(displayStream);

        const totalCount = stream.length;
        const filteredCount = filteredStream.length;
        const limitedCount = displayStream.length;
        lastThinkingSnapshot = {
          agentId: agent?.id || null,
          agentName: agent?.display_name || agent?.id || '',
          generatedAt: Date.now(),
          scope: workspaceThinkingScope,
          entries: filteredStream.map(entry => ({ ...entry }))
        };

        let emptyMessage = '该 Agent 暂无思考记录';
        if (workspaceThinkingScope === 'current' && !activeTask) {
          emptyMessage = '当前没有运行中的任务，无法限定到“当前任务”';
        } else if (workspaceThinkingScope === 'current' && filterTaskId && filteredStream.length === 0) {
          emptyMessage = '当前任务尚未产出思考记录';
        } else if (searchKeyword && filteredStream.length === 0) {
          emptyMessage = '没有符合搜索条件的记录';
        } else if (filteredStream.length === 0 && stream.length > 0) {
          emptyMessage = '暂无符合筛选条件的思考记录';
        }

        const entryHtml = displayStream.length > 0
          ? displayStream.map(entry => renderThinkingStreamEntry(entry, activeTask)).join('')
          : '<div class="empty-state">' + emptyMessage + '</div>';
        const streamIndicator = renderLlmStreamIndicator(agent, activeTask);
        const scopeOptions = [
          { key: 'all', label: '全部记录', disabled: false },
          { key: 'current', label: '当前任务', disabled: !activeTask }
        ];
        const scopeButtonsHtml = scopeOptions.map(opt =>
          '<button class="thinking-chip ' + (workspaceThinkingScope === opt.key ? 'active' : '') + '" data-action="setWorkspaceScope" data-scope="' + opt.key + '"' + (opt.disabled ? ' disabled' : '') + '>' + opt.label + '</button>'
        ).join('');
        const allTypesSelected = workspaceThinkingTypeFilters.size === THINKING_TYPE_OPTIONS.length;
        const typeChipsHtml = THINKING_TYPE_OPTIONS.map(opt => {
          const active = workspaceThinkingTypeFilters.has(opt.key);
          return '<button class="thinking-chip ' + (active ? 'active' : '') + '" data-action="toggleThinkingTypeFilter" data-filter-key="' + opt.key + '">' + opt.label + '</button>';
        }).join('');
        const resetTypesHtml = allTypesSelected
          ? ''
          : '<button class="thinking-chip ghost" data-action="resetThinkingTypeFilters">重置</button>';
        const filtersHtml = [
          '<div class="workspace-thinking-filters">',
            '<div class="thinking-chip-group">',
              '<span class="thinking-chip-label">范围</span>',
              scopeButtonsHtml,
            '</div>',
            '<div class="thinking-chip-group thinking-chip-types">',
              '<span class="thinking-chip-label">类型</span>',
              typeChipsHtml,
              resetTypesHtml,
            '</div>',
            '<label class="workspace-thinking-searchbox">',
              '<span class="workspace-thinking-search-icon">🔍</span>',
              '<input type="text" id="workspace-thinking-search" placeholder="搜索内容 / 工具 / 文件" value="' + escapeHtml(workspaceThinkingSearch) + '" oninput="handleWorkspaceThinkingSearch(event)">',
            '</label>',
          '</div>'
        ].join('');
        const summaryHtml = totalCount > 0 || filteredCount > 0
          ? '<div class="workspace-thinking-summary">显示 <strong>' + limitedCount + '</strong> / ' + filteredCount + ' 条 · 总计 ' + totalCount + '</div>'
          : '';
        const badgeText = limitedCount + '/' + (totalCount || 0);
        const hasEntries = filteredStream.length > 0;
        const actionsHtml = `
          <div class="workspace-section-actions">
            <button class="link-button" data-action="expandAllThinkingEntries" ${hasEntries ? '' : 'disabled'}>全部展开</button>
            <button class="link-button" data-action="collapseAllThinkingEntries" ${hasEntries ? '' : 'disabled'}>全部折叠</button>
            <button class="link-button" data-action="exportThinkingLog" ${hasEntries ? '' : 'disabled'}>导出</button>
          </div>
        `;
        const externalInputs = getExternalInputsForAgent(agent, 12);
        const externalListHtml = externalInputs.length
          ? '<div class="workspace-external-list">' + externalInputs.map(renderExternalInputCard).join('') + '</div>'
          : '<div class="empty-state">暂无提及该 Agent 的外部输入。</div>';

        thinking.innerHTML = [
          '<div class="workspace-section">',
            '<div class="workspace-section-header">',
              '<div class="workspace-section-title">',
                '思考过程',
                '<span class="badge badge-default">' + badgeText + '</span>',
              '</div>',
              actionsHtml,
            '</div>',
            '<div class="workspace-section-body">',
              streamIndicator,
              filtersHtml,
              summaryHtml,
              '<div class="thinking-chat-list" id="workspace-thinking-list">',
                entryHtml,
              '</div>',
              '<details class="workspace-external-stack">',
                '<summary>外部输入 (' + externalInputs.length + ')</summary>',
                externalListHtml,
              '</details>',
            '</div>',
          '</div>'
        ].join('');
      }

      function setThinkingEntriesExpansion(expand) {
        const list = document.getElementById('workspace-thinking-list');
        if (!list) {
          return;
        }
        list.querySelectorAll('.thinking-log-entry').forEach(entryEl => {
          entryEl.classList.toggle('collapsed', !expand);
          const header = entryEl.querySelector('.thinking-log-header');
          if (header) {
            header.setAttribute('aria-expanded', expand ? 'true' : 'false');
          }
          const icon = entryEl.querySelector('.thinking-log-toggle-icon');
          if (icon) {
            icon.textContent = expand ? '▼' : '▶';
          }
          const encoded = entryEl.getAttribute('data-entry-key');
          if (encoded) {
            try {
              const decoded = decodeURIComponent(encoded);
              thinkingEntryExpansion.set(decoded, expand);
            } catch (error) {
              console.warn('[ThinkingLog] Failed to decode entry key', error);
            }
          }
        });
      }

      window.expandAllThinkingEntries = function() {
        setThinkingEntriesExpansion(true);
      };

      window.collapseAllThinkingEntries = function() {
        setThinkingEntriesExpansion(false);
      };

      function formatThinkingEntryForExport(entry) {
        const timestamp = entry.timestamp ? formatTime(entry.timestamp) : '';
        const typeLabel = entry.stepType ? getThinkingStepTypeText(entry.stepType) : getThinkingStepTypeText(entry.type);
        const lines = [];
        lines.push(`[${timestamp}] ${typeLabel}`);
        if (entry.taskId) {
          lines.push(`任务: ${entry.taskId}`);
        }
        if (entry.content) {
          lines.push(entry.content.trim());
        }
        if (entry.tool) {
          lines.push(`工具: ${entry.tool.name}`);
          if (entry.tool.input) {
            lines.push('输入:');
            lines.push(formatThinkingPayload(entry.tool.input, 600));
          }
          if (entry.tool.output) {
            lines.push('输出:');
            lines.push(formatThinkingPayload(entry.tool.output, 600));
          }
        }
        if (entry.fileChange) {
          lines.push(`文件: ${entry.fileChange.file_path || entry.fileChange.id}`);
          if (entry.fileChange.diff) {
            lines.push(entry.fileChange.diff.slice(0, 800));
          }
        }
        if (entry.governance) {
          lines.push(`治理: ${formatGovernanceAction(entry.governance.action)}`);
          if (entry.governance.summary) {
            lines.push(entry.governance.summary);
          }
        }
        if (entry.userMessage) {
          lines.push('用户补充:');
          lines.push(formatMultilineText(entry.userMessage.content || ''));
        }
        return lines.join('\n');
      }

      window.exportThinkingLog = function() {
        if (!lastThinkingSnapshot.entries.length) {
          updateStatus('暂无可导出的思考记录');
          return;
        }
        const header = `Agent ${lastThinkingSnapshot.agentName || lastThinkingSnapshot.agentId || '未知'} · 条目 ${lastThinkingSnapshot.entries.length} · 范围 ${workspaceThinkingScope === 'current' ? '当前任务' : '全部记录'}`;
        const body = lastThinkingSnapshot.entries.map(formatThinkingEntryForExport).join('\n\n');
        const content = `${header}\n\n${body}`;
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(content).then(() => {
            updateStatus('已复制思考日志到剪贴板');
          }).catch(() => {
            vscode.postMessage({
              type: 'show_info',
              message: '复制失败，请手动复制'
            });
          });
        } else {
          vscode.postMessage({
            type: 'show_info',
            message: '当前环境不支持剪贴板，请手动复制'
          });
        }
      };

      function getActiveLlmStream(agent, activeTask) {
        const entries = Array.from(llmStreamStates.values());
        const sessionId = currentSessionId;
        const filtered = entries
          .filter(entry => {
            if (entry.session_id && sessionId && entry.session_id !== sessionId) {
              return false;
            }
            if (agent && entry.agent_id && entry.agent_id !== agent.id) {
              return false;
            }
            if (workspaceThinkingScope === 'current' && activeTask && entry.task_id && entry.task_id !== activeTask.id) {
              return false;
            }
            return entry.status === 'stream';
          })
          .sort((a, b) => (b.updatedAt || 0) - (a.updatedAt || 0));
        return filtered[0] || null;
      }

      function renderLlmStreamIndicator(agent, activeTask) {
        const streamState = getActiveLlmStream(agent, activeTask);
        if (!streamState) {
          return '';
        }
        const label = streamState.status === 'error' ? 'LLM 异常' : 'LLM 输出中...';
        const badge = streamState.task_id
          ? '<span class="badge badge-info">任务 ' + escapeHtml(streamState.task_id) + '</span>'
          : '';
        const content = streamState.content && streamState.content.trim().length > 0
          ? formatMultilineText(streamState.content)
          : '正在生成...';
        return [
          '<div class="workspace-thinking-stream">',
            '<div class="workspace-thinking-stream-status">',
              streamState.status === 'stream' ? '<span class="spinner" aria-hidden="true"></span>' : '',
              '<span>' + escapeHtml(label) + '</span>',
              badge,
            '</div>',
            '<div class="workspace-thinking-stream-content">' + content + '</div>',
          '</div>'
        ].join('');
      }

      function renderWorkspace(agent) {
        if (!agent) {
          setWorkspaceEmptyState(true);
          return;
        }

        setWorkspaceEmptyState(false);

        const nameEl = document.getElementById('workspace-agent-name');
        if (nameEl) {
          const displayName = escapeHtml(agent.display_name || agent.id);
          nameEl.innerHTML = displayName + '<span class="workspace-agent-id"> #' + escapeHtml(agent.id) + '</span>';
        }
        const metaEl = document.getElementById('workspace-agent-meta');
        if (metaEl) {
          const roles = (agent.roles || []).map(getRoleText).join(' / ') || '未配置角色';
          const statusText = agent.is_enabled === false ? '已停用' : getStatusText(agent.status || 'offline');
          metaEl.textContent = roles + ' · ' + statusText;
        }

        const agentTasks = (allTasks || []).filter(task =>
          task.assigned_to === agent.id &&
          (!currentSessionId || (task.session_id || null) === currentSessionId)
        );
        const agentLogs = (allThinkingLogs || []).filter(log =>
          log.agent_id === agent.id &&
          (!currentSessionId || (log.session_id || null) === currentSessionId)
        );
        renderWorkspaceOverview(agent, agentTasks);
        renderWorkspaceThinking(agent, agentTasks, agentLogs);
        switchWorkspaceTabInternal(currentWorkspaceTab || 'overview');
      }

      window.switchWorkspaceTab = function(input) {
        if (input && typeof input.preventDefault === 'function') {
          input.preventDefault();
        }
        if (typeof input === 'string') {
          switchWorkspaceTabInternal(input);
          return;
        }
        const target = input && input.currentTarget ? input.currentTarget : (input && input.target ? input.target : null);
        const tab = target ? target.getAttribute('data-workspace-tab') : null;
        switchWorkspaceTabInternal(tab || currentWorkspaceTab || 'overview');
      };

      window.refreshWorkspace = function() {
        const agent = selectedAgentId ? allAgents.find(a => a.id === selectedAgentId) : null;
        renderWorkspace(agent || null);
      };

      function workspaceTabVisible() {
        const workspaceTab = document.getElementById('main-tab-workspace');
        return workspaceTab && workspaceTab.classList.contains('active');
      }

      function rerenderWorkspaceIfVisible() {
        if (!selectedAgentId || !workspaceTabVisible()) {
          return;
        }
        const agent = allAgents.find(a => a.id === selectedAgentId);
        if (agent) {
          renderWorkspace(agent);
        }
      }

      window.setWorkspaceThinkingScope = function(scope) {
        const nextScope = scope === 'current' ? 'current' : 'all';
        if (workspaceThinkingScope === nextScope) {
          return;
        }
        workspaceThinkingScope = nextScope;
        const agent = selectedAgentId ? allAgents.find(a => a.id === selectedAgentId) : null;
        renderWorkspace(agent || null);
      };

      window.handleWorkspaceThinkingSearch = function(event) {
        const value = event && event.target ? event.target.value : '';
        workspaceThinkingSearch = value || '';
        const agent = selectedAgentId ? allAgents.find(a => a.id === selectedAgentId) : null;
        renderWorkspace(agent || null);
      };

      window.toggleThinkingTypeFilter = function(input) {
        const key = typeof input === 'string' && input
          ? input
          : (input && input.currentTarget ? input.currentTarget.getAttribute('data-filter-key') : (input && input.getAttribute ? input.getAttribute('data-filter-key') : null));
        if (!key) {
          return;
        }
        if (!workspaceThinkingTypeFilters.has(key)) {
          workspaceThinkingTypeFilters.add(key);
        } else if (workspaceThinkingTypeFilters.size > 1) {
          workspaceThinkingTypeFilters.delete(key);
        } else {
          return;
        }
        const agent = selectedAgentId ? allAgents.find(a => a.id === selectedAgentId) : null;
        renderWorkspace(agent || null);
      };

      window.resetThinkingTypeFilters = function() {
        workspaceThinkingTypeFilters = new Set(DEFAULT_THINKING_TYPE_KEYS);
        const agent = selectedAgentId ? allAgents.find(a => a.id === selectedAgentId) : null;
        renderWorkspace(agent || null);
      };

      function extractEntryIdFromEvent(event) {
        if (!event) {
          return null;
        }
        if (typeof event === 'string') {
          return event;
        }
        const target = event.currentTarget || event.target;
        if (target && target.getAttribute) {
          const idAttr = target.getAttribute('data-entry-id');
          if (idAttr) {
            return idAttr;
          }
          const entryEl = target.closest('.thinking-log-entry');
          if (entryEl) {
            return entryEl.getAttribute('data-entry-id');
          }
        }
        return null;
      }

      function getThinkingEntryElement(entryId) {
        if (!entryId) {
          return null;
        }
        return document.querySelector('.thinking-log-entry[data-entry-id="' + entryId + '"]');
      }

      window.toggleThinkingEntry = function(input) {
        const entryId = typeof input === 'string' && input
          ? input
          : extractEntryIdFromEvent(input);
        if (!entryId) {
          return;
        }
        const normalizedId = String(entryId);
        const nextExpanded = !(thinkingEntryExpansion.get(normalizedId) ?? false);
        thinkingEntryExpansion.set(normalizedId, nextExpanded);
        const listContainer = document.getElementById('workspace-thinking-list');
        const previousScrollTop = listContainer ? listContainer.scrollTop : null;
        const entryEl = getThinkingEntryElement(normalizedId);
        if (!entryEl) {
          return;
        }
        entryEl.classList.toggle('collapsed', !nextExpanded);
        const header = entryEl.querySelector('.thinking-log-header');
        if (header) {
          header.setAttribute('aria-expanded', nextExpanded ? 'true' : 'false');
        }
        const icon = entryEl.querySelector('.thinking-log-toggle-icon');
        if (icon) {
          icon.textContent = nextExpanded ? '▼' : '▶';
        }
        if (listContainer !== null && previousScrollTop !== null) {
          listContainer.scrollTop = previousScrollTop;
        }
      };

      switchWorkspaceTabInternal(currentWorkspaceTab);

      // Agent 操作函数（必须在 renderAgents 之前定义）
      window.selectAgent = function(agentId, event) {
        if (event) event.stopPropagation();
        selectedAgentId = agentId;

        // Update UI
        document.querySelectorAll('.agent-card').forEach(card => {
          const cardAgentId = card.getAttribute('data-agent-id');
          if (cardAgentId === agentId) {
            card.classList.add('selected');
          } else {
            card.classList.remove('selected');
          }
        });

        console.log('[MinimalPanel] Selected agent:', agentId);
        const agent = allAgents.find(a => a.id === agentId);
        renderWorkspace(agent || null);
      };

      window.editAgent = function(agentId) {
        console.log('[MinimalPanel] Edit agent:', agentId);
        const agent = allAgents.find(a => a.id === agentId);
        if (!agent) {
          console.error('[MinimalPanel] Agent not found:', agentId);
          return;
        }

        // 填充表单数据
        const form = document.getElementById('form-add-agent');
        form.querySelector('[name="id"]').value = agent.id;
        form.querySelector('[name="id"]').disabled = true; // ID 不可修改
        form.querySelector('[name="display_name"]').value = agent.display_name;
        setSelectedRoles(form, agent.roles || []);
        setSelectedCapabilities(form, agent.capabilities || []);
        setSelectedToolPermissions(form, agent.tool_permissions || []);
        // 填充 LLM 配置
        form.querySelector('[name="llm_provider"]').value = agent.llm_provider || '';
        form.querySelector('[name="llm_model"]').value = agent.llm_model || '';
        form.querySelector('[name="llm_api_key"]').value = agent.llm_api_key || '';
        form.querySelector('[name="llm_base_url"]').value = agent.llm_base_url || '';
        handleProviderChange();

        // 修改 Modal 标题和按钮
        const modal = document.getElementById('modal-add-agent');
        modal.querySelector('.modal-title').textContent = '编辑 Agent';
        const submitBtn = modal.querySelector('[data-action="submitAddAgent"]');
        submitBtn.setAttribute('data-action', 'submitEditAgent');
        submitBtn.setAttribute('data-agent-id', agentId);
        submitBtn.textContent = '保存';

        // 打开 Modal
        window.openModal('modal-add-agent');
      };

      window.deleteAgent = function(agentId) {
        console.log('[MinimalPanel] Delete agent:', agentId);
        // 直接发送删除请求，Extension 端会显示确认对话框
        vscode.postMessage({ type: 'delete_agent', data: { id: agentId } });
      };

      window.refreshAgent = function(agentId) {
        if (!agentId) {
          return;
        }
        pendingAgentRefresh.add(agentId);
        renderGlobalAgentTable(allAgents);
        vscode.postMessage({
          type: 'refresh_agent_llm',
          data: { id: agentId }
        });
      };

      window.toggleAgentEnabled = function(agentId, nextState) {
        if (!agentId) {
          return;
        }
        const enabled =
          typeof nextState === 'string'
            ? nextState === 'true'
            : !!nextState;
        vscode.postMessage({
          type: 'toggle_agent_enabled',
          data: { id: agentId, enabled }
        });
      };

      // Render functions
      function renderGlobalAgentTable(agents) {
        const container = document.getElementById('global-agent-list');
        if (!container) {
          return;
        }
        if (!agents || agents.length === 0) {
          container.innerHTML = '<div class="empty-state">暂无 Agent 数据</div>';
          return;
        }

        const validAgentIds = new Set(agents.map(agent => agent.id));
        Array.from(pendingAgentRefresh).forEach(id => {
          if (!validAgentIds.has(id)) {
            pendingAgentRefresh.delete(id);
          }
        });

        const cards = agents.map(agent => {
          const roles = agent.roles && agent.roles.length
            ? agent.roles.map(role => escapeHtml(getRoleText(role))).join('、')
            : '未设置';
          const capabilities = agent.capabilities && agent.capabilities.length
            ? agent.capabilities.map(cap => escapeHtml(getCapabilityText(cap))).join('、')
            : '未配置';
          const toolPermissions = agent.tool_permissions && agent.tool_permissions.length
            ? agent.tool_permissions.map(tool => escapeHtml(getToolPermissionText(tool))).join('、')
            : '未授权';
          const metrics = agent.metrics || null;
          const successRate = typeof metrics?.success_rate === 'number'
            ? Math.round(Math.max(0, Math.min(1, metrics.success_rate)) * 100)
            : null;
          const latencySeconds = typeof metrics?.average_response_ms === 'number'
            ? Math.max(0, Math.round(metrics.average_response_ms / 1000))
            : null;
          const metricsText = metrics
            ? `${successRate !== null ? successRate + '% 成功率' : '成功率未知'} · ${latencySeconds !== null ? latencySeconds + 's 响应' : '响应未知'}`
            : '暂无数据';
          const llmText = agent.llm_model
            ? escapeHtml(`${agent.llm_provider || '自定义'} · ${agent.llm_model}`)
            : '未配置';
          const heartbeat = agent.last_heartbeat_at ? formatTime(agent.last_heartbeat_at) : '--';
          const isEnabled = agent.is_enabled !== false;
          const statusText = isEnabled ? getStatusText(agent.status) : '已停用';
          const agentIdText = escapeHtml(agent.id);
          const displayName = escapeHtml(agent.display_name || agent.id);
          const statusClass = !isEnabled
            ? 'agent-status-disabled'
            : agent.status === 'online'
              ? 'agent-status-online'
              : agent.status === 'busy'
                ? 'agent-status-busy'
                : 'agent-status-offline';
         const isRefreshing = pendingAgentRefresh.has(agent.id);
          const refreshText = isRefreshing ? '刷新中...' : '刷新';
          const statusDetail = agent.status_detail ? escapeHtml(agent.status_detail) : '';
          const toggleLabel = isEnabled ? '停用' : '启用';
          const cardClasses = 'agent-config-card' + (isEnabled ? '' : ' agent-disabled');

          return `
            <div class="${cardClasses}">
              <div class="agent-card-header">
                <div class="agent-card-title">
                  <div class="global-agent-name">${displayName}</div>
                  <div class="global-agent-meta">ID: ${agentIdText}</div>
                </div>
                <span class="agent-status-badge ${statusClass}">${statusText}</span>
              </div>
              ${statusDetail ? `<div class="global-agent-meta">${statusDetail}</div>` : ''}
              <div class="agent-card-body">
                <div class="agent-card-section">
                  <div class="agent-card-section-title">角色</div>
                  <div>${roles}</div>
                </div>
                <div class="agent-card-section">
                  <div class="agent-card-section-title">能力</div>
                  <div>${capabilities}</div>
                </div>
                <div class="agent-card-section">
                  <div class="agent-card-section-title">工具权限</div>
                  <div>${toolPermissions}</div>
                </div>
                <div class="agent-card-section">
                  <div class="agent-card-section-title">LLM 配置</div>
                  <div>${llmText}</div>
                </div>
                <div class="agent-card-section">
                  <div class="agent-card-section-title">运行指标</div>
                  <div>${metricsText}</div>
                </div>
                <div class="agent-card-section">
                  <div class="agent-card-section-title">最近心跳</div>
                  <div>${heartbeat}</div>
                </div>
              </div>
              <div class="global-agent-actions">
                <button class="mcp-card-btn"
                  data-agent-id="${agentIdText}"
                  data-enable="${isEnabled ? 'false' : 'true'}"
                  onclick="toggleAgentEnabled(this.getAttribute('data-agent-id'), this.getAttribute('data-enable'))">${toggleLabel}</button>
                <button class="mcp-card-btn ghost"
                  data-agent-id="${agentIdText}"
                  onclick="refreshAgent(this.getAttribute('data-agent-id'))"
                  ${isRefreshing ? 'disabled' : ''}>${refreshText}</button>
                <button class="mcp-card-btn"
                  data-agent-id="${agentIdText}"
                  onclick="editAgent(this.getAttribute('data-agent-id'))">编辑</button>
                <button class="mcp-card-btn danger"
                  data-agent-id="${agentIdText}"
                  onclick="deleteAgent(this.getAttribute('data-agent-id'))">删除</button>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = cards;
      }

      function renderAgents(agents) {
        allAgents = agents || [];
        const container = document.getElementById('agents-list');
        const statsEl = document.getElementById('agent-stats');
        const hasAgents = allAgents.length > 0;
        const activeAgents = allAgents.filter(agent => agent.is_enabled !== false);
        const hasActive = activeAgents.length > 0;
        setAgentEmptyOverlay(!hasAgents);

        const panelHintHtml = '<div class="panel-inline-hint">提示：Agent 配置统一在「全局配置」页签维护。</div>';

        if (!hasAgents) {
          container.innerHTML = panelHintHtml + '<div class="empty-state">暂无 Agent</div>';
          if (statsEl) statsEl.textContent = '';
          renderWorkspace(null);
          renderGlobalAgentTable(allAgents);
          return;
        }

        if (!hasActive) {
          container.innerHTML = panelHintHtml + '<div class="empty-state">所有 Agent 均已停用，请先在全局配置页签启用。</div>';
          if (statsEl) statsEl.textContent = '0 / 0 在线';
          renderWorkspace(null);
          renderGlobalAgentTable(allAgents);
          return;
        }

        const sortedAgents = [...activeAgents].sort((a, b) => {
          if (a.status === 'online' && b.status !== 'online') return -1;
          if (a.status !== 'online' && b.status === 'online') return 1;
          return b.created_at - a.created_at;
        });

        const onlineCount = activeAgents.filter(a => a.status === 'online').length;
        if (statsEl) statsEl.textContent = onlineCount + ' / ' + activeAgents.length + ' 在线';

        const displayAgents = sortedAgents.slice(0, 6);
        if (!selectedAgentId && displayAgents.length > 0) {
          selectedAgentId = displayAgents[0].id;
        }

        const cardsHtml = displayAgents.map(agent => {
          const isSelected = selectedAgentId === agent.id;
          const statusClass = agent.status === 'online' ? 'agent-status-online' :
                             agent.status === 'busy' ? 'agent-status-busy' :
                             'agent-status-offline';
          const roles = agent.roles && agent.roles.length > 0 ? agent.roles : [];
          const roleBadges = roles.length > 0
            ? roles.map(role => `<span class="badge badge-default">${getRoleText(role)}</span>`).join(' ')
            : '<span class="badge badge-default">未设置</span>';

          return `
            <div class="agent-card ${isSelected ? 'selected' : ''}" data-agent-id="${agent.id}" onclick="selectAgent('${agent.id}', event)">
              <div class="agent-card-header">
                <div class="agent-card-name">
                  <div class="agent-status-dot ${statusClass}"></div>
                  <span class="agent-name-text">${agent.display_name} (${agent.id})</span>
                </div>
              </div>
              <div class="agent-card-footer">
                <span class="agent-role-badges">${roleBadges}</span>
                <span class="agent-heartbeat">${formatTime(agent.last_heartbeat_at)}</span>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = panelHintHtml + cardsHtml;

        const selectedAgent = allAgents.find(agent => agent.id === selectedAgentId);
        renderWorkspace(selectedAgent || null);
        renderGlobalAgentTable(allAgents);
      }

      // Render tasks
      function renderTasks(tasks) {
        allTasks = Array.isArray(tasks) ? tasks : [];
        const container = document.getElementById('tasks-list');
        const statsEl = document.getElementById('task-stats');

        let scopedTasks = currentSessionId
          ? allTasks.filter(task => (task.session_id || null) === currentSessionId)
          : [];
        sessionTasks = scopedTasks;
        renderWorkflowTodos();
        renderWorkflowStagePanel();

        taskDependencyGraph = buildTaskDependencyGraph(scopedTasks);
        const progressHtml = buildTaskProgressSummary(currentSessionId);

        if (statsEl) {
          const completedCount = scopedTasks.filter(task => normalizeTaskStatus(task.status) === 'completed').length;
          statsEl.textContent = scopedTasks.length ? `${completedCount}/${scopedTasks.length}` : '';
        }

        if (!scopedTasks.length) {
          const emptyHtml = currentSessionId
            ? '<div class="empty-state">当前会话暂无任务</div>'
            : '<div class="empty-state">请选择一个会话开始协作</div>';
          container.innerHTML = (progressHtml || '') + emptyHtml;
          if (selectedAgentId) {
            const currentAgent = allAgents.find(agent => agent.id === selectedAgentId);
            renderWorkspace(currentAgent || null);
          }
          return;
        }

        if (taskSummaryFilter && !taskSummaryFilter.startsWith('session:')) {
          if (taskSummaryFilter.startsWith('plan_source:')) {
            scopedTasks = scopedTasks.filter(task => Array.isArray(task.labels) && task.labels.includes(taskSummaryFilter));
          }
        }

        const groups = buildTaskGroupSummaries(scopedTasks);
        if (!groups.length) {
          container.innerHTML = (progressHtml || '') + '<div class="empty-state">暂无符合条件的任务</div>';
          return;
        }

        const cardsHtml = `
          <div class="task-group-grid">
            ${groups.map(renderTaskGroupCard).join('')}
          </div>
        `;
        container.innerHTML = (progressHtml || '') + cardsHtml;

        if (pendingTaskFocusId) {
          const targetId = pendingTaskFocusId;
          pendingTaskFocusId = null;
          ensurePanelExpanded('panel-tasks');
          setTimeout(() => focusTaskInList(targetId), 0);
        }
      }

      function buildTaskGroupSummaries(tasks) {
        const map = new Map();
        tasks.forEach(task => {
          const instanceId = getLabelValue(task.labels, 'workflow_instance:') || 'ad_hoc';
          if (!map.has(instanceId)) {
            const detail = instanceId !== 'ad_hoc' ? getWorkflowInstanceDetailById(instanceId) : null;
            map.set(instanceId, {
              id: instanceId,
              detail,
              title: formatInstanceTitle(instanceId, detail),
              scenarioLabel: formatScenarioLabel(detail?.metadata?.scenario),
              tasks: []
            });
          }
          map.get(instanceId).tasks.push(task);
        });
        return Array.from(map.values()).map(group => {
          const total = group.tasks.length;
          const completed = group.tasks.filter(task => normalizeTaskStatus(task.status) === 'completed').length;
          const running = group.tasks.filter(task => {
            const status = normalizeTaskStatus(task.status);
            return status === 'running' || status === 'assigned';
          }).length;
          return {
            ...group,
            total,
            completed,
            running
          };
        }).sort((a, b) => {
          const outstandingA = a.total - a.completed;
          const outstandingB = b.total - b.completed;
          if (outstandingA !== outstandingB) {
            return outstandingB - outstandingA;
          }
          const updatedA = a.detail?.updatedAt || 0;
          const updatedB = b.detail?.updatedAt || 0;
          return updatedB - updatedA;
        });
      }

      function renderTaskGroupCard(group) {
        const percent = group.total ? Math.min(100, Math.round((group.completed / group.total) * 100)) : 0;
        const tasksHtml = group.tasks.slice(0, 4).map(renderTaskRow).join('');
        const metaText = group.id === 'ad_hoc'
          ? '未关联 Workflow 实例'
          : `实例 ${escapeHtml(group.id)} · ${escapeHtml(group.scenarioLabel || '未归类')}`;
        return `
          <div class="task-group-card" data-instance-id="${escapeHtml(group.id)}">
            <div class="task-group-head">
              <div>
                <div class="task-group-title">${escapeHtml(group.title)}</div>
                <div class="task-group-meta">${metaText}</div>
              </div>
              <div class="task-group-status">${group.completed}/${group.total}</div>
            </div>
            <div class="task-group-meter"><span style="width:${percent}%"></span></div>
            <div class="task-group-body">
              ${tasksHtml || '<div class="empty-state">暂无任务</div>'}
            </div>
          </div>
        `;
      }

      function renderTaskRow(task) {
        const persona = derivePersonaFromTask(task);
        const personaBadge = persona ? `<span class="badge badge-default">${escapeHtml(persona.label)}</span>` : '';
        const automationBadge = renderAutomationPill(task.metadata?.automation);
        const priorityLabel = PRIORITY_LABELS[task.priority] || task.priority || '未设置';
        const phaseLabel = getLabelValue(task.labels, 'workflow_phase:');
        const metaPieces = [
          personaBadge,
          phaseLabel ? `<span>阶段：${escapeHtml(phaseLabel)}</span>` : '',
          `<span>优先级：${escapeHtml(priorityLabel)}</span>`,
          automationBadge
        ].filter(Boolean);
        return `
          <div class="task-row" data-action="openTaskDetailModal" data-task-id="${escapeHtml(task.id)}">
            <div class="task-row-header">
              <div class="task-row-title">${escapeHtml(task.title || task.id)}</div>
              <div class="task-row-status">${escapeHtml(getTaskStatusLabel(task.status))}</div>
            </div>
            <div class="task-row-meta">
              ${metaPieces.length ? metaPieces.join('') : '<span>—</span>'}
            </div>
          </div>
        `;
      }

      function renderAutomationPill(automationMeta) {
        if (!automationMeta) {
          return '';
        }
        const status = automationMeta.last_run_status || (automationMeta.auto === false ? 'manual' : 'idle');
        const labelMap = {
          succeeded: '自动完成',
          failed: '自动失败',
          running: '执行中',
          idle: '待执行',
          manual: '待人工'
        };
        const text = labelMap[status] || '自动执行';
        return `<span class="task-row-automation">⚙ ${escapeHtml(text)}</span>`;
      }

      function buildTaskProgressSummary(sessionId) {
        if (!sessionId || !Array.isArray(taskBacklogSummaries)) {
          return '';
        }
        const groups = taskBacklogSummaries.filter(summary => summary.session_id === sessionId && summary.total > 0);
        if (!groups.length) {
          return '';
        }
        const sorted = groups.slice().sort((a, b) => {
          const outstandingA = a.total - a.completed;
          const outstandingB = b.total - b.completed;
          if (outstandingA !== outstandingB) {
            return outstandingB - outstandingA;
          }
          return a.title.localeCompare(b.title);
        });
        const visible = sorted.slice(0, 3);
        return `
          <div class="task-progress-summary">
            ${visible.map(item => buildTaskProgressCard(item, taskSummaryFilter === item.id)).join('')}
          </div>
        `;
      }

      function buildTaskProgressCard(summary, isActive) {
        const remaining = Math.max(summary.total - summary.completed, 0);
        const percent = summary.total ? Math.min(100, Math.round((summary.completed / summary.total) * 100)) : 0;
        const blockedLabel = summary.blocked ? ` · 阻塞 ${summary.blocked}` : '';
        return `
          <div class="task-progress-card${isActive ? ' active' : ''}">
            <div class="task-progress-card-head">
              <span class="task-progress-card-title">${escapeHtml(summary.title)}</span>
              <span class="task-progress-count">${summary.completed}/${summary.total}</span>
            </div>
            <div class="task-progress-meter"><span style="width:${percent}%"></span></div>
            <div class="task-progress-meta">剩余 ${remaining}${blockedLabel}</div>
            <div class="task-progress-actions">
              <button data-action="focusBacklogSummary" data-summary-id="${summary.id}">${isActive ? '查看全部任务' : '查看任务'}</button>
              ${isActive ? '<button class="ghost" data-action="clearBacklogFilter">清除筛选</button>' : ''}
            </div>
          </div>
        `;
      }

      function buildTaskNode(task, depth) {
        const responsibleId = task.assigned_to;
        const agentName = responsibleId ? getAgentName(responsibleId) : '未分配';
        const taskIdText = String(task.id);
        const isFileChangeMatch = fileChangeTaskFilter && taskIdText.includes(fileChangeTaskFilter);
        const highlightClass = isFileChangeMatch ? ' file-change-highlight' : '';
        const dependencyIds = taskDependencyGraph.dependencies.get(task.id) || [];
        const dependencyTasks = dependencyIds
          .map(id => getTaskById(id))
          .filter(Boolean);
        const resolvedDeps = dependencyTasks.filter(dep => dep.status === 'completed').length;
        const totalDeps = dependencyTasks.length;
        const dependencyStatusClass =
          totalDeps === 0 ? 'neutral' : resolvedDeps === totalDeps ? 'success' : 'warning';
        const childTaskIds = taskDependencyGraph.children.get(task.id) || [];
        const dependentsIds = taskDependencyGraph.dependents.get(task.id) || [];
        const hasDependencyDetails =
          totalDeps > 0 || childTaskIds.length > 0 || dependentsIds.length > 0;
        const normalizedStatus = normalizeTaskStatus(task.status);
        const taskActionButtons = [
          '<button class="task-action-btn" data-action="filterFileChangesByTask" data-task-id="' + taskIdText + '">查看关联变更</button>'
        ];
        if (hasDependencyDetails) {
          taskActionButtons.push('<button class="task-action-btn" data-action="openTaskDependencyModal" data-task-id="' + taskIdText + '">查看依赖</button>');
        }
        if (normalizedStatus === 'running') {
          taskActionButtons.push('<button class="task-action-btn" data-action="pauseTask" data-task-id="' + taskIdText + '">暂停任务</button>');
        }
        if (normalizedStatus === 'blocked' || normalizedStatus === 'paused') {
          taskActionButtons.push('<button class="task-action-btn" data-action="resumeTask" data-task-id="' + taskIdText + '">重新启动</button>');
        }

        const indentPx = depth > 0 ? Math.min(depth, 3) * 18 : 0;
        const depthClass = depth > 0 ? ' task-item-nested depth-' + depth : '';

        // 生成状态徽章
        const statusBadgeClass = `task-badge task-badge-status status-${normalizedStatus}`;
        const statusBadge = `<span class="${statusBadgeClass}">${escapeHtml(getStatusText(task.status))}</span>`;

        // 生成负责人徽章
        const assigneeBadgeClass = `task-badge task-badge-assignee${responsibleId ? '' : ' unassigned'}`;
        const assigneeBadge = `<span class="${assigneeBadgeClass}">${escapeHtml(agentName)}</span>`;

        // 生成优先级徽章
        const priorityLevel = task.priority || 0;
        let priorityClass = 'priority-none';
        if (priorityLevel >= 9) priorityClass = 'priority-critical';
        else if (priorityLevel >= 7) priorityClass = 'priority-high';
        else if (priorityLevel >= 4) priorityClass = 'priority-medium';
        else if (priorityLevel >= 1) priorityClass = 'priority-low';
        const priorityBadgeClass = `task-badge task-badge-priority ${priorityClass}`;
        const priorityBadge = `<span class="${priorityBadgeClass}">${escapeHtml(formatPriorityLabel(task.priority))}</span>`;

        return `
          <div class="task-item${highlightClass}${depthClass}" data-task-id="${taskIdText}" style="margin-left:${indentPx}px">
            <div class="task-item-header">
              <div>
                <div class="task-title">${escapeHtml(getTaskDisplayTitle(task))}</div>
                <div class="task-meta">
                  ${statusBadge}
                  ${assigneeBadge}
                  ${priorityBadge}
                </div>
              </div>
              <div class="task-actions">
                ${taskActionButtons.join('')}
              </div>
            </div>
            <div class="task-body">
              <div class="task-description">${formatMultilineText(task.description || '尚未填写任务描述')}</div>
              ${hasDependencyDetails ? `
                <div class="task-dependencies">
                  <span class="dependency-chip ${dependencyStatusClass}">依赖 ${resolvedDeps}/${totalDeps}</span>
                  ${childTaskIds.length ? `<span class="dependency-chip">子任务 ${childTaskIds.length}</span>` : ''}
                  ${dependentsIds.length ? `<span class="dependency-chip">被依赖 ${dependentsIds.length}</span>` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }
      function buildReferenceItemMeta(ref) {
        if (!ref || !ref.id) {
          return null;
        }
        const token = ref.token || buildReferenceToken(ref.type, ref.id);
        if (ref.type === 'task') {
          const task = getTaskById(ref.id);
          if (!task) {
            return {
              token,
              type: ref.type,
              id: ref.id,
              title: `任务 ${ref.id}`,
              subtitle: '任务不可用'
            };
          }
          return {
            token,
            type: ref.type,
            id: ref.id,
            title: getTaskDisplayTitle(task),
            subtitle: `状态：${getTaskStatusLabel(task.status)}`
          };
        }
        if (ref.type === 'file') {
          const change = getFileChangeById(ref.id);
          if (!change) {
            return {
              token,
              type: ref.type,
              id: ref.id,
              title: `文件变更 ${ref.id}`,
              subtitle: '记录不可用'
            };
          }
          const summary = change.change_type
            ? `${change.change_type.toUpperCase()} · ${formatTime(change.created_at)}`
            : formatTime(change.created_at);
          return {
            token,
            type: ref.type,
            id: ref.id,
            title: change.file_path || `变更 ${change.id}`,
            subtitle: summary
          };
        }
        if (ref.type === 'proof') {
          const record = getProofRecordById(ref.id);
          if (!record) {
            return {
              token,
              type: ref.type,
              id: ref.id,
              title: `Proof ${ref.id}`,
              subtitle: '记录不可用'
            };
          }
          const title = record.description || record.task_id || record.id;
          const subtitle = record.phase_id ? `阶段：${getPhaseTitle(record.phase_id)}` : '';
          return {
            token,
            type: ref.type,
            id: ref.id,
            title,
            subtitle
          };
        }
        if (ref.type === 'message') {
          const quotedMsg = allMessages.find(m => m.id === ref.id);
          return {
            token,
            type: ref.type,
            id: ref.id,
            title: quotedMsg ? getAgentName(quotedMsg.agent_id) : `消息 ${ref.id}`,
            subtitle: quotedMsg ? (quotedMsg.content || '').slice(0, 40) : ''
          };
        }
        return {
          token,
          type: ref.type || 'custom',
          id: ref.id,
          title: `${ref.type || '引用'} ${ref.id}`,
          subtitle: ''
        };
      }

      function getReferenceTypeLabel(type) {
        switch (type) {
          case 'task':
            return '任务';
          case 'file':
            return '文件';
          case 'proof':
            return 'Proof';
          case 'message':
            return '消息';
          default:
            return '引用';
        }
      }

      function buildReferenceToken(type, id) {
        if (!type) {
          return id;
        }
        return `${type}:${id}`;
      }

      function parseReferenceToken(value) {
        if (!value || typeof value !== 'string') {
          return null;
        }
        const colonIndex = value.indexOf(':');
        if (colonIndex === -1) {
          if (getTaskById(value)) {
            return { type: 'task', id: value, token: `task:${value}` };
          }
          if (getFileChangeById(value)) {
            return { type: 'file', id: value, token: `file:${value}` };
          }
          if (getProofRecordById(value)) {
            return { type: 'proof', id: value, token: `proof:${value}` };
          }
          return { type: 'message', id: value, token: value };
        }
        const type = value.slice(0, colonIndex);
        const id = value.slice(colonIndex + 1);
        return { type: type || 'message', id, token: value };
      }

      function parseMessageReferences(message) {
        if (!message) {
          return [];
        }
        const references = Array.isArray(message.references)
          ? message.references
          : (typeof message.references === 'string' ? safeParseArray(message.references) : []);
        const tokens = references.length ? references : legacyMessageReferences(message);
        return tokens
          .map(token => parseReferenceToken(token))
          .filter(Boolean);
      }

      function legacyMessageReferences(message) {
        const tokens = [];
        if (message.reference_type && message.reference_id) {
          tokens.push(`${message.reference_type}:${message.reference_id}`);
        } else if (message.reference_id) {
          tokens.push(message.reference_id);
        }
        return tokens;
      }

      function safeParseArray(value) {
        try {
          const parsed = JSON.parse(value);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      function buildMessageReferenceCard(ref) {
        if (!ref || ref.type === 'message') {
          return '';
        }
        const meta = buildReferenceItemMeta(ref);
        if (!meta) {
          return '';
        }
        const personaBadge = ref.type === 'task'
          ? buildPersonaBadgeHtml(derivePersonaFromTask(getTaskById(ref.id)))
          : '';
        const headerTools = `
          <div style="display:flex;align-items:center;gap:6px;">
            ${personaBadge}
            <button data-action="openReferenceTarget"
                    data-reference-type="${ref.type}"
                    data-reference-id="${ref.id}">
              查看
            </button>
          </div>
        `;
        return `
          <div class="message-reference-card">
            <div class="message-reference-card-header">
              <span>${escapeHtml(getReferenceTypeLabel(ref.type))}</span>
              ${headerTools}
            </div>
            <div class="message-reference-card-title">${escapeHtml(meta.title)}</div>
            ${meta.subtitle ? `<div style="color: var(--vscode-descriptionForeground);">${escapeHtml(meta.subtitle)}</div>` : ''}
          </div>
        `;
      }

      function resolveMessagePersona(message) {
        if (!message) {
          return null;
        }
        const agentId = (message.agent_id || '').toLowerCase();
        if (agentId === 'workflow_orchestrator' || agentId === 'system') {
          return { key: 'moderator', label: WORKFLOW_PERSONA_LABELS.moderator };
        }
        if (agentId === 'user' || agentId === 'customer') {
          return { key: 'user', label: WORKFLOW_PERSONA_LABELS.user };
        }
        const payloadPersona = message.payload?.workflow_role_persona || message.payload?.workflow_persona;
        if (payloadPersona && WORKFLOW_PERSONA_LABELS[payloadPersona]) {
          return { key: payloadPersona, label: WORKFLOW_PERSONA_LABELS[payloadPersona] };
        }
        const references = parseMessageReferences(message.references);
        const taskRef = references.find(ref => ref.type === 'task');
        if (taskRef) {
          const taskPersona = derivePersonaFromTask(getTaskById(taskRef.id));
          if (taskPersona) {
            return taskPersona;
          }
        }
        const agent = allAgents.find(agent => agent.id === message.agent_id);
        if (agent) {
          const persona = derivePersonaFromAgent(agent);
          if (persona) {
            return persona;
          }
        }
        return null;
      }

      function buildMessagePersonaBadge(message) {
        const persona = resolveMessagePersona(message);
        if (!persona) {
          return '';
        }
        return buildPersonaBadgeHtml(persona);
      }

      function buildPersonaBadgeHtml(persona) {
        if (!persona) {
          return '';
        }
        return `<span class="message-role-badge persona-${persona.key}">${escapeHtml(persona.label)}</span>`;
      }

      function derivePersonaFromTask(task) {
        if (!task) {
          return null;
        }
        const role = extractRoleFromLabels(task.labels);
        if (role) {
          const personaKey = mapRoleToPersona(role);
          if (personaKey) {
            return {
              key: personaKey,
              label: formatPersonaLabel(personaKey, role)
            };
          }
        }
        if (task.intent) {
          const personaFromIntent = mapIntentToPersona(task.intent);
          if (personaFromIntent) {
            return {
              key: personaFromIntent,
              label: formatPersonaLabel(personaFromIntent, task.intent)
            };
          }
        }
        return null;
      }

      function derivePersonaFromAgent(agent) {
        if (!agent || !Array.isArray(agent.roles)) {
          return null;
        }
        for (const role of agent.roles) {
          const persona = mapRoleToPersona(role);
          if (persona) {
            return {
              key: persona,
              label: formatPersonaLabel(persona, role)
            };
          }
        }
        return null;
      }

      function mapRoleToPersona(role) {
        if (!role) {
          return null;
        }
        const normalized = role.toLowerCase();
        if (ROLE_PERSONA_MAP[normalized]) {
          return ROLE_PERSONA_MAP[normalized];
        }
        return null;
      }

      function formatPersonaLabel(persona, role) {
        const base = WORKFLOW_PERSONA_LABELS[persona] || persona;
        if (!role) {
          return base;
        }
        const normalized = role.toLowerCase();
        const roleLabel = ROLE_DISPLAY_LABELS[normalized] || normalized;
        return `${base} · ${roleLabel}`;
      }

      function extractRoleFromLabels(labels) {
        if (!Array.isArray(labels)) {
          return null;
        }
        for (const label of labels) {
          if (label.startsWith('workflow_role:')) {
            return label.replace('workflow_role:', '');
          }
          if (label.startsWith('role:')) {
            return label.replace('role:', '');
          }
        }
        return null;
      }

      function mapIntentToPersona(intent) {
        if (!intent) {
          return null;
        }
        const normalized = intent.toLowerCase();
        if (normalized.includes('clarify') || normalized.includes('plan') || normalized.includes('approve')) {
          return 'lead';
        }
        if (normalized.includes('review') || normalized.includes('qa') || normalized.includes('signoff')) {
          return 'reviewer';
        }
        if (
          normalized.includes('implement') ||
          normalized.includes('write') ||
          normalized.includes('execute') ||
          normalized.includes('fix') ||
          normalized.includes('run') ||
          normalized.includes('bug') ||
          normalized.includes('defect')
        ) {
          return 'executor';
        }
        return null;
      }

      function openReferenceTarget(type, id) {
        if (!type || !id) {
          return;
        }
        if (type === 'task') {
          window.openTaskDetailModal(id);
          return;
        }
        if (type === 'file') {
          focusFileChangePanel();
          const numeric = Number(id);
          if (!Number.isNaN(numeric)) {
            window.toggleFileChangeDetail(numeric);
          }
          return;
        }
        if (type === 'proof') {
          window.switchBlackboardView('workflow');
          const proofList = document.getElementById('workflow-proof-list');
          if (proofList) {
            proofList.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
          return;
        }
      }

      // Render messages
      function renderMessages(messages) {
        allMessages = Array.isArray(messages) ? messages : [];
        const container = document.getElementById('messages-list');

        // Check if user was at bottom before rendering
        const wasAtBottom = isAtBottom(container);

        const scopedMessages = currentSessionId
          ? allMessages.filter(m => (m.session_id || null) === currentSessionId)
          : [];

        syncBlackboardEventEntries(scopedMessages);

        let filteredMessages = scopedMessages
          .filter(m => getMessageVisibilityValue(m) === 'blackboard')
          .filter(m => {
            const category = getMessageCategoryValue(m);
            return category !== 'system_event' && category !== 'automation';
          });

        // Filter by search query
        if (currentSearchQuery) {
          filteredMessages = filteredMessages.filter(m => {
            const content = m.content.toLowerCase();
            const agentName = getAgentName(m.agent_id).toLowerCase();
            return content.includes(currentSearchQuery) || agentName.includes(currentSearchQuery);
          });
        }

        // Sort: older messages first (chat style - new messages at bottom)
        filteredMessages = [...filteredMessages].sort((a, b) => a.created_at - b.created_at);

        if (filteredMessages.length === 0) {
          container.innerHTML = currentSessionId
            ? '<div class="empty-state">当前会话暂无消息</div>'
            : '<div class="empty-state">请选择一个会话开始协作</div>';
          hideNewMessageButton();
          return;
        }

        container.innerHTML = filteredMessages.map(msg => {
          const agentName = getAgentName(msg.agent_id);
          const avatarColor = getAgentAvatarColor(msg.agent_id);
          const avatarLetter = agentName.charAt(0).toUpperCase();
          const isUserMessage = msg.agent_id === 'user';
          const messageInstanceId = deriveMessageInstanceId(msg);
          const instanceBadge = buildMessageInstanceBadge(messageInstanceId);
          const parsedReferences = parseMessageReferences(msg);
          const quotedReference = parsedReferences.find(ref => ref.type === 'message');
          const attachmentReferences = parsedReferences.filter(ref => ref.type !== 'message');
          const backlogSummary = deriveMessageTaskBacklog(msg);
          const directBadge = buildMessageDirectBadge(msg);

          // Parse reply and quote
          let replyHtml = '';
          let quotedHtml = '';

          // 处理回复
          if (msg.reply_to) {
            const repliedMsg = allMessages.find(m => m.id === msg.reply_to);
            if (repliedMsg) {
              const repliedAgentName = getAgentName(repliedMsg.agent_id);
              const repliedContent = repliedMsg.content.length > 50
                ? repliedMsg.content.substring(0, 50) + '...'
                : repliedMsg.content;
              replyHtml = `
                <div class="message-reply">
                  <div class="message-reply-author">回复 @${repliedAgentName}:</div>
                  <div class="message-reply-content">${repliedContent}</div>
                </div>
              `;
            }
          }

          if (quotedReference) {
            const quotedMsg = allMessages.find(m => m.id === quotedReference.id);
            if (quotedMsg) {
              const quotedAgentName = getAgentName(quotedMsg.agent_id);
              const quotedContent = quotedMsg.content.length > 100
                ? quotedMsg.content.substring(0, 100) + '...'
                : quotedMsg.content;
              quotedHtml = `
                <div class="message-quoted">
                  <div class="message-quoted-author">引用 @${quotedAgentName}:</div>
                  <div class="message-quoted-content">${quotedContent}</div>
                </div>
              `;
            }
          }

          const backlogHtml = backlogSummary ? buildBacklogSummarySnippet(backlogSummary) : '';
          const attachmentsHtml = attachmentReferences.length
            ? `<div class="message-reference-cards">
                ${attachmentReferences.map(buildMessageReferenceCard).filter(Boolean).join('')}
               </div>`
            : '';

          return `
            <div class="message-item${isUserMessage ? ' user-message' : ''}">
              <div class="message-avatar message-avatar-${avatarColor}">${avatarLetter}</div>
              <div class="message-content">
                <div class="message-header">
                  <div style="display:flex;align-items:center;gap:4px;">
                    <span class="message-author">${agentName}</span>
                    ${buildMessagePersonaBadge(msg)}
                    ${instanceBadge}
                    ${directBadge}
                  </div>
                  <span class="message-time">${formatTime(msg.created_at)}</span>
                </div>
                <div class="message-bubble message-bubble-${avatarColor}">
                  <div style="margin-bottom: 6px;">
                    <span class="badge badge-${getMessageBadgeClass(msg.message_type)}">${getMessageTypeText(msg.message_type)}</span>
                    ${msg.priority === 'high' ? '<span class="badge badge-error" style="margin-left: 4px;">高优先级</span>' : ''}
                  </div>
                  ${replyHtml}
                  ${quotedHtml}
                  <div class="message-text">${msg.content}</div>
                  ${backlogHtml}
                  ${attachmentsHtml}
                  <div class="message-actions">
                    ${!isUserMessage ? `<button class="message-action-btn" data-msg-id="${msg.id}" onclick="handleReplyMessage('${msg.id}')">回复</button>` : ''}
                    <button class="message-action-btn" data-msg-id="${msg.id}" onclick="handleQuoteMessage('${msg.id}')">引用</button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');

        // Auto-scroll logic after rendering
        // Use setTimeout to ensure DOM is updated
        setTimeout(() => {
          if (!isUserScrolling || wasAtBottom) {
            // User was at bottom or first load -> auto scroll to bottom
            scrollToBottom(container, false);
            hasNewMessages = false;
            hideNewMessageButton();
          } else {
            // User is viewing history -> show new message indicator
            hasNewMessages = true;
            showNewMessageButton();
          }
        }, 0);
        rerenderWorkspaceIfVisible();
      }

      // Agent interaction functions
      // Main Tab Switching
      window.switchMainTab = function(tab, evt) {
        currentMainTab = tab;
        document.querySelectorAll('.main-tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.main-tab-content').forEach(content => content.classList.remove('active'));

        const mainTabTrigger = (evt && evt.target) || document.querySelector(".main-tab-button[data-main-tab='" + tab + "']");
        if (mainTabTrigger) {
          mainTabTrigger.classList.add('active');
        }
        const tabContent = document.getElementById('main-tab-' + tab);
        if (tabContent) {
          tabContent.classList.add('active');
        }

        // Load data for the selected tab
        if (tab === 'workspace') {
          // Agent 工作台数据会通过事件自动更新
        } else if (tab === 'global') {
          refreshGlobalConfigData();
        }
      };

      let currentGlobalConfigTab = 'agents';

      window.switchGlobalConfigTab = function(tab) {
        currentGlobalConfigTab = tab;
        document.querySelectorAll('.global-config-tab').forEach(btn => {
          if (btn.getAttribute('data-global-tab') === tab) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        document.querySelectorAll('.global-tab-content').forEach(content => {
          if (content.id === 'global-tab-' + tab) {
            content.classList.add('active');
          } else {
            content.classList.remove('active');
          }
        });

        if (tab === 'mcp') {
          vscode.postMessage({ type: 'get_mcp_servers' });
        }
      };

      window.switchGlobalConfigTab(currentGlobalConfigTab);

      function refreshGlobalConfigData() {
        window.switchGlobalConfigTab(currentGlobalConfigTab);
        vscode.postMessage({ type: 'get_mcp_servers' });
      }

      window.openGlobalAgentTab = function() {
        window.switchMainTab('global');
        window.switchGlobalConfigTab('agents');
      };

      window.setWorkflowInstanceFilter = function(filter) {
        if (!filter || filter === workflowInstanceFilter) {
          return;
        }
        workflowInstanceFilter = filter;
        renderWorkflowInstanceList();
      };

      window.setWorkflowScenarioFilter = function(scenario) {
        let normalized = null;
        if (typeof scenario === 'string') {
          normalized = scenario.trim().length > 0 ? scenario.trim() : null;
        } else if (scenario) {
          const value = String(scenario).trim();
          normalized = value.length > 0 ? value : null;
        }
        if (normalized === workflowInstanceScenarioFilter) {
          workflowInstanceScenarioFilter = null;
        } else {
          workflowInstanceScenarioFilter = normalized;
        }
        renderWorkflowInstanceList();
      };

      window.openCreateSessionModal = function() {
        pendingCreateSessionId = 'session-' + Date.now();
        const preview = document.getElementById('session-create-preview');
        if (preview) {
          preview.textContent = pendingCreateSessionId;
        }
        window.openModal('modal-create-session');
      };

      window.confirmCreateSession = function() {
        if (!pendingCreateSessionId) {
          return;
        }
        sessionIdToAutoSelect = pendingCreateSessionId;
        vscode.postMessage({ type: 'create_session', data: { id: pendingCreateSessionId } });
        pendingCreateSessionId = null;
        window.closeModal();
      };

      window.openDeleteSessionModal = function() {
        if (!currentSessionId) {
          vscode.postMessage({ type: 'show_info', message: '暂无可删除的会话' });
          return;
        }
        pendingDeleteSessionId = currentSessionId;
        const preview = document.getElementById('session-delete-preview');
        if (preview) {
          preview.textContent = pendingDeleteSessionId;
        }
        window.openModal('modal-delete-session');
      };

      window.confirmDeleteSession = function() {
        if (!pendingDeleteSessionId) {
          window.closeModal();
          return;
        }
        vscode.postMessage({ type: 'delete_session', data: { id: pendingDeleteSessionId } });
        pendingDeleteSessionId = null;
        window.closeModal();
      };

      function setCurrentWorkflowInstance(instanceId, options = {}) {
        if (!currentSessionId || !instanceId) {
          return;
        }
        const instance = getWorkflowInstanceDetailById(instanceId);
        if (!instance || (instance.sessionId || null) !== currentSessionId) {
          return;
        }
        if (currentWorkflowInstanceId === instanceId && !options.force) {
          return;
        }
        currentWorkflowInstanceId = instanceId;
        workflowInstanceSelections.set(currentSessionId, instanceId);
        renderWorkflowStagePanel();
        renderWorkflowTodos();
        if (!options.skipProofRefresh) {
          requestProofRecordsSnapshot();
        }
      }

      window.selectWorkflowInstance = function(instanceId) {
        setCurrentWorkflowInstance(instanceId);
      };

      window.focusWorkflowInstance = function(instanceId) {
        setCurrentWorkflowInstance(instanceId);
        window.switchBlackboardView('workflow');
      };

      // Blackboard View Switching
      window.switchBlackboardView = function(view) {
        currentBlackboardView = view;
        document.querySelectorAll('.sub-tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));

        const subTabTrigger = (typeof event !== 'undefined' && event && event.target) || document.querySelector(".sub-tab-button[onclick*='" + view + "']");
        if (subTabTrigger) {
          subTabTrigger.classList.add('active');
        }
        document.getElementById('blackboard-' + view).classList.add('active');

        // Load data for the selected view
        if (view === 'workflow') {
          renderWorkflowStagePanel();
          renderWorkflowTodos();
          return;
        }
        if (view === 'discussion') {
          if (!currentSessionId) {
            updateStatus('请先创建或选择一个会话');
            return;
          }
          requestMessagesSnapshot('tab-switch');
        } else if (view === 'governance') {
          fetchGovernanceHistory({ resetPage: false });
        } else if (view === 'mcp') {
          vscode.postMessage({ type: 'get_mcp_servers' });
        } else if (view === 'tools') {
          renderToolRuns();
          if (currentSessionId) {
            requestToolRunsSnapshot();
          }
        } else if (view === 'notifications') {
          if (!currentSessionId) {
            updateStatus('请先创建或选择一个会话');
            return;
          }
          vscode.postMessage({ type: 'get_notifications', data: { session_id: currentSessionId } });
        } else if (view === 'governance-analytics') {
          fetchGovernanceAnalytics();
        }
      };

      // Message Search
      let currentSearchQuery = '';

      window.searchMessages = function(query) {
        currentSearchQuery = query.toLowerCase();
        renderMessages(allMessages);
      };

      window.applyMessageTemplate = function(templateId) {
        const template = MESSAGE_TEMPLATES.find(item => item.id === templateId);
        if (!template) {
          return;
        }
        const input = document.getElementById('message-input');
        if (!input) {
          return;
        }
        const prefix = input.value && !input.value.endsWith('\n') ? '\n' : '';
        input.value = input.value ? (input.value + prefix + template.content) : template.content;
        input.focus();
        handleMessageInputChange();
      };

      // Handle Reply Message
      window.handleReplyMessage = function(messageId) {
        const message = allMessages.find(m => m.id === messageId);
        if (message) {
          replyToMessage = message;
          quotedMessage = null;
          renderReplyIndicator();
          document.getElementById('message-input').focus();
        }
      };

      // Handle Quote Message
      window.handleQuoteMessage = function(messageId) {
        const message = allMessages.find(m => m.id === messageId);
        if (message) {
          quotedMessage = message;
          replyToMessage = null;
          renderReplyIndicator();
          document.getElementById('message-input').focus();
        }
      };

      // Render Reply Indicator
      function renderReplyIndicator() {
        const container = document.getElementById('reply-indicator');
        if (!replyToMessage && !quotedMessage) {
          container.innerHTML = '';
          return;
        }

        const msg = replyToMessage || quotedMessage;
        const agentName = getAgentName(msg.agent_id);
        const isReply = !!replyToMessage;
        const action = isReply ? '回复' : '引用';
        const cssClass = isReply ? 'is-reply' : 'is-quote';

        container.innerHTML = `
          <div class="reply-indicator ${cssClass}">
            <span class="reply-indicator-text">${action} @${agentName}: ${msg.content.substring(0, 50)}...</span>
            <button class="reply-indicator-close" onclick="cancelReply()">×</button>
          </div>
        `;
      }

      // Cancel Reply
      window.cancelReply = function() {
        replyToMessage = null;
        quotedMessage = null;
        renderReplyIndicator();
      };

      // Send Message
      window.sendMessage = function() {
        const input = document.getElementById('message-input');
        const content = input.value.trim();

        if (!currentSessionId) {
          ensureActiveSession();
        }

        if (!content) return;

        handleMessageInputChange();
        const inferredType = currentMessageTypeGuess || inferMessageTypeFromContent(content);
        const finalMessageType = inferredType || 'discussion';

        const messageData = {
          content: content,
          message_type: finalMessageType,
          priority: 'normal',
          session_id: currentSessionId
        };

        if (replyToMessage) {
          messageData.reply_to = replyToMessage.id;
        }

        if (quotedMessage) {
          const referenceTokens = [buildReferenceToken('message', quotedMessage.id)];
          messageData.references = JSON.stringify(referenceTokens);
        }

        vscode.postMessage({
          type: 'send_message',
          data: messageData
        });
        requestMessagesSnapshot('post-message');

        input.value = '';
        cancelReply();
        hideMentionSuggestions();
        handleMessageInputChange();
      };

      // ========== Votes Rendering ==========
      let allVotes = [];

      // 倒计时更新函数
      let countdownIntervals = [];

      function updateCountdowns() {
        const now = Date.now();
        document.querySelectorAll('[data-countdown]').forEach(el => {
          const timeoutAt = parseInt(el.getAttribute('data-countdown'));
          const timeLeft = timeoutAt - now;

          if (timeLeft <= 0) {
            el.textContent = '已超时';
            el.style.color = '#f44336';
          } else {
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            el.textContent = `剩余 ${minutes} 分 ${seconds} 秒`;
          }
        });
      }

      function renderVotes(votes) {
        allVotes = Array.isArray(votes) ? votes : [];
        const container = document.getElementById('votes-list');
        const statsEl = document.getElementById('vote-stats');

        // 清理旧的倒计时定时器
        countdownIntervals.forEach(interval => clearInterval(interval));
        countdownIntervals = [];

        let scopedVotes = currentSessionId
          ? allVotes.filter(vote => (vote.session_id || null) === currentSessionId)
          : [];

        if (!scopedVotes.length) {
          container.innerHTML = currentSessionId
            ? '<div class="empty-state">当前会话暂无投票</div>'
            : '<div class="empty-state">请选择一个会话以查看投票</div>';
          if (statsEl) statsEl.textContent = '';
          governanceSummary.pendingVotes = 0;
          governanceSummary.timeoutVotes = 0;
          governanceSummary.nextPendingVoteId = null;
          governanceSummary.nextTimeoutVoteId = null;
          updateGovernanceSummaryUI();
          return;
        }

        // Update stats
        const pendingCount = scopedVotes.filter(v => v.status === 'pending').length;
        if (statsEl) statsEl.textContent = pendingCount > 0 ? pendingCount + ' 待处理' : '';

        // Sort: pending first, then by created_at desc
        const sortedVotes = [...scopedVotes].sort((a, b) => {
          if (a.status === 'pending' && b.status !== 'pending') return -1;
          if (a.status !== 'pending' && b.status === 'pending') return 1;
          return b.created_at - a.created_at;
        });
        const timeoutSoonCount = sortedVotes.filter(v => isVoteTimeoutSoon(v)).length;
        const firstPendingVote = sortedVotes.find(v => v.status === 'pending');
        const firstTimeoutVote = sortedVotes.find(v => v.status === 'pending' && isVoteTimeoutSoon(v));
        governanceSummary.pendingVotes = pendingCount;
        governanceSummary.timeoutVotes = timeoutSoonCount;
        governanceSummary.nextPendingVoteId = firstPendingVote ? firstPendingVote.id : null;
        governanceSummary.nextTimeoutVoteId = firstTimeoutVote ? firstTimeoutVote.id : null;
        governanceSummary.lastPolledAt = Date.now();
        updateGovernanceSummaryUI();

        container.innerHTML = sortedVotes.map(vote => {
          const isPending = vote.status === 'pending';
          const votesList = vote.votes || [];
          const isTimeoutSoon = isVoteTimeoutSoon(vote);

          // 检查用户是否已投票
          const userVote = votesList.find(v => v.agent_id === 'user');
          const agentVotes = votesList.filter(v => v.agent_id !== 'user');

          // 统计 Agent 投票
          const agentApprove = agentVotes.filter(v => v.choice === 'approve').length;
          const agentReject = agentVotes.filter(v => v.choice === 'reject').length;
          const agentAbstain = agentVotes.filter(v => v.choice === 'abstain').length;
          const totalApprove = agentApprove + (userVote?.choice === 'approve' ? 1 : 0);
          const totalReject = agentReject + (userVote?.choice === 'reject' ? 1 : 0);
          const totalAbstain = agentAbstain + (userVote?.choice === 'abstain' ? 1 : 0);

          // 确定状态文本和样式
          let statusText = '';
          let statusBadgeClass = '';

          if (vote.status === 'pending') {
            statusText = '进行中';
            statusBadgeClass = 'warning';
          } else if (vote.status === 'completed') {
            if (vote.result === 'user_approve') {
              statusText = '用户通过';
              statusBadgeClass = 'success';
            } else if (vote.result === 'user_reject') {
              statusText = '用户否决';
              statusBadgeClass = 'error';
            } else if (vote.result === 'agent_approve') {
              statusText = 'Agent 通过';
              statusBadgeClass = 'success';
            } else if (vote.result === 'agent_reject') {
              statusText = 'Agent 拒绝';
              statusBadgeClass = 'error';
            } else {
              statusText = '已完成';
              statusBadgeClass = 'info';
            }
          } else if (vote.status === 'timeout') {
            statusText = '已超时';
            statusBadgeClass = 'error';
          }
          const deadlineText = isPending
            ? '<span data-countdown="' + vote.timeout_at + '"></span> • 截止: ' + formatTime(vote.timeout_at)
            : '截止: ' + formatTime(vote.timeout_at);
          const timeoutWarningBadge = isTimeoutSoon
            ? '<span class="badge badge-warning" style="margin-right: 6px;">即将超时</span>'
            : '';

          return `
            <div class="vote-card" data-vote-id="${vote.id}">
              <div class="vote-card-header">
                <div class="vote-title">${vote.title}</div>
                <span class="badge badge-${statusBadgeClass}">${statusText}</span>
              </div>
              ${vote.description ? `<div class="vote-description">${vote.description}</div>` : ''}

              <div style="font-size: 11px; color: var(--vscode-descriptionForeground); margin: 8px 0;">
                发起：${getAgentName(vote.created_by || 'user')}
              </div>

              ${userVote ? `
                <div style="margin: 12px 0; padding: 8px; background: ${userVote.choice === 'approve' ? 'rgba(76, 175, 80, 0.1)' : 'rgba(244, 67, 54, 0.1)'}; border-left: 3px solid ${userVote.choice === 'approve' ? '#4caf50' : '#f44336'}; border-radius: 2px;">
                  <div style="font-size: 13px; font-weight: 500; color: ${userVote.choice === 'approve' ? '#4caf50' : '#f44336'};">
                    ${userVote.choice === 'approve' ? '您已一票通过' : '您已一票否决'}
                  </div>
                  <div style="font-size: 11px; color: var(--vscode-descriptionForeground); margin-top: 4px;">
                    投票已结束，您的决定为最终结果
                  </div>
                </div>
              ` : ''}

              <div style="margin: 8px 0;">
                <div style="font-size: 12px; font-weight: 500; margin-bottom: 6px; color: var(--vscode-foreground);">
                  投票统计（含用户）
                </div>
                <div style="display: flex; gap: 12px; font-size: 11px;">
                  <div style="flex: 1;">
                    <div style="color: #4caf50; font-weight: 500;">赞成: ${totalApprove} 票</div>
                    ${agentApprove > 0 ? `<div style="color: var(--vscode-descriptionForeground); margin-top: 2px;">Agent: ${agentVotes.filter(v => v.choice === 'approve').map(v => v.agent_id).join(', ')}</div>` : ''}
                    ${userVote?.choice === 'approve' ? `<div style="color: var(--vscode-descriptionForeground); margin-top: 2px;">用户：您</div>` : ''}
                  </div>
                  <div style="flex: 1;">
                    <div style="color: #f44336; font-weight: 500;">反对: ${totalReject} 票</div>
                    ${agentReject > 0 ? `<div style="color: var(--vscode-descriptionForeground); margin-top: 2px;">Agent: ${agentVotes.filter(v => v.choice === 'reject').map(v => v.agent_id).join(', ')}</div>` : ''}
                    ${userVote?.choice === 'reject' ? `<div style="color: var(--vscode-descriptionForeground); margin-top: 2px;">用户：您</div>` : ''}
                  </div>
                  <div style="flex: 1;">
                    <div style="color: var(--vscode-descriptionForeground); font-weight: 500;">弃权: ${totalAbstain} 票</div>
                    ${agentAbstain > 0 ? `<div style="color: var(--vscode-descriptionForeground); margin-top: 2px;">Agent: ${agentVotes.filter(v => v.choice === 'abstain').map(v => v.agent_id).join(', ')}</div>` : ''}
                    ${userVote?.choice === 'abstain' ? `<div style="color: var(--vscode-descriptionForeground); margin-top: 2px;">用户：您</div>` : ''}
                  </div>
                </div>
              </div>

              <div style="font-size: 11px; color: var(--vscode-descriptionForeground); margin-top: 8px; display: flex; align-items: center; gap: 6px;">
                ${timeoutWarningBadge}${deadlineText}
              </div>

              ${isPending && !userVote ? `
                <div class="vote-actions" style="margin-top: 12px;">
                  <button class="vote-btn vote-btn-approve" onclick="castVote('${vote.id}', 'approve')" style="background-color: #4caf50; color: white; font-weight: 500;">一票通过</button>
                  <button class="vote-btn" onclick="castVote('${vote.id}', 'reject')" style="background-color: #f44336; color: white; font-weight: 500;">一票否决</button>
                </div>
              ` : ''}
              <div class="card-footer-actions">
                <button class="link-button" data-action="openVoteDetail" data-topic-id="${vote.id}">查看详情</button>
                ${vote.task_id ? `<button class="link-button" data-action="filterFileChangesByTask" data-task-id="${vote.task_id}">关联变更</button>` : ''}
              </div>
            </div>
          `;
        }).join('');

        // 启动倒计时更新（每秒更新一次）
        if (sortedVotes.some(v => v.status === 'pending')) {
          updateCountdowns();
          const interval = setInterval(updateCountdowns, 1000);
          countdownIntervals.push(interval);
        }

        const voteDetailModal = document.getElementById('modal-vote-detail');
        if (voteDetailModal && voteDetailModal.classList.contains('show') && currentVoteDetail) {
          const refreshed = allVotes.find(topic => topic.id === currentVoteDetail.id);
          if (refreshed) {
            currentVoteDetail = refreshed;
            renderVoteDetail();
          }
        }

        if (pendingGovernanceFocus && pendingGovernanceFocus.type === 'vote') {
          const target = sortedVotes.find(v => String(v.id) === String(pendingGovernanceFocus.id));
          if (target) {
            pendingGovernanceFocus = null;
            window.switchBlackboardView('governance');
            ensurePanelExpanded('panel-votes');
            focusVoteCard(String(target.id));
          }
        }
      }

      window.castVote = function(topicId, choice, options = {}) {
        vscode.postMessage({
          type: 'cast_vote',
          data: {
            topicId,
            agentId: 'user',
            choice,
            comment: options.comment || ''
          }
        });
      };

      // ========== Approvals & Notifications Rendering ==========
      let allApprovals = [];
      let governanceHistoryEntries = [];
      let allNotifications = [];

      function renderApprovals(approvals) {
        allApprovals = Array.isArray(approvals) ? approvals : [];
        const container = document.getElementById('approvals-list');
        const statsEl = document.getElementById('approval-stats');

        let scopedApprovals = currentSessionId
          ? allApprovals.filter(approval => (approval.session_id || null) === currentSessionId)
          : [];

        if (!scopedApprovals.length) {
          container.innerHTML = currentSessionId
            ? '<div class="empty-state">当前会话暂无审批</div>'
            : '<div class="empty-state">请选择一个会话以查看审批</div>';
          if (statsEl) statsEl.textContent = '';
          governanceSummary.pendingApprovals = 0;
          governanceSummary.nextPendingApprovalId = null;
          updateGovernanceSummaryUI();
          return;
        }

        // Update stats
        const pendingCount = scopedApprovals.filter(a => a.decision === 'pending').length;
        if (statsEl) statsEl.textContent = pendingCount > 0 ? pendingCount + ' 待审批' : '';

        // Sort: pending first, then by created_at desc
        const sortedApprovals = [...scopedApprovals].sort((a, b) => {
          if (a.decision === 'pending' && b.decision !== 'pending') return -1;
          if (a.decision !== 'pending' && b.decision === 'pending') return 1;
          return b.created_at - a.created_at;
        });

        const firstPendingApproval = sortedApprovals.find(a => a.decision === 'pending');
        container.innerHTML = sortedApprovals.map(approval => {
          const isPending = approval.decision === 'pending';
          const statusText = getApprovalDecisionText(approval.decision);
          const statusBadgeClass = approval.decision === 'pending' ? 'warning' : approval.decision === 'approved' ? 'success' : 'error';
          const approverName = getAgentName(approval.approver_id);
          return `
            <div class="approval-card" data-approval-id="${approval.id}">
              <div class="approval-card-header">
                <div class="approval-title">审批 #${approval.id}</div>
                <span class="badge badge-${statusBadgeClass}">${statusText}</span>
              </div>
              <div class="approval-description">任务: ${escapeHtml(formatTaskLabel(approval.task_id))}</div>
              <div class="approval-description">审批人: ${escapeHtml(approverName)}</div>
              <div style="font-size: 11px; color: var(--vscode-descriptionForeground); margin: 4px 0;">
                发起：${approval.created_by || '未知'} • ${formatTime(approval.created_at)}
              </div>
              ${approval.comment ? `<div class="approval-description" style="margin-top: 6px;">说明: ${escapeHtml(approval.comment)}</div>` : ''}
              ${isPending ? `
                <div class="approval-actions">
                  <button class="approval-btn approval-btn-approve" onclick="approveRequest(${approval.id}, 'approved')">批准</button>
                  <button class="approval-btn" onclick="approveRequest(${approval.id}, 'rejected')">拒绝</button>
                </div>
              ` : ''}
              <div class="card-footer-actions">
                <button class="link-button" data-action="openApprovalDetail" data-approval-id="${approval.id}">查看详情</button>
                <button class="link-button" data-action="filterFileChangesByTask" data-task-id="${approval.task_id}">关联变更</button>
              </div>
            </div>
          `;
        }).join('');

        governanceSummary.pendingApprovals = pendingCount;
        governanceSummary.nextPendingApprovalId = firstPendingApproval ? firstPendingApproval.id : null;
        governanceSummary.lastPolledAt = Date.now();
        updateGovernanceSummaryUI();

        const approvalDetailModal = document.getElementById('modal-approval-detail');
        if (approvalDetailModal && approvalDetailModal.classList.contains('show') && currentApprovalDetail) {
          const refreshed = allApprovals.find(item => item.id === currentApprovalDetail.id);
          if (refreshed) {
            currentApprovalDetail = refreshed;
            renderApprovalDetail();
          }
        }

        if (pendingGovernanceFocus && pendingGovernanceFocus.type === 'approval') {
          const target = sortedApprovals.find(approval => String(approval.id) === String(pendingGovernanceFocus.id));
          if (target) {
            pendingGovernanceFocus = null;
            window.switchBlackboardView('governance');
            ensurePanelExpanded('panel-approvals');
            window.openApprovalDetail(String(target.id));
          }
        }
      }

      window.approveRequest = function(approvalId, decision, comment = '') {
        vscode.postMessage({
          type: 'approve_request',
          data: { approvalId, decision, approverId: 'user', comment }
        });
      };

      function readGovernanceHistoryFiltersFromInputs() {
        const typeSelect = document.getElementById('history-type-filter');
        const actionSelect = document.getElementById('history-action-filter');
        const entityInput = document.getElementById('history-entity-filter');
        const searchInput = document.getElementById('history-search-filter');
        governanceHistoryFilters.type = (typeSelect?.value || 'all');
        governanceHistoryFilters.action = (actionSelect?.value || 'all');
        governanceHistoryFilters.entityQuery = (entityInput?.value || '').trim();
        governanceHistoryFilters.search = (searchInput?.value || '').trim();
      }

      function fetchGovernanceHistory(options = {}) {
        if (options.resetPage) {
          governanceHistoryPage = 1;
        }
        if (!currentSessionId) {
          governanceHistoryEntries = [];
          renderGovernanceHistory([]);
          return;
        }
        const payload = {
          type: governanceHistoryFilters.type,
          action: governanceHistoryFilters.action,
          entityQuery: governanceHistoryFilters.entityQuery,
          search: governanceHistoryFilters.search,
          page: governanceHistoryPage,
          pageSize: GOVERNANCE_HISTORY_PAGE_SIZE
        };
        vscode.postMessage({
          type: 'get_governance_history',
          session_id: currentSessionId,
          data: { filters: payload, session_id: currentSessionId }
        });
      }

      window.refreshGovernanceHistory = function() {
        fetchGovernanceHistory({ resetPage: false });
      };

      window.focusGovernanceSource = function(entryType, entityId) {
        if (!entryType || !entityId) {
          return;
        }
        if (typeof window.switchMainTab === 'function') {
          window.switchMainTab('blackboard');
        }
        if (typeof window.switchBlackboardView === 'function') {
          window.switchBlackboardView('governance');
        }
        if (entryType === 'vote') {
          focusVoteCard(entityId);
        } else if (entryType === 'approval') {
          focusApprovalCard(entityId);
        } else if (entryType === 'task') {
          window.focusTaskInList(entityId);
        }
      };

      window.applyGovernanceHistoryFilters = function() {
        readGovernanceHistoryFiltersFromInputs();
        governanceHistoryPage = 1;
        fetchGovernanceHistory();
      };

      window.resetGovernanceHistoryFilters = function() {
        const typeSelect = document.getElementById('history-type-filter');
        const actionSelect = document.getElementById('history-action-filter');
        const entityInput = document.getElementById('history-entity-filter');
        const searchInput = document.getElementById('history-search-filter');
        if (typeSelect) typeSelect.value = 'all';
        if (actionSelect) actionSelect.value = 'all';
        if (entityInput) entityInput.value = '';
        if (searchInput) searchInput.value = '';
        governanceHistoryFilters.type = 'all';
        governanceHistoryFilters.action = 'all';
        governanceHistoryFilters.entityQuery = '';
        governanceHistoryFilters.search = '';
        governanceHistoryPage = 1;
        fetchGovernanceHistory();
      };

      window.governanceHistoryPrev = function() {
        if (governanceHistoryPage <= 1) {
          return;
        }
        governanceHistoryPage -= 1;
        fetchGovernanceHistory();
      };

      window.governanceHistoryNext = function() {
        if (!governanceHistoryHasMore) {
          return;
        }
        governanceHistoryPage += 1;
        fetchGovernanceHistory();
      };

      populateGovernanceActionFilter();
      initGovernanceHistoryFilters();
      initGovernanceAnalyticsFilters();

      // ========== Governance History Rendering ==========
      function renderGovernanceHistory(entries) {
        governanceHistoryEntries = entries || [];
        const container = document.getElementById('governance-history-list');
        const statsEl = document.getElementById('governance-history-stats');
        if (!container) return;

        if (!currentSessionId) {
          container.innerHTML = '<div class="empty-state">请选择或创建会话以查看治理历史</div>';
          if (statsEl) statsEl.textContent = '';
          return;
        }

        if (!entries || entries.length === 0) {
          container.innerHTML = '<div class="empty-state">当前会话暂无治理历史</div>';
          if (statsEl) statsEl.textContent = '';
          return;
        }

        if (statsEl) {
          statsEl.textContent = entries.length + ' 条记录';
        }

        container.innerHTML = entries.map(entry => {
          const typeLabel = entry.type === 'vote' ? '投票' : entry.type === 'approval' ? '审批' : '任务';
          const actionLabel = getGovernanceActionLabel(entry);
          const payloadText = formatGovernancePayload(entry.payload);
          const summaryText = entry.summary || actionLabel;
          const actor = entry.actor_id ? getAgentName(entry.actor_id) : '系统';
          const payloadHtml = payloadText
            ? '<div class="gov-history-payload">' + escapeHtml(payloadText) + '</div>'
            : '';

          return [
            '<div class="gov-history-item" data-action="focusGovernanceSource" data-entry-type="', entry.type,
            '" data-entity-id="', entry.entity_id, '">',
              '<div class="gov-history-head">',
                '<span class="gov-history-type ', entry.type, '">', escapeHtml(typeLabel), '</span>',
                '<span class="gov-history-action">', escapeHtml(actionLabel), '</span>',
                '<span class="gov-history-time">', formatTime(entry.created_at), '</span>',
              '</div>',
              '<div class="gov-history-summary">', escapeHtml(summaryText), '</div>',
              '<div class="gov-history-meta">来源：', escapeHtml(actor), ' • ID: ', escapeHtml(entry.entity_id), '</div>',
              payloadHtml,
            '</div>'
          ].join('');
        }).join('');
        updateGovernanceHistoryPaginationUI();
      }

      function populateGovernanceActionFilter() {
        const actionSelect = document.getElementById('history-action-filter');
        if (!actionSelect) {
          return;
        }
        const options = ['<option value="all">全部动作</option>'];
        Object.entries(GOVERNANCE_ACTION_LABELS).forEach(([key, label]) => {
          options.push('<option value="' + key + '">' + label + '</option>');
        });
        actionSelect.innerHTML = options.join('');
      }

      function initGovernanceHistoryFilters() {
        const typeSelect = document.getElementById('history-type-filter');
        const actionSelect = document.getElementById('history-action-filter');
        const entityInput = document.getElementById('history-entity-filter');
        const searchInput = document.getElementById('history-search-filter');

        if (typeSelect) {
          typeSelect.addEventListener('change', () => {
            window.applyGovernanceHistoryFilters();
          });
        }
        if (actionSelect) {
          actionSelect.addEventListener('change', () => {
            window.applyGovernanceHistoryFilters();
          });
        }
        [entityInput, searchInput].forEach(input => {
          if (!input) {
            return;
          }
          input.addEventListener('keydown', event => {
            if (event.key === 'Enter') {
              window.applyGovernanceHistoryFilters();
            }
          });
        });
      }

      function initGovernanceAnalyticsFilters() {
        const rangeSelect = document.getElementById('governance-analytics-range');
        if (rangeSelect) {
          rangeSelect.value = governanceAnalyticsRange;
          rangeSelect.addEventListener('change', event => {
            const target = event.target;
            if (target && target.value) {
              governanceAnalyticsRange = target.value;
              fetchGovernanceAnalytics();
            }
          });
        }
        updateGovernanceAnalyticsTypeButtons();
      }

      function fetchGovernanceAnalytics() {
        if (!currentSessionId) {
          governanceAnalyticsData = null;
          updateGovernanceAnalyticsUpdated(null);
          setGovernanceAnalyticsStatus('请选择或创建会话以查看治理分析', false);
          renderGovernanceAnalyticsSummary('vote', null);
          renderGovernanceAnalyticsSummary('approval', null);
          renderGovernanceAnalyticsTimeline([]);
          renderGovernanceAnalyticsHotspots([]);
          renderGovernanceAnalyticsRecent([]);
          return;
        }
        setGovernanceAnalyticsStatus('数据加载中…', false);
        vscode.postMessage({
          type: 'get_governance_analytics',
          session_id: currentSessionId,
          data: { range: governanceAnalyticsRange, type: governanceAnalyticsType, session_id: currentSessionId }
        });
      }

      function setGovernanceAnalyticsStatus(message, isError) {
        const statusEl = document.getElementById('governance-analytics-status');
        if (!statusEl) {
          return;
        }
        statusEl.textContent = message || '';
        if (isError) {
          statusEl.classList.add('error');
        } else {
          statusEl.classList.remove('error');
        }
      }

      function updateGovernanceAnalyticsUpdated(timestamp) {
        const badge = document.getElementById('governance-analytics-updated');
        if (!badge) {
          return;
        }
        if (!timestamp) {
          badge.textContent = '';
          return;
        }
        const date = new Date(timestamp);
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        badge.textContent = '更新 ' + hours + ':' + minutes;
      }

      function updateGovernanceAnalyticsTypeButtons() {
        const buttons = document.querySelectorAll('[data-action="setGovernanceAnalyticsType"]');
        buttons.forEach(button => {
          const type = button.getAttribute('data-analytics-type') || 'all';
          if (type === governanceAnalyticsType) {
            button.classList.add('active');
          } else {
            button.classList.remove('active');
          }
        });
      }

      function setGovernanceAnalyticsType(type) {
        if (!type) {
          return;
        }
        if (type === governanceAnalyticsType) {
          updateGovernanceAnalyticsTypeButtons();
          return;
        }
        governanceAnalyticsType = type;
        updateGovernanceAnalyticsTypeButtons();
        fetchGovernanceAnalytics();
      }

      function renderGovernanceAnalytics(data) {
        governanceAnalyticsData = data || null;
        if (!currentSessionId) {
          setGovernanceAnalyticsStatus('请选择或创建会话以查看治理分析', false);
          updateGovernanceAnalyticsUpdated(null);
          return;
        }
        if (!data) {
          setGovernanceAnalyticsStatus('当前会话暂无治理分析数据', false);
          updateGovernanceAnalyticsUpdated(null);
          renderGovernanceAnalyticsSummary('vote', null);
          renderGovernanceAnalyticsSummary('approval', null);
          renderGovernanceAnalyticsTimeline([]);
          renderGovernanceAnalyticsHotspots([]);
          renderGovernanceAnalyticsRecent([]);
          return;
        }
        setGovernanceAnalyticsStatus('', false);
        updateGovernanceAnalyticsUpdated(data.generated_at);
        renderGovernanceAnalyticsSummary('vote', data.summary ? data.summary.votes : null);
        renderGovernanceAnalyticsSummary('approval', data.summary ? data.summary.approvals : null);
        renderGovernanceAnalyticsTimeline(data.timeline || []);
        renderGovernanceAnalyticsHotspots(data.hotspots || []);
        renderGovernanceAnalyticsRecent(data.recent_actions || []);
      }

      function renderGovernanceAnalyticsSummary(kind, summary) {
        const container = document.getElementById(
          kind === 'vote' ? 'analytics-vote-summary' : 'analytics-approval-summary'
        );
        if (!container) {
          return;
        }
        if (!summary) {
          container.innerHTML = '<div class="empty-state">暂无数据</div>';
          return;
        }
        const detail = kind === 'vote'
          ? '待处理 ' + summary.pending + ' · 已完成 ' + summary.completed + ' · 超时 ' + summary.timeout
          : '待审批 ' + summary.pending + ' · 通过 ' + summary.approved + ' · 拒绝 ' + summary.rejected;
        container.innerHTML = [
          '<div class="analytics-summary-title">', (kind === 'vote' ? '投票概览' : '审批概览'), '</div>',
          '<div class="analytics-summary-value">', summary.total, '</div>',
          '<div class="analytics-summary-detail">', detail, '</div>',
          '<div class="analytics-summary-meta">平均耗时 ', formatDuration(summary.average_duration_ms), '</div>'
        ].join('');
      }

      function renderGovernanceAnalyticsTimeline(buckets) {
        const container = document.getElementById('governance-analytics-timeline');
        if (!container) {
          return;
        }
        if (!buckets || buckets.length === 0) {
          container.innerHTML = '<div class="empty-state">暂无趋势数据</div>';
          return;
        }
        const maxValue = Math.max(
          1,
          ...buckets.map(bucket => Math.max(bucket.votes, bucket.approvals))
        );
        container.innerHTML = buckets.map(bucket => {
          const voteHeight = Math.round((bucket.votes / maxValue) * 100);
          const approvalHeight = Math.round((bucket.approvals / maxValue) * 100);
          return [
            '<div class="analytics-bar-item">',
              '<div class="analytics-bar">',
                '<span class="analytics-bar-segment votes" style="height:', voteHeight, '%"></span>',
                '<span class="analytics-bar-segment approvals" style="height:', approvalHeight, '%"></span>',
              '</div>',
              '<div class="analytics-bar-label">', bucket.label, '</div>',
              '<div style="font-size:10px;">', bucket.votes, '/', bucket.approvals, '</div>',
            '</div>'
          ].join('');
        }).join('');
      }

      function renderGovernanceAnalyticsHotspots(hotspots) {
        const container = document.getElementById('governance-analytics-hotspots');
        if (!container) {
          return;
        }
        if (!hotspots || hotspots.length === 0) {
          container.innerHTML = '<div class="empty-state">暂无热点任务</div>';
          return;
        }
        container.innerHTML = hotspots.map((item, index) => {
          return [
            '<div class="analytics-hotspot-item">',
              '<div class="hotspot-rank">', index + 1, '</div>',
              '<div style="flex:1;">',
                '<div style="font-size:13px;font-weight:500;">', escapeHtml(item.task_title), '</div>',
                '<div class="hotspot-meta">投票 ', item.votes, ' · 审批 ', item.approvals, ' · 最近 ', formatTime(item.last_event), '</div>',
              '</div>',
            '</div>'
          ].join('');
        }).join('');
      }

      function renderGovernanceAnalyticsRecent(actions) {
        const container = document.getElementById('governance-analytics-recent');
        if (!container) {
          return;
        }
        if (!actions || actions.length === 0) {
          container.innerHTML = '<div class="empty-state">暂无治理动作</div>';
          return;
        }
        container.innerHTML = actions.map(entry => {
          const actionLabel = getGovernanceActionLabel(entry);
          return [
            '<div class="analytics-recent-item">',
              '<div class="analytics-recent-title">', escapeHtml(actionLabel), '</div>',
              '<div class="analytics-recent-meta">',
                '<span>ID: ', escapeHtml(entry.entity_id), '</span>',
                '<span>', formatTime(entry.created_at), '</span>',
                '<span>', entry.type === 'vote' ? '投票' : '审批', '</span>',
              '</div>',
            '</div>'
          ].join('');
        }).join('');
      }

      function formatDuration(ms) {
        if (!ms || ms <= 0) {
          return '--';
        }
        const minutes = Math.floor(ms / 60000);
        if (minutes === 0) {
          return Math.max(1, Math.round(ms / 1000)) + ' 秒';
        }
        if (minutes >= 60) {
          const hours = Math.floor(minutes / 60);
          const remain = minutes % 60;
          return hours + ' 小时' + (remain > 0 ? ' ' + remain + ' 分' : '');
        }
        return minutes + ' 分';
      }

      function getGovernanceActionLabel(entry) {
        return GOVERNANCE_ACTION_LABELS[entry.action] || entry.action;
      }

      function formatGovernancePayload(payload) {
        if (!payload) {
          return '';
        }
        try {
          if (typeof payload === 'string') {
            return payload;
          }
          return JSON.stringify(payload, null, 2);
        } catch (error) {
          return String(payload);
        }
      }

      function renderNotifications(notifications) {
        allNotifications = Array.isArray(notifications) ? notifications : [];
        const container = document.getElementById('notifications-list');
        let scopedNotifications = currentSessionId
          ? allNotifications.filter(notif => (notif.session_id || null) === currentSessionId)
          : [];

        if (!scopedNotifications.length) {
          container.innerHTML = currentSessionId
            ? '<div class="empty-state">当前会话暂无通知</div>'
            : '<div class="empty-state">请选择一个会话以查看通知</div>';
          governanceSummary.unreadNotifications = 0;
          updateGovernanceSummaryUI();
          updateNotificationFilterUI();
          return;
        }
        const unreadCount = scopedNotifications.filter(n => !n.read).length;
        const badge = document.getElementById('notification-stats');
        if (badge) badge.textContent = unreadCount > 0 ? unreadCount : '';
        governanceSummary.unreadNotifications = unreadCount;
        updateGovernanceSummaryUI();

        let filteredNotifications = scopedNotifications.filter(notif => notificationLevelFilters.has(notif.level));
        if (notificationUnreadOnly) {
          filteredNotifications = filteredNotifications.filter(notif => !notif.read);
        }

        if (!filteredNotifications.length) {
          container.innerHTML = '<div class="empty-state">当前筛选条件下暂无通知</div>';
          updateNotificationFilterUI();
          return;
        }

        // Sort: unread first, then by created_at desc
        const sortedNotifications = [...filteredNotifications].sort((a, b) => {
          if (!a.read && b.read) return -1;
          if (a.read && !b.read) return 1;
          return b.created_at - a.created_at;
        });

        container.innerHTML = sortedNotifications.map(notif => {
          const isUnread = !notif.read;
          const levelText = notif.level === 'info'
            ? '信息'
            : notif.level === 'success'
              ? '成功'
              : notif.level === 'warning'
                ? '警告'
                : '错误';
          const levelBadgeClass = notif.level === 'info'
            ? 'info'
            : notif.level === 'success'
              ? 'success'
              : notif.level === 'warning'
                ? 'warning'
                : 'error';
          return `
            <div class="notification-card ${isUnread ? 'unread' : ''}" data-notification-id="${notif.id}" data-action="handleNotificationClick">
              <div class="notification-header">
                ${isUnread ? '<div class="notification-unread-dot"></div>' : ''}
                <div style="flex: 1;">
                  <span class="badge badge-${levelBadgeClass}">${levelText}</span>
                  <div class="notification-title">${notif.title}</div>
                </div>
              </div>
              <div class="notification-message">${notif.message}</div>
              <div class="notification-time">${formatTime(notif.created_at)}</div>
            </div>
          `;
        }).join('');
        updateNotificationFilterUI();
      }

      window.markNotificationAsRead = function(notificationId) {
        vscode.postMessage({
          type: 'mark_notification_read',
          data: { notificationId }
        });
      };

      window.handleNotificationClick = function(notificationId) {
        if (!notificationId) {
          return;
        }
        const normalizedId = String(notificationId);
        const notification = allNotifications.find(item => String(item.id) === normalizedId);
        if (!notification) {
          return;
        }
        if (!notification.read) {
          window.markNotificationAsRead(notification.id);
        }
        const metadata = notification.metadata || {};
        const targetSessionId = metadata.session_id || notification.session_id || null;
        const workflowTarget = metadata.workflow_instance_id || null;
        const taskTarget = metadata.task_id || null;
        const approvalTarget = metadata.approval_id || null;
        const voteTarget = metadata.topic_id || null;

        if (targetSessionId && targetSessionId !== currentSessionId) {
          if (workflowTarget) {
            pendingWorkflowFocusId = workflowTarget;
          }
          if (taskTarget) {
            pendingTaskFocusId = taskTarget;
          }
          if (approvalTarget) {
            pendingGovernanceFocus = { type: 'approval', id: approvalTarget };
          } else if (voteTarget) {
            pendingGovernanceFocus = { type: 'vote', id: voteTarget };
          }
          workflowInstanceFilter = 'all';
          workflowInstanceScenarioFilter = null;
          workflowInstanceParticipantFilter = null;
          renderWorkflowInstanceList();
          setCurrentSession(targetSessionId, { reason: 'notification-jump', forceRender: true, forceFetch: true });
          window.switchMainTab('blackboard');
          if (workflowTarget) {
            window.switchBlackboardView('workflow');
          } else if (approvalTarget || voteTarget) {
            window.switchBlackboardView('governance');
          }
          return;
        }

        window.switchMainTab('blackboard');
        if (workflowTarget) {
          workflowInstanceFilter = 'all';
          workflowInstanceScenarioFilter = null;
          workflowInstanceParticipantFilter = null;
          renderWorkflowInstanceList();
          focusWorkflowInstance(workflowTarget);
          window.switchBlackboardView('workflow');
          return;
        }
        if (taskTarget) {
          ensurePanelExpanded('panel-tasks');
          focusTaskInList(taskTarget);
          return;
        }
        if (approvalTarget) {
          pendingGovernanceFocus = null;
          window.switchBlackboardView('governance');
          ensurePanelExpanded('panel-approvals');
          window.openApprovalDetail(String(approvalTarget));
          return;
        }
        if (voteTarget) {
          pendingGovernanceFocus = null;
          window.switchBlackboardView('governance');
          ensurePanelExpanded('panel-votes');
          focusVoteCard(String(voteTarget));
          return;
        }
      };

      function updateNotificationFilterUI() {
        const levelGroup = document.getElementById('notification-level-filters');
        if (levelGroup) {
          levelGroup.querySelectorAll('.notification-filter-btn').forEach(btn => {
            const level = btn.getAttribute('data-level');
            if (!level) {
              return;
            }
            if (notificationLevelFilters.has(level)) {
              btn.classList.add('active');
            } else {
              btn.classList.remove('active');
            }
          });
        }
        const unreadToggle = document.getElementById('notification-unread-toggle');
        if (unreadToggle) {
          unreadToggle.checked = notificationUnreadOnly;
        }
      }

      window.toggleNotificationLevel = function(level) {
        if (!level) {
          return;
        }
        if (notificationLevelFilters.has(level)) {
          if (notificationLevelFilters.size === 1) {
            return;
          }
          notificationLevelFilters.delete(level);
        } else {
          notificationLevelFilters.add(level);
        }
        renderNotifications(allNotifications);
      };

window.toggleNotificationUnread = function() {
  notificationUnreadOnly = !notificationUnreadOnly;
  renderNotifications(allNotifications);
};

updateNotificationFilterUI();

      function formatToolRunStatus(status) {
        const map = {
          running: '执行中',
          succeeded: '已完成',
          failed: '失败'
        };
        return map[status] || status || '未知状态';
      }

      function formatToolRunDuration(run) {
        if (!run || !run.started_at || !run.completed_at) {
          return run && run.status === 'running' ? '执行中' : '—';
        }
        const diff = run.completed_at - run.started_at;
        if (diff <= 0) {
          return '—';
        }
        if (diff >= 60000) {
          return (diff / 60000).toFixed(1) + ' 分钟';
        }
        return Math.round(diff / 1000) + ' 秒';
      }

      function renderToolRunLog(run) {
        if (!run) {
          return '暂无日志';
        }
        const fragments = [];
        if (run.output?.stdout) {
          fragments.push('stdout:\n' + escapeHtml(run.output.stdout));
        }
        if (run.output?.stderr) {
          fragments.push('stderr:\n' + escapeHtml(run.output.stderr));
        }
        if (run.error) {
          fragments.push('error:\n' + escapeHtml(run.error));
        }
        const attachments = run.output?.attachments;
        if (attachments?.files?.length) {
          fragments.push('files:\n' + attachments.files.map(file => `• ${escapeHtml(file)}`).join('\n'));
        }
        if (attachments?.links?.length) {
          fragments.push('links:\n' + attachments.links.map(link => `• ${escapeHtml(link)}`).join('\n'));
        }
        if (!fragments.length) {
          return '暂无日志';
        }
        return fragments.join('\n\n');
      }

      function buildToolRunCard(run) {
        const statusText = formatToolRunStatus(run.status);
        const started = run.started_at ? formatTime(run.started_at) : '—';
        const duration = formatToolRunDuration(run);
        const logId = `tool-log-${run.id}`;
        const command = run.command || (run.input?.command) || '—';
        const taskId = run.task_id || '—';
        const showRetry = run.status === 'failed';
        const instanceLabel = run.workflow_instance_id ? `<span class="tool-run-meta">实例 ${escapeHtml(run.workflow_instance_id)}</span>` : '';
        return `
          <div class="tool-run-card status-${escapeHtml(run.status || 'unknown')}" data-run-id="${escapeHtml(run.id)}">
            <div class="tool-run-head">
              <div>
                <span class="tool-run-name">${escapeHtml(run.tool_name || '工具')}</span>
                <span class="tool-run-meta">${statusText}</span>
                ${instanceLabel}
              </div>
              <div class="tool-run-actions">
                <button class="link-button" data-action="toggleToolRunLog" data-log-id="${logId}">查看日志</button>
                ${showRetry ? `<button class="link-button" data-action="rerunTool" data-run-id="${escapeHtml(run.id)}">重试</button>` : ''}
              </div>
            </div>
            <div class="tool-run-body">
              <div>命令：${escapeHtml(command)}</div>
              <div>任务：${escapeHtml(taskId)}</div>
              <div>开始：${escapeHtml(started)}</div>
              <div>耗时：${escapeHtml(duration)}</div>
            </div>
            <div class="tool-run-log" id="${logId}">${renderToolRunLog(run)}</div>
          </div>
        `;
      }

      function renderToolRuns() {
        const container = document.getElementById('tool-run-list');
        const stats = document.getElementById('tool-run-stats');
        if (!container) {
          return;
        }
        const runs = (allToolRuns || []).filter(run => {
          if (!currentSessionId) {
            return true;
          }
          return (run.session_id || null) === currentSessionId;
        });
        const filtered = runs.filter(run => toolRunStatusFilter === 'all' ? true : run.status === toolRunStatusFilter);
        if (stats) {
          stats.textContent = runs.length ? `${filtered.length}/${runs.length}` : '';
        }
        document.querySelectorAll('.tool-run-filter-btn').forEach(btn => {
          const status = btn.getAttribute('data-status') || 'all';
          btn.classList.toggle('active', status === toolRunStatusFilter);
        });
        if (!filtered.length) {
          container.innerHTML = '<div class="empty-state">暂无工具执行记录</div>';
          return;
        }
        container.innerHTML = filtered.map(run => buildToolRunCard(run)).join('');
      }

      window.setToolRunStatusFilter = function(filter) {
        if (!filter) {
          return;
        }
        if (filter === toolRunStatusFilter) {
          return;
        }
        toolRunStatusFilter = filter;
        renderToolRuns();
      };

window.setWorkflowParticipantFilter = function(participantId) {
  const normalized = participantId && participantId.trim().length > 0 ? participantId.trim() : null;
  if (normalized === workflowInstanceParticipantFilter) {
    workflowInstanceParticipantFilter = null;
  } else {
    workflowInstanceParticipantFilter = normalized;
  }
  renderWorkflowInstanceList();
};

  window.sendWorkflowNote = function() {
    const instance = getCurrentWorkflowInstanceDetail();
    if (!instance) {
      updateStatus('当前会话尚未创建 Workflow 实例');
      return;
    }
    const noteInput = document.getElementById('workflow-note-input');
    if (!noteInput) {
      return;
    }
    const content = noteInput.value.trim();
    if (!content) {
      updateStatus('请先输入需要插话的内容');
      return;
    }
    if (!currentSessionId) {
      updateStatus('请先选择会话');
      return;
    }
    const scenario = getInstanceScenarioTags(instance);
    const messageData = {
      content,
      message_type: 'discussion',
      priority: 'medium',
      session_id: currentSessionId,
      tags: [`workflow_instance:${instance.id}`],
      payload: {
        workflow_instance_id: instance.id,
        scenario
      }
    };
    vscode.postMessage({
      type: 'send_message',
      data: messageData
    });
    noteInput.value = '';
    updateStatus(`已向实例 ${instance.id} 提交插话`);
  };

      function renderLocks(locks) {
        allLocks = Array.isArray(locks) ? locks : [];
        const container = document.getElementById('lock-list');
        const statsEl = document.getElementById('lock-stats');
        if (!container) {
          return;
        }
        const scopedLocks = currentSessionId
          ? allLocks.filter(lock => (lock.session_id || null) === currentSessionId)
          : allLocks;
        if (statsEl) {
          if (currentSessionId) {
            statsEl.textContent = scopedLocks.length > 0 ? scopedLocks.length + ' 条' : '';
          } else if (allLocks.length > 0) {
            statsEl.textContent = scopedLocks.length + '/' + allLocks.length;
          } else {
            statsEl.textContent = '';
          }
        }
        if (scopedLocks.length === 0) {
          container.innerHTML = currentSessionId
            ? '<div class="empty-state">当前会话暂无活跃锁</div>'
            : '<div class="empty-state">暂无活跃锁</div>';
          return;
        }
        container.innerHTML = scopedLocks.map(lock => {
          const ttlText = lock.expires_at ? ('到期：' + formatTime(lock.expires_at)) : '到期：--';
          const holderBtn = lock.holder_id
            ? '<button class="task-action-btn" data-action="releaseLockHolder" data-lock-holder="' + lock.holder_id + '">释放持有者锁</button>'
            : '';
          const sessionBtn = lock.session_id
            ? '<button class="task-action-btn" data-action="releaseSessionLocks" data-lock-session="' + lock.session_id + '">释放会话锁</button>'
            : '';
          return '' +
            '<div class="lock-card">' +
              '<div class="lock-card-header">' +
                '<div class="lock-resource">' + escapeHtml(lock.resource) + '</div>' +
                '<span class="badge badge-default">' + escapeHtml(lock.session_id || '全局') + '</span>' +
              '</div>' +
              '<div class="lock-meta">' +
                '<span>持有者：' + escapeHtml(lock.holder_id || '未知') + '</span>' +
                '<span>' + ttlText + '</span>' +
              '</div>' +
              '<div class="lock-actions">' +
                holderBtn +
                sessionBtn +
                '<button class="task-action-btn danger" data-action="releaseLock" data-lock-resource="' + lock.resource + '">释放资源</button>' +
              '</div>' +
            '</div>';
        }).join('');
      }

      function renderMcpServers(servers) {
        allMcpServers = Array.isArray(servers) ? servers : [];
        const container = document.getElementById('mcp-server-list');
        const statsEl = document.getElementById('mcp-server-stats');
        if (!container) {
          return;
        }
        const validIds = new Set(allMcpServers.map(server => server.id));
        Array.from(mcpToolsCache.keys()).forEach(id => {
          if (!validIds.has(id)) {
            mcpToolsCache.delete(id);
          }
        });
        Array.from(pendingMcpRefresh).forEach(id => {
          if (!validIds.has(id)) {
            pendingMcpRefresh.delete(id);
          }
        });
        const enabledCount = allMcpServers.filter(server => server.enabled).length;
        const availableCount = allMcpServers.filter(server => {
          const status = mcpServerStatus.get(server.id);
          return server.enabled && status?.available;
        }).length;
        if (statsEl) {
          if (enabledCount > 0) {
            statsEl.textContent = availableCount + '/' + enabledCount + ' 在线';
          } else if (allMcpServers.length > 0) {
            statsEl.textContent = '全部已停用';
          } else {
            statsEl.textContent = '';
          }
        }
        if (allMcpServers.length === 0) {
          container.innerHTML =
            '<div class="empty-state">暂无 MCP Server 配置<div class="mcp-empty-cta">' +
            '<button class="mcp-btn" data-action="openMcpAddModal">立即添加</button>' +
            '</div></div>';
          return;
        }
        const summarizeItems = (label, items, mapper) => {
          if (!Array.isArray(items)) {
            return '<div>' + label + '：未加载</div>';
          }
          if (items.length === 0) {
            return '<div>' + label + '：暂无</div>';
          }
          const names = items
            .map(item => mapper(item))
            .filter(Boolean);
          const preview = names.slice(0, 3).map(name => escapeHtml(name)).join(', ');
          const suffix = names.length > 3 ? ' 等 ' + names.length + ' 个' : '';
          return '<div>' + label + '：' + (preview || '（无名称）') + suffix + '</div>';
        };
        container.innerHTML = allMcpServers.map(server => {
              const statusInfo = mcpServerStatus.get(server.id);
              const isEnabled = server.enabled !== false;
              const statusBadge = !isEnabled
                ? '<span class="mcp-badge disabled">已停用</span>'
                : statusInfo?.available
                  ? '<span class="mcp-badge enabled">可用</span>'
                  : '<span class="mcp-badge disabled">' + escapeHtml(statusInfo?.error || '不可用') + '</span>';
          const argsPreview = (server.args || []).join(' ');
          const envPreview = server.env ? Object.keys(server.env).join(', ') : '';
          const tools = mcpToolsCache.get(server.id);
          const statusToolCount = typeof statusInfo?.toolCount === 'number' ? statusInfo.toolCount : null;
          const isRefreshing = pendingMcpRefresh.has(server.id);
          const refreshDisabled = isRefreshing || !isEnabled;
          const refreshText = isRefreshing ? '刷新中...' : '刷新';
          const toggleLabel = isEnabled ? '停用' : '启用';
          const toggleNext = isEnabled ? 'false' : 'true';
          const toolItems = Array.isArray(tools) && tools.length > 0
            ? tools.map(tool => {
                const toolName = tool.name || tool.id || '(未命名)';
                const desc = tool.description ? '：' + tool.description : '';
                const fullText = toolName + (tool.description ? '：' + tool.description : '');
                return '<div class="mcp-tool-item" title="' + escapeHtml(fullText) + '">' +
                  escapeHtml(toolName) + (tool.description ? '：' + escapeHtml(tool.description) : '') +
                '</div>';
              }).join('')
            : '<div class="global-agent-meta">暂无工具配置</div>';
          const toolsSummary = tools
            ? '<details style="margin-top: 8px;"><summary>工具列表 (' + tools.length + ')</summary>' +
                toolItems +
              '</details>'
            : '<div class="global-agent-meta">工具列表将自动加载，保存后稍候查看</div>';
          const stateHint = isEnabled ? '' : '<div class="global-agent-meta">此 Server 已停用，启用后即可重新连接并刷新状态</div>';
          const cardClasses = 'mcp-server-card' + (isEnabled ? '' : ' disabled');
          return '' +
            '<div class="' + cardClasses + '">' +
              '<div class="mcp-card-header">' +
                '<div class="mcp-card-title">' + escapeHtml(server.name) + '</div>' +
                statusBadge +
              '</div>' +
              '<div class="mcp-card-body">' +
                '<div>' + escapeHtml(server.command) + (argsPreview ? ' ' + escapeHtml(argsPreview) : '') + '</div>' +
                (server.description ? '<div>' + escapeHtml(server.description) + '</div>' : '') +
                (envPreview ? '<div>Env: ' + escapeHtml(envPreview) + '</div>' : '') +
                '<div class="global-agent-meta">工具缓存：' + (statusToolCount !== null ? statusToolCount + ' 个' : '未知') + '</div>' +
                stateHint +
                toolsSummary +
              '</div>' +
              '<div class="mcp-card-actions">' +
                '<button class="mcp-card-btn" data-action="toggleMcpServer" data-mcp-id="' + server.id + '" data-enable="' + toggleNext + '">' + toggleLabel + '</button>' +
                '<button class="mcp-card-btn ghost" data-action="refreshMcpServer" data-mcp-id="' + server.id + '"' + (refreshDisabled ? ' disabled' : '') + '>' + refreshText + '</button>' +
                '<button class="mcp-card-btn" data-action="editMcpServer" data-mcp-id="' + server.id + '">编辑</button>' +
                '<button class="mcp-card-btn danger" data-action="deleteMcpServer" data-mcp-id="' + server.id + '">删除</button>' +
              '</div>' +
            '</div>';
        }).join('');
      }

      function getMcpServerById(serverId) {
        if (!serverId) {
          return null;
        }
        return (allMcpServers || []).find(server => server.id === serverId) || null;
      }

      window.openMcpConfigModal = function(mode = 'create', serverId = null) {
        const modal = document.getElementById('modal-mcp-config');
        const textarea = document.getElementById('mcp-config-json');
        const errorEl = document.getElementById('mcp-config-error');
        const titleEl = document.getElementById('mcp-config-title');
        if (!modal || !textarea || !errorEl || !titleEl) {
          return;
        }
        errorEl.textContent = '';
        currentMcpServerEditId = mode === 'edit' ? serverId : null;
        const target = serverId ? getMcpServerById(serverId) : null;
        if (mode === 'edit' && target) {
          titleEl.textContent = '编辑 MCP Server - ' + target.name;
          const payload = {
            name: target.name,
            description: target.description || '',
            command: target.command,
            args: target.args || [],
            env: target.env || {},
            enabled: target.enabled,
            is_default: target.is_default
          };
          textarea.value = JSON.stringify(payload, null, 2);
        } else {
          titleEl.textContent = '新增 MCP Server';
          textarea.value = JSON.stringify({
            name: 'mcp-server',
            description: '',
            command: 'python',
            args: ['-m', 'my_mcp.entry'],
            env: {},
            enabled: true,
            is_default: allMcpServers.length === 0
          }, null, 2);
        }
        window.openModal('modal-mcp-config');
      };

      function normalizeMcpConfigPayload(input, allowImplicitDefault) {
        const toConfig = (raw, fallbackName) => {
          if (!raw || typeof raw !== 'object' || Array.isArray(raw)) {
            throw new Error('配置必须是对象');
          }
          const name = (raw.name ?? fallbackName ?? '').toString().trim();
          const command = (raw.command ?? '').toString().trim();
          if (!name || !command) {
            throw new Error('name 和 command 为必填项');
          }
          const args = Array.isArray(raw.args) ? raw.args.map(arg => String(arg)) : [];
          let env;
          if (raw.env !== undefined) {
            if (!raw.env || typeof raw.env !== 'object' || Array.isArray(raw.env)) {
              throw new Error('env 必须是对象');
            }
            env = Object.fromEntries(Object.entries(raw.env).map(([key, value]) => [String(key), String(value)]));
          }
          return {
            name,
            description: raw.description ? String(raw.description) : undefined,
            command,
            args,
            env,
            enabled: raw.enabled !== false,
            is_default: !!raw.is_default
          };
        };

        if (input && typeof input === 'object' && !Array.isArray(input) && input.mcpServers && typeof input.mcpServers === 'object' && !Array.isArray(input.mcpServers)) {
          const entries = Object.entries(input.mcpServers).map(([key, value]) => toConfig(value, key));
          if (entries.length === 0) {
            throw new Error('mcpServers 为空');
          }
          if (allowImplicitDefault && !entries.some(item => item.is_default)) {
            entries[0].is_default = true;
          }
          return entries;
        }
        return [toConfig(input)];
      }

      window.submitMcpConfig = function() {
        const textarea = document.getElementById('mcp-config-json');
        const errorEl = document.getElementById('mcp-config-error');
        if (!textarea || !errorEl) {
          return;
        }
        errorEl.textContent = '';
        let parsed;
        try {
          parsed = JSON.parse(textarea.value);
        } catch (error) {
          errorEl.textContent = 'JSON 解析失败：' + (error instanceof Error ? error.message : error);
          return;
        }

        let configs = [];
        try {
          configs = normalizeMcpConfigPayload(parsed, allMcpServers.length === 0 && !currentMcpServerEditId);
        } catch (error) {
          errorEl.textContent = error instanceof Error ? error.message : String(error);
          return;
        }

        if (currentMcpServerEditId) {
          if (configs.length !== 1) {
            errorEl.textContent = '编辑模式仅支持单个 MCP Server 配置';
            return;
          }
          vscode.postMessage({
            type: 'update_mcp_server',
            data: { id: currentMcpServerEditId, config: configs[0] }
          });
        } else {
          configs.forEach((config) => {
            vscode.postMessage({
              type: 'create_mcp_server',
              data: { config }
            });
          });
        }
        window.closeModal();
      };

      window.refreshMcpServer = function(serverId) {
        if (!serverId) {
          return;
        }
        pendingMcpRefresh.add(Number(serverId));
        renderMcpServers(allMcpServers);
        vscode.postMessage({
          type: 'refresh_mcp_server_status',
          data: { id: Number(serverId) }
        });
      };

      window.toggleMcpServer = function(serverId, enableValue) {
        if (!serverId) {
          return;
        }
        const enabled =
          typeof enableValue === 'string'
            ? enableValue === 'true'
            : !!enableValue;
        vscode.postMessage({
          type: 'toggle_mcp_server',
          data: { id: Number(serverId), enabled }
        });
      };

      window.refreshLocks = function() {
        vscode.postMessage({
          type: 'get_locks',
          data: currentSessionId ? { session_id: currentSessionId } : {}
        });
      };

      window.releaseLock = function(resource) {
        if (!resource) {
          return;
        }
        const confirmed = window.confirm('确定要释放锁 ' + resource + ' 吗？');
        if (!confirmed) {
          return;
        }
        vscode.postMessage({
          type: 'release_lock',
          data: { resource }
        });
      };

      window.releaseLocksByHolder = function(holderId) {
        if (!holderId) {
          return;
        }
        const confirmed = window.confirm('释放持有者 ' + holderId + ' 的所有锁？');
        if (!confirmed) {
          return;
        }
        vscode.postMessage({
          type: 'release_lock_holder',
          data: { holder_id: holderId }
        });
      };

      window.releaseSessionLocks = function(sessionId) {
        if (!sessionId) {
          return;
        }
        const confirmed = window.confirm('释放会话 ' + sessionId + ' 的所有锁？');
        if (!confirmed) {
          return;
        }
        vscode.postMessage({
          type: 'release_session_locks',
          data: { session_id: sessionId }
        });
      };

      window.cleanupLocks = function() {
        vscode.postMessage({ type: 'cleanup_expired_locks' });
      };

      const FILE_CHANGE_NO_TASK_KEY = '__no_task__';
      let fileChangeFilter = 'all';
      let fileChangeViewMode = 'timeline';
      let fileChangeTaskFilter = '';
      let fileChangeAgentFilter = '';
      const expandedFileChanges = new Set();

      function renderFileChanges(changes) {
        allFileChanges = Array.isArray(changes) ? changes : [];
        const container = document.getElementById('file-changes-list');
        const statsEl = document.getElementById('file-change-stats');
        if (!container) {
          return;
        }

        const baseChanges = currentSessionId
          ? allFileChanges.filter(change => (change.session_id || null) === currentSessionId)
          : [];

        const filtered = baseChanges.filter(change => {
          if (fileChangeFilter !== 'all' && change.change_type !== fileChangeFilter) {
            return false;
          }
          if (fileChangeTaskFilter && !(String(change.task_id ?? '')).includes(fileChangeTaskFilter)) {
            return false;
          }
          if (fileChangeAgentFilter && !(String(change.agent_id ?? '')).includes(fileChangeAgentFilter)) {
            return false;
          }
          return true;
        });

        const sorted = filtered
          .slice()
          .sort((a, b) => (b.created_at || 0) - (a.created_at || 0));

        if (statsEl) {
          if (baseChanges.length === 0) {
            statsEl.textContent = '0 条';
          } else if (sorted.length === 0) {
            statsEl.textContent = '0/' + baseChanges.length + ' 条';
          } else if (fileChangeViewMode === 'task') {
            const uniqueTasks = new Set(
              sorted.map(change => getTaskGroupKey(change.task_id))
            );
            statsEl.textContent = uniqueTasks.size + ' 个任务';
          } else if (
            fileChangeFilter === 'all' &&
            !fileChangeTaskFilter &&
            !fileChangeAgentFilter
          ) {
            statsEl.textContent = baseChanges.length + ' 条';
          } else {
            statsEl.textContent = sorted.length + '/' + baseChanges.length + ' 条';
          }
        }

        if (sorted.length === 0) {
          if (!currentSessionId) {
            container.innerHTML = '<div class="empty-state">请选择一个会话以查看文件变更</div>';
          } else if (baseChanges.length === 0) {
            container.innerHTML =
              '<div class="empty-state">当前会话尚未产生文件变更。若 Agent 已完成产物，可直接在工作区查看或等待写文件工具记录。</div>';
          } else {
            container.innerHTML = '<div class="empty-state">当前筛选条件下没有记录</div>';
          }
          return;
        }

        if (fileChangeViewMode === 'task') {
          container.innerHTML = buildFileChangeTaskView(sorted);
          return;
        }

        container.innerHTML = sorted
          .slice(0, 8)
          .map(change => buildFileChangeItem(change))
          .join('');
      }

      function buildFileChangeItem(change) {
        const badgeColor =
          change.change_type === 'create'
            ? '#4caf50'
            : change.change_type === 'delete'
              ? '#f44336'
              : '#2196f3';

        const lineSummary = change.line_changes
          ? '+' + change.line_changes.added + ' / -' + change.line_changes.removed
          : '';

        const isExpanded = expandedFileChanges.has(change.id);

        return [
          '<div class="file-change-item" data-change-id="' + change.id + '">',
            '<div class="file-change-item-header">',
              '<div>',
                '<div class="file-path">' + escapeHtml(change.file_path) + '</div>',
                '<div style="font-size: 11px; color: var(--vscode-descriptionForeground);">' +
                  (lineSummary ? lineSummary + ' • ' : '') + formatTime(change.created_at) +
                '</div>',
              '</div>',
              '<span class="badge" style="background-color: ' + badgeColor + '; color: white;">' + change.change_type + '</span>',
            '</div>',
            '<div style="font-size: 12px; color: var(--vscode-foreground); margin-top: 6px;">' + escapeHtml(change.reason || '自动记录') + '</div>',
            '<div class="file-change-actions">',
              '<button class="file-change-action-btn" data-action="toggleFileChangeDetail" data-change-id="' + change.id + '">' +
                (isExpanded ? '收起详情' : '查看详情') +
              '</button>',
              '<button class="file-change-action-btn" data-action="openFileChange" data-change-id="' + change.id + '">打开文件</button>',
              '<button class="file-change-action-btn" data-action="copyFileChangeDiff" data-change-id="' + change.id + '">复制 diff</button>',
              '<button class="file-change-action-btn" data-action="rollbackFileChange" data-change-id="' + change.id + '">回滚</button>',
            '</div>',
            isExpanded
              ? '<div class="file-change-detail">' +
                  '<div style="font-size: 11px; color: var(--vscode-descriptionForeground); margin-bottom: 6px;">变更 ID: ' + change.id + '</div>' +
                  '<div class="file-change-diff">' + formatDiffHtml(change.diff) + '</div>' +
                '</div>'
              : '',
          '</div>'
        ].join('');
      }

      function focusFileChangePanel() {
        const rightSidebar = document.getElementById('right-sidebar');
        if (rightSidebar && rightSidebar.classList.contains('collapsed')) {
          rightSidebar.classList.remove('collapsed');
          const toggleBtn = rightSidebar.querySelector('.collapse-btn');
          if (toggleBtn) {
            toggleBtn.textContent = '▶';
          }
        }

        const panel = document.getElementById('panel-file-changes');
        if (!panel) {
          return;
        }
        if (panel.classList.contains('collapsed')) {
          panel.classList.remove('collapsed');
          panel.style.flex = '1';
          panel.style.height = '';
          const btn = panel.querySelector('.panel-collapse-btn');
          if (btn) {
            btn.textContent = '▼';
          }
        }
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      function formatDiffHtml(diffText) {
        if (!diffText) {
          return '<div class="diff-line">没有可预览的 diff</div>';
        }
        return diffText.split(/\r?\n/).map(line => {
          let cls = 'diff-line';
          if (line.startsWith('+')) {
            cls += ' diff-line-add';
          } else if (line.startsWith('-')) {
            cls += ' diff-line-remove';
          } else if (line.startsWith('@@')) {
            cls += ' diff-line-hunk';
          }
          return '<div class="' + cls + '">' + escapeHtml(line) + '</div>';
        }).join('');
      }

      function buildFileChangeTaskView(changes) {
        const grouped = new Map();
        changes.forEach(change => {
          const key = getTaskGroupKey(change.task_id);
          if (!grouped.has(key)) {
            const label = key === FILE_CHANGE_NO_TASK_KEY
              ? '未关联任务'
              : '任务 ' + String(change.task_id);
            grouped.set(key, { display: label, items: [] });
          }
          grouped.get(key).items.push(change);
        });

        const entries = Array.from(grouped.values())
          .map(group => {
            const sortedItems = group.items
              .slice()
              .sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
            const latestItem = sortedItems.length > 0 ? sortedItems[0] : null;
            return {
              display: group.display,
              items: sortedItems,
              latest: latestItem && latestItem.created_at ? latestItem.created_at : 0
            };
          })
          .sort((a, b) => b.latest - a.latest)
          .slice(0, 5);

        if (entries.length === 0) {
          return '<div class="empty-state">当前筛选条件下没有任务</div>';
        }

        return entries
          .map(entry => buildFileChangeTaskGroup(entry.display, entry.items))
          .join('');
      }

      function buildFileChangeTaskGroup(taskDisplayId, items) {
        if (!items || items.length === 0) {
          return '';
        }

        const latestTime = items[0] && items[0].created_at
          ? formatTime(items[0].created_at)
          : '未知时间';

        const stats = { create: 0, modify: 0, delete: 0 };
        items.forEach(item => {
          if (stats[item.change_type] !== undefined) {
            stats[item.change_type] += 1;
          }
        });
        const summaryParts = [];
        if (stats.create) summaryParts.push('新增 ' + stats.create);
        if (stats.modify) summaryParts.push('修改 ' + stats.modify);
        if (stats.delete) summaryParts.push('删除 ' + stats.delete);
        const summaryText = summaryParts.length ? summaryParts.join(' / ') : '暂无统计';

        const agentIds = Array.from(new Set(items.map(item => item.agent_id).filter(Boolean)));
        let agentSummaryText = agentIds.length
          ? 'Agent：' + agentIds.slice(0, 3).join(', ')
          : 'Agent：暂无';
        if (agentIds.length > 3) {
          agentSummaryText += ' 等 ' + agentIds.length + ' 个';
        }

        const listHtml = items
          .slice(0, 3)
          .map(item => buildFileChangeItem(item))
          .join('');

        const remainder = items.length - 3;
        const remainderText = remainder > 0
          ? '<div class="task-group-more">还有 ' + remainder + ' 条变更，打开任务可查看全部</div>'
          : '';

        return [
          '<div class="file-change-task-group">',
            '<div class="task-group-header">',
              '<div class="task-group-title">' + escapeHtml(taskDisplayId) + '</div>',
              '<span class="task-group-meta">' + escapeHtml(summaryText) + ' • 最近 ' + escapeHtml(latestTime) + '</span>',
            '</div>',
            '<div class="task-group-agent">' + escapeHtml(agentSummaryText) + '</div>',
            '<div class="task-group-list">',
              listHtml || '<div class="empty-state">暂无记录</div>',
              remainderText,
            '</div>',
          '</div>'
        ].join('');
      }

      function getTaskGroupKey(taskId) {
        if (taskId === undefined || taskId === null || taskId === '') {
          return FILE_CHANGE_NO_TASK_KEY;
        }
        return String(taskId);
      }

      window.toggleFileChangeDetail = function(changeId) {
        const numericId = Number(changeId);
        if (Number.isNaN(numericId)) {
          return;
        }
        if (expandedFileChanges.has(numericId)) {
          expandedFileChanges.delete(numericId);
        } else {
          expandedFileChanges.add(numericId);
        }
        renderFileChanges(allFileChanges);
      };

      window.copyFileChangeDiff = function(changeId) {
        const numericId = Number(changeId);
        if (Number.isNaN(numericId)) {
          return;
        }
        const change = allFileChanges.find(item => item.id === numericId);
        if (!change) {
          vscode.postMessage({
            type: 'show_info',
            message: '未找到变更 ' + numericId
          });
          return;
        }
        const diffText = change.diff || '没有可预览的 diff';
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(diffText).then(() => {
            vscode.postMessage({
              type: 'show_info',
              message: '已复制变更 ' + numericId + ' 的 diff'
            });
          }).catch(() => {
            vscode.postMessage({
              type: 'show_info',
              message: '复制失败，请手动复制'
            });
          });
        } else {
          vscode.postMessage({
            type: 'show_info',
            message: '当前环境不支持剪贴板，请手动复制'
          });
        }
      };

      window.rollbackFileChange = function(changeId) {
        const numericId = Number(changeId);
        if (Number.isNaN(numericId)) {
          return;
        }
        vscode.postMessage({
          type: 'rollback_file_change',
          data: { changeId: numericId }
        });
      };

      window.openFileChange = function(changeId) {
        const numericId = Number(changeId);
        if (Number.isNaN(numericId)) {
          return;
        }
        vscode.postMessage({
          type: 'open_file_change',
          data: { changeId: numericId }
        });
      };

      window.setFileChangeFilter = function(filter) {
        if (!['all', 'create', 'modify', 'delete'].includes(filter)) {
          filter = 'all';
        }
        fileChangeFilter = filter;
        expandedFileChanges.clear();
        document.querySelectorAll('.file-change-filter-btn').forEach(btn => {
          const value = btn.getAttribute('data-filter') || 'all';
          btn.classList.toggle('active', value === filter);
        });
        renderFileChanges(allFileChanges);
      };

      window.setFileChangeTaskFilter = function(value, options = {}) {
        const normalized = value || '';
        fileChangeTaskFilter = normalized;
        if (!options.skipInputSync) {
          const input = document.getElementById('file-change-task-filter');
          if (input && input.value !== normalized) {
            input.value = normalized;
          }
        }
        expandedFileChanges.clear();
        renderFileChanges(allFileChanges);
        renderTasks(allTasks);
      };

      window.setFileChangeAgentFilter = function(value) {
        fileChangeAgentFilter = value || '';
        expandedFileChanges.clear();
        renderFileChanges(allFileChanges);
      };

      window.filterFileChangesByTask = function(taskId) {
        const normalized = taskId ? String(taskId) : '';
        const nextValue = normalized && normalized === fileChangeTaskFilter ? '' : normalized;
        focusFileChangePanel();
        if (fileChangeViewMode !== 'timeline') {
          window.setFileChangeView('timeline');
          // setFileChangeView already re-renders; task filter update follows
        }
        window.setFileChangeTaskFilter(nextValue);
      };

      window.setFileChangeView = function(viewMode) {
        const allowed = ['timeline', 'task'];
        if (!allowed.includes(viewMode)) {
          viewMode = 'timeline';
        }
        const changed = fileChangeViewMode !== viewMode;
        fileChangeViewMode = viewMode;
        if (changed) {
          expandedFileChanges.clear();
        }
        document.querySelectorAll('.file-change-view-btn').forEach(btn => {
          const value = btn.getAttribute('data-view') || 'timeline';
          btn.classList.toggle('active', value === viewMode);
        });
        renderFileChanges(allFileChanges);
      };

      function getPolicyTypeText(type) {
        const map = {
          'auto_approve': '自动审批',
          'auto_merge': '自动合并',
          'auto_test': '自动测试',
          'auto_notify': '自动通知',
          'require_review': '需要审查',
          'require_vote': '需要投票'
        };
        return map[type] || type;
      }

      function getPolicyTypeBadgeClass(type) {
        const map = {
          'auto_approve': 'success',
          'auto_merge': 'info',
          'auto_test': 'info',
          'auto_notify': 'warning',
          'require_review': 'warning',
          'require_vote': 'info'
        };
        return map[type] || 'default';
      }

      // 接收消息
      window.addEventListener('message', event => {
        const message = event.data;
        console.log('[MinimalPanel] Received message:', message.type);

        switch (message.type) {
          case 'agents_data':
          case 'agents_update':
            updateStatus('Agents loaded');
            renderAgents(message.data);
            break;
          case 'agent_refresh_status':
            if (message.data && message.data.id) {
              pendingAgentRefresh.delete(message.data.id);
              renderGlobalAgentTable(allAgents);
              if (message.data.success) {
                updateStatus('Agent 刷新成功');
              } else if (message.data.error) {
                updateStatus('Agent 刷新失败：' + message.data.error);
              }
            }
            break;

          case 'tasks_data':
          case 'tasks_update':
            updateStatus('Tasks loaded');
            renderTasks(message.data);
            if (message.type === 'tasks_update') {
              scheduleTaskMetricsRefresh();
            }
            break;

          case 'messages_data':
          case 'messages_update':
            console.log('[MinimalPanel] Messages loaded:', message.data.length);
            renderMessages(message.data);
            updateStatus('Messages loaded: ' + message.data.length);
            break;

          case 'blackboard_message':
            console.log('[MinimalPanel] Received real-time message:', message.data);
            if (message.data) {
              allMessages.push(message.data);
              renderMessages(allMessages);
            }
            break;

          case 'votes_data':
          case 'votes_update':
            console.log('[MinimalPanel] Votes loaded:', message.data.length);
            renderVotes(message.data);
            break;

          case 'approvals_data':
          case 'approvals_update':
            console.log('[MinimalPanel] Approvals loaded:', message.data.length);
            renderApprovals(message.data);
            break;

          case 'notifications_data':
          case 'notifications_update':
            console.log('[MinimalPanel] Notifications loaded:', message.data.length);
            renderNotifications(message.data);
            break;

          case 'tool_runs_data':
          case 'tool_runs_update':
            allToolRuns = Array.isArray(message.data) ? message.data : [];
            renderToolRuns();
            break;

          case 'sessions_data':
          case 'sessions_update':
            console.log('[MinimalPanel] Sessions loaded:', Array.isArray(message.data) ? message.data.length : 0);
            applySessionsPayload(message.data);
            break;
          case 'thinking_logs_data':
          case 'thinking_logs_update':
            console.log('[MinimalPanel] Thinking logs loaded:', Array.isArray(message.data) ? message.data.length : 0);
            allThinkingLogs = Array.isArray(message.data) ? message.data : [];
            if (selectedAgentId) {
              const currentAgent = allAgents.find(agent => agent.id === selectedAgentId);
              renderWorkspace(currentAgent || null);
            }
            break;
          case 'task_metrics_update':
            renderTaskMetrics(message.data || null);
            break;
          case 'llm_stream_update':
            handleLlmStreamMessage(message.data);
            break;

          case 'file_changes_update':
            console.log('[MinimalPanel] File changes update:', message.data.length);
            renderFileChanges(message.data);
            break;
          case 'file_changes_data':
            console.log('[MinimalPanel] File changes loaded:', message.data.length);
            renderFileChanges(message.data);
            break;
          case 'mcp_servers_update':
          case 'mcp_servers_data':
            console.log('[MinimalPanel] MCP servers loaded:', Array.isArray(message.data) ? message.data.length : 0);
            renderMcpServers(message.data);
            break;
          case 'mcp_tools_data':
            if (message.data && typeof message.data.serverId === 'number') {
              mcpToolsCache.set(message.data.serverId, message.data.tools || []);
              renderMcpServers(allMcpServers);
            }
            break;
          case 'locks_data':
            renderLocks(message.data || []);
            break;
          case 'mcp_server_status':
            if (message.data && typeof message.data.serverId === 'number') {
              mcpServerStatus.set(message.data.serverId, {
                available: !!message.data.available,
                error: message.data.error || null,
                toolCount: typeof message.data.toolCount === 'number' ? message.data.toolCount : null
              });
              pendingMcpRefresh.delete(message.data.serverId);
              renderMcpServers(allMcpServers);
            }
            break;
          case 'workflow_instances_update':
            handleWorkflowInstancesUpdate(message.data);
            break;
          case 'workflow_instances_data':
            handleWorkflowInstancesData(message.data);
            break;
          case 'proof_records_data':
          case 'proof_records_update':
            applyProofRecords(message.data);
            break;
          case 'workflow_event':
            scheduleWorkflowSnapshot(200);
            break;
          case 'governance_history_data':
            console.log('[MinimalPanel] Governance history loaded:', Array.isArray(message.data) ? message.data.length : 0);
            governanceHistoryPage = message.pagination?.page || governanceHistoryPage;
            governanceHistoryHasMore = !!message.pagination?.hasMore;
            renderGovernanceHistory(message.data);
            break;
          case 'task_backlog_update':
            taskBacklogSummaries = Array.isArray(message.data) ? message.data : [];
            renderTasks(allTasks);
            break;
          case 'governance_history_update':
            console.log('[MinimalPanel] Governance history update event, refetching');
            fetchGovernanceHistory();
            break;
          case 'governance_analytics_data':
            console.log('[MinimalPanel] Governance analytics loaded');
            renderGovernanceAnalytics(message.data);
            break;
          case 'governance_analytics_error':
            console.error('[MinimalPanel] Governance analytics error:', message.error);
            setGovernanceAnalyticsStatus(message.error || '获取治理分析失败', true);
            break;
          case 'scheduler_event':
            handleSchedulerEvent(message.data);
            break;
          case 'sentinel_event':
            handleSentinelEvent(message.data);
            break;
          case 'workflow_template_update':
            workflowTemplateInfo = message.data || null;
            renderWorkflowTemplateBadge();
            break;
          default:
            console.warn('[MinimalPanel] Unknown message type:', message.type);
        }
      });

      function handleLlmStreamMessage(payload) {
        if (!payload) {
          return;
        }
        const key = payload.task_id || ('agent:' + (payload.agent_id || 'unknown'));
        if (payload.status === 'done' || payload.status === 'error') {
          llmStreamStates.delete(key);
        } else {
          llmStreamStates.set(key, {
            ...payload,
            updatedAt: payload.timestamp || Date.now()
          });
        }
        if (selectedAgentId) {
          const currentAgent = allAgents.find(agent => agent.id === selectedAgentId);
          renderWorkspace(currentAgent || null);
        }
      }

      // 侧边栏收起/展开功能
      window.toggleLeftSidebar = function() {
        const sidebar = document.getElementById('left-sidebar');
        const btn = sidebar.querySelector('.collapse-btn');
        sidebar.classList.toggle('collapsed');
        btn.textContent = sidebar.classList.contains('collapsed') ? '▶' : '◀';
        console.log('[MinimalPanel] Left sidebar toggled');
      };

      window.toggleRightSidebar = function() {
        const sidebar = document.getElementById('right-sidebar');
        const btn = sidebar.querySelector('.collapse-btn');
        sidebar.classList.toggle('collapsed');
        btn.textContent = sidebar.classList.contains('collapsed') ? '◀' : '▶';
        console.log('[MinimalPanel] Right sidebar toggled');
      };

      // 面板折叠/展开功能
      window.togglePanel = function(event) {
        const target = event.target.closest('[data-panel]');
        if (!target) return;

        const panelId = target.getAttribute('data-panel');
        const panel = document.getElementById(panelId);
        if (!panel) return;

        const isCollapsing = !panel.classList.contains('collapsed');

        if (isCollapsing) {
          // 折叠：移除自定义高度，让 CSS 类控制
          panel.style.height = '';
          panel.style.flex = '';
          panel.classList.add('collapsed');
        } else {
          // 展开：恢复默认 flex
          panel.classList.remove('collapsed');
          panel.style.flex = '1';
          panel.style.height = '';
        }

        const btn = panel.querySelector('.panel-collapse-btn');
        if (btn) {
          btn.textContent = panel.classList.contains('collapsed') ? '▶' : '▼';
        }
        console.log('[MinimalPanel] Panel toggled:', panelId, isCollapsing ? 'collapsed' : 'expanded');
      };

      // LLM Provider 切换处理
      function handleProviderChange() {
        const provider = document.getElementById('agent-llm-provider').value;
        const modelInput = document.getElementById('agent-llm-model');
        const baseUrlGroup = document.getElementById('base-url-group');
        const baseUrlInput = document.getElementById('agent-llm-base-url');
        const baseUrlHint = document.getElementById('base-url-hint');
        const modelHint = document.getElementById('model-hint');
        const apiKeyHint = document.getElementById('api-key-hint');

        const preset = LLM_PRESETS[provider];
        if (!preset) return;

        // 检查当前模型是否属于当前 provider 的模型列表
        const currentModel = modelInput.value.trim();
        const isValidModel = currentModel === '' ||
          !preset.models.includes(currentModel);

        // 如果当前模型不属于当前 provider，或者为空，设置为默认模型
        if (isValidModel && preset.defaultModel) {
          modelInput.value = preset.defaultModel;
        }

        // 检查当前 Base URL 是否是某个 preset 的默认值
        const currentBaseUrl = baseUrlInput.value.trim();
        const isPresetBaseUrl = currentBaseUrl === '' ||
          Object.values(LLM_PRESETS).some(p => p.baseURL === currentBaseUrl);

        // Base URL 输入（始终显示，允许覆盖）
        baseUrlGroup.style.display = 'block';

        // 如果是空的或者是其他 preset 的默认值，更新为当前 provider 的 Base URL
        if (isPresetBaseUrl) {
          if (preset.baseURL) {
            baseUrlInput.value = preset.baseURL;
            baseUrlInput.placeholder = preset.baseURL;
            if (baseUrlHint) {
              baseUrlHint.textContent = `默认：${preset.baseURL}，可按需修改`;
            }
          } else {
            baseUrlInput.value = '';
            baseUrlInput.placeholder = 'https://your-api-endpoint.com/v1';
            if (baseUrlHint) {
              baseUrlHint.textContent = '请输入符合 OpenAI 协议的接口地址';
            }
          }
        } else if (baseUrlHint) {
          // 用户自定义的 Base URL，保持不变
          baseUrlHint.textContent = '已自定义 Base URL，可根据需要修改';
        }

        // 更新提示信息
        if (preset.models.length > 0) {
          modelHint.textContent = '可选模型：' + preset.models.join(', ');
        } else {
          modelHint.textContent = '请输入自定义模型名称';
        }

        apiKeyHint.textContent = '必填：用于调用 ' + preset.name + ' API';
        renderModelSuggestions(provider);
      }

      // 监听 provider 变化
      const providerSelect = document.getElementById('agent-llm-provider');
      if (providerSelect) {
        providerSelect.addEventListener('change', handleProviderChange);
        renderModelSuggestions(providerSelect.value);
      }



      function renderModelSuggestions(provider) {
        const container = document.getElementById('model-suggestion-chips');
        if (!container) {
          return;
        }
        const preset = LLM_PRESETS[provider];
        if (!preset || preset.models.length === 0) {
          container.innerHTML = '<span class="form-hint">无推荐模型，可自定义填写</span>';
          return;
        }
        container.innerHTML = preset.models.map(model => (
          '<button type="button" class="chip" data-action="applyModelSuggestion" data-model="' + escapeHtml(model) + '">' +
            escapeHtml(model) +
          '</button>'
        )).join('');
      }

      window.applyModelSuggestion = function(model) {
        if (!model) {
          return;
        }
        const input = document.getElementById('agent-llm-model');
        if (!input) {
          return;
        }
        input.value = model;
      };

      // 模态弹窗管理
      window.openModal = function(modalId) {
        console.log('[MinimalPanel] Opening modal:', modalId);
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.classList.add('show');
          // 初始化 provider 提示
          if (modalId === 'modal-add-agent') {
            handleProviderChange();
            const form = modal.querySelector('form');
            const submitBtn = modal.querySelector('[data-action="submitEditAgent"], [data-action="submitAddAgent"]');
            const isEditing = submitBtn?.getAttribute('data-action') === 'submitEditAgent';
            if (!isEditing && form) {
              setSelectedRoles(form, []);
              setSelectedCapabilities(form, []);
              setSelectedToolPermissions(form, []);
            }
          }
          // 聚焦到第一个输入框
          setTimeout(() => {
            const firstInput = modal.querySelector('input, textarea, select');
            if (firstInput) firstInput.focus();
          }, 100);
        }
      };

      window.closeModal = function() {
        console.log('[MinimalPanel] Closing modal');
        const modals = document.querySelectorAll('.modal-overlay.show');
        modals.forEach(modal => {
          modal.classList.remove('show');
          // 清空表单
          const form = modal.querySelector('form');
          if (form) {
            form.reset();
            setSelectedRoles(form, []);
            setSelectedToolPermissions(form, []);
          }

          // 重置 Modal 状态（用于编辑 Agent）
          if (modal.id === 'modal-add-agent') {
            modal.querySelector('.modal-title').textContent = '添加 Agent';
            const submitBtn = modal.querySelector('[data-action="submitEditAgent"], [data-action="submitAddAgent"]');
            if (submitBtn) {
              submitBtn.setAttribute('data-action', 'submitAddAgent');
              submitBtn.removeAttribute('data-agent-id');
              submitBtn.textContent = '确定';
            }
            // 恢复 ID 输入框可编辑
            const idInput = form.querySelector('[name="id"]');
            if (idInput) idInput.disabled = false;
            setSelectedRoles(form, []);
            setSelectedCapabilities(form, []);
            setSelectedToolPermissions(form, []);
          }
          if (modal.id === 'modal-vote-detail') {
            currentVoteDetail = null;
            const commentInput = document.getElementById('vote-comment-input');
            if (commentInput) {
              commentInput.value = '';
            }
          }
          if (modal.id === 'modal-approval-detail') {
            currentApprovalDetail = null;
            const commentInput = document.getElementById('approval-comment-input');
            if (commentInput) {
              commentInput.value = '';
            }
          }
          if (modal.id === 'modal-task-detail') {
            currentTaskDetail = null;
          }
          if (modal.id === 'modal-task-dependency') {
            currentTaskDependencyDetail = null;
          }
          if (modal.id === 'modal-mcp-config') {
            currentMcpServerEditId = null;
            const errorInput = document.getElementById('mcp-config-error');
            if (errorInput) {
              errorInput.textContent = '';
            }
          }
        });
      };

      // 初始化标签云事件监听器
      function initTagCloudListeners() {
        // 角色标签点击事件
        document.querySelectorAll('#agent-roles-cloud .tag-chip').forEach(chip => {
          chip.addEventListener('click', function() {
            this.classList.toggle('selected');

            // 确保至少有一个角色被选中
            const selectedRoles = document.querySelectorAll('#agent-roles-cloud .tag-chip.selected');
            if (selectedRoles.length === 0) {
              this.classList.add('selected');
            }
          });
        });

        // 能力标签点击事件
        document.querySelectorAll('#agent-capabilities-cloud .tag-chip').forEach(chip => {
          chip.addEventListener('click', function() {
            this.classList.toggle('selected');
          });
        });

        // 工具权限标签点击事件
        document.querySelectorAll('#agent-tools-cloud .tag-chip').forEach(chip => {
          chip.addEventListener('click', function() {
            this.classList.toggle('selected');
          });
        });
      }

      window.clearOrchestrationEvents = function() {
        orchestrationEvents.length = 0;
        renderOrchestrationEvents();
      };

      // 页面加载时初始化
      initTagCloudListeners();

      // ESC 键关闭
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          window.closeModal();
        }
      });

      window.addEventListener('beforeunload', () => {
        stopGovernancePolling();
      });

      // 添加 Agent
      window.addAgent = function() {
        console.log('[MinimalPanel] Add agent clicked');
        const form = document.getElementById('form-add-agent');
        if (form) {
          form.reset();
          const idInput = form.querySelector('[name="id"]');
          if (idInput) {
            idInput.disabled = false;
          }
          setSelectedRoles(form, []);
          setSelectedCapabilities(form, []);
          setSelectedToolPermissions(form, []);
        }
        const modal = document.getElementById('modal-add-agent');
        if (modal) {
          modal.querySelector('.modal-title').textContent = '添加 Agent';
          const submitBtn = modal.querySelector('.modal-footer .btn-primary');
          if (submitBtn) {
            submitBtn.setAttribute('data-action', 'submitAddAgent');
            submitBtn.removeAttribute('data-agent-id');
            submitBtn.textContent = '确定';
          }
        }
        handleProviderChange();
        updateStatus('Opening add agent modal...');
        window.openModal('modal-add-agent');
      };

      // 提交添加 Agent 表单
      window.submitAddAgent = function() {
        console.log('[MinimalPanel] Submit add agent');
        const form = document.getElementById('form-add-agent');

        // 验证表单
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        // 收集表单数据
        const formData = new FormData(form);
        const roles = getSelectedRoles(form);
        if (!roles || roles.length === 0) {
          updateStatus('请至少选择一个角色');
          const firstRoleInput = form.querySelector('input[name="agent_roles"]');
          if (firstRoleInput) {
            firstRoleInput.focus();
          }
          return;
        }
        const capabilities = getSelectedCapabilities(form);
        const toolPermissions = getSelectedToolPermissions(form);
        const agentData = {
          id: formData.get('id'),
          display_name: formData.get('display_name'),
          roles,
          capabilities,
          tool_permissions: toolPermissions,
          llm_provider: formData.get('llm_provider'),
          llm_model: formData.get('llm_model'),
          llm_api_key: formData.get('llm_api_key') || undefined,
          llm_base_url: formData.get('llm_base_url') || undefined
        };

        console.log('[MinimalPanel] Agent data:', agentData);
        updateStatus('Creating agent...');

        // 发送到后端
        vscode.postMessage({
          type: 'create_agent',
          data: agentData
        });

        // 关闭模态弹窗
        window.closeModal();
      };

      // 提交编辑 Agent 表单
      window.submitEditAgent = function() {
        console.log('[MinimalPanel] Submit edit agent');
        const form = document.getElementById('form-add-agent');
        const submitBtn = document.querySelector('[data-action="submitEditAgent"]');
        const agentId = submitBtn.getAttribute('data-agent-id');

        // 验证表单
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        // 收集表单数据
        const formData = new FormData(form);
        const roles = getSelectedRoles(form);
        if (!roles || roles.length === 0) {
          updateStatus('请至少选择一个角色');
          const firstRoleInput = form.querySelector('input[name="agent_roles"]');
          if (firstRoleInput) {
            firstRoleInput.focus();
          }
          return;
        }
        const capabilities = getSelectedCapabilities(form);
        const toolPermissions = getSelectedToolPermissions(form);
        const agentData = {
          id: agentId,
          display_name: formData.get('display_name'),
          roles,
          capabilities,
          tool_permissions: toolPermissions,
          // LLM 配置
          llm_provider: formData.get('llm_provider'),
          llm_model: formData.get('llm_model'),
          llm_api_key: formData.get('llm_api_key') || undefined,
          llm_base_url: formData.get('llm_base_url') || undefined
        };

        console.log('[MinimalPanel] Update agent data:', agentData);
        updateStatus('Updating agent...');

        // 发送到后端
        vscode.postMessage({
          type: 'update_agent',
          data: agentData
        });

        // 关闭模态弹窗
        window.closeModal();
      };

      // 面板拖动调整大小功能
      let isDragging = false;
      let currentResizer = null;
      let currentPanel = null;
      let startY = 0;
      let startHeight = 0;

      document.querySelectorAll('.panel-resizer').forEach(resizer => {
        resizer.addEventListener('mousedown', (e) => {
          isDragging = true;
          currentResizer = resizer;
          const targetId = resizer.getAttribute('data-target');
          currentPanel = document.getElementById(targetId);

          if (!currentPanel) return;

          startY = e.clientY;
          startHeight = currentPanel.offsetHeight;

          currentResizer.classList.add('dragging');
          document.body.style.cursor = 'ns-resize';
          document.body.style.userSelect = 'none';

          e.preventDefault();
        });
      });

      // 输入区域拖动调整大小功能
      const MIN_INPUT_HEIGHT = 100;
      const MAX_INPUT_HEIGHT = 360;

      let isInputResizing = false;
      let inputArea = null;
      let inputStartY = 0;
      let inputStartHeight = 0;

      const inputResizeHandle = document.getElementById('input-resize-handle');
      if (inputResizeHandle) {
        inputResizeHandle.addEventListener('mousedown', (e) => {
          isInputResizing = true;
          inputArea = document.getElementById('message-textarea-wrapper');

          if (!inputArea) return;

          inputStartY = e.clientY;
          inputStartHeight = inputArea.offsetHeight;

          inputResizeHandle.classList.add('dragging');
          document.body.style.cursor = 'ns-resize';
          document.body.style.userSelect = 'none';

          e.preventDefault();
        });
      }

      document.addEventListener('mousemove', (e) => {
        if (isDragging && currentPanel) {
          const deltaY = e.clientY - startY;
          const newHeight = startHeight + deltaY;

          // 限制最小高度
          if (newHeight >= 100) {
            currentPanel.style.flex = 'none';
            currentPanel.style.height = newHeight + 'px';
          }
        }

        if (isInputResizing && inputArea) {
          const deltaY = inputStartY - e.clientY; // 反向，因为是从下往上拖
          const newHeight = inputStartHeight + deltaY;

          const clampedHeight = Math.max(MIN_INPUT_HEIGHT, Math.min(newHeight, MAX_INPUT_HEIGHT));
          inputArea.style.height = clampedHeight + 'px';
        }
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          if (currentResizer) {
            currentResizer.classList.remove('dragging');
          }
          currentResizer = null;
          currentPanel = null;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }

        if (isInputResizing) {
          isInputResizing = false;
          if (inputResizeHandle) {
            inputResizeHandle.classList.remove('dragging');
          }
          inputArea = null;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      // 消息搜索输入框事件监听
      const messageSearchInput = document.getElementById('message-search');
      if (messageSearchInput) {
        messageSearchInput.addEventListener('input', (e) => {
          window.searchMessages(e.target.value);
        });
      }
      initMentionInput();

      // 消息列表滚动监听
      const messagesContainer = document.getElementById('messages-list');
      if (messagesContainer) {
        messagesContainer.addEventListener('scroll', () => {
          if (isAtBottom(messagesContainer)) {
            // User scrolled to bottom
            isUserScrolling = false;
            hasNewMessages = false;
            hideNewMessageButton();
          } else {
            // User scrolled away from bottom
            isUserScrolling = true;
          }
        });
      }

      // 事件委托
      document.addEventListener('click', (e) => {
        const target = e.target instanceof Element ? e.target : null;

        // 处理任务卡片点击
        const taskItem = target ? target.closest('.task-item') : null;
        if (taskItem && !target.closest('[data-action]') && !target.closest('button')) {
          const taskId = taskItem.getAttribute('data-task-id');
          if (taskId) {
            window.openTaskDetailModal(taskId);
            return;
          }
        }

        const actionElement = target ? target.closest('[data-action]') : null;
        if (!actionElement) {
          return;
        }

        const action = actionElement.getAttribute('data-action');
        if (!action) {
          return;
        }

        console.log('[MinimalPanel] Action clicked:', action);

        if (action === 'togglePanel') {
          window.togglePanel(e);
        } else if (action === 'closeModal') {
          window.closeModal();
        } else if (action === 'submitAddAgent') {
          window.submitAddAgent();
        } else if (action === 'submitEditAgent') {
          window.submitEditAgent();
        } else if (action === 'openGlobalAgentTab') {
          window.openGlobalAgentTab();
        } else if (action === 'handleNotificationClick') {
          const notificationId = actionElement.getAttribute('data-notification-id') || '';
          window.handleNotificationClick(notificationId);
        } else if (action === 'openCreateSessionModal') {
          window.openCreateSessionModal();
        } else if (action === 'confirmCreateSession') {
          window.confirmCreateSession();
        } else if (action === 'openDeleteSessionModal') {
          window.openDeleteSessionModal();
        } else if (action === 'confirmDeleteSession') {
          window.confirmDeleteSession();
        } else if (action === 'setFileChangeFilter') {
          const filter = actionElement.getAttribute('data-filter') || 'all';
          window.setFileChangeFilter(filter);
        } else if (action === 'applyMessageTemplate') {
          const templateId = actionElement.getAttribute('data-template-id') || '';
          window.applyMessageTemplate(templateId);
        } else if (action === 'openReferenceTarget') {
          const refType = actionElement.getAttribute('data-reference-type') || '';
          const refId = actionElement.getAttribute('data-reference-id') || '';
          openReferenceTarget(refType, refId);
        } else if (action === 'openCreateVoteModal') {
          const taskId = actionElement.getAttribute('data-task-id') || '';
          window.openCreateVoteModal(taskId);
        } else if (action === 'showApprovalsPanel') {
          if (typeof window.showApprovalsPanel === 'function') {
            window.showApprovalsPanel();
          }
        } else if (action === 'openVoteDetail') {
          const topicId = actionElement.getAttribute('data-topic-id') || '';
          window.openVoteDetail(topicId);
        } else if (action === 'openApprovalDetail') {
          const approvalId = actionElement.getAttribute('data-approval-id') || '';
          window.openApprovalDetail(approvalId);
        } else if (action === 'submitVoteDecision') {
          const choice = actionElement.getAttribute('data-choice') || '';
          window.submitVoteDecision(choice);
        } else if (action === 'submitApprovalDecision') {
          const decision = actionElement.getAttribute('data-decision') || '';
          window.submitApprovalDecision(decision);
        } else if (action === 'openTaskDetailModal') {
          const taskId = actionElement.getAttribute('data-task-id') || '';
          window.openTaskDetailModal(taskId);
        } else if (action === 'openTaskDependencyModal') {
          const taskId = actionElement.getAttribute('data-task-id') || '';
          window.openTaskDependencyModal(taskId);
        } else if (action === 'focusTaskInList') {
          const taskId = actionElement.getAttribute('data-task-id') || '';
          window.focusTaskInList(taskId);
        } else if (action === 'focusBacklogSummary') {
          const summaryId = actionElement.getAttribute('data-summary-id') || '';
          focusBacklogSummary(summaryId || null);
        } else if (action === 'clearBacklogFilter') {
          focusBacklogSummary(null);
        } else if (action === 'setFileChangeView') {
          const view = actionElement.getAttribute('data-view') || 'timeline';
          window.setFileChangeView(view);
        } else if (action === 'sendWorkflowNote') {
          window.sendWorkflowNote();
        } else if (action === 'filterFileChangesByTask') {
          const taskId = actionElement.getAttribute('data-task-id') || '';
          window.filterFileChangesByTask(taskId);
        } else if (action === 'pauseTask') {
          const taskId = actionElement.getAttribute('data-task-id') || '';
          if (taskId) {
            window.pauseTask(taskId);
          }
        } else if (action === 'rerunTool') {
          const runId = actionElement.getAttribute('data-run-id') || '';
          if (runId) {
            vscode.postMessage({ type: 'rerun_tool', data: { run_id: runId } });
          }
        } else if (action === 'toggleToolRunLog') {
          const logId = actionElement.getAttribute('data-log-id');
          if (logId) {
            const el = document.getElementById(logId);
            if (el) {
              el.classList.toggle('visible');
            }
          }
        } else if (action === 'resumeTask') {
          const taskId = actionElement.getAttribute('data-task-id') || '';
          if (taskId) {
            window.resumeTask(taskId);
          }
        } else if (action === 'switchWorkspaceTab') {
          const tab = actionElement.getAttribute('data-workspace-tab') || 'overview';
          window.switchWorkspaceTab(tab);
        } else if (action === 'setWorkspaceScope') {
          const scope = actionElement.getAttribute('data-scope') || 'all';
          window.setWorkspaceThinkingScope(scope);
        } else if (action === 'toggleThinkingTypeFilter') {
          const filterKey = actionElement.getAttribute('data-filter-key') || '';
          window.toggleThinkingTypeFilter(filterKey || actionElement);
        } else if (action === 'resetThinkingTypeFilters') {
          window.resetThinkingTypeFilters();
        } else if (action === 'governanceAlertAction') {
          const govTarget = actionElement.getAttribute('data-gov-target') || '';
          window.handleGovernanceAlertAction(govTarget);
        } else if (action === 'openMcpAddModal') {
          window.openMcpConfigModal('create');
        } else if (action === 'refreshMcpServer') {
          const serverId = Number(actionElement.getAttribute('data-mcp-id'));
          if (!Number.isNaN(serverId)) {
            window.refreshMcpServer(serverId);
          }
        } else if (action === 'toggleMcpServer') {
          const serverId = Number(actionElement.getAttribute('data-mcp-id'));
          if (!Number.isNaN(serverId)) {
            const enableValue = actionElement.getAttribute('data-enable') || 'false';
            window.toggleMcpServer(serverId, enableValue);
          }
        } else if (action === 'addCustomCapability') {
          window.addCustomCapability();
        } else if (action === 'removeCustomCapability') {
          const capability = actionElement.getAttribute('data-capability') || '';
          window.removeCustomCapability(capability);
        } else if (action === 'applyModelSuggestion') {
          const model = actionElement.getAttribute('data-model') || '';
          window.applyModelSuggestion(model);
        } else if (action === 'refreshWorkspace') {
          window.refreshWorkspace();
        } else if (action === 'editMcpServer') {
          const serverId = Number(actionElement.getAttribute('data-mcp-id'));
          if (!Number.isNaN(serverId)) {
            window.openMcpConfigModal('edit', serverId);
          }
        } else if (action === 'refreshLocks') {
          window.refreshLocks();
        } else if (action === 'releaseLock') {
          const resource = actionElement.getAttribute('data-lock-resource') || '';
          if (resource) {
            window.releaseLock(resource);
          }
        } else if (action === 'releaseLockHolder') {
          const holderId = actionElement.getAttribute('data-lock-holder') || '';
          if (holderId) {
            window.releaseLocksByHolder(holderId);
          }
        } else if (action === 'releaseSessionLocks') {
          const sessionId = actionElement.getAttribute('data-lock-session') || '';
          if (sessionId) {
            window.releaseSessionLocks(sessionId);
          }
        } else if (action === 'cleanupLocks') {
          window.cleanupLocks();
        } else if (action === 'clearOrchestrationEvents') {
          window.clearOrchestrationEvents();
        } else if (action === 'refreshGovernanceAnalytics') {
          fetchGovernanceAnalytics();
        } else if (action === 'setGovernanceAnalyticsType') {
          const analyticsType = actionElement.getAttribute('data-analytics-type') || 'all';
          setGovernanceAnalyticsType(analyticsType);
        } else if (action === 'openIntegrationConfig') {
          vscode.postMessage({ type: 'open_integration_config' });
        } else if (action === 'resolveUserNote') {
          const noteId = actionElement.getAttribute('data-note-id') || '';
          const phaseId = actionElement.getAttribute('data-phase-id') || '';
          const instanceId = actionElement.getAttribute('data-instance-id') || '';
          if (noteId && phaseId && instanceId) {
            vscode.postMessage({
              type: 'resolve_user_note',
              data: {
                note_id: noteId,
                phase_id: phaseId,
                instance_id: instanceId
              }
            });
          }
        } else if (action === 'deleteMcpServer') {
          const serverId = Number(actionElement.getAttribute('data-mcp-id'));
          if (!Number.isNaN(serverId)) {
            const confirmed = window.confirm('确定要删除该 MCP Server 吗？此操作不可撤销。');
            if (confirmed) {
              vscode.postMessage({
                type: 'delete_mcp_server',
                data: { id: serverId }
              });
            }
          }
        } else if (action === 'toggleFileChangeDetail') {
          const changeId = Number(actionElement.getAttribute('data-change-id'));
          if (!Number.isNaN(changeId)) {
            window.toggleFileChangeDetail(changeId);
          }
        } else if (action === 'openFileChange') {
          const changeId = Number(actionElement.getAttribute('data-change-id'));
          if (!Number.isNaN(changeId)) {
            window.openFileChange(changeId);
          }
        } else if (action === 'copyFileChangeDiff') {
          const changeId = Number(actionElement.getAttribute('data-change-id'));
          if (!Number.isNaN(changeId)) {
            window.copyFileChangeDiff(changeId);
          }
        } else if (action === 'rollbackFileChange') {
          const changeId = Number(actionElement.getAttribute('data-change-id'));
          if (!Number.isNaN(changeId)) {
            window.rollbackFileChange(changeId);
          }
        } else if (action === 'refreshGovernanceHistory') {
          window.refreshGovernanceHistory();
        } else if (action === 'focusGovernanceSource') {
          const entryType = actionElement.getAttribute('data-entry-type');
          const entityId = actionElement.getAttribute('data-entity-id');
          window.focusGovernanceSource(entryType, entityId);
        } else if (action === 'toggleThinkingEntry') {
          const entryId = actionElement.getAttribute('data-entry-id') || '';
          window.toggleThinkingEntry(entryId || actionElement);
        } else if (typeof window[action] === 'function') {
          window[action](e);
        }
      });

      // 接收来自后端的消息
      // ✅ 旧的测试代码已清理，现在使用新的标签切换逻辑（switchMainTab, switchBlackboardView）
      // ✅ 消息监听器已在上方统一处理，不需要重复添加

      // 自动加载初始数据
      console.log('[MinimalPanel] Loading initial data...');
      vscode.postMessage({ type: 'get_agents' });
      vscode.postMessage({ type: 'get_sessions' });
      vscode.postMessage({ type: 'get_locks' });
      vscode.postMessage({ type: 'get_mcp_servers' });
      vscode.postMessage({ type: 'get_task_backlogs' });
      requestTaskMetrics();
      fetchGovernanceHistory({ resetPage: true });
      fetchGovernanceAnalytics();
      startGovernancePolling();
    })();
  </script>
</body>
</html>
