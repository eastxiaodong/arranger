<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="thinking-collapse.js"></script>
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline';">
  <title>Arranger 面板</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    .ace-activity-panel {
      margin-top: 20px;
      border-top: 1px solid var(--vscode-panel-border);
      padding-top: 16px;
    }

    .ace-activity-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
    }

    .ace-activity-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    .ace-activity-card {
      padding: 12px;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      background: var(--vscode-sideBar-background);
    }

    .ace-activity-card h4 {
      margin: 0 0 6px;
      font-size: 14px;
    }

    .ace-activity-meta {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    .ace-activity-card .ace-activity-card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .ace-activity-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
    }

    .ace-activity-status .ace-activity-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--vscode-descriptionForeground);
    }

    .ace-activity-status.status-running .ace-activity-dot {
      background: var(--vscode-testing-iconQueued);
      box-shadow: 0 0 4px var(--vscode-testing-iconQueued);
    }

    .ace-activity-status.status-succeeded .ace-activity-dot {
      background: var(--vscode-testing-iconPassed);
      box-shadow: 0 0 4px var(--vscode-testing-iconPassed);
    }

    .ace-activity-status.status-failed .ace-activity-dot {
      background: var(--vscode-testing-iconFailed);
      box-shadow: 0 0 4px var(--vscode-testing-iconFailed);
    }

    .ace-activity-body {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .ace-activity-meta strong {
      color: var(--vscode-foreground);
    }

    .ace-activity-empty {
      font-style: italic;
      color: var(--vscode-descriptionForeground);
    }

    .ace-health-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    .ace-health-item {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: var(--vscode-sideBar-background);
    }

    .ace-health-label {
      font-size: 12px;
      text-transform: uppercase;
      color: var(--vscode-descriptionForeground);
      letter-spacing: 0.05em;
    }

    .ace-health-value {
      font-size: 16px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .ace-health-value.warning {
      color: var(--vscode-errorForeground);
    }

    .ace-health-meta {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .ace-health-meta.warning {
      color: var(--vscode-errorForeground);
    }

    .ace-health-detail {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .ace-health-detail.hidden {
      display: none;
    }

    body {
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      color: var(--vscode-foreground);
      background-color: var(--vscode-editor-background);
      overflow: hidden;
      height: 100vh;
      position: relative;
    }

    .agent-empty-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.45);
      backdrop-filter: blur(2px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .agent-empty-overlay.hidden {
      display: none;
    }

    .agent-empty-card {
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 12px;
      width: 360px;
      padding: 24px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.35);
      text-align: center;
      pointer-events: auto;
    }

    .agent-empty-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .agent-empty-desc {
      font-size: 13px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 18px;
      line-height: 1.5;
    }

    .agent-empty-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .agent-empty-button {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }

    .agent-empty-button.primary {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .agent-empty-button.secondary {
      background: none;
      color: var(--vscode-textLink-foreground);
    }

    .panel-link-button {
      border: none;
      background: none;
      color: var(--vscode-textLink-foreground);
      cursor: pointer;
      font-size: 12px;
      margin-left: 6px;
      text-decoration: underline;
      padding: 0;
    }

    /* 三栏布局容器 */
    .container {
      display: flex;
      height: 100vh;
      width: 100%;
    }

    /* 侧边栏通用样式 */
    .sidebar {
      display: flex;
      flex-direction: column;
      background-color: var(--vscode-sideBar-background);
      border-right: 1px solid var(--vscode-panel-border);
      transition: width 0.3s ease;
      overflow: hidden;
      position: relative;
    }

    .sidebar.left {
      width: 340px;
      border-right: 1px solid var(--vscode-panel-border);
    }

    .sidebar.right {
      width: 340px;
      border-left: 1px solid var(--vscode-panel-border);
      border-right: none;
    }

    /* 收起状态 */
    .sidebar.collapsed {
      width: 32px;
    }

    .sidebar.collapsed .sidebar-content {
      display: none;
    }

    /* 侧边栏收放按钮 - 固定在垂直中间 */
    .collapse-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 100;
      background-color: var(--vscode-sideBarSectionHeader-background);
      color: var(--vscode-foreground);
      border: 1px solid var(--vscode-panel-border);
      padding: 24px 8px;
      cursor: pointer;
      font-size: 16px;
      opacity: 0.7;
      transition: opacity 0.2s, background-color 0.2s;
      border-radius: 4px;
    }

    .collapse-btn:hover {
      opacity: 1;
      background-color: var(--vscode-list-hoverBackground);
    }

    /* 左侧边栏的按钮在右边缘 */
    .sidebar.left .collapse-btn {
      right: -18px;
    }

    /* 右侧边栏的按钮在左边缘 */
    .sidebar.right .collapse-btn {
      left: -18px;
    }

    /* 侧边栏内容 */
    .sidebar-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* 面板样式 */
    .panel {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 100px;
      background-color: var(--vscode-sideBar-background);
    }

    .panel.collapsed {
      flex: 0 0 28px !important;
      min-height: 28px;
      height: 28px !important;
      order: 999;
    }

    .panel.collapsed .panel-body {
      display: none;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 12px;
      background-color: var(--vscode-sideBarSectionHeader-background);
      border-bottom: 1px solid var(--vscode-panel-border);
      cursor: pointer;
      user-select: none;
    }

    .panel-header:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .panel-title {
      font-weight: 600;
      font-size: 11px;
      color: var(--vscode-sideBarTitle-foreground);
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .panel-title-text {
      /* 主标题文字 */
      font-size: 11px;
      font-weight: 600;
      color: var(--vscode-sideBarTitle-foreground);
    }

    .panel-title-badge {
      font-size: 10px;
      font-weight: 400;
      opacity: 0.7;
      background-color: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
      padding: 2px 6px;
      border-radius: 10px;
    }

    /* 面板操作按钮组 */
    .panel-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .panel-action-btn {
      background: transparent;
      color: var(--vscode-foreground);
      border: none;
      padding: 0;
      cursor: pointer;
      font-size: 16px;
      width: 22px;
      height: 22px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
      border-radius: 3px;
    }

    .panel-action-btn:hover {
      opacity: 1;

      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .panel-collapse-btn {
      background: transparent;
      color: var(--vscode-foreground);
      border: none;
      padding: 0;
      cursor: pointer;
      font-size: 12px;
      width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.7;
    }

    .panel-collapse-btn:hover {
      opacity: 1;
    }

    .task-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 16px;
    }

    .task-detail-label {
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: 0.08em;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 4px;
    }

    .task-detail-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--vscode-editor-foreground);
    }

    .task-detail-subtitle {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    .task-detail-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-end;
    }

    .task-detail-meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .task-detail-meta-item {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .task-detail-meta-item .label {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .task-detail-meta-item .value {
      font-size: 13px;
      color: var(--vscode-editor-foreground);
      word-break: break-word;
    }

    .task-detail-section {
      margin-bottom: 16px;
    }

    .task-detail-section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--vscode-descriptionForeground);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .task-detail-section-body {
      font-size: 13px;
      line-height: 1.6;
      color: var(--vscode-editor-foreground);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.02);
    }

    .task-detail-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .task-tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--vscode-panel-border);
      background: rgba(255, 255, 255, 0.02);
    }

    .task-detail-timeline {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }

    .task-detail-timeline-item {
      border-left: 3px solid var(--vscode-editorHoverWidget-border);
      padding-left: 10px;
      font-size: 12px;
    }

    .task-detail-timeline-item .label {
      display: block;
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .task-detail-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .task-detail-empty {
      color: var(--vscode-descriptionForeground);
      font-size: 12px;
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .panel-inline-hint {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
    }

    .note-status-pill {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      color: #fff;
    }

    .note-status-pill.pending {
      background: rgba(255, 193, 7, 0.8);
    }

    .note-status-pill.resolved {
      background: rgba(76, 175, 80, 0.8);
    }

    .note-action-btn,
    .note-link {
      border: none;
      background: rgba(255, 255, 255, 0.08);
      color: var(--vscode-textLink-foreground);
      cursor: pointer;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .note-action-btn:hover,
    .note-link:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .panel-link-button {
      border: none;
      background: none;
      color: var(--vscode-textLink-foreground);
      cursor: pointer;
      font-size: 11px;
      margin-left: 4px;
      text-decoration: underline;
      padding: 0;
    }

    /* 列表项样式 */
    .list-item {
      padding: 8px 12px;
      border-bottom: 1px solid var(--vscode-panel-border);
      cursor: pointer;
      transition: background-color 0.1s;
    }

    .list-item:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .list-item:last-child {
      border-bottom: none;
    }

    .file-change-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
      align-items: center;
    }

    .file-change-filter-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease, color 0.15s ease;
    }

    .file-change-filter-btn.active {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border-color: var(--vscode-button-background);
    }

    .file-change-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .file-change-filter-input {
      border: 1px solid var(--vscode-panel-border);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .file-change-view-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .file-change-view-toggle span {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .file-change-view-btn {
      border: 1px solid transparent;
      background: transparent;
      color: var(--vscode-foreground);
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .file-change-view-btn.active {
      border-color: var(--vscode-button-background);
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .file-change-view-btn:hover {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .mcp-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-textLink-foreground);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .mcp-btn:hover {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .mcp-server-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* 统一的配置卡片样式 */
    .config-card,
    .mcp-server-card,
    .agent-config-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.02);
      margin-bottom: 12px;
    }

    .config-card.disabled,
    .mcp-server-card.disabled,
    .agent-config-card.agent-disabled {
      opacity: 0.6;
    }

    .config-card-header,
    .mcp-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .config-card-title,
    .mcp-card-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .config-badge,
    .mcp-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      margin-left: 6px;
      border: 1px solid transparent;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .config-badge.enabled,
    .mcp-badge.enabled {
      color: #2e7d32;
      border-color: rgba(46, 125, 50, 0.35);
      background: rgba(46, 125, 50, 0.15);
    }

    .config-badge.disabled,
    .mcp-badge.disabled {
      color: var(--vscode-descriptionForeground);
      border-color: rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
    }

    .config-card-body,
    .mcp-card-body {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .config-card-actions,
    .mcp-card-actions,
    .global-agent-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .config-card-btn,
    .mcp-card-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-textLink-foreground);
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .config-card-btn:hover:not(:disabled),
    .mcp-card-btn:hover:not(:disabled) {
      background-color: var(--vscode-toolbar-hoverBackground);
      border-color: var(--vscode-focusBorder);
    }

    .config-card-btn:disabled,
    .mcp-card-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .config-card-btn.ghost,
    .mcp-card-btn.ghost {
      color: var(--vscode-foreground);
    }

    .config-card-btn.danger,
    .mcp-card-btn.danger {
      border-color: rgba(244, 67, 54, 0.5);
      color: #f44336;
    }

    .config-card-btn.danger:hover:not(:disabled),
    .mcp-card-btn.danger:hover:not(:disabled) {
      background: rgba(244, 67, 54, 0.1);
      border-color: #f44336;
    }

    .mcp-empty-cta {
      margin-top: 12px;
    }

    .file-change-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .file-change-actions {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }

    .file-change-action-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }

    .file-change-action-btn:hover {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .file-change-detail {
      margin-top: 8px;
      border-top: 1px solid var(--vscode-panel-border);
      padding-top: 8px;
    }

    .file-change-diff {
      font-family: var(--vscode-editor-font-family, monospace);
      font-size: 11px;
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 8px;
      overflow-x: auto;
    }

    .diff-line {
      white-space: pre-wrap;
    }

    .file-change-task-group {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px;
      background-color: rgba(255, 255, 255, 0.02);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .task-group-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .task-group-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .task-group-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .task-group-agent {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .task-group-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .task-group-more {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      border-top: 1px dashed var(--vscode-panel-border);
      padding-top: 4px;
    }

    /* 空状态 */
    .empty-state {
      padding: 24px 12px;
      text-align: center;
      color: var(--vscode-descriptionForeground);
      font-size: 12px;
    }

    /* Main Tab Navigation */
    .main-tab-nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
      background-color: var(--vscode-editor-background);
    }

    .main-tab-buttons {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .main-tab-button {
      padding: 6px 16px;
      background: none;
      border: none;
      color: var(--vscode-foreground);
      cursor: pointer;
      border-radius: 2px;
      font-size: 13px;
      font-weight: 500;
    }

    .main-tab-button:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .main-tab-button.active {
      background-color: var(--vscode-list-activeSelectionBackground);
      color: var(--vscode-list-activeSelectionForeground);
    }

    .main-tab-content {
      display: none;
      flex: 1;
      min-height: 0;
      flex-direction: column;
    }

    .main-tab-content.active {
      display: flex;
    }

    .session-tab-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .session-current-label {
      min-width: 80px;
      text-align: left;
      color: var(--vscode-foreground);
    }

    .session-select {
      min-width: 160px;
      padding: 4px 8px;
      border: 1px solid var(--vscode-input-border);
      border-radius: 4px;
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      font-size: 12px;
    }

    .session-action-btn {
      border: 1px solid var(--vscode-panel-border);
      background: var(--vscode-toolbar-inactiveForeground);
      color: var(--vscode-toolbar-hoverForeground);
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    .session-action-btn:hover {
      background: var(--vscode-toolbar-hoverBackground);
    }

    .session-action-btn.danger {
      color: var(--vscode-errorForeground);
    }

    .global-config-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 12px;
      overflow-y: auto;
    }

    .global-config-body {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 12px;
      background-color: rgba(255, 255, 255, 0.01);
    }

    .global-config-tabs {
      display: flex;
      gap: 4px;
      padding: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
      background-color: var(--vscode-editor-background);
    }

    .global-config-tab {
      padding: 6px 16px;
      background: none;
      border: none;
      color: var(--vscode-foreground);
      cursor: pointer;
      border-radius: 2px;
      font-size: 13px;
      font-weight: 500;
    }

    .global-config-tab:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .global-config-tab.active {
      background-color: var(--vscode-list-activeSelectionBackground);
      color: var(--vscode-list-activeSelectionForeground);
    }

    /* ACE 配置面板样式 */
    .ace-config-grid,
    .manager-llm-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-top: 16px;
    }

    .ace-config-grid .full-row,
    .manager-llm-grid .full-row {
      grid-column: 1 / -1;
    }

    .ace-config-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .ace-config-field label {
      font-size: 13px;
      font-weight: 500;
      color: var(--vscode-foreground);
      margin-bottom: 2px;
    }

    .ace-config-field input,
    .ace-config-field textarea,
    .ace-config-field select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 4px;
      border: 1px solid var(--vscode-input-border);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      font-size: 13px;
      transition: border-color 0.2s;
    }

    .ace-config-field input:focus,
    .ace-config-field textarea:focus,
    .ace-config-field select:focus {
      outline: none;
      border-color: var(--vscode-focusBorder);
    }

    .ace-config-field textarea {
      min-height: 80px;
      resize: vertical;
      font-family: var(--vscode-editor-font-family);
    }

    .ace-status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border);
      border-radius: 4px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--vscode-descriptionForeground);
    }

    .status-dot.connected {
      background: var(--vscode-testing-iconPassed);
      box-shadow: 0 0 4px var(--vscode-testing-iconPassed);
    }

    .status-dot.disconnected {
      background: var(--vscode-testing-iconFailed);
    }

    .status-dot.loading {
      background: var(--vscode-charts-yellow);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    .ace-config-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .ace-config-actions button {
      padding: 7px 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .ace-config-actions button:hover {
      opacity: 0.9;
    }

    .ace-config-actions .primary {
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .ace-config-actions .primary:hover {
      background: var(--vscode-button-hoverBackground);
    }

    .ace-config-actions .ghost {
      background: transparent;
      border: 1px solid var(--vscode-button-border, var(--vscode-panel-border));
      color: var(--vscode-button-foreground);
    }

    .ace-config-actions .ghost:hover {
      background: var(--vscode-button-secondaryHoverBackground);
    }

    .form-hint {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      line-height: 1.4;
    }

    .ace-status-banner {
      padding: 10px 14px;
      border-radius: 4px;
      border: 1px solid var(--vscode-panel-border);
      background: var(--vscode-input-background);
      font-size: 13px;
      margin-bottom: 16px;
    }

    .ace-status-banner.success {
      border-color: var(--vscode-testing-iconPassed);
      background: color-mix(in srgb, var(--vscode-testing-iconPassed) 10%, transparent);
      color: var(--vscode-testing-iconPassed);
    }

    .ace-status-banner.error {
      border-color: var(--vscode-testing-iconFailed);
      background: color-mix(in srgb, var(--vscode-testing-iconFailed) 10%, transparent);
      color: var(--vscode-testing-iconFailed);
    }

    .ace-status-banner.info {
      border-color: var(--vscode-charts-blue);
      background: color-mix(in srgb, var(--vscode-charts-blue) 10%, transparent);
      color: var(--vscode-charts-blue);
    }

    /* 搜索测试面板 */
    .ace-search-panel {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--vscode-panel-border);
    }

    .ace-search-header {
      margin-bottom: 12px;
    }

    .ace-search-header h3 {
      font-size: 14px;
      font-weight: 600;
      margin: 0 0 4px 0;
      color: var(--vscode-foreground);
    }

    .ace-search-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .ace-search-controls input {
      flex: 1;
      padding: 8px 10px;
      border-radius: 4px;
      border: 1px solid var(--vscode-input-border);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      font-size: 13px;
    }

    .ace-search-controls input:focus {
      outline: none;
      border-color: var(--vscode-focusBorder);
    }

    .ace-search-controls button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      transition: background 0.2s;
    }

    .ace-search-controls button:hover {
      background: var(--vscode-button-hoverBackground);
    }

    .ace-search-output {
      min-height: 200px;
      max-height: 400px;
      padding: 12px;
      border-radius: 4px;
      border: 1px solid var(--vscode-panel-border);
      background: var(--vscode-editor-background);
      font-family: var(--vscode-editor-font-family);
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      overflow-y: auto;
      color: var(--vscode-editor-foreground);
    }

    .ace-search-output:empty::before {
      content: '尚未执行搜索';
      color: var(--vscode-descriptionForeground);
      font-style: italic;
    }

    .global-section {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 12px 14px;
      background-color: rgba(255, 255, 255, 0.02);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .global-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .global-section-title {
      font-size: 14px;
      font-weight: 600;
    }

    .global-section-desc {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    .global-section-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .global-section-body {
      display: flex;
      flex-direction: column;
    }

    .global-tab-content {
      display: none;
    }

    .global-tab-content.active {
      display: block;
    }

    /* Agent 配置卡片 */
    .global-agent-list {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .agent-config-card .agent-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .agent-config-card .agent-card-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .global-agent-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .global-agent-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .agent-status-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .agent-status-badge.agent-status-online {
      color: #2e7d32;
      border-color: rgba(46, 125, 50, 0.35);
      background: rgba(46, 125, 50, 0.15);
    }

    .agent-status-badge.agent-status-busy {
      color: #ef6c00;
      border-color: rgba(239, 108, 0, 0.35);
      background: rgba(239, 108, 0, 0.15);
    }

    .agent-status-badge.agent-status-offline {
      color: #c62828;
      border-color: rgba(198, 40, 40, 0.35);
      background: rgba(198, 40, 40, 0.15);
    }

    .agent-status-badge.agent-status-disabled {
      color: var(--vscode-descriptionForeground);
      border-color: rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
    }

    .agent-config-card .agent-card-body {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px 16px;
      font-size: 12px;
      color: var(--vscode-foreground);
      margin-bottom: 10px;
    }

    .agent-config-card .agent-card-section {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .agent-config-card .agent-card-section-title {
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
    }

    .global-config-notice button {
      margin-top: 8px;
      padding: 4px 12px;
      font-size: 12px;
    }

    .mcp-tool-item {
      font-size: 12px;
      color: var(--vscode-foreground);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chip-group {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .chip {
      border: 1px solid var(--vscode-panel-border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--vscode-foreground);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .chip:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .tag-chip {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid var(--vscode-panel-border);
      color: var(--vscode-foreground);
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .tag-chip button {
      background: none;
      border: none;
      color: var(--vscode-descriptionForeground);
      cursor: pointer;
      font-size: 11px;
      padding: 0;
    }

    /* Sub-tab Navigation (for Blackboard) */
    .sub-tab-nav {
      display: flex;
      gap: 4px;
      padding: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .sub-tab-button {
      padding: 4px 12px;
      background: none;
      border: none;
      color: var(--vscode-foreground);
      cursor: pointer;
      border-radius: 2px;
      font-size: 12px;
    }

    .sub-tab-button:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .sub-tab-button.active {
      background-color: var(--vscode-list-activeSelectionBackground);
      color: var(--vscode-list-activeSelectionForeground);
    }

    .manager-status-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
      padding: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
      background: var(--vscode-sideBar-background);
    }

    .manager-status-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.02);
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 56px;
    }

    .manager-stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
    }

    .manager-status-card.stacked {
      min-height: 90px;
      flex: 0 0 90px;
    }

    .manager-status-card h4 {
      margin: 0;
      font-size: 12px;
      font-weight: 600;
      color: var(--vscode-descriptionForeground);
      letter-spacing: 0.05em;
    }

    .manager-status-value {
      font-size: 14px;
      font-weight: 600;
      color: var(--vscode-foreground);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .manager-status-meta {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .manager-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--vscode-descriptionForeground);
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.2);
    }

    .manager-status-dot.online {
      background: var(--vscode-testing-iconPassed);
      box-shadow: 0 0 6px var(--vscode-testing-iconPassed);
    }

    .manager-status-dot.offline {
      background: var(--vscode-testing-iconFailed);
      box-shadow: 0 0 6px var(--vscode-testing-iconFailed);
    }

    .manager-status-dot.processing {
      background: var(--vscode-editorWarning-foreground);
      box-shadow: 0 0 6px var(--vscode-editorWarning-foreground);
    }

    .sub-tab-content {
      display: none;
      flex: 1;
      min-height: 0;
    }

    .sub-tab-content.active {
      display: flex;
      flex-direction: column;
    }

    .message-role-badge {
      display: inline-flex;
      align-items: center;
      padding: 0 8px;
      border-radius: 999px;
      font-size: 10px;
      margin-left: 6px;
      border: 1px solid var(--vscode-panel-border);
      color: var(--vscode-foreground);
      background: rgba(255, 255, 255, 0.08);
    }

    .message-role-badge.persona-lead {
      border-color: #4fc3f7;
      color: #4fc3f7;
    }

    .message-role-badge.persona-reviewer {
      border-color: #ba68c8;
      color: #ba68c8;
    }

    .message-role-badge.persona-executor {
      border-color: #81c784;
      color: #81c784;
    }

    .message-role-badge.persona-moderator {
      border-color: #ffb74d;
      color: #ffb74d;
    }

    .message-role-badge.persona-user {
      border-color: var(--vscode-descriptionForeground);
      color: var(--vscode-descriptionForeground);
    }

    .message-direct-badge {
      border: 1px solid #ff922b;
      color: #ff922b;
      background: rgba(255, 146, 43, 0.15);
      border-radius: 999px;
      font-size: 10px;
      padding: 0 6px;
      margin-left: 6px;
      cursor: pointer;
    }

    .message-reference-cards {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }

    .message-reference-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 8px 10px;
      font-size: 12px;
      background: var(--vscode-sideBar-background);
      transition: background 0.2s;
    }

    .message-reference-card:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .message-reference-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .message-reference-card-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--vscode-foreground);
    }

    .message-reference-card-content {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      line-height: 1.4;
    }

    .message-reference-card button {
      border: none;
      background: none;
      color: var(--vscode-textLink-foreground);
      cursor: pointer;
      font-size: 11px;
      padding: 0;
    }

    /* Message Styles */
    .message-item {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 0 8px;
    }

    /* User message (right-aligned) */
    .message-item.user-message {
      flex-direction: row-reverse;
    }

    .message-item.user-message .message-content {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .message-item.user-message .message-header {
      flex-direction: row-reverse;
    }

    .message-item.user-message .message-bubble {
      background-color: rgba(0, 122, 204, 0.15);
      border: 1px solid rgba(0, 122, 204, 0.3);
    }

    .message-item.user-message .message-text {
      color: var(--vscode-foreground);
    }

    .message-item.user-message .message-quoted {
      background-color: rgba(0, 0, 0, 0.15);
      border-left-color: rgba(0, 122, 204, 0.6);
    }

    .message-item.user-message .message-quoted-author {
      color: rgba(0, 122, 204, 1);
    }

    .message-item.user-message .message-quoted-content {
      color: var(--vscode-descriptionForeground);
      opacity: 0.9;
    }

    .message-item.user-message .message-actions {
      justify-content: flex-end;
    }

    .message-avatar {
      flex-shrink: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      font-weight: 600;
    }

    .message-content {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .message-author {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .message-typing {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .message-time {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .message-bubble {
      background-color: var(--vscode-editor-inactiveSelectionBackground);
      border-radius: 8px;
      padding: 10px 12px;
      max-width: 70%;
      width: fit-content;
      border: 1px solid transparent;
    }

    /* Agent color-coded message bubbles */
    /* 回复样式 */
    .message-reply {
      border-left: 3px solid rgba(76, 175, 80, 0.8);
      background-color: rgba(76, 175, 80, 0.1);
      padding: 6px 8px;
      margin-bottom: 8px;
      font-size: 12px;
      border-radius: 4px;
    }

    .message-reply-author {
      font-weight: 600;
      color: rgba(76, 175, 80, 1);
      margin-bottom: 2px;
    }

    .message-reply-content {
      color: var(--vscode-foreground);
      opacity: 0.85;
    }

    /* 引用样式 */
    .message-quoted {
      border-left: 3px solid rgba(33, 150, 243, 0.8);
      background-color: rgba(33, 150, 243, 0.1);
      padding: 6px 8px;
      margin-bottom: 8px;
      font-size: 12px;
      border-radius: 4px;
    }

    .message-quoted-author {
      font-weight: 600;
      color: rgba(33, 150, 243, 1);
      margin-bottom: 2px;
    }

    .message-quoted-content {
      color: var(--vscode-foreground);
      opacity: 0.85;
    }

    .message-text {
      font-size: 13px;
      line-height: 1.5;
      color: var(--vscode-foreground);
      word-wrap: break-word;
    }

    .message-actions {
      display: flex;
      gap: 12px;
      margin-top: 6px;
    }

    .message-action-btn {
      font-size: 11px;
      color: var(--vscode-textLink-foreground);
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
    }

    .message-action-btn:hover {
      text-decoration: underline;
    }

    /* 输入框上方的回复/引用指示器 */
    .reply-indicator {
      border-radius: 4px;
      padding: 8px 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 3px solid;
    }

    .reply-indicator.is-reply {
      background-color: rgba(76, 175, 80, 0.15);
      border-left-color: rgba(76, 175, 80, 0.8);
    }

    .reply-indicator.is-quote {
      background-color: rgba(33, 150, 243, 0.15);
      border-left-color: rgba(33, 150, 243, 0.8);
    }

    .reply-indicator-text {
      font-size: 12px;
      font-weight: 500;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .reply-indicator.is-reply .reply-indicator-text {
      color: rgba(76, 175, 80, 1);
    }

    .reply-indicator.is-quote .reply-indicator-text {
      color: rgba(33, 150, 243, 1);
    }

    .reply-indicator-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 8px;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .reply-indicator-close:hover {
      opacity: 1;
    }

    .reply-indicator.is-reply .reply-indicator-close {
      color: rgba(76, 175, 80, 1);
    }

    .reply-indicator.is-quote .reply-indicator-close {
      color: rgba(33, 150, 243, 1);
    }

    /* Agent Card Styles */
    .agent-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      background-color: var(--vscode-editor-background);
      transition: background-color 0.15s;
      cursor: pointer;
      position: relative;
    }

    .agent-card:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .agent-card.selected {
      background-color: var(--vscode-list-activeSelectionBackground);
      border-color: var(--vscode-focusBorder);
    }

    .agent-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .agent-card-name {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .agent-card:hover .agent-card-actions {
      display: flex;
    }

    .agent-action-btn:hover {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .agent-action-btn svg {
      width: 14px;
      height: 14px;
    }

    .agent-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .agent-status-dot.agent-status-online {
      background-color: #4caf50;
    }

    .agent-status-dot.agent-status-offline {
      background-color: var(--vscode-descriptionForeground);
    }

    .agent-status-dot.agent-status-busy {
      background-color: #ff9800;
    }

    .agent-name-text {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .agent-card-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .agent-heartbeat {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .agent-role-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    /* Badge Styles */
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 500;
      line-height: 1.2;
      white-space: nowrap;
    }

    .badge-default {
      background-color: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
    }

    .badge-info {
      background-color: rgba(33, 150, 243, 0.2);
      color: #2196f3;
    }

    .badge-warning {
      background-color: rgba(255, 152, 0, 0.2);
      color: #ff9800;
    }

    .badge-success {
      background-color: var(--vscode-testing-iconPassed);
      color: var(--vscode-editor-background);
    }

    .badge-error {
      background-color: rgba(244, 67, 54, 0.2);
      color: #f44336;
    }

    /* Task Item Styles */
    .task-item {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      background-color: var(--vscode-editor-background);
      transition: background-color 0.15s;
      cursor: pointer;
    }

    .task-progress-summary {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 8px;
    }

    .task-progress-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px 10px;
      background: rgba(255, 255, 255, 0.02);
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .task-progress-card.active {
      border-color: var(--vscode-focusBorder);
      box-shadow: 0 0 0 1px var(--vscode-focusBorder);
    }

    .task-progress-card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .task-progress-card-title {
      color: var(--vscode-foreground);
    }

    .task-group-grid {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }

    .task-group-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.01);
    }

    .task-group-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .task-group-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .task-group-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 2px;
    }

    .task-group-meter {
      margin: 8px 0;
      height: 6px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.05);
      overflow: hidden;
    }

    .task-group-meter span {
      display: block;
      height: 100%;
      background: var(--vscode-focusBorder);
    }

    .task-group-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .task-row {
      padding: 8px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
    }

    .task-row:first-child {
      border-top: none;
    }

    .task-row-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
    }

    .task-row-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--vscode-foreground);
    }

    .task-row-status {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--vscode-descriptionForeground);
    }

    .task-row-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    .task-row-automation {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(92, 124, 250, 0.12);
      color: #5c7cfa;
      font-size: 10px;
      font-weight: 600;
    }

    .task-progress-count {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .task-progress-meter {
      position: relative;
      height: 4px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      overflow: hidden;
    }

    .task-progress-meter span {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      background: var(--vscode-progressBar-background, #0e639c);
    }

    .task-progress-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .task-progress-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 11px;
    }

    .task-progress-actions button {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      border-radius: 4px;
      padding: 2px 8px;
      cursor: pointer;
      font-size: 11px;
    }

    .task-progress-actions button.ghost {
      color: var(--vscode-descriptionForeground);
    }

    .task-item:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .task-item.file-change-highlight {
      border-color: var(--vscode-focusBorder);
      box-shadow: 0 0 0 1px var(--vscode-focusBorder);
    }

    @keyframes flash-border {
      0% {
        box-shadow: 0 0 0 1px transparent;
      }

      50% {
        box-shadow: 0 0 0 1px var(--vscode-focusBorder);
      }

      100% {
        box-shadow: 0 0 0 1px transparent;
      }
    }

    .task-item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 8px;
    }

    .task-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--vscode-foreground);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .task-body {
      margin-top: 8px;
    }

    .task-sub-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }

    .task-inline-action {
      margin-left: auto;
      white-space: nowrap;
      padding: 2px 6px;
      font-size: 12px;
    }

    .task-description {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      line-height: 1.5;
      margin-bottom: 8px;
    }

    /* Task Badge Styles */
    .task-badge {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      line-height: 1.2;
      border: 1px solid transparent;
      white-space: nowrap;
    }

    /* Status Badges */
    .task-badge-status {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .task-badge-status.status-running {
      color: #2196f3;
      background-color: rgba(33, 150, 243, 0.15);
      border-color: rgba(33, 150, 243, 0.3);
    }

    .task-badge-status.status-pending {
      color: #ff9800;
      background-color: rgba(255, 152, 0, 0.15);
      border-color: rgba(255, 152, 0, 0.3);
    }

    .task-badge-status.status-paused {
      color: #9e9e9e;
      background-color: rgba(158, 158, 158, 0.15);
      border-color: rgba(158, 158, 158, 0.3);
    }

    .task-badge-status.status-completed {
      color: #4caf50;
      background-color: rgba(76, 175, 80, 0.15);
      border-color: rgba(76, 175, 80, 0.3);
    }

    .task-badge-status.status-failed {
      color: #f44336;
      background-color: rgba(244, 67, 54, 0.15);
      border-color: rgba(244, 67, 54, 0.3);
    }

    .task-badge-status.status-approved {
      color: #4caf50;
      background-color: rgba(76, 175, 80, 0.15);
      border-color: rgba(76, 175, 80, 0.3);
    }

    .task-badge-status.status-rejected {
      color: #d32f2f;
      background-color: rgba(211, 47, 47, 0.15);
      border-color: rgba(211, 47, 47, 0.35);
    }

    .task-badge-status.status-timeout {
      color: #ff9800;
      background-color: rgba(255, 152, 0, 0.15);
      border-color: rgba(255, 152, 0, 0.35);
    }

    .task-badge-status.status-cancelled {
      color: #9e9e9e;
      background-color: rgba(158, 158, 158, 0.12);
      border-color: rgba(158, 158, 158, 0.25);
    }

    /* Assignee Badge */
    .task-badge-assignee.unassigned {
      color: var(--vscode-descriptionForeground);
      background-color: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }

    /* Priority Badges */
    .task-badge-priority.priority-critical {
      color: #d32f2f;
      background-color: rgba(211, 47, 47, 0.15);
      border-color: rgba(211, 47, 47, 0.35);
    }

    .task-badge-priority.priority-high {
      color: #f57c00;
      background-color: rgba(245, 124, 0, 0.15);
      border-color: rgba(245, 124, 0, 0.3);
    }

    .task-badge-priority.priority-medium {
      color: #fbc02d;
      background-color: rgba(251, 192, 45, 0.15);
      border-color: rgba(251, 192, 45, 0.3);
    }

    .task-badge-priority.priority-low {
      color: #7cb342;
      background-color: rgba(124, 179, 66, 0.15);
      border-color: rgba(124, 179, 66, 0.3);
    }

    .task-badge-priority.priority-none {
      color: var(--vscode-descriptionForeground);
      background-color: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .task-action-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-textLink-foreground);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }

    .task-action-btn:hover {
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .gov-summary-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      width: 100%;
    }

    .quick-action-btn {
      border: 1px solid var(--vscode-panel-border);
      background-color: rgba(255, 255, 255, 0.04);
      color: var(--vscode-foreground);
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.15s ease, border-color 0.15s ease;
    }

    .quick-action-btn:hover {
      background-color: rgba(255, 255, 255, 0.08);
      border-color: var(--vscode-focusBorder);
    }

    .quick-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .summary-tile {
      flex: 1;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background-color: var(--vscode-sideBar-background);
      transition: border-color 0.15s;
    }

    .summary-tile[data-action] {
      cursor: pointer;
    }

    .summary-tile:hover {
      border-color: var(--vscode-focusBorder);
    }

    .summary-tile-title {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .summary-tile-value {
      font-size: 20px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .summary-tile-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .gov-polling-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 10px;
      background-color: var(--vscode-sideBar-background);
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: border-color 0.15s;
    }

    .gov-polling-card.active {
      border-color: var(--vscode-focusBorder);
    }

    .gov-polling-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .polling-meta-item {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .polling-meta-label {
      color: var(--vscode-descriptionForeground);
    }

    .polling-meta-value {
      color: var(--vscode-foreground);
      font-weight: 500;
    }

    .panel.collapsed {
      flex: 0 !important;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .panel.collapsed .panel-body {
      display: none;
    }

    .panel.collapsed .panel-collapse-btn {
      transform: none;
    }

    .form-group.inline {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .checkbox-group .checkbox {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--vscode-foreground);
    }

    .checkbox-group input[type="checkbox"] {
      margin: 0;
    }

    .input-with-suffix .suffix {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .analytics-type-btn.active {
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border-color: var(--vscode-button-background);
    }

    .analytics-status.error {
      color: var(--vscode-inputValidation-errorBorder);
    }

    .analytics-summary-title {
      font-size: 13px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
    }

    .analytics-summary-value {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .analytics-summary-detail {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 4px;
    }

    .analytics-summary-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .analytics-bar-item {
      flex: 1;
      text-align: center;
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
    }

    .analytics-bar {
      height: 100px;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      gap: 4px;
      padding: 2px;
      background: rgba(255, 255, 255, 0.03);
      margin-bottom: 4px;
    }

    .analytics-bar-segment {
      width: 10px;
      border-radius: 2px;
      display: inline-block;
    }



    .analytics-hotspot-item {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .workspace-container {
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 12px;
    }

    .workspace-panel {
      display: flex;
      flex-direction: column;
      height: 100%;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      border: 1px solid var(--vscode-panel-border);
      padding: 12px;
      gap: 12px;
      overflow: hidden;
    }

    .workspace-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .workspace-status-strip {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .workspace-status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--vscode-descriptionForeground);
      box-shadow: 0 0 0 1px var(--vscode-panel-border);
    }

    .workspace-status-dot.online {
      background: var(--vscode-testing-iconPassed);
      box-shadow: 0 0 6px var(--vscode-testing-iconPassed);
    }

    .workspace-status-dot.busy {
      background: var(--vscode-testing-iconQueued);
      box-shadow: 0 0 6px var(--vscode-testing-iconQueued);
    }

    .workspace-status-dot.offline {
      background: var(--vscode-errorForeground);
    }

    .workspace-agent-meta {
      display: flex;
      flex-direction: column;
    }

    .workspace-agent-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .workspace-agent-name .workspace-agent-id {
      margin-left: 8px;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      font-weight: 400;
    }

    .workspace-agent-subtitle {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-top: 2px;
    }

    .workspace-header-meta {
      display: flex;
      gap: 12px;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      align-items: center;
    }

    .workspace-header-actions {
      display: flex;
      gap: 8px;
    }

    .workspace-header-actions button {
      padding: 6px 12px;
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    .workspace-empty {
      padding: 24px;
      color: var(--vscode-descriptionForeground);
      text-align: center;
    }

    .workspace-panel.hidden {
      display: none;
    }

    .workspace-timeline {
      flex: 1;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      background: var(--vscode-sideBar-background);
      padding: 10px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 260px;
    }

    .workspace-timeline-item {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px;
      background: var(--vscode-editor-background);
    }

    .workspace-timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      margin-bottom: 4px;
      gap: 8px;
    }

    .workspace-timeline-meta {
      display: flex;
      gap: 6px;
      align-items: center;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .workspace-timeline-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 10px;
      font-size: 11px;
      border: 1px solid var(--vscode-panel-border);
    }

    .badge-system {
      background: var(--vscode-sideBarSectionHeader-background);
    }

    .badge-tool {
      background: rgba(90, 196, 255, 0.08);
      color: var(--vscode-textLink-foreground);
    }

    .badge-thinking {
      background: rgba(255, 215, 128, 0.1);
    }

    .badge-external {
      background: rgba(255, 128, 171, 0.08);
    }

    .badge-ace {
      background: rgba(128, 235, 255, 0.08);
    }

    .workspace-timeline-body {
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      color: var(--vscode-foreground);
    }

    .workspace-input {
      position: relative;
      display: flex;
      flex-direction: column;
    }

    .workspace-input textarea {
      flex: 1;
      min-height: 120px;
      max-height: 220px;
      resize: vertical;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--vscode-panel-border);
      background: var(--vscode-editor-background);
      color: var(--vscode-foreground);
      font-size: 13px;
      line-height: 1.5;
      overflow: auto;
    }

    .workspace-input button {
      position: absolute;
      right: 8px;
      bottom: 8px;
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      cursor: pointer;
      font-size: 12px;
    }

    .workspace-empty-hint {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }


    .workspace-external-header small {
      font-weight: 400;
      color: var(--vscode-descriptionForeground);
      font-size: 11px;
    }

    .workspace-external-stack {
      margin-top: 16px;
      color: var(--vscode-descriptionForeground);
    }

    .workspace-external-stack summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--vscode-foreground);
      margin-bottom: 8px;
    }

    .workspace-external-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .workspace-external-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .workspace-external-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 4px;
    }

    .workspace-external-meta .author {
      font-weight: 600;
      color: var(--vscode-foreground);
    }

    .workspace-external-body {
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .workspace-key-value {
      display: grid;
      grid-template-columns: 120px 1fr;
      gap: 6px 12px;
      font-size: 12px;
    }

    .workspace-key-value span:first-child {
      color: var(--vscode-descriptionForeground);
    }

    .workspace-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .workspace-table th,
    .workspace-table td {
      padding: 6px 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
      text-align: left;
    }

    .workspace-table th {
      color: var(--vscode-descriptionForeground);
      font-weight: 500;
    }

    .workspace-table tr:last-child td {
      border-bottom: none;
    }

    .thinking-log-entry {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .thinking-log-entry.collapsed .thinking-log-body {
      display: none;
    }

    .thinking-log-entry.type-file_change {
      border-left: 3px solid #4fc3f7;
    }

    .thinking-log-entry.type-user_feedback {
      border-left: 3px solid #80cbc4;
    }

    .thinking-log-entry:not(.collapsed) .thinking-log-toggle-icon {
      color: var(--vscode-foreground);
    }

    .thinking-log-task.active {
      color: var(--vscode-focusBorder);
    }

    .thinking-chat-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .thinking-chat-entry {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 10px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .thinking-chat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
    }

    .thinking-chat-bubble {
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .thinking-chat-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 6px;
    }

    .thinking-chat-note {
      padding: 2px 6px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
    }

    .workspace-thinking-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }

    .thinking-chip-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .thinking-chip-label {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-right: 4px;
    }

    .thinking-chip {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
      transition: background-color 0.15s ease, border-color 0.15s ease, color 0.15s ease;
    }

    .thinking-chip:hover:not(:disabled) {
      border-color: var(--vscode-button-background);
    }

    .thinking-chip.active {
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border-color: var(--vscode-button-background);
    }

    .thinking-chip:disabled {
      opacity: 0.45;
      cursor: not-allowed;
    }

    .thinking-chip.ghost {
      border-style: dashed;
      color: var(--vscode-descriptionForeground);
    }

    .workspace-thinking-searchbox {
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 4px 8px;
      background: var(--vscode-input-background);
      flex: 1;
      min-width: 160px;
    }

    .workspace-thinking-searchbox input {
      background: transparent;
      border: none;
      outline: none;
      color: var(--vscode-input-foreground);
      width: 100%;
      font-size: 12px;
    }

    .workspace-thinking-searchbox input::placeholder {
      color: var(--vscode-descriptionForeground);
    }

    .workspace-thinking-search-icon {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .workspace-thinking-summary {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
    }

    .workspace-thinking-summary strong {
      color: var(--vscode-foreground);
    }

    .workspace-thinking-stream {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 12px;
      background: rgba(255, 255, 255, 0.02);
    }

    .workspace-thinking-stream-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 6px;
    }

    .workspace-thinking-stream-content {
      font-size: 12px;
      line-height: 1.5;
      color: var(--vscode-foreground);
      max-height: 160px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: var(--vscode-editor-font-family, monospace);
    }

    .workspace-thinking-stream .spinner {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid var(--vscode-descriptionForeground);
      border-top-color: transparent;
      animation: stream-rotate 0.8s linear infinite;
    }

    @keyframes stream-rotate {
      from {
        transform: rotate(0deg);
      }

      to {
        transform: rotate(360deg);
      }
    }

    .hotspot-rank {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: rgba(255, 255, 255, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
    }

    .hotspot-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .analytics-recent-item {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 8px;
    }

    .analytics-recent-title {
      font-size: 13px;
      font-weight: 500;
    }

    .analytics-recent-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .gov-history-item {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 8px;
      padding: 10px 12px;
      background-color: rgba(255, 255, 255, 0.02);
      cursor: pointer;
      transition: border-color 0.15s ease, background-color 0.15s ease;
    }

    .gov-history-item:hover {
      border-color: var(--vscode-focusBorder);
      background-color: rgba(255, 255, 255, 0.05);
    }

    .gov-history-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-bottom: 4px;
      gap: 8px;
    }

    .gov-history-type {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }



    .gov-history-summary {
      font-size: 13px;
      font-weight: 500;
      color: var(--vscode-foreground);
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .gov-history-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .gov-history-payload {
      margin-top: 6px;
      padding: 6px;
      border-radius: 4px;
      font-size: 11px;
      background-color: rgba(255, 255, 255, 0.03);
      color: var(--vscode-descriptionForeground);
      border: 1px dashed var(--vscode-panel-border);
      white-space: pre-wrap;
      word-break: break-all;
    }

    /* 消息过滤按钮 */
    .message-filter-btn:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .message-filter-btn.active {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border-color: var(--vscode-button-background);
      font-weight: 600;
    }

    /* 消息列表项 */
    .message-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--vscode-panel-border);
      cursor: pointer;
      transition: background-color 0.15s ease;
      background-color: transparent;
    }

    .message-item:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .message-item:last-child {
      border-bottom: none;
    }

    .message-item-type.request {
      background-color: #0066cc;
      color: #ffffff;
    }

    .message-item-type.response {
      background-color: #008000;
      color: #ffffff;
    }

    .message-item-type.notification {
      background-color: #ff9900;
      color: #000000;
    }

    .message-item-type.message {
      background-color: #666666;
      color: #ffffff;
    }

    /* 消息输入框 */
    #message-input {
      padding: 10px;
      background-color: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border);
      border-radius: 3px;
      font-family: var(--vscode-font-family);
      font-size: 12px;
      resize: none;
      height: 60px;
      transition: all 0.15s ease;
      outline: none;
    }

    #message-input:focus {
      border-color: var(--vscode-focusBorder);
      box-shadow: 0 0 0 1px var(--vscode-focusBorder);
    }

    /* 模态弹窗 */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .modal-overlay.show {
      display: flex;
      opacity: 1;
    }

    .modal-container {
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      width: 700px;
      max-width: 90%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      transform: scale(0.9);
      transition: transform 0.2s ease;
    }

    .modal-overlay.show .modal-container {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--vscode-foreground);
      margin: 0;
    }

    .modal-close-btn {
      background: transparent;
      color: var(--vscode-foreground);
      border: none;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 20px;
      opacity: 0.7;
      line-height: 1;
    }

    .modal-close-btn:hover {
      opacity: 1;
      background-color: var(--vscode-toolbar-hoverBackground);
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .modal-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      padding: 16px 20px;
      border-top: 1px solid var(--vscode-panel-border);
    }

    /* 表单样式 */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      color: var(--vscode-foreground);
      margin-bottom: 6px;
    }

    .form-label.required::after {
      content: ' *';
      color: var(--vscode-errorForeground);
    }

    .form-input,
    .form-textarea,
    .form-select {
      width: 100%;
      padding: 6px 8px;
      font-size: 13px;
      color: var(--vscode-input-foreground);
      background-color: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border);
      border-radius: 2px;
      outline: none;
      font-family: var(--vscode-font-family);
    }

    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      border-color: var(--vscode-focusBorder);
    }

    .form-textarea {
      resize: vertical;
      min-height: 60px;
    }

    .form-hint {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    /* 按钮样式 */
    .btn {
      padding: 6px 14px;
      font-size: 13px;
      border: none;
      border-radius: 2px;
      cursor: pointer;
      transition: background-color 0.1s;
    }

    .btn-primary {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .btn-primary:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    .btn-secondary {
      background-color: var(--vscode-button-secondaryBackground);
      color: var(--vscode-button-secondaryForeground);
    }

    .btn-secondary:hover {
      background-color: var(--vscode-button-secondaryHoverBackground);
    }

    .btn-danger {
      background-color: rgba(244, 67, 54, 0.18);
      color: #f44336;
    }

    .btn-danger:hover {
      background-color: rgba(244, 67, 54, 0.3);
    }

    .link-button {
      background: none;
      border: none;
      color: var(--vscode-textLink-foreground);
      font-size: 11px;
      cursor: pointer;
      padding: 0;
    }

    /* 任务卡片样式 */
    .task-card {
      padding: 12px;
      margin-bottom: 8px;
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .task-card:hover {
      background-color: var(--vscode-list-hoverBackground);
      border-color: var(--vscode-focusBorder);
    }

    .task-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .task-state {
      display: inline-block;
      padding: 2px 6px;
      background-color: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
      border-radius: 2px;
      font-weight: 600;
    }

    .task-time {
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
    }

    .task-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .task-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .task-sub {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .task-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    /* 协助卡片样式 */
    .assist-card {
      padding: 12px;
      margin-bottom: 8px;
      background-color: var(--vscode-editor-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .assist-card:hover {
      background-color: var(--vscode-list-hoverBackground);
      border-color: var(--vscode-focusBorder);
    }

    .assist-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .assist-state {
      display: inline-block;
      padding: 2px 6px;
      background-color: var(--vscode-badge-background);
      color: var(--vscode-badge-foreground);
      border-radius: 2px;
      font-weight: 600;
    }

    .assist-time {
      font-size: 10px;
      color: var(--vscode-descriptionForeground);
    }

    .assist-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .assist-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .assist-sub {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
    }

    .assist-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    /* Badge 样式 */
    .link-button:hover {
      text-decoration: underline;
    }

    .detail-section {
      margin-bottom: 12px;
    }

    .detail-section-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--vscode-foreground);
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
    }

    .detail-label {
      color: var(--vscode-descriptionForeground);
    }

    .detail-value {
      color: var(--vscode-foreground);
      text-align: right;
    }

    .detail-list {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 6px;
      max-height: 220px;
      overflow-y: auto;
    }

    .detail-list-item {
      padding: 6px 4px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    .detail-list-item:last-child {
      border-bottom: none;
    }

    .detail-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 2px;
    }

    /* 标签云样式 */
    .tag-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      line-height: 1.5;
    }

    .tag-chip {
      padding: 6px 14px;
      border: 1px solid var(--vscode-input-border);
      border-radius: 3px;
      background: var(--vscode-input-background);
      color: var(--vscode-foreground);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 13px;
      user-select: none;
      white-space: nowrap;
      flex-shrink: 0;
    }

    .tag-chip:hover {
      border-color: var(--vscode-focusBorder);
      box-shadow: 0 0 0 1px var(--vscode-focusBorder);
    }

    .tag-chip.selected {
      background: var(--vscode-button-background);
      border-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      font-weight: 500;
    }

    .tag-chip.selected:hover {
      background: var(--vscode-button-hoverBackground);
      border-color: var(--vscode-button-hoverBackground);
    }

    .tag-chip.role {
      min-width: 80px;
      text-align: center;
    }

    .tag-chip.capability {
      min-width: 60px;
      text-align: center;
      font-size: 12px;
    }

    .tag-chip.tool {
      min-width: 90px;
      border-color: #f6a640;
      color: #8a4b01;
    }

    .tag-chip.tool.selected {
      background: #f6a640;
      border-color: #f6a640;
      color: #1a1a1a;
    }

    .card-footer-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 6px;
    }

    /* 面板分割线 */
    .panel-resizer {
      height: 4px;
      background-color: var(--vscode-panel-border);
      cursor: ns-resize;
      flex-shrink: 0;
      position: relative;
      order: 0;
    }

    .panel-resizer:hover {
      background-color: var(--vscode-focusBorder);
    }

    .panel-resizer.dragging {
      background-color: var(--vscode-focusBorder);
    }

    /* 隐藏折叠面板后面的分割线 */
    .panel.collapsed+.panel-resizer {
      display: none;
    }

    /* 输入区域调整手柄 */
    .input-resize-handle {
      height: 4px;
      background-color: var(--vscode-panel-border);
      cursor: ns-resize;
      flex-shrink: 0;
      position: relative;
    }

    .input-resize-handle:hover {
      background-color: var(--vscode-focusBorder);
    }

    .input-resize-handle.dragging {
      background-color: var(--vscode-focusBorder);
    }

    .message-input-area {
      padding: 8px;
      border-top: 1px solid var(--vscode-panel-border);
      min-height: 140px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: var(--vscode-editor-background);
      position: relative;
    }

    .mention-suggestion-list {
      position: absolute;
      bottom: 110px;
      right: 16px;
      width: 280px;
      background: var(--vscode-sideBar-background);
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.45);
      max-height: 220px;
      overflow-y: auto;
      display: none;
      z-index: 25;
    }

    .mention-suggestion-header {
      font-size: 11px;
      padding: 6px 10px;
      color: var(--vscode-descriptionForeground);
      border-bottom: 1px solid var(--vscode-panel-border);
      background: rgba(255, 255, 255, 0.02);
    }

    .mention-suggestion-item {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 12px;
      background: transparent;
      color: var(--vscode-foreground);
      border: none;
      text-align: left;
    }

    .mention-suggestion-item strong {
      font-size: 12px;
      margin-bottom: 2px;
    }

    .mention-suggestion-item:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .mention-suggestion-role {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
    }

    .message-textarea-wrapper {
      position: relative;
      min-height: 100px;
      max-height: 360px;
      height: 140px;
    }

    #message-input {
      width: 100%;
      height: 100%;
      padding: 6px 48px 6px 8px;
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border);
      border-radius: 2px;
      resize: none;
      font-family: var(--vscode-font-family);
      font-size: var(--vscode-font-size);
      box-sizing: border-box;
    }



















    /* Notification Card Styles */
    .notification-card {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background-color 0.15s;
    }

    .notification-card.unread {
      background-color: rgba(33, 150, 243, 0.1);
      border-color: rgba(33, 150, 243, 0.3);
    }

    .notification-card:hover {
      background-color: var(--vscode-list-hoverBackground);
    }

    .notification-filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .notification-filter-group {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .notification-filter-btn {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 11px;
      background: transparent;
      color: var(--vscode-foreground);
      cursor: pointer;
    }

    .notification-filter-btn.active {
      background: var(--vscode-button-background);
      border-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
    }

    .notification-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      cursor: pointer;
    }

    .notification-toggle input {
      margin: 0;
    }

    /* 工具执行面板 */
    .tool-run-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* 筛选区域 */
    .tool-run-filters {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 12px;
      background: var(--vscode-sideBar-background);
      border-radius: 6px;
      border: 1px solid var(--vscode-panel-border);
    }

    .tool-run-filter-label {
      font-size: 13px;
      font-weight: 500;
      color: var(--vscode-foreground);
      white-space: nowrap;
    }

    .tool-run-filter-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tool-run-filter-btn {
      border: 1px solid var(--vscode-panel-border);
      background: transparent;
      color: var(--vscode-foreground);
      padding: 6px 14px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }

    .tool-run-filter-btn:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .tool-run-filter-btn.active {
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border-color: var(--vscode-button-background);
    }

    /* 操作区域 */
    .tool-run-launcher {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .tool-run-section {
      padding: 16px;
      background: var(--vscode-sideBar-background);
      border-radius: 6px;
      border: 1px solid var(--vscode-panel-border);
    }

    .tool-run-section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--vscode-panel-border);
    }

    /* 命令行执行 */
    .tool-run-inline {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }

    .tool-run-inline input {
      flex: 1;
      min-width: 0;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--vscode-input-border);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      font-size: 13px;
    }

    .tool-run-inline input:focus {
      outline: none;
      border-color: var(--vscode-focusBorder);
    }

    .tool-run-inline button {
      flex-shrink: 0;
      white-space: nowrap;
    }

    /* MCP 工具执行 */
    .tool-run-mcp-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .tool-run-mcp-row {
      display: flex;
      gap: 8px;
      align-items: stretch;
    }

    .tool-run-mcp-row select {
      flex: 1;
      min-width: 0;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--vscode-input-border);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      font-size: 13px;
    }

    .tool-run-mcp-row input {
      flex: 1;
      min-width: 0;
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid var(--vscode-input-border);
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      font-size: 13px;
    }

    .tool-run-mcp-row button {
      flex-shrink: 0;
      white-space: nowrap;
    }

    .tool-run-mcp-row select:focus,
    .tool-run-mcp-row input:focus {
      outline: none;
      border-color: var(--vscode-focusBorder);
    }

    .tool-run-mcp-row select:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .tool-run-mcp-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .panel-action-btn.primary {
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      width: auto;
      height: auto;
      padding: 8px 16px;
      font-size: 13px;
      opacity: 1;
    }

    .panel-action-btn.primary:hover {
      background: var(--vscode-button-hoverBackground);
    }

    .panel-action-btn.ghost {
      background: transparent;
      border: 1px solid var(--vscode-button-border, var(--vscode-panel-border));
      color: var(--vscode-button-foreground);
      width: auto;
      height: auto;
      padding: 8px 16px;
      font-size: 13px;
      opacity: 1;
    }

    .panel-action-btn.ghost:hover {
      background: var(--vscode-button-secondaryHoverBackground);
    }

    .mcp-tool-result {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 4px;
      border: 1px solid var(--vscode-panel-border);
      background: var(--vscode-editor-background);
      font-family: var(--vscode-editor-font-family);
      font-size: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 200px;
      overflow-y: auto;
    }

    .mcp-tool-result:empty {
      display: none;
    }

    .mcp-tool-result.success {
      border-color: var(--vscode-testing-iconPassed);
      color: var(--vscode-testing-iconPassed);
    }

    .mcp-tool-result.error {
      border-color: var(--vscode-testing-iconFailed);
      color: var(--vscode-testing-iconFailed);
    }

    /* 执行日志列表 */
    .tool-run-list {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: var(--vscode-sideBar-background);
      min-height: 200px;
      max-height: 600px;
      overflow-y: auto;
    }

    .tool-run-card {
      border: 1px solid var(--vscode-panel-border);
      border-left: 4px solid var(--vscode-panel-border);
      border-radius: 6px;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      background: var(--vscode-editor-background);
    }

    .tool-run-card.status-running {
      border-left-color: #4da3ff;
    }

    .tool-run-card.status-failed {
      border-left-color: #ff6b6b;
    }

    .tool-run-card.status-succeeded {
      border-left-color: #50c878;
    }

    .tool-run-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .tool-run-name {
      font-weight: 600;
      font-size: 13px;
    }

    .tool-run-meta {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-left: 8px;
    }

    .tool-run-actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .tool-run-body {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 4px 12px;
    }

    .tool-run-log {
      border: 1px solid var(--vscode-panel-border);
      border-radius: 4px;
      padding: 6px;
      font-family: var(--vscode-editor-font-family, monospace);
      font-size: 11px;
      max-height: 160px;
      overflow: auto;
      background: rgba(255, 255, 255, 0.02);
      display: none;
      white-space: pre-wrap;
    }

    .tool-run-log.visible {
      display: block;
    }

    .notification-header {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 6px;
    }

    .notification-unread-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #2196f3;
      flex-shrink: 0;
      margin-top: 4px;
    }

    .notification-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--vscode-foreground);
      flex: 1;
    }

    .notification-message {
      font-size: 12px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
      line-height: 1.4;
    }

    .notification-time {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
    }

    /* 主内容区 */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background-color: var(--vscode-editor-background);
      overflow: hidden;
    }

    .main-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;
    }

    /* 按钮样式 */
    button {
      background-color: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: none;
      padding: 6px 12px;
      cursor: pointer;
      border-radius: 2px;
      font-size: 13px;
    }

    button:hover {
      background-color: var(--vscode-button-hoverBackground);
    }

    /* Toggle Switch */
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 2px;
      bottom: 2px;
      background-color: var(--vscode-foreground);
      transition: .3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked+.toggle-slider {
      background-color: var(--vscode-button-background);
      border-color: var(--vscode-button-background);
    }

    .toggle-switch input:checked+.toggle-slider:before {
      transform: translateX(16px);
      background-color: var(--vscode-button-foreground);
    }

    /* Session 和表单相关样式 */
    .session-id-preview {
      padding: 8px 12px;
      background-color: var(--vscode-input-background);
      border: 1px solid var(--vscode-input-border);
      border-radius: 2px;
      font-family: monospace;
      font-size: 12px;
      color: var(--vscode-foreground);
      word-break: break-all;
    }

    .form-textarea {
      width: 100%;
      min-height: 80px;
      padding: 8px;
      background-color: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border);
      border-radius: 2px;
      font-size: 12px;
      font-family: var(--vscode-font-family);
      resize: vertical;
    }

    .form-textarea:focus {
      outline: none;
      border-color: var(--vscode-focusBorder);
      box-shadow: 0 0 0 1px var(--vscode-focusBorder);
    }

    .form-hint {
      font-size: 11px;
      color: var(--vscode-descriptionForeground);
      margin-top: 4px;
      display: block;
    }

    .form-error {
      font-size: 11px;
      color: var(--vscode-errorForeground);
      margin-top: 4px;
      display: none;
    }

    .form-error:not(:empty) {
      display: block;
    }

    .form-label.required::after {
      content: ' *';
      color: var(--vscode-errorForeground);
    }
  </style>
</head>

<body>
  <div id="agent-empty-overlay" class="agent-empty-overlay hidden">
    <div class="agent-empty-card">
      <div class="agent-empty-title">尚未配置任何 Agent</div>
      <div class="agent-empty-desc">请先在左侧“Agent 管理”中添加至少一个 Agent，从而开始需求认领与任务执行。</div>
      <div class="agent-empty-actions">
        <button id="agent-empty-add-btn" class="agent-empty-button primary">立即添加 Agent</button>
        <button id="agent-empty-refresh-btn" class="agent-empty-button secondary">已配置？刷新列表</button>
      </div>
    </div>
  </div>
  <div class="container">
    <!-- 左侧边栏 -->
    <div class="sidebar left" id="left-sidebar">
      <button class="collapse-btn" data-action="toggleLeftSidebar">◀</button>
      <div class="sidebar-content">
        <!-- Agents 面板 -->
        <div class="panel" id="panel-agents" style="flex: 1;">
          <div class="panel-header" data-action="togglePanel" data-panel="panel-agents">
            <span class="panel-title">
              <span class="panel-title-text">Agent 状态</span>
              <span class="panel-title-badge" id="agent-stats"></span>
            </span>
            <div class="panel-actions">
              <button class="panel-collapse-btn" data-action="togglePanel" data-panel="panel-agents">▼</button>
            </div>
          </div>
          <div class="panel-body" id="agents-list">
            <div class="panel-inline-hint">
              提示：Agent 配置入口位于「全局配置」页签。
              <button class="panel-link-button" data-action="openGlobalAgentTab">前往管理</button>
            </div>
            <div class="empty-state">暂无 Agent 数据</div>
          </div>
        </div>

        <!-- 分割线 -->
        <div class="panel-resizer" data-target="panel-agents"></div>

        <!-- Tasks 面板 -->
        <div class="panel" id="panel-tasks" style="flex: 1;">
          <div class="panel-header" data-action="togglePanel" data-panel="panel-tasks">
            <span class="panel-title">
              <span class="panel-title-text">任务列表</span>
              <span class="panel-title-badge" id="task-stats"></span>
            </span>
            <div class="panel-actions">
              <button class="panel-collapse-btn" data-action="togglePanel" data-panel="panel-tasks">▼</button>
            </div>
          </div>
          <div class="panel-body" id="tasks-list">
            <div class="empty-state">暂无任务数据</div>
          </div>
        </div>

        <!-- 协助面板 -->
        <div class="panel" id="panel-assists" style="flex: 1;">
          <div class="panel-header" data-action="togglePanel" data-panel="panel-assists">
            <span class="panel-title">
              <span class="panel-title-text">协助请求</span>
            </span>
            <div class="panel-actions">
              <button class="panel-collapse-btn" data-action="togglePanel" data-panel="panel-assists">▼</button>
            </div>
          </div>
          <div class="panel-body" id="assist-list">
            <div class="empty-state">暂无协助请求</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
      <!-- Main Tab Navigation -->
      <div class="main-tab-nav">
        <div class="main-tab-buttons">
          <button class="main-tab-button active" data-main-tab="blackboard"
            onclick="switchMainTab('blackboard', event)">黑板系统</button>
          <button class="main-tab-button" data-main-tab="workspace"
            onclick="switchMainTab('workspace', event)">Agent工作台</button>
          <button class="main-tab-button" data-main-tab="global" onclick="switchMainTab('global', event)">全局配置</button>
        </div>
        <div class="session-tab-controls">
          <span>当前会话</span>
          <select id="session-select" class="session-select" disabled>
            <option value="">加载中...</option>
          </select>
          <span id="blackboard-current-session" class="session-current-label">--</span>
          <button class="session-action-btn" data-action="openCreateSessionModal" title="新建会话">＋</button>
          <button class="session-action-btn danger" data-action="openDeleteSessionModal" title="删除当前会话">🗑</button>
        </div>
      </div>

      <div class="main-body">
        <!-- Tab 1: Blackboard System -->
        <div id="main-tab-blackboard" class="main-tab-content active">
          <!-- Sub Tab Navigation -->
          <div class="sub-tab-nav">
            <button class="sub-tab-button active" onclick="switchBlackboardView('discussion')">协作对话</button>
            <button class="sub-tab-button" onclick="switchBlackboardView('notifications')">通知中心</button>
            <button class="sub-tab-button" onclick="switchBlackboardView('tools')">工具执行</button>
          </div>
          <!-- Discussion View -->
          <div id="blackboard-discussion" class="sub-tab-content active">
            <!-- Message Search -->
            <div style="padding: 8px; border-bottom: 1px solid var(--vscode-panel-border); flex-shrink: 0;">
              <input type="text" id="message-search" placeholder="🔍 搜索消息..."
                style="width: 100%; padding: 4px 8px; background: var(--vscode-input-background); color: var(--vscode-input-foreground); border: 1px solid var(--vscode-input-border); border-radius: 2px; font-size: 12px;">
            </div>

            <!-- Messages List Container (scrollable) -->
            <div style="flex: 1; position: relative; min-height: 0;">
              <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; overflow-y: auto; padding: 8px;"
                id="messages-list">
                <div class="empty-state">暂无消息</div>
              </div>

              <!-- New Message Indicator Button (outside messages content) -->
              <button id="new-message-indicator" style="display: none; position: absolute; bottom: 20px; right: 20px;
                             z-index: 100; padding: 8px 16px; border-radius: 20px;
                             background: var(--vscode-button-background);
                             color: var(--vscode-button-foreground);
                             border: none; cursor: pointer;
                             box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                             font-size: 12px;
                             transition: opacity 0.2s;" onclick="scrollToBottomAndHide()">
                有新消息 ↓
              </button>
            </div>

            <!-- Message Input Area (fixed at bottom) -->
            <div id="message-input-area" class="message-input-area">
              <div class="message-template-row" id="message-template-row"></div>
              <div id="mention-suggestions" class="mention-suggestion-list"></div>
              <!-- Reply/Quote Indicator -->
              <div id="reply-indicator"></div>
              <!-- Input Area Resize Handle -->
              <div class="input-resize-handle" id="input-resize-handle"></div>
              <!-- Text Input -->
              <div class="message-textarea-wrapper" id="message-textarea-wrapper">
                <textarea id="message-input" placeholder="输入消息... (Enter 发送, Shift+Enter 换行)"></textarea>
                <button id="message-send-btn" onclick="sendMessage()"
                  style="position: absolute; bottom: 8px; right: 8px; padding: 6px; width: 32px; height: 32px; background: var(--vscode-button-background); color: var(--vscode-button-foreground); border: none; border-radius: 2px; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                  <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"
                    fill="currentColor">
                    <path d="M1 2L15 8L1 14V9L11 8L1 7V2Z" />
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <!-- Notifications View -->
          <div id="blackboard-notifications" class="sub-tab-content">
            <div class="panel" style="flex: 1;">
              <div class="panel-header">
                <span class="panel-title">
                  <span class="panel-title-text">通知中心</span>
                  <span class="panel-title-badge" id="notification-stats"></span>
                </span>
              </div>
              <div class="panel-body">
                <div id="notifications-list">
                  <div class="empty-state">暂无通知</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Tool Runs View -->
          <div id="blackboard-tools" class="sub-tab-content">
            <div class="panel" style="flex: 1;">
              <div class="panel-header">
                <span class="panel-title">
                  <span class="panel-title-text">工具执行日志</span>
                  <span class="panel-title-badge" id="tool-run-stats"></span>
                </span>
                <div class="panel-actions">
                  <button class="panel-action-btn" data-action="refreshToolRuns" title="刷新"
                    onclick="requestToolRunsSnapshot()">⟳</button>
                </div>
              </div>
              <div class="panel-body">
                <div class="tool-run-panel">
                  <!-- 状态筛选 -->
                  <div class="tool-run-filters">
                    <div class="tool-run-filter-label">筛选：</div>
                    <div class="tool-run-filter-buttons">
                      <button class="tool-run-filter-btn active" data-status="all"
                        onclick="setToolRunStatusFilter('all')">全部</button>
                      <button class="tool-run-filter-btn" data-status="running"
                        onclick="setToolRunStatusFilter('running')">执行中</button>
                      <button class="tool-run-filter-btn" data-status="succeeded"
                        onclick="setToolRunStatusFilter('succeeded')">成功</button>
                      <button class="tool-run-filter-btn" data-status="failed"
                        onclick="setToolRunStatusFilter('failed')">失败</button>
                    </div>
                  </div>

                  <!-- 操作区域 -->
                  <div class="tool-run-launcher">
                    <!-- 命令行执行 -->
                    <div class="tool-run-section">
                      <div class="tool-run-section-title">命令行执行</div>
                      <div class="tool-run-inline">
                        <input type="text" id="tool-run-command-input" placeholder="输入要执行的命令，如: ls -la" />
                        <button class="panel-action-btn primary" data-action="runToolCommand"
                          onclick="runToolCommand()">执行</button>
                      </div>
                    </div>

                    <!-- MCP 工具执行 -->
                    <div class="tool-run-section">
                      <div class="tool-run-section-title">MCP 工具执行</div>
                      <div class="tool-run-mcp-grid">
                        <div class="tool-run-mcp-row">
                          <select id="mcp-server-select" class="form-select" onchange="handleMcpServerChange()">
                            <option value="">选择 MCP Server</option>
                          </select>
                          <button class="panel-action-btn ghost" data-action="runMcpPing"
                            onclick="runMcpPing()">测试连接</button>
                        </div>
                        <div class="tool-run-mcp-row">
                          <select id="mcp-tool-select" class="form-select" disabled>
                            <option value="">选择工具</option>
                          </select>
                          <input type="text" id="mcp-tool-args" placeholder="工具参数（JSON 格式，可留空）" />
                        </div>
                        <div class="tool-run-mcp-actions">
                          <button class="panel-action-btn primary" data-action="runMcpTool"
                            onclick="runMcpTool()">运行工具</button>
                          <button class="panel-action-btn ghost" data-action="refreshMcpTools"
                            onclick="refreshMcpTools()">刷新工具列表</button>
                        </div>
                      </div>
                      <div id="mcp-tool-result" class="mcp-tool-result"></div>
                    </div>
                  </div>

                  <!-- 执行日志列表 -->
                  <div class="tool-run-list" id="tool-run-list">
                    <div class="empty-state">暂无工具执行记录</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- Tab 2: Agent Workspace -->
        <div id="main-tab-workspace" class="main-tab-content">
          <div class="workspace-container">
            <div id="workspace-empty" class="workspace-empty">
              <div>请选择一个 Agent 查看工作台</div>
              <div style="margin-top: 6px; font-size: 12px;">选中左侧 Agent 卡片后，这里显示与该 Agent 的单聊时间线</div>
            </div>
            <div id="workspace-panel" class="workspace-panel hidden">
              <div class="workspace-header">
                <div class="workspace-agent-meta">
                  <div class="workspace-agent-name" id="workspace-agent-name">Agent</div>
                  <div class="workspace-agent-subtitle" id="workspace-agent-meta">状态与指标</div>
                  <div class="workspace-header-meta" id="workspace-agent-extra"></div>
                  <div class="workspace-status-strip">
                    <span class="workspace-status-dot" id="workspace-agent-status-dot"></span>
                    <span id="workspace-agent-status-text">--</span>
                  </div>
                </div>
                <div class="workspace-header-actions">
                  <button data-action="refreshWorkspace">刷新</button>
                </div>
              </div>
              <div id="workspace-timeline" class="workspace-timeline">
                <div class="workspace-empty-hint">暂无对话，发送一条消息开始吧。</div>
              </div>
              <div class="workspace-input">
                <textarea id="workspace-input" placeholder="与该 Agent 单聊，无需 @"></textarea>
                <button id="workspace-send-btn" type="button">发送</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab 3: Global Configuration -->
        <div id="main-tab-global" class="main-tab-content">
          <div class="global-config-panel">
            <div class="global-config-tabs">
              <button class="global-config-tab active" data-global-tab="agents"
                onclick="switchGlobalConfigTab('agents')">Agent 管理</button>
              <button class="global-config-tab" data-global-tab="mcp" onclick="switchGlobalConfigTab('mcp')">MCP
                配置</button>
              <button class="global-config-tab" data-global-tab="ace" onclick="switchGlobalConfigTab('ace')">ACE
                集成</button>
              <button class="global-config-tab" data-global-tab="manager-llm"
                onclick="switchGlobalConfigTab('manager-llm')">经理 LLM</button>
            </div>
            <div class="global-config-body">
              <div id="global-tab-agents" class="global-tab-content active">
                <div class="global-section">
                  <div class="global-section-header">
                    <div>
                      <div class="global-section-title">Agent 管理</div>
                      <div class="global-section-desc">统一维护 Agent LLM 配置与能力标签，跨项目共享</div>
                    </div>
                    <div class="global-section-actions">
                      <button class="quick-action-btn" type="button" data-action="addAgent" onclick="addAgent()">＋ 新增
                        Agent</button>
                    </div>
                  </div>
                  <div class="global-section-body">
                    <div class="global-agent-list" id="global-agent-list">
                      <div class="empty-state">暂无 Agent 数据</div>
                    </div>
                  </div>
                </div>
              </div>
              <div id="global-tab-mcp" class="global-tab-content">
                <section class="global-section">
                  <div class="global-section-header">
                    <div>
                      <div class="global-section-title">MCP 配置</div>
                      <div class="global-section-desc">统一维护标准 MCP Server，启用后自动参与所有 Agent 调用</div>
                    </div>
                    <div class="global-section-actions">
                      <button class="quick-action-btn" data-action="openMcpAddModal">＋ 添加 MCP Server</button>
                    </div>
                  </div>
                  <div class="global-section-body">
                    <div class="panel" style="flex: 1;">
                      <div class="panel-header">
                        <span class="panel-title">
                          <span class="panel-title-text">MCP 服务列表</span>
                          <span class="panel-title-badge" id="mcp-server-stats"></span>
                        </span>
                      </div>
                      <div class="panel-body" style="display: flex; flex-direction: column;">
                        <div class="mcp-server-list" id="mcp-server-list">
                          <div class="empty-state">
                            暂无 MCP Server 配置
                            <div class="mcp-empty-cta">
                              <button class="mcp-btn" data-action="openMcpAddModal">立即配置</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </section>
              </div>
              <div id="global-tab-ace" class="global-tab-content">
                <section class="global-section">
                  <div class="global-section-header">
                    <div>
                      <div class="global-section-title">ACE 集成</div>
                      <div class="global-section-desc">配置 ACE 源，启用代码库索引与语义搜索</div>
                    </div>
                    <div class="global-section-actions"></div>
                  </div>
                  <div class="global-section-body">
                    <!-- 状态横幅 -->
                    <div class="ace-status-banner" id="ace-status-banner">ACE 配置信息未加载</div>

                    <!-- 配置表单 -->
                    <form id="ace-config-form" class="ace-config-grid">
                      <!-- 连接状态 -->
                      <div class="ace-config-field full-row">
                        <label>连接状态</label>
                        <div class="ace-status-indicator">
                          <span class="status-dot" id="ace-status-dot"></span>
                          <span id="ace-status-text">未配置</span>
                        </div>
                      </div>

                      <div class="ace-config-field full-row">
                        <label>运行概览</label>
                        <div class="ace-health-grid">
                          <div class="ace-health-item">
                            <div class="ace-health-label">上次索引</div>
                            <div class="ace-health-value" id="ace-health-index-value">--</div>
                            <div class="ace-health-meta" id="ace-health-index-meta">等待运行</div>
                          </div>
                          <div class="ace-health-item">
                            <div class="ace-health-label">上次搜索</div>
                            <div class="ace-health-value" id="ace-health-search-value">--</div>
                            <div class="ace-health-meta" id="ace-health-search-meta">等待运行</div>
                          </div>
                          <div class="ace-health-item">
                            <div class="ace-health-label">失败监控</div>
                            <div class="ace-health-value" id="ace-health-failure-value">运行正常</div>
                            <div class="ace-health-meta" id="ace-health-failure-meta">最近未出现失败</div>
                            <div class="ace-health-detail hidden" id="ace-health-failure-detail"></div>
                          </div>
                        </div>
                      </div>

                      <!-- Base URL -->
                      <div class="ace-config-field">
                        <label for="ace-base-url">Base URL</label>
                        <input type="text" id="ace-base-url" placeholder="https://api.example.com" />
                        <span class="form-hint">ACE 服务的 API 地址</span>
                      </div>

                      <!-- API Token -->
                      <div class="ace-config-field">
                        <label for="ace-token">API Token</label>
                        <input type="password" id="ace-token" placeholder="输入访问令牌" />
                        <span class="form-hint">用于身份验证的访问令牌</span>
                      </div>

                      <!-- 操作按钮 -->
                      <div class="ace-config-field full-row">
                        <div class="ace-config-actions">
                          <button class="primary" type="submit">保存配置</button>
                          <button class="ghost" type="button" id="ace-refresh-btn">刷新索引</button>
                          <button class="ghost" type="button" id="ace-test-connection">测试连接</button>
                        </div>
                      </div>
                    </form>

                    <!-- 最近活动概览 -->
                    <div class="ace-activity-panel">
                      <div class="ace-activity-header">
                        <h3>最近活动</h3>
                        <span class="form-hint">最新的索引、搜索和测试记录</span>
                      </div>
                      <div class="ace-activity-grid" id="ace-activity-list">
                        <div class="empty-state">暂无 ACE 活动</div>
                      </div>
                    </div>

                    <!-- 搜索测试面板 -->
                    <div class="ace-search-panel">
                      <div class="ace-search-header">
                        <h3>语义搜索测试</h3>
                        <span class="form-hint">测试 ACE 的搜索功能</span>
                      </div>
                      <div class="ace-search-controls">
                        <input type="text" id="ace-search-query" placeholder="输入要搜索的内容，例如：logging configuration" />
                        <button type="button" class="primary" id="ace-search-btn">搜索</button>
                      </div>
                      <div class="ace-search-output" id="ace-search-result">尚未执行搜索</div>
                    </div>
                  </div>
                </section>
              </div>
              <div id="global-tab-manager-llm" class="global-tab-content">
                <section class="global-section">
                  <div class="global-section-header">
                    <div>
                      <div class="global-section-title">团队经理 LLM</div>
                      <div class="global-section-desc">配置调度经理使用的基础模型与提示，统一管理轮值池</div>
                    </div>
                  </div>
                  <div class="global-section-body">
                    <div class="ace-status-banner" id="manager-llm-status-banner">配置未加载</div>
                    <form id="manager-llm-form" class="manager-llm-grid">
                      <div class="ace-config-field">
                        <label for="manager-llm-provider">模型提供方</label>
                        <select id="manager-llm-provider">
                          <option value="claude">Anthropic · Claude</option>
                          <option value="openai">OpenAI</option>
                          <option value="glm">智谱 GLM</option>
                          <option value="gemini">Google Gemini</option>
                          <option value="custom">自定义（兼容 OpenAI）</option>
                        </select>
                        <span class="form-hint">决定默认的 API 兼容协议</span>
                      </div>
                      <div class="ace-config-field">
                        <label for="manager-llm-model">模型名称</label>
                        <input type="text" id="manager-llm-model" placeholder="如 claude-3.5-sonnet" />
                        <span class="form-hint">经理使用的具体模型 ID</span>
                      </div>
                      <div class="ace-config-field">
                        <label for="manager-llm-base-url">Base URL</label>
                        <input type="text" id="manager-llm-base-url" placeholder="https://api.example.com/v1" />
                        <span class="form-hint">可选，默认使用官方地址</span>
                      </div>
                      <div class="ace-config-field">
                        <label for="manager-llm-api-key">API Key</label>
                        <input type="password" id="manager-llm-api-key" placeholder="sk-..." />
                        <span class="form-hint">仅存储在本机全局配置中</span>
                      </div>
                      <div class="ace-config-field">
                        <label for="manager-llm-temperature">Temperature</label>
                        <input type="number" id="manager-llm-temperature" min="0" max="1" step="0.1"
                          placeholder="0.4" />
                        <span class="form-hint">调度输出的发散程度，建议 0.2~0.6</span>
                      </div>
                      <div class="ace-config-field">
                        <label for="manager-llm-max-tokens">最大输出 Token</label>
                        <input type="number" id="manager-llm-max-tokens" min="256" max="8192" step="64"
                          placeholder="2048" />
                        <span class="form-hint">经理在一次响应中可以输出的上限</span>
                      </div>
                      <div class="ace-config-field full-row">
                        <label for="manager-llm-system-prompt">系统提示词</label>
                        <textarea id="manager-llm-system-prompt" rows="4" placeholder="描述经理的职责、语气与输出格式"></textarea>
                        <span class="form-hint">会在每次调度调用中注入，建议强调任务拆解与风险提示</span>
                      </div>
                      <div class="ace-config-field full-row">
                        <div class="ace-config-actions">
                          <button class="primary" type="submit">保存配置</button>
                          <button class="ghost" type="button" id="manager-llm-reload">重新加载</button>
                          <button class="ghost" type="button" id="manager-llm-test">测试连接</button>
                        </div>
                      </div>
                    </form>
                  </div>
                </section>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 右侧边栏 -->
    <div class="sidebar right" id="right-sidebar">
      <button class="collapse-btn" data-action="toggleRightSidebar">▶</button>
      <div class="sidebar-content">
        <div class="manager-stack">
          <div class="manager-status-card stacked" id="manager-status-primary">
            <h4>调度经理</h4>
            <div class="manager-status-value">
              <span class="manager-status-dot" id="manager-status-dot"></span>
              <span id="manager-status-name">配置加载中...</span>
            </div>
            <div class="manager-status-meta">
              <span id="manager-status-model">--</span>
              <span id="manager-status-updated">--</span>
            </div>
          </div>
          <div class="manager-status-card stacked" id="manager-status-queue">
            <h4>任务队列</h4>
            <div class="manager-status-value">-- / --</div>
            <div class="manager-status-meta">
              <span id="manager-status-queue-meta">排队 0</span>
            </div>
          </div>
          <div class="manager-status-card stacked" id="manager-status-ace">
            <h4>上下文索引</h4>
            <div class="manager-status-value" id="manager-status-ace-value">等待索引</div>
            <div class="manager-status-meta" id="manager-status-ace-meta">
              <span>--</span>
              <span>--</span>
            </div>
          </div>
        </div>

        <!-- 文件变更面板 -->
        <div class="panel collapsed" id="panel-file-changes" style="flex: 1;">
          <div class="panel-header" data-action="togglePanel" data-panel="panel-file-changes">
            <span class="panel-title">
              <span class="panel-title-text">文件变更</span>
              <span class="panel-title-badge" id="file-change-stats"></span>
            </span>
            <div class="panel-actions">
              <button class="panel-collapse-btn" data-action="togglePanel" data-panel="panel-file-changes">▶</button>
            </div>
          </div>
          <div class="panel-body">
            <div class="file-change-filters">
              <button class="file-change-filter-btn active" data-action="setFileChangeFilter"
                data-filter="all">全部</button>
              <button class="file-change-filter-btn" data-action="setFileChangeFilter" data-filter="create">新增</button>
              <button class="file-change-filter-btn" data-action="setFileChangeFilter" data-filter="modify">修改</button>
              <button class="file-change-filter-btn" data-action="setFileChangeFilter" data-filter="delete">删除</button>
              <input type="text" class="file-change-filter-input" id="file-change-task-filter" placeholder="任务 ID" />
              <input type="text" class="file-change-filter-input" id="file-change-agent-filter"
                placeholder="Agent ID" />
            </div>
            <div class="file-change-view-toggle">
              <span>视图</span>
              <button class="file-change-view-btn active" data-action="setFileChangeView"
                data-view="timeline">按时间</button>
              <button class="file-change-view-btn" data-action="setFileChangeView" data-view="task">按任务</button>
            </div>
            <div class="file-change-list" id="file-changes-list">
              <div class="empty-state">暂无文件变更记录</div>
            </div>
          </div>
        </div>

        <!-- 分割线 -->
        <div class="panel-resizer" data-target="panel-file-changes"></div>

      </div>
    </div>
  </div>

  <!-- 模态弹窗：添加 Agent -->
  <div class="modal-overlay" id="modal-add-agent">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">添加 Agent</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <form id="form-add-agent">
          <div class="form-group">
            <label class="form-label required">Agent ID</label>
            <input type="text" class="form-input" id="agent-id" name="id" required placeholder="例如：agent-developer-1">
            <div class="form-hint">唯一标识符，建议使用英文和数字</div>
          </div>
          <div class="form-group">
            <label class="form-label required">显示名称</label>
            <input type="text" class="form-input" id="agent-display-name" name="display_name" required
              placeholder="例如：开发助手">
          </div>
          <div class="form-group">
            <label class="form-label required">能力标签（点击选择，可多选）</label>
            <div class="tag-cloud" id="agent-capabilities-cloud">
              <button type="button" class="tag-chip capability" data-capability="coding">编码</button>
              <button type="button" class="tag-chip capability" data-capability="analysis">分析</button>
              <button type="button" class="tag-chip capability" data-capability="planning">规划</button>
              <button type="button" class="tag-chip capability" data-capability="testing">测试</button>
              <button type="button" class="tag-chip capability" data-capability="review">审查</button>
              <button type="button" class="tag-chip capability" data-capability="security">安全</button>
              <button type="button" class="tag-chip capability" data-capability="documentation">文档</button>
              <button type="button" class="tag-chip capability" data-capability="devops">DevOps</button>
              <button type="button" class="tag-chip capability" data-capability="automation">自动化</button>
              <button type="button" class="tag-chip capability" data-capability="monitoring">监控</button>
              <button type="button" class="tag-chip capability" data-capability="design">设计</button>
              <button type="button" class="tag-chip capability" data-capability="coordination">协调</button>
              <button type="button" class="tag-chip capability" data-capability="refactoring">重构</button>
              <button type="button" class="tag-chip capability" data-capability="debugging">调试</button>
              <button type="button" class="tag-chip capability" data-capability="optimization">优化</button>
              <button type="button" class="tag-chip capability" data-capability="deployment">部署</button>
            </div>
            <div class="form-hint">可多选，用于描述 Agent 的特长</div>
          </div>
          <div class="form-group">
            <label class="form-label required">推理档位（1-10）</label>
            <input type="number" class="form-input" id="agent-reasoning-tier" name="reasoning_tier" min="1" max="10"
              step="1" value="5">
            <div class="form-hint">数值越高推理越强，默认 5</div>
          </div>
          <div class="form-group">
            <label class="form-label">成本系数</label>
            <select class="form-select" id="agent-cost-factor" name="cost_factor">
              <option value="0.8">低 · 0.8</option>
              <option value="1" selected>中 · 1.0</option>
              <option value="1.3">高 · 1.3</option>
            </select>
            <div class="form-hint">预设三档成本权重，默认 中 · 1.0</div>
          </div>
          <div class="form-group">
            <label class="form-label required">LLM Provider</label>
            <select class="form-select" id="agent-llm-provider" name="llm_provider" required>
              <option value="claude">Claude (Anthropic)</option>
              <option value="openai">OpenAI</option>
              <option value="gemini">Gemini (Google)</option>
              <option value="glm">GLM (智谱AI)</option>
              <option value="custom">自定义 (OpenAI 兼容)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label required">LLM Model</label>
            <input type="text" class="form-input" id="agent-llm-model" name="llm_model" required
              placeholder="例如：claude-3-5-sonnet-20241022">
            <div class="form-hint" id="model-hint"></div>
            <div class="chip-group" id="model-suggestion-chips"></div>
          </div>
          <div class="form-group" id="base-url-group">
            <label class="form-label">LLM Base URL</label>
            <input type="text" class="form-input" id="agent-llm-base-url" name="llm_base_url"
              placeholder="https://api.openai.com/v1">
            <div class="form-hint" id="base-url-hint">默认使用 Provider 推荐地址，可按需修改</div>
          </div>
          <div class="form-group">
            <label class="form-label">LLM API Key</label>
            <input type="password" class="form-input" id="agent-llm-api-key" name="llm_api_key"
              placeholder="请输入对应 Provider 的 API Key">
            <div class="form-hint" id="api-key-hint">必填：用于调用 LLM API</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">取消</button>
        <button class="btn btn-primary" data-action="submitAddAgent">确定</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modal-task-dependency">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">任务依赖详情</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <div id="task-dependency-body" class="detail-section">
          <div class="empty-state">请选择一个任务查看依赖关系</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">关闭</button>
      </div>
    </div>
  </div>

  <!-- 模态弹窗：敏感命令确认 -->
  <div class="modal-overlay" id="modal-sensitive-confirm">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">⚠️ 敏感命令确认</h3>
        <button class="modal-close-btn" data-action="closeSensitiveModal">×</button>
      </div>
      <div class="modal-body">
        <div class="sensitive-confirm-content">
          <div class="sensitive-warning">
            <div class="warning-icon">⚠️</div>
            <div class="warning-text">
              <p>检测到敏感命令，需要您的确认才能执行</p>
            </div>
          </div>
          <div class="sensitive-details">
            <div class="detail-item">
              <label>命令：</label>
              <div class="command-display" id="sensitive-command-display"></div>
            </div>
            <div class="detail-item">
              <label>匹配关键字：</label>
              <div class="keywords-display" id="sensitive-keywords-display"></div>
            </div>
            <div class="detail-item">
              <label>风险等级：</label>
              <div class="risk-level-display" id="sensitive-risk-level-display"></div>
            </div>
            <div class="detail-item">
              <label>操作来源：</label>
              <div class="source-display" id="sensitive-source-display"></div>
            </div>
          </div>
          <div class="sensitive-confirm-note">
            <p>请确认您了解此命令的影响，然后选择是否继续执行。</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeSensitiveModal">取消</button>
        <button class="btn btn-danger" id="sensitive-confirm-btn" data-action="confirmSensitiveCommand">确认执行</button>
      </div>
    </div>
  </div>

  <!-- 模态弹窗：创建会话 -->
  <div class="modal-overlay" id="modal-create-session">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">创建新会话</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">会话 ID</label>
          <div class="session-id-preview" id="session-create-preview"></div>
          <div class="form-hint">系统将自动生成唯一的会话 ID</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">取消</button>
        <button class="btn btn-primary" data-action="confirmCreateSession">确认创建</button>
      </div>
    </div>
  </div>

  <!-- 模态弹窗：删除会话 -->
  <div class="modal-overlay" id="modal-delete-session">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">⚠️ 删除会话</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <div class="sensitive-warning">
          <div class="warning-icon">⚠️</div>
          <div class="warning-text">
            <p>确定要删除以下会话吗？此操作不可撤销。</p>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">会话 ID</label>
          <div class="session-id-preview" id="session-delete-preview"></div>
        </div>
        <div class="sensitive-confirm-note">
          <p>删除会话将同时删除该会话下的所有消息、任务和相关数据。</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">取消</button>
        <button class="btn btn-danger" data-action="confirmDeleteSession">确认删除</button>
      </div>
    </div>
  </div>

  <!-- 模态弹窗：任务详情 -->
  <div class="modal-overlay" id="modal-task-detail">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title" id="task-detail-title">任务详情</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body" id="task-detail-body">
        <div class="empty-state">暂无任务信息</div>
      </div>
      <div class="modal-footer" style="justify-content: flex-end;">
        <button class="btn btn-secondary" data-action="closeModal">关闭</button>
      </div>
    </div>
  </div>

  <!-- 模态弹窗：MCP 配置 -->
  <div class="modal-overlay" id="modal-mcp-config">
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title">MCP Server 配置</h3>
        <button class="modal-close-btn" data-action="closeModal">×</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">配置 JSON</label>
          <textarea class="form-textarea" id="mcp-config-json"
            placeholder='{"command": "uvx", "args": ["package@latest"]}' rows="10"></textarea>
          <div class="form-hint">请输入符合 MCP 规范的 JSON 配置</div>
          <div class="form-error" id="mcp-config-error"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-action="closeModal">取消</button>
        <button class="btn btn-primary" data-action="submitMcpConfig">确认</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      console.log('[MinimalPanel] 脚本开始执行');

      const vscode = (typeof acquireVsCodeApi === 'function')
        ? acquireVsCodeApi()
        : {
          postMessage(message) {
            console.warn('[MinimalPanel] VSCode API 不可用，已丢弃消息：', message);
          },
          getState() {
            return undefined;
          },
          setState() {
            // noop
          }
        };
      console.log('[MinimalPanel] VSCode API 已准备就绪');

      const agentEmptyOverlay = document.getElementById('agent-empty-overlay');
      const agentEmptyAddBtn = document.getElementById('agent-empty-add-btn');
      const agentEmptyRefreshBtn = document.getElementById('agent-empty-refresh-btn');
      const sessionSelectEl = document.getElementById('session-select');
      const aceConfigForm = document.getElementById('ace-config-form');
      const aceBaseUrlInput = document.getElementById('ace-base-url');
      const aceTokenInput = document.getElementById('ace-token');
      const aceRefreshBtn = document.getElementById('ace-refresh-btn');
      const aceStatusBanner = document.getElementById('ace-status-banner');
      const aceSearchInput = document.getElementById('ace-search-query');
      const aceSearchBtn = document.getElementById('ace-search-btn');
      const aceSearchResultEl = document.getElementById('ace-search-result');
      const managerLLMForm = document.getElementById('manager-llm-form');
      const managerLLMBanner = document.getElementById('manager-llm-status-banner');
      const managerLLMProviderInput = document.getElementById('manager-llm-provider');
      const managerLLMModelInput = document.getElementById('manager-llm-model');
      const managerLLMBaseUrlInput = document.getElementById('manager-llm-base-url');
      const managerLLMApiKeyInput = document.getElementById('manager-llm-api-key');
      const managerLLMTemperatureInput = document.getElementById('manager-llm-temperature');
      const managerLLMMaxTokensInput = document.getElementById('manager-llm-max-tokens');
      const managerLLMSystemPromptInput = document.getElementById('manager-llm-system-prompt');
      const managerLLMReloadBtn = document.getElementById('manager-llm-reload');
      const managerLLMTestBtn = document.getElementById('manager-llm-test');
      let aceConfigData = null;
      let aceStatusTimer = null;
      let managerLLMConfig = null;

      function escapeHtml(value) {
        if (value === null || value === undefined) {
          return '';
        }
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }
      function setAgentEmptyOverlay(isEmpty) {
        if (!agentEmptyOverlay) {
          return;
        }
        if (isEmpty) {
          agentEmptyOverlay.classList.remove('hidden');
        } else {
          agentEmptyOverlay.classList.add('hidden');
        }
      }

      function updateAceStatusBanner(message, status = 'info') {
        if (!aceStatusBanner) {
          return;
        }
        aceStatusBanner.textContent = message;
        aceStatusBanner.className = `ace-status-banner ${status}`;
        if (aceStatusTimer) {
          clearTimeout(aceStatusTimer);
        }
        aceStatusTimer = setTimeout(() => {
          aceStatusBanner.className = 'ace-status-banner';
        }, 5000);
      }

      function updateAceStatusIndicator(isConnected, statusText) {
        const statusDot = document.getElementById('ace-status-dot');
        const statusTextEl = document.getElementById('ace-status-text');

        if (statusDot) {
          statusDot.className = 'status-dot';
          if (isConnected === true) {
            statusDot.classList.add('connected');
          } else if (isConnected === false) {
            statusDot.classList.add('disconnected');
          } else {
            statusDot.classList.add('loading');
          }
        }

        if (statusTextEl) {
          statusTextEl.textContent = statusText || '未知';
        }
      }

      // 基础配置常量与标签映射
      const ROLE_OPTIONS = [
        { value: 'admin', label: '管理员' },
        { value: 'developer', label: '开发者' },
        { value: 'reviewer', label: '审查者' },
        { value: 'tester', label: '测试者' },
        { value: 'security', label: '安全' },
        { value: 'documenter', label: '文档' },
        { value: 'coordinator', label: '协调者' },
        { value: 'analyzer', label: '分析者' }
      ];

      const CAPABILITY_OPTIONS = [
        { value: 'coding', label: 'Coding（编码）' },
        { value: 'analysis', label: 'Analysis（分析）' },
        { value: 'planning', label: 'Planning（规划）' },
        { value: 'testing', label: 'Testing（测试）' },
        { value: 'review', label: 'Review（审查）' },
        { value: 'security', label: 'Security（安全）' },
        { value: 'documentation', label: 'Documentation（文档）' },
        { value: 'devops', label: 'DevOps' }
      ];

      const TOOL_PERMISSION_OPTIONS = [
        { value: 'terminal_exec', label: '终端脚本' },
        { value: 'workspace_write', label: '工作区写入' },
        { value: 'mcp_tools', label: 'MCP 工具' },
        { value: 'web_fetch', label: 'Web 获取' },
        { value: 'context_engine', label: '上下文引擎' },
        { value: 'custom_tool', label: '自定义工具' }
      ];

      const ROLE_LABEL_MAP = ROLE_OPTIONS.reduce((map, item) => {
        map[item.value] = item.label;
        return map;
      }, {});

      const CAPABILITY_LABEL_MAP = CAPABILITY_OPTIONS.reduce((map, item) => {
        map[item.value] = item.label;
        return map;
      }, {});

      const TOOL_PERMISSION_LABEL_MAP = TOOL_PERMISSION_OPTIONS.reduce((map, item) => {
        map[item.value] = item.label;
        return map;
      }, {});

      const PERSONA_LABELS = {
        lead: '主持',
        reviewer: '评审',
        executor: '执行',
        moderator: '主持',
        user: '用户'
      };

      const ROLE_PERSONA_MAP = {
        coordinator: 'lead',
        product: 'lead',
        architect: 'lead',
        admin: 'lead',
        reviewer: 'reviewer',
        tester: 'reviewer',
        security: 'reviewer',
        qa: 'reviewer',
        developer: 'executor',
        documenter: 'executor',
        analyzer: 'executor',
        scribe: 'executor',
        implementer: 'executor'
      };

      const ROLE_DISPLAY_LABELS = {
        coordinator: '协调',
        product: '产品',
        architect: '架构',
        admin: '管理',
        reviewer: '评审',
        tester: '测试',
        security: '安全',
        developer: '研发',
        documenter: '文档',
        analyzer: '分析',
        scribe: '记录',
        qa: '测试',
        implementer: '执行'
      };

      const MESSAGE_TYPE_LABELS = {
        discussion: '讨论',
        requirement: '需求',
        warning: '告警',
        suggestion: '建议',
        question: '问题',
        decision: '决策'
      };

      const MESSAGE_TYPE_KEYWORDS = {
        requirement: ['需求', '实现', '开发', '完成', '功能', 'feature', '请实现', '帮我做', '新增', '修复'],
        warning: ['告警', '报警', '警告', '异常', '失败', '报错', 'error', '紧急', '崩溃', '故障'],
        suggestion: ['建议', '优化', '改进', 'idea', '推荐', '可否考虑'],
        question: ['怎么', '如何', '吗', '是否', '能否', '?', '？']
      };

      function getRoleText(role) {
        return ROLE_LABEL_MAP[role] || role || '未设置';
      }

      function getCapabilityText(capability) {
        return CAPABILITY_LABEL_MAP[capability] || capability || '未配置';
      }

      function getToolPermissionText(tool) {
        return TOOL_PERMISSION_LABEL_MAP[tool] || tool || '未授权';
      }

      function getSelectedRoles(form) {
        const chips = form?.querySelectorAll('#agent-roles-cloud .tag-chip.selected');
        if (!chips) return [];
        return Array.from(chips).map(chip => chip.dataset.role);
      }

      function setSelectedRoles(form, roles) {
        const roleSet = new Set(roles || []);
        const chips = form?.querySelectorAll('#agent-roles-cloud .tag-chip') || [];
        chips.forEach(chip => {
          if (roleSet.has(chip.dataset.role)) {
            chip.classList.add('selected');
          } else {
            chip.classList.remove('selected');
          }
        });
      }

      function getSelectedCapabilities(form) {
        const chips = form?.querySelectorAll('#agent-capabilities-cloud .tag-chip.selected');
        return chips ? Array.from(chips).map(chip => chip.dataset.capability) : [];
      }

      // 预留：工具权限选择。目前界面未提供具体选项，保持兼容以避免调用时报错。
      function setSelectedToolPermissions(form, permissions) {
        // 如果未来增加工具权限云，在此同步按钮选中状态
        const container = form?.querySelector('#agent-tool-permissions-cloud');
        if (!container) {
          return;
        }
        const permissionSet = new Set(permissions || []);
        const chips = container.querySelectorAll('.tag-chip');
        chips.forEach(chip => {
          if (permissionSet.has(chip.dataset.permission)) {
            chip.classList.add('selected');
          } else {
            chip.classList.remove('selected');
          }
        });
      }

      function setSelectedCapabilities(form, capabilities) {
        const capabilitySet = new Set(capabilities || []);
        const chips = form?.querySelectorAll('#agent-capabilities-cloud .tag-chip') || [];
        chips.forEach(chip => {
          const capability = chip.dataset.capability;
          if (capabilitySet.has(capability)) {
            chip.classList.add('selected');
          } else {
            chip.classList.remove('selected');
          }
        });
      }

      function getStatusText(status) {
        const normalized = (status || 'offline').toLowerCase();
        const map = {
          online: '在线',
          busy: '忙碌',
          running: '执行中',
          offline: '离线',
          stopped: '已停用',
          error: '异常',
          starting: '启动中'
        };
        return map[normalized] || status || '未知';
      }

      function getMessageVisibilityValue(message) {
        if (!message) {
          return 'blackboard';
        }
        if (message.visibility) {
          return message.visibility;
        }
        if ((message.agent_id || '').toLowerCase() === 'system') {
          return 'event_log';
        }
        return 'blackboard';
      }

      function getMessageCategoryValue(message) {
        if (message?.category) {
          return message.category;
        }
        const agentId = (message?.agent_id || '').toLowerCase();
        if (agentId === 'user' || agentId.startsWith('human')) {
          return 'user';
        }
        if (agentId === 'system') {
          return 'system_event';
        }
        return 'agent_summary';
      }

      function deriveEventSeverityFromMessage(message) {
        if (!message) {
          return 'info';
        }
        if (message.priority === 'high') {
          return 'critical';
        }
        // 默认返回 info，优先级已经在上面处理
        return 'info';
      }

      function buildEventMetaPartsFromMessage(message) {
        const meta = [];
        if (message?.reference_type === 'task' && message.reference_id) {
          meta.push(`任务 ${message.reference_id}`);
        }
        if (Array.isArray(message?.tags) && message.tags.length > 0) {
          meta.push(...message.tags);
        }
        return meta.length ? meta : ['系统事件'];
      }

      function getAgentAvatarColor(agentId) {
        const colors = ['blue', 'green', 'purple', 'orange'];
        if (!agentId) {
          return colors[0];
        }
        const index = allAgents.findIndex(a => a.id === agentId);
        return colors[Math.abs(index) % colors.length];
      }

      function getAgentName(agentId) {
        if (!agentId) {
          return '系统';
        }
        const normalized = String(agentId).toLowerCase();
        if (normalized === 'user' || normalized === 'customer') {
          return '用户';
        }
        if (normalized === 'system') {
          return '系统';
        }
        const agent = allAgents.find(a => a.id === agentId);
        return agent ? agent.display_name : agentId;
      }

      function buildMessageDirectBadge(message) {
        const mentions = Array.isArray(message?.mentions) ? message.mentions.filter(Boolean) : [];
        if (!mentions.length) {
          return '';
        }
        const displayMentions = mentions.slice(0, 2).map(id => getAgentName(id));
        const overflow = mentions.length > 2 ? ` +${mentions.length - 2}` : '';
        const title = `直达：${mentions.map(id => getAgentName(id)).join('、')}`;
        return `<span class="message-direct-badge" title="${escapeHtml(title)}">@${escapeHtml(displayMentions.join('、'))}${overflow}</span>`;
      }

      function buildPersonaBadgeHtml(persona) {
        if (!persona) {
          return '';
        }
        return `<span class="message-role-badge persona-${persona.key}">${escapeHtml(persona.label)}</span>`;
      }

      function resolveMessagePersona(message) {
        if (!message) {
          return null;
        }
        const agentId = (message.agent_id || '').toLowerCase();
        if (agentId === 'system') {
          return { key: 'moderator', label: PERSONA_LABELS.moderator };
        }
        if (agentId === 'user' || agentId === 'customer') {
          return { key: 'user', label: PERSONA_LABELS.user };
        }
        const references = parseMessageReferences(message.references || message);
        const taskRef = references.find(ref => ref.type === 'task');
        if (taskRef) {
          const taskPersona = derivePersonaFromTask(getTaskById(taskRef.id));
          if (taskPersona) {
            return taskPersona;
          }
        }
        const agent = allAgents.find(agent => agent.id === message.agent_id);
        if (agent) {
          const persona = derivePersonaFromAgent(agent);
          if (persona) {
            return persona;
          }
        }
        return null;
      }

      function buildMessagePersonaBadge(message) {
        const persona = resolveMessagePersona(message);
        if (!persona) {
          return '';
        }
        return buildPersonaBadgeHtml(persona);
      }

      // 消息滚动相关
      let isUserScrolling = false;
      let hasNewMessages = false;

      function isAtBottom(container) {
        if (!container) return false;
        const threshold = 50;
        return container.scrollHeight - container.scrollTop - container.clientHeight < threshold;
      }

      function scrollToBottom(container, smooth = true) {
        if (!container) return;
        container.scrollTo({
          top: container.scrollHeight,
          behavior: smooth ? 'smooth' : 'auto'
        });
      }

      function showNewMessageButton() {
        const btn = document.getElementById('new-message-indicator');
        if (btn) btn.style.display = 'block';
      }

      function hideNewMessageButton() {
        const btn = document.getElementById('new-message-indicator');
        if (btn) btn.style.display = 'none';
      }

      window.scrollToBottomAndHide = function () {
        const container = document.getElementById('messages-list');
        scrollToBottom(container, true);
        isUserScrolling = false;
        hasNewMessages = false;
        hideNewMessageButton();
      };

      // 消息引用解析与卡片构建
      function getReferenceTypeLabel(type) {
        switch (type) {
          case 'task':
            return '任务';
          case 'file':
            return '文件';
          case 'message':
            return '消息';
          default:
            return '引用';
        }
      }

      function buildReferenceToken(type, id) {
        if (!type) {
          return id;
        }
        return `${type}:${id}`;
      }

      function parseReferenceToken(value) {
        if (!value || typeof value !== 'string') {
          return null;
        }
        const colonIndex = value.indexOf(':');
        if (colonIndex === -1) {
          if (getTaskById(value)) {
            return { type: 'task', id: value, token: `task:${value}` };
          }
          if (getFileChangeById(value)) {
            return { type: 'file', id: value, token: `file:${value}` };
          }
          return { type: 'message', id: value, token: value };
        }
        const type = value.slice(0, colonIndex);
        const id = value.slice(colonIndex + 1);
        return { type: type || 'message', id, token: value };
      }

      function parseMessageReferences(message) {
        if (!message) {
          return [];
        }
        const references = Array.isArray(message.references)
          ? message.references
          : (typeof message.references === 'string' ? safeParseArray(message.references) : []);
        const tokens = references.length ? references : legacyMessageReferences(message);
        return tokens
          .map(token => parseReferenceToken(token))
          .filter(Boolean);
      }

      function legacyMessageReferences(message) {
        const tokens = [];
        if (message.reference_type && message.reference_id) {
          tokens.push(`${message.reference_type}:${message.reference_id}`);
        } else if (message.reference_id) {
          tokens.push(message.reference_id);
        }
        return tokens;
      }

      function safeParseArray(value) {
        try {
          const parsed = JSON.parse(value);
          return Array.isArray(parsed) ? parsed : [];
        } catch {
          return [];
        }
      }

      function getTaskById(taskId) {
        if (!taskId) {
          return null;
        }
        const pool = sessionTasks && sessionTasks.length > 0 ? sessionTasks : allTasks;
        return pool.find(task => task.id === taskId) || null;
      }

      function getTaskStatusLabel(status) {
        const normalized = (status || '').toLowerCase();
        const map = {
          pending: '待办',
          queued: '排队',
          assigned: '已分配',
          running: '进行中',
          completed: '已完成',
          failed: '失败',
          blocked: '阻塞',
          paused: '已暂停'
        };
        return map[normalized] || normalized || '未知状态';
      }

      function getFileChangeById(changeId) {
        if (!changeId) {
          return null;
        }
        return allFileChanges.find(change => String(change.id) === String(changeId)) || null;
      }

      function getPhaseTitle(phaseId) {
        return phaseId || '未知阶段';
      }

      function buildReferenceItemMeta(ref) {
        if (!ref || !ref.id) {
          return null;
        }
        const token = ref.token || buildReferenceToken(ref.type, ref.id);
        if (ref.type === 'task') {
          const task = getTaskById(ref.id);
          if (!task) {
            return {
              token,
              type: ref.type,
              id: ref.id,
              title: `任务 ${ref.id}`,
              subtitle: '任务不可用'
            };
          }
          return {
            token,
            type: ref.type,
            id: ref.id,
            title: getTaskDisplayTitle(task),
            subtitle: `状态：${getTaskStatusLabel(task.status)}`
          };
        }
        if (ref.type === 'file') {
          const change = getFileChangeById(ref.id);
          if (!change) {
            return {
              token,
              type: ref.type,
              id: ref.id,
              title: `文件变更 ${ref.id}`,
              subtitle: '记录不可用'
            };
          }
          const summary = change.change_type
            ? `${change.change_type.toUpperCase()} · ${formatTime(change.created_at)}`
            : formatTime(change.created_at);
          return {
            token,
            type: ref.type,
            id: ref.id,
            title: change.file_path || `变更 ${change.id}`,
            subtitle: summary
          };
        }
        if (ref.type === 'message') {
          const quotedMsg = allMessages.find(m => m.id === ref.id);
          return {
            token,
            type: ref.type,
            id: ref.id,
            title: quotedMsg ? getAgentName(quotedMsg.agent_id) : `消息 ${ref.id}`,
            subtitle: quotedMsg ? (quotedMsg.content || '').slice(0, 40) : ''
          };
        }
        return {
          token,
          type: ref.type || 'custom',
          id: ref.id,
          title: `${ref.type || '引用'} ${ref.id}`,
          subtitle: ''
        };
      }

      function buildMessageReferenceCard(ref) {
        if (!ref || ref.type === 'message') {
          return '';
        }
        const meta = buildReferenceItemMeta(ref);
        if (!meta) {
          return '';
        }
        const personaBadge = ref.type === 'task'
          ? buildPersonaBadgeHtml(derivePersonaFromTask(getTaskById(ref.id)))
          : '';
        const headerTools = `
          <div style="display:flex;align-items:center;gap:6px;">
            ${personaBadge || ''}
            <button data-action="openReferenceTarget"
                    data-reference-type="${ref.type}"
                    data-reference-id="${ref.id}">
              查看
            </button>
          </div>
        `;
        return `
          <div class="message-reference-card">
            <div class="message-reference-card-header">
              <span>${escapeHtml(getReferenceTypeLabel(ref.type))}</span>
              ${headerTools}
            </div>
            <div class="message-reference-card-title">${escapeHtml(meta.title)}</div>
            ${meta.subtitle ? `<div style="color: var(--vscode-descriptionForeground);">${escapeHtml(meta.subtitle)}</div>` : ''}
          </div>
        `;
      }

      function handleAceConfigPayload(payload) {
        populateAceConfigForm(payload || null);
      }

      function populateAceConfigForm(config) {
        aceConfigData = config || null;
        if (!aceConfigForm) {
          return;
        }
        if (!config) {
          if (aceBaseUrlInput) aceBaseUrlInput.value = '';
          if (aceTokenInput) aceTokenInput.value = '';
          updateAceStatusBanner('ACE 配置信息未加载', 'error');
          updateAceStatusIndicator(false, '未配置');
          return;
        }
        if (aceBaseUrlInput) {
          aceBaseUrlInput.value = config.baseUrl || '';
        }
        if (aceTokenInput) {
          aceTokenInput.value = config.token || '';
        }

        const isConfigured = config.baseUrl && config.token;
        const statusText = isConfigured
          ? `已连接 - ${config.baseUrl}`
          : '未完整配置';
        updateAceStatusBanner(
          isConfigured ? `ACE 已配置并连接到 ${config.baseUrl}` : 'ACE 需要配置 Base URL 和 Token',
          isConfigured ? 'success' : 'info'
        );
        updateAceStatusIndicator(isConfigured, statusText);
      }

      function updateManagerLLMStatusBanner(message, status = 'info') {
        if (!managerLLMBanner) {
          return;
        }
        managerLLMBanner.textContent = message;
        managerLLMBanner.className = `ace-status-banner ${status}`;
      }

      function handleManagerLLMConfigPayload(config) {
        managerLLMConfig = config || null;
        const resolved = managerLLMConfig || {
          provider: 'claude',
          model: '',
          base_url: '',
          api_key: '',
          temperature: 0.4,
          max_output_tokens: 2048,
          system_prompt: ''
        };
        if (managerLLMProviderInput) {
          managerLLMProviderInput.value = resolved.provider || 'claude';
        }
        if (managerLLMModelInput) {
          managerLLMModelInput.value = resolved.model || '';
        }
        if (managerLLMBaseUrlInput) {
          managerLLMBaseUrlInput.value = resolved.base_url || '';
        }
        if (managerLLMApiKeyInput) {
          managerLLMApiKeyInput.value = resolved.api_key || '';
        }
        if (managerLLMTemperatureInput) {
          managerLLMTemperatureInput.value = typeof resolved.temperature === 'number' ? resolved.temperature.toString() : '0.4';
        }
        if (managerLLMMaxTokensInput) {
          managerLLMMaxTokensInput.value = typeof resolved.max_output_tokens === 'number' ? resolved.max_output_tokens.toString() : '2048';
        }
        if (managerLLMSystemPromptInput) {
          managerLLMSystemPromptInput.value = resolved.system_prompt || '';
        }
        const ready = Boolean(resolved.api_key && resolved.model);
        updateManagerLLMStatusBanner(
          ready ? `已配置 ${resolved.provider || '自定义'} · ${resolved.model}` : '请完善模型与 API Key',
          ready ? 'success' : 'error'
        );
        renderManagerStatusStrip();
      }

      function requestAceConfig() {
        vscode.postMessage({ type: 'get_ace_config' });
      }

      function requestManagerLLMConfig() {
        vscode.postMessage({ type: 'get_manager_llm_config' });
      }

      function deriveMessageTaskBacklog(message) {
        if (!message || !Array.isArray(taskBacklogSummaries)) {
          return null;
        }
        const payloadPlanId = message.payload?.source_task_id;
        if (payloadPlanId) {
          const match = taskBacklogSummaries.find(summary =>
            summary.source_task_id === payloadPlanId && summary.session_id === message.session_id
          );
          if (match) {
            return match;
          }
        }
        const references = parseMessageReferences(message);
        const taskRef = references.find(ref => ref.type === 'task');
        if (taskRef) {
          const link = taskBacklogSummaries.find(summary => summary.session_id === message.session_id && summary.id === `plan_source:${taskRef.id}`);
          if (link) {
            return link;
          }
        }
        return null;
      }

      function buildBacklogSummarySnippet(summary) {
        if (!summary || !summary.total) {
          return '';
        }
        const remaining = Math.max(summary.total - summary.completed, 0);
        return `
          <div class="task-progress-card" style="margin-top: 8px;">
            <div class="task-progress-card-head">
              <span class="task-progress-card-title">${escapeHtml(summary.title)}</span>
              <span class="task-progress-count">${summary.completed}/${summary.total}</span>
            </div>
            <div class="task-progress-meter"><span style="width:${summary.total ? Math.min(100, Math.round((summary.completed / summary.total) * 100)) : 0}%"></span></div>
            <div class="task-progress-meta">剩余 ${remaining}${blockedLabel}</div>
            <div class="task-progress-actions">
              <button data-action="focusBacklogSummary" data-summary-id="${summary.id}">详情</button>
            </div>
          </div>
        `;
      }

      function focusBacklogSummary(summaryId) {
        if (summaryId) {
          taskSummaryFilter = summaryId;
        } else {
          taskSummaryFilter = null;
        }
        renderTasks(allTasks);
        const tasksPanel = document.getElementById('panel-tasks');
        if (tasksPanel) {
          tasksPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      function rerenderSessionPanels() {
        renderTasks(allTasks);
        renderMessages(allMessages);
        renderNotifications(allNotifications);
        renderFileChanges(allFileChanges);
        const agent = selectedAgentId ? allAgents.find(a => a.id === selectedAgentId) : null;
        renderWorkspace(agent || null);
      }

      function requestTaskMetrics(options = {}) {
        if (options.showLoading) {
          resetTaskMetricsTile('同步中...');
        }
        if (typeof currentSessionId !== 'undefined' && currentSessionId) {
          vscode.postMessage({ type: 'get_task_metrics', data: { session_id: currentSessionId } });
        } else {
          vscode.postMessage({ type: 'get_task_metrics' });
        }
      }

      function scheduleTaskMetricsRefresh(delay = 800) {
        if (taskMetricsRefreshTimer) {
          clearTimeout(taskMetricsRefreshTimer);
        }
        taskMetricsRefreshTimer = window.setTimeout(() => {
          taskMetricsRefreshTimer = null;
          requestTaskMetrics();
        }, delay);
      }

      function resetSessionScopedState(nextSessionId) {
        allTasks = [];
        sessionTasks = []; allMessages = [];
        allAssists = [];
        allNotifications = [];
        allFileChanges = []; allThinkingLogs = [];
        taskDependencyGraph = buildTaskDependencyGraph([]);
        latestTaskMetrics = null;
        latestTaskMetricsSessionId = null;
      }

      function refreshSessionScopedData(options = {}) {
        if (!currentSessionId) {
          console.log('[MinimalPanel] Skip refreshing session data: no active session');
          rerenderSessionPanels();
          return;
        }
        console.log('[MinimalPanel] Refreshing data for session:', currentSessionId, options.reason || '');
        const payload = { session_id: currentSessionId };
        const showLoading = options.showLoading !== false;
        vscode.postMessage({ type: 'get_tasks', data: payload });
        vscode.postMessage({ type: 'get_messages', data: payload });
        vscode.postMessage({ type: 'get_notifications', data: payload });
        vscode.postMessage({ type: 'get_tool_runs', data: payload });
        vscode.postMessage({ type: 'get_assists', data: payload });
        vscode.postMessage({ type: 'get_file_changes', data: payload }); vscode.postMessage({
          type: 'get_thinking_logs',
          data: { filters: { session_id: currentSessionId, limit: WORKSPACE_THINKING_LIMIT } }
        }); requestTaskMetrics({ showLoading });
      }

      function requestMessagesSnapshot(reason = 'manual') {
        if (!currentSessionId) {
          console.warn('[MinimalPanel] Skip requesting messages snapshot:', reason, '- no active session');
          return;
        }
        console.log('[MinimalPanel] Requesting messages snapshot:', currentSessionId, reason);
        vscode.postMessage({
          type: 'get_messages',
          data: { session_id: currentSessionId }
        });
      }

      function requestToolRunsSnapshot() {
        if (!currentSessionId) {
          console.warn('[MinimalPanel] Skip requesting tool runs - no active session');
          return;
        }
        vscode.postMessage({
          type: 'get_tool_runs',
          data: { session_id: currentSessionId }
        });
      }

      function runToolCommand() {
        const input = document.getElementById('tool-run-command-input');
        if (!input) return;
        const command = input.value.trim();
        if (!command) {
          updateStatus('请输入要执行的命令');
          return;
        }
        const payload = { command };
        if (currentSessionId) {
          payload.session_id = currentSessionId;
        }
        vscode.postMessage({
          type: 'run_tool_command',
          data: payload
        });
        input.value = '';
        updateStatus('命令已发送执行');
      }

      function renderMcpServerSelect() {
        const select = document.getElementById('mcp-server-select');
        if (!select) return;
        const options = Array.isArray(allMcpServers) ? allMcpServers : [];
        select.innerHTML = '<option value=\"\">选择 MCP Server 运行</option>' + options
          .map(server => `<option value=\"${server.id}\">${escapeHtml(server.name || 'Server ' + server.id)}</option>`)
          .join('');
      }

      function renderMcpToolSelect(serverId) {
        const select = document.getElementById('mcp-tool-select');
        if (!select) return;
        if (!serverId) {
          select.innerHTML = '<option value=\"\">选择 MCP 工具</option>';
          select.disabled = true;
          return;
        }
        const tools = mcpToolsCache.get(serverId) || [];
        if (!tools.length) {
          select.innerHTML = '<option value=\"\">当前服务未加载工具</option>';
          select.disabled = true;
          return;
        }
        select.innerHTML = '<option value=\"\">选择 MCP 工具</option>' + tools
          .map(tool => `<option value=\"${tool.name || tool.id}\">${escapeHtml(tool.name || tool.id)}</option>`)
          .join('');
        select.disabled = false;
      }

      function getSelectedMcpServerId() {
        const select = document.getElementById('mcp-server-select');
        if (!select) return null;
        const value = select.value;
        if (!value) {
          return null;
        }
        const parsed = Number(value);
        return Number.isNaN(parsed) ? null : parsed;
      }

      function runMcpPing() {
        const select = document.getElementById('mcp-server-select');
        if (!select) return;
        const serverId = select.value ? Number(select.value) : null;
        if (!serverId && serverId !== 0) {
          updateStatus('请选择 MCP Server');
          return;
        }
        vscode.postMessage({
          type: 'run_mcp_ping',
          data: { server_id: serverId }
        });
      }

      function refreshMcpTools(serverId) {
        const targetId = typeof serverId === 'number' ? serverId : getSelectedMcpServerId();
        if (targetId === null) {
          updateStatus('请选择 MCP Server');
          return;
        }
        pendingMcpRefresh.add(Number(targetId));
        vscode.postMessage({
          type: 'list_mcp_tools',
          data: { server_id: targetId }
        });
        renderMcpServers(allMcpServers);
      }

      function handleMcpServerChange() {
        const serverId = getSelectedMcpServerId();
        renderMcpToolSelect(serverId);
        if (serverId && !mcpToolsCache.has(serverId)) {
          refreshMcpTools(serverId);
        }
      }

      function renderMcpToolResult(payload) {
        const resultEl = document.getElementById('mcp-tool-result');
        if (!resultEl) return;
        if (!payload) {
          resultEl.textContent = '';
          resultEl.className = 'mcp-tool-result';
          return;
        }
        const { tool, serverId, error, result, status } = payload;
        const statusText = status === 'running' ? '执行中...' : '';
        if (error) {
          resultEl.textContent = `MCP ${serverId ?? ''} ${tool || ''} 失败：${error}`;
          resultEl.className = 'mcp-tool-result error';
          return;
        }
        const text = typeof result === 'string'
          ? result
          : JSON.stringify(result ?? {}, null, 0);
        resultEl.textContent = statusText ? statusText : `MCP ${serverId ?? ''} ${tool || ''} 成功：${text || '无返回'}`;
        resultEl.className = 'mcp-tool-result success';
      }

      function runMcpTool() {
        const serverId = getSelectedMcpServerId();
        if (serverId === null) {
          updateStatus('请选择 MCP Server');
          return;
        }
        const toolSelect = document.getElementById('mcp-tool-select');
        const toolName = toolSelect && toolSelect.value ? toolSelect.value.trim() : '';
        const argsInput = document.getElementById('mcp-tool-args');
        let args = {};
        if (argsInput) {
          const raw = argsInput.value.trim();
          if (raw) {
            try {
              args = JSON.parse(raw);
            } catch (err) {
              updateStatus('工具参数必须是合法的 JSON');
              return;
            }
          }
        }
        if (!toolName) {
          updateStatus('请选择 MCP 工具');
          return;
        }
        renderMcpToolResult({ serverId, tool: toolName, status: 'running' });
        vscode.postMessage({
          type: 'run_mcp_tool',
          data: { server_id: serverId, tool: toolName, args, session_id: currentSessionId || null }
        });
      }

      function setCurrentSession(nextSessionId, options = {}) {
        const normalized = typeof nextSessionId === 'string' && nextSessionId.trim().length > 0
          ? nextSessionId.trim()
          : null;
        const changed = normalized !== currentSessionId;
        if (!changed && !options.forceRender) {
          if (options.forceFetch && normalized) {
            refreshSessionScopedData({
              reason: options.reason || 'session-refresh',
              showLoading: options.showLoading !== false
            });
          }
          return false;
        }
        if (changed) {
          resetSessionScopedState(normalized);
        }
        currentSessionId = normalized;
        renderBlackboardSessions(blackboardSessions);
        rerenderSessionPanels();
        if (!normalized) {
          requestTaskMetrics({ showLoading: true });
        }
        if (!options.skipFetch && normalized) {
          refreshSessionScopedData({
            reason: options.reason || 'session-change',
            showLoading: true
          });
        }
        return changed;
      }

      function ensureActiveSession() {
        if (currentSessionId) {
          return currentSessionId;
        }
        const autoId = `session-${Date.now()}`;
        console.log('[MinimalPanel] Auto creating session:', autoId);
        sessionIdToAutoSelect = autoId;
        setCurrentSession(autoId, { skipFetch: true, reason: 'auto-create', forceRender: true });
        vscode.postMessage({ type: 'create_session', data: { id: autoId } });
        updateStatus(`已自动创建会话 ${autoId}`);
        return autoId;
      }

      function applySessionsPayload(sessions) {
        const normalizedSessions = Array.isArray(sessions) ? sessions : [];
        const previousSessionId = currentSessionId;
        blackboardSessions = normalizedSessions;
        const hasSessions = normalizedSessions.length > 0;
        let targetSessionId = currentSessionId;

        if (sessionIdToAutoSelect && normalizedSessions.some(item => item.id === sessionIdToAutoSelect)) {
          targetSessionId = sessionIdToAutoSelect;
          sessionIdToAutoSelect = null;
        }

        if (targetSessionId && !normalizedSessions.some(item => item.id === targetSessionId)) {
          targetSessionId = hasSessions ? normalizedSessions[0].id : null;
        } else if (!targetSessionId && hasSessions) {
          targetSessionId = normalizedSessions[0].id;
        } else if (!hasSessions) {
          targetSessionId = null;
        }

        const shouldFetch = !!targetSessionId && targetSessionId !== previousSessionId;
        const changed = setCurrentSession(targetSessionId, {
          skipFetch: !shouldFetch,
          forceRender: true,
          reason: 'sessions-update'
        });

        if (!targetSessionId) {
          console.log('[MinimalPanel] No sessions available, waiting for creation');
          return;
        }

        if (!changed && !shouldFetch && !previousSessionId && targetSessionId) {
          refreshSessionScopedData({ reason: 'sessions-init', showLoading: true });
        }
      }

      if (agentEmptyAddBtn) {
        agentEmptyAddBtn.addEventListener('click', () => {
          window.openGlobalAgentTab();
          if (typeof window.addAgent === 'function') {
            window.addAgent();
          }
        });
      }

      if (agentEmptyRefreshBtn) {
        agentEmptyRefreshBtn.addEventListener('click', () => {
          vscode.postMessage({ type: 'get_agents' });
        });
      }

      if (aceConfigForm) {
        aceConfigForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const payload = {
            baseUrl: aceBaseUrlInput ? aceBaseUrlInput.value.trim() : '',
            token: aceTokenInput ? aceTokenInput.value.trim() : ''
          };
          updateAceStatusBanner('正在保存 ACE 配置...', 'info');
          updateAceStatusIndicator(null, '保存中...');
          vscode.postMessage({ type: 'update_ace_config', data: payload });
        });
      }

      // ACE 刷新按钮（表单内）
      if (aceRefreshBtn) {
        aceRefreshBtn.addEventListener('click', () => {
          updateAceStatusBanner('正在刷新 ACE 索引...', 'info');
          updateAceStatusIndicator(null, '刷新中...');
          vscode.postMessage({ type: 'ace_refresh_index' });
        });
      }

      // ACE 刷新按钮（头部）
      // ACE 测试连接按钮
      const aceTestConnectionBtn = document.getElementById('ace-test-connection');
      if (aceTestConnectionBtn) {
        aceTestConnectionBtn.addEventListener('click', () => {
          updateAceStatusBanner('正在测试连接...', 'info');
          updateAceStatusIndicator(null, '测试中...');
          vscode.postMessage({ type: 'ace_test_connection' });
        });
      }

      // ACE 搜索按钮
      if (aceSearchBtn) {
        aceSearchBtn.addEventListener('click', () => {
          const query = aceSearchInput ? aceSearchInput.value.trim() : '';
          if (!query) {
            updateAceStatusBanner('请输入搜索关键词', 'error');
            return;
          }
          aceSearchResultEl.textContent = '正在搜索...';
          vscode.postMessage({ type: 'ace_search', data: { query } });
        });
      }

      // ACE 搜索输入框回车
      if (aceSearchInput) {
        aceSearchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            aceSearchBtn?.click();
          }
        });
      }

      if (managerLLMForm) {
        managerLLMForm.addEventListener('submit', (event) => {
          event.preventDefault();
          const payload = {
            provider: managerLLMProviderInput ? managerLLMProviderInput.value.trim() || 'claude' : 'claude',
            model: managerLLMModelInput ? managerLLMModelInput.value.trim() : '',
            base_url: managerLLMBaseUrlInput ? managerLLMBaseUrlInput.value.trim() : '',
            api_key: managerLLMApiKeyInput ? managerLLMApiKeyInput.value.trim() : '',
            temperature: managerLLMTemperatureInput ? Number.parseFloat(managerLLMTemperatureInput.value) || 0.4 : 0.4,
            max_output_tokens: managerLLMMaxTokensInput ? Number.parseInt(managerLLMMaxTokensInput.value, 10) || 2048 : 2048,
            system_prompt: managerLLMSystemPromptInput ? managerLLMSystemPromptInput.value : ''
          };
          updateManagerLLMStatusBanner('正在保存配置...', 'info');
          vscode.postMessage({ type: 'update_manager_llm_config', data: payload });
        });
      }

      if (managerLLMReloadBtn) {
        managerLLMReloadBtn.addEventListener('click', () => {
          updateManagerLLMStatusBanner('正在重新加载配置...', 'info');
          requestManagerLLMConfig();
        });
      }
      if (managerLLMTestBtn) {
        managerLLMTestBtn.addEventListener('click', () => {
          updateManagerLLMStatusBanner('正在测试经理模型...', 'info');
          vscode.postMessage({ type: 'test_manager_llm' });
        });
      }

      const workspaceSendBtn = document.getElementById('workspace-send-btn');
      if (workspaceSendBtn) {
        workspaceSendBtn.addEventListener('click', () => {
          window.sendWorkspaceMessage();
        });
      }
      const workspaceInputEl = document.getElementById('workspace-input');
      if (workspaceInputEl) {
        let workspaceInputComposing = false;
        workspaceInputEl.addEventListener('compositionstart', () => {
          workspaceInputComposing = true;
        });
        workspaceInputEl.addEventListener('compositionend', () => {
          workspaceInputComposing = false;
        });
        workspaceInputEl.addEventListener('keydown', (e) => {
          if (workspaceInputComposing || e.isComposing) {
            return;
          }
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            window.sendWorkspaceMessage();
          }
        });
      }

      // ACE 命令面板按钮
      if (sessionSelectEl) {
        sessionSelectEl.addEventListener('change', (event) => {
          const target = event.target;
          const value = target ? target.value : '';
          window.switchBlackboardSession(value || null);
        });
      }

      document.querySelectorAll('.file-change-filter-btn').forEach(btn => {
        btn.addEventListener('click', (event) => {
          const target = event.currentTarget;
          if (!(target instanceof HTMLElement)) {
            return;
          }
          const filter = target.getAttribute('data-filter') || 'all';
          window.setFileChangeFilter(filter);
        });
      });

      const taskFilterInput = document.getElementById('file-change-task-filter');
      if (taskFilterInput) {
        taskFilterInput.addEventListener('input', (event) => {
          const target = event.target;
          const value = target && target.value ? target.value.trim() : '';
          window.setFileChangeTaskFilter(value, { skipInputSync: true });
        });
      }

      const agentFilterInput = document.getElementById('file-change-agent-filter');
      if (agentFilterInput) {
        agentFilterInput.addEventListener('input', (event) => {
          const target = event.target;
          const value = target && target.value ? target.value.trim() : '';
          window.setFileChangeAgentFilter(value);
        });
      }

      // ✅ 初始化管理器 - 防御性编程
      // LLM Presets 配置
      const LLM_PRESETS = {
        claude: {
          name: 'Claude (Anthropic)',
          models: ['claude-4.5-sonnet', 'claude-4.5-haiku', 'claude-3.5-sonnet', 'claude-3.5-haiku', 'claude-3-opus'],
          defaultModel: 'claude-4.5-sonnet',
          requiresApiKey: true,
          baseURL: 'https://api.anthropic.com'
        },
        openai: {
          name: 'OpenAI',
          models: ['gpt-5', 'gpt-5-codex', 'gpt-4o', 'gpt-4-turbo'],
          defaultModel: 'gpt-5',
          requiresApiKey: true,
          baseURL: 'https://api.openai.com/v1'
        },
        glm: {
          name: 'GLM (智谱AI)',
          models: ['glm-4.6', 'glm-4-Long', 'glm-4-Air'],
          defaultModel: 'glm-4.6',
          requiresApiKey: true,
          baseURL: ' https://open.bigmodel.cn/api/coding/paas/v4'
        },
        gemini: {
          name: 'Gemini (Google)',
          models: ['gemini-2.5-pro', 'gemini-1.5-flash', 'gemini-1.5-flash-8b'],
          defaultModel: 'gemini-2.5-pro',
          requiresApiKey: true,
          baseURL: 'https://generativelanguage.googleapis.com/v1beta/openai/'
        },
        custom: {
          name: '自定义 (OpenAI 兼容)',
          models: [],
          defaultModel: '',
          requiresApiKey: true,
          baseURL: ''
        }
      };

      function updateStatus(text) {
        console.log('[MinimalPanel] Status:', text);
      }

      // Global state
      function renderAgents(agents) {
        allAgents = agents || [];
        const container = document.getElementById('agents-list');
        const statsEl = document.getElementById('agent-stats');
        const hasAgents = allAgents.length > 0;
        const activeAgents = allAgents.filter(agent => agent.is_enabled !== false);
        const hasActive = activeAgents.length > 0;
        setAgentEmptyOverlay(!hasAgents);

        const panelHintHtml = '<div class="panel-inline-hint">提示：Agent 配置统一在「全局配置」页签维护。</div>';

        if (!hasAgents) {
          container.innerHTML = panelHintHtml + '<div class="empty-state">暂无 Agent</div>';
          if (statsEl) statsEl.textContent = '';
          renderWorkspace(null);
          renderGlobalAgentTable(allAgents);
          return;
        }

        if (!hasActive) {
          container.innerHTML = panelHintHtml + '<div class="empty-state">所有 Agent 均已停用，请先在全局配置页签启用。</div>';
          if (statsEl) statsEl.textContent = '0 / 0 在线';
          renderWorkspace(null);
          renderGlobalAgentTable(allAgents);
          return;
        }

        const sortedAgents = [...activeAgents].sort((a, b) => {
          if (a.status === 'online' && b.status !== 'online') return -1;
          if (a.status !== 'online' && b.status === 'online') return 1;
          return b.created_at - a.created_at;
        });

        const onlineCount = activeAgents.filter(a => a.status === 'online').length;
        if (statsEl) statsEl.textContent = onlineCount + ' / ' + activeAgents.length + ' 在线';

        const displayAgents = sortedAgents.slice(0, 6);
        if (!selectedAgentId && displayAgents.length > 0) {
          selectedAgentId = displayAgents[0].id;
        }

        const cardsHtml = displayAgents.map(agent => {
          const isSelected = selectedAgentId === agent.id;
          const statusClass = agent.status === 'online' ? 'agent-status-online' :
            agent.status === 'busy' ? 'agent-status-busy' :
              'agent-status-offline';

          return `
            <div class="agent-card ${isSelected ? 'selected' : ''}" data-agent-id="${agent.id}" onclick="selectAgent('${agent.id}', event)">
              <div class="agent-card-header">
                <div class="agent-card-name">
                  <div class="agent-status-dot ${statusClass}"></div>
                  <span class="agent-name-text">${agent.display_name} (${agent.id})</span>
                </div>
              </div>
              <div class="agent-card-footer">
                <span class="agent-heartbeat">${formatTime(agent.last_heartbeat_at)}</span>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = panelHintHtml + cardsHtml;

        const selectedAgent = allAgents.find(agent => agent.id === selectedAgentId);
        renderWorkspace(selectedAgent || null);
        renderGlobalAgentTable(allAgents);
      }
      let currentSessionId = null;
      let allAgents = [];
      let allTasks = [];
      let sessionTasks = [];
      let taskBacklogSummaries = [];
      let taskSummaryFilter = null;
      let allMessages = [];
      let allAssists = [];
      let allThinkingLogs = [];
      let allToolRuns = [];
      let target = null;
      let aceStateData = null;
      const llmStreamStates = new Map();
      function buildTaskDependencyGraph(tasks) {
        if (!Array.isArray(tasks)) return new Map();
        const map = new Map();
        tasks.forEach(() => { });
        return map;
      }
      const THINKING_TYPE_OPTIONS = [
        { key: 'thought', label: '思考' },
        { key: 'tool', label: '工具' },
        { key: 'file', label: '文件' },
        { key: 'feedback', label: '反馈' }
      ];
      const DEFAULT_THINKING_TYPE_KEYS = THINKING_TYPE_OPTIONS.map(opt => opt.key);
      let workspaceThinkingTypeFilters = new Set(DEFAULT_THINKING_TYPE_KEYS);
      let allFileChanges = [];
      let selectedAgentId = null;
      let taskFilter = 'all';
      let currentMainTab = 'blackboard';
      let currentBlackboardView = 'discussion';
      let currentWorkspaceTab = 'overview'; // 保留变量以避免事件引用报错
      let workspaceThinkingScope = 'all';
      let workspaceThinkingSearch = '';
      let replyToMessage = null;
      let quotedMessage = null;
      const orchestrationEvents = [];
      let blackboardEventEntries = [];
      const MAX_ORCHESTRATION_EVENTS = 40;
      const ORCHESTRATION_EVENT_FILTERS = ['scheduler', 'sentinel', 'system'];
      let orchestrationEventFilter = new Set(ORCHESTRATION_EVENT_FILTERS);
      let notificationLevelFilters = new Set(['info', 'success', 'warning', 'error']);
      let notificationUnreadOnly = false;
      const mentionState = {
        active: false,
        startIndex: -1,
        prefix: '',
        hideTimer: null
      };
      function extractMentionsFromText(text) {
        if (!text) return [];
        const matches = text.match(/@([a-zA-Z0-9._\\-]+)/g);
        if (!matches) return [];
        const uniq = new Set();
        matches.forEach(m => {
          const id = m.slice(1).trim();
          if (id) {
            uniq.add(id);
          }
        });
        return Array.from(uniq);
      }
      function renderTasks(tasks) {
        allTasks = Array.isArray(tasks) ? tasks : [];
        sessionTasks = currentSessionId ? allTasks.filter(t => t.session_id === currentSessionId) : allTasks;
        renderTaskList(sessionTasks);
      }

      function renderTaskList(tasks) {
        const container = document.getElementById('tasks-list');
        if (!container) return;
        const visible = Array.isArray(tasks) ? tasks : [];
        if (!visible.length) {
          container.innerHTML = '<div class="empty-state">暂无任务数据</div>';
          return;
        }
        const cards = visible.slice(0, 100).map(task => buildTaskCard(task)).join('');
        container.innerHTML = cards;
      }

      function workspaceTabVisible() {
        const workspaceTab = document.getElementById('main-tab-workspace');
        return workspaceTab && workspaceTab.classList.contains('active');
      }

      function rerenderWorkspaceIfVisible() {
        if (!selectedAgentId || !workspaceTabVisible()) {
          return;
        }
        const agent = allAgents.find(a => a.id === selectedAgentId);
        if (agent) {
          renderWorkspace(agent);
        }
      }

      function getWorkspaceMessages() {
        if (!currentSessionId || !selectedAgentId) return [];
        const messages = Array.isArray(allMessages) ? allMessages : [];
        const base = messages
          .filter(m => m.session_id === currentSessionId)
          .filter(m => m.agent_id === selectedAgentId || (Array.isArray(m.mentions) && m.mentions.includes(selectedAgentId)))
          .map(m => ({
            type: 'message',
            id: m.id,
            ts: m.created_at || m.updated_at || Date.now(),
            actor: m.agent_id,
            content: m.content || '',
            priority: m.priority,
            source: m.agent_id === selectedAgentId ? 'agent' : 'external'
          }));

        // 补充与当前 Agent 相关的指派任务提示
        const tasks = Array.isArray(allTasks) ? allTasks : [];
        const taskHints = tasks
          .filter(t => t.session_id === currentSessionId && t.assigned_to === selectedAgentId)
          .slice(0, 30)
          .map(t => ({
            type: 'message',
            id: `task_hint_${t.id}`,
            ts: t.updated_at || t.created_at || Date.now(),
            actor: 'system',
            content: `任务指派：${t.title || t.id}（${getTaskStatusLabel(t.status)}）`,
            priority: t.priority || 'medium',
            source: 'external'
          }));

        return [...base, ...taskHints];
      }

      function getWorkspaceThinking() {
        if (!currentSessionId || !selectedAgentId) return [];
        return (allThinkingLogs || [])
          .filter(log => log.session_id === currentSessionId && log.agent_id === selectedAgentId)
          .map(log => ({
            type: 'thinking',
            id: log.id || `thinking-${log.timestamp || Date.now()}`,
            ts: log.timestamp || log.created_at || Date.now(),
            actor: log.agent_id,
            content: log.content || '',
            thinking_type: log.thinking_type || 'thought'
          }));
      }

      function getWorkspaceTools() {
        if (!currentSessionId || !selectedAgentId) return [];
        return (allToolRuns || [])
          .filter(run => run.session_id === currentSessionId && (run.created_by === selectedAgentId || run.agent_id === selectedAgentId))
          .map(run => ({
            type: 'tool',
            id: run.id || `tool-${run.created_at || Date.now()}`,
            ts: run.updated_at || run.created_at || Date.now(),
            status: run.status || 'running',
            tool: run.tool || run.tool_name || 'tool',
            args: run.args || {},
            output: run.output || run.result || '',
            error: run.error || '',
            duration_ms: run.duration_ms || run.duration || null
          }));
      }

      function getWorkspaceStreamNode() {
        if (!selectedAgentId) return null;
        for (const [, payload] of llmStreamStates.entries()) {
          if (payload.agent_id === selectedAgentId && payload.status === 'streaming') {
            return {
              type: 'message',
              id: `stream-${payload.agent_id}`,
              ts: payload.timestamp || Date.now(),
              actor: payload.agent_id,
              content: payload.content || '输入中…',
              priority: 'normal',
              source: 'agent',
              streaming: true
            };
          }
        }
        return null;
      }

      function buildWorkspaceItems() {
        const items = [
          ...getWorkspaceMessages(),
          ...getWorkspaceThinking(),
          ...getWorkspaceTools()
        ];
        const streamNode = getWorkspaceStreamNode();
        if (streamNode) {
          items.push(streamNode);
        }
        return items.sort((a, b) => (a.ts || 0) - (b.ts || 0));
      }

      function deriveAgentUiMetrics(agent) {
        if (!agent) return null;
        if (agent.metrics) {
          return agent.metrics;
        }
        const runs = Array.isArray(allToolRuns)
          ? allToolRuns.filter(run => run.agent_id === agent.id)
          : [];
        if (!runs.length) return null;
        const succeeded = runs.filter(run => run.status === 'succeeded');
        const durations = runs
          .map(run => Number(run.duration_ms || run.duration))
          .filter(v => Number.isFinite(v));
        const avgMs = durations.length
          ? Math.round(durations.reduce((sum, v) => sum + v, 0) / durations.length)
          : undefined;
        return {
          success_rate: runs.length ? succeeded.length / runs.length : undefined,
          average_response_ms: avgMs
        };
      }

      function renderWorkspaceTimeline() {
        const container = document.getElementById('workspace-timeline');
        if (!container) return;
        if (!currentSessionId || !selectedAgentId) {
          container.innerHTML = '<div class="workspace-empty-hint">请选择会话与 Agent</div>';
          return;
        }
        const items = buildWorkspaceItems();
        if (!items.length) {
          container.innerHTML = '<div class="workspace-empty-hint">暂无对话，发送一条消息开始吧。</div>';
          return;
        }
        const html = items.map(item => {
          if (item.type === 'tool') {
            const statusText = item.status === 'succeeded' ? '成功' : item.status === 'failed' ? '失败' : '运行中';
            const meta = [
              `工具: ${escapeHtml(item.tool)}`,
              statusText,
              item.duration_ms ? `耗时 ${Math.round(item.duration_ms / 1000)}s` : null
            ].filter(Boolean).join(' · ');
            const body = item.error
              ? `<div style="color:var(--vscode-errorForeground);">${escapeHtml(item.error)}</div>`
              : (item.output ? `<div>${escapeHtml(String(item.output).slice(0, 400))}</div>` : '<div class="workspace-empty-hint">无输出</div>');
            return `
              <div class="workspace-timeline-item">
                <div class="workspace-timeline-header">
                  <div class="workspace-timeline-meta">
                    <span class="workspace-timeline-badge badge-tool">工具</span>
                    <span>${escapeHtml(meta)}</span>
                  </div>
                  <span class="workspace-timeline-meta">${formatTime(item.ts)}</span>
                </div>
                <div class="workspace-timeline-body">${body}</div>
              </div>
            `;
          }
          if (item.type === 'thinking') {
            return `
              <div class="workspace-timeline-item">
                <div class="workspace-timeline-header">
                  <div class="workspace-timeline-meta">
                    <span class="workspace-timeline-badge badge-thinking">思考 · ${escapeHtml(item.thinking_type || '')}</span>
                    <span>${escapeHtml(getAgentName(item.actor))}</span>
                  </div>
                  <span class="workspace-timeline-meta">${formatTime(item.ts)}</span>
                </div>
                <div class="workspace-timeline-body">${escapeHtml(item.content || '')}</div>
              </div>
            `;
          }
          // message
          const badges = [];
          if (item.source === 'external' && item.actor !== selectedAgentId) {
            badges.push('<span class="workspace-timeline-badge badge-external">外部/黑板</span>');
          }
          if (item.streaming) {
            badges.push('<span class="workspace-timeline-badge badge-system">输入中…</span>');
          }
          return `
            <div class="workspace-timeline-item">
              <div class="workspace-timeline-header">
                <div class="workspace-timeline-meta">
                  ${badges.join(' ')}
                  <span>${escapeHtml(getAgentName(item.actor))}</span>
                </div>
                <span class="workspace-timeline-meta">${formatTime(item.ts)}</span>
              </div>
              <div class="workspace-timeline-body">${escapeHtml(item.content || '')}</div>
            </div>
          `;
        }).join('');
        container.innerHTML = html;
      }

      function renderWorkspace(agent) {
        selectedAgentId = agent ? agent.id : null;
        const panel = document.getElementById('workspace-panel');
        const empty = document.getElementById('workspace-empty');
        const nameEl = document.getElementById('workspace-agent-name');
        const metaEl = document.getElementById('workspace-agent-meta');
        const extraEl = document.getElementById('workspace-agent-extra');
        const statusDot = document.getElementById('workspace-agent-status-dot');
        const statusTextEl = document.getElementById('workspace-agent-status-text');
        if (!agent || !currentSessionId) {
          if (panel) panel.classList.add('hidden');
          if (empty) empty.style.display = 'block';
          return;
        }
        if (panel) panel.classList.remove('hidden');
        if (empty) empty.style.display = 'none';
        if (nameEl) {
          nameEl.textContent = agent.display_name || agent.id;
        }
        if (metaEl) {
          metaEl.textContent = `状态：${getStatusText(agent.status)} · 心跳：${agent.last_heartbeat_at ? formatTime(agent.last_heartbeat_at) : '--'}`;
        }
        if (extraEl) {
          const metrics = deriveAgentUiMetrics(agent) || {};
          const hasSuccess = typeof metrics.success_rate === 'number';
          const hasLatency = typeof metrics.average_response_ms === 'number';
          const successRate = hasSuccess
            ? `${Math.round(Math.max(0, Math.min(1, metrics.success_rate)) * 100)}%`
            : '未上报';
          const latency = hasLatency
            ? `${Math.max(0, Math.round(metrics.average_response_ms / 1000))}s`
            : '未上报';
          extraEl.textContent = `成功率 ${successRate} · 响应 ${latency}`;
        }
        if (statusDot) {
          statusDot.className = 'workspace-status-dot';
          const status = (agent.status || 'offline').toLowerCase();
          if (status === 'online') statusDot.classList.add('online');
          else if (status === 'busy') statusDot.classList.add('busy');
          else statusDot.classList.add('offline');
        }
        if (statusTextEl) {
          const heartbeat = agent.last_heartbeat_at ? formatTime(agent.last_heartbeat_at) : '--';
          statusTextEl.textContent = `${getStatusText(agent.status)} · 心跳 ${heartbeat}`;
        }
        renderWorkspaceTimeline();
      }

      window.refreshWorkspace = function () {
        const agent = selectedAgentId ? allAgents.find(a => a.id === selectedAgentId) : null;
        renderWorkspace(agent || null);
      };

      // 兼容旧事件钩子，保持空实现避免错误
      function switchWorkspaceTabInternal() { }
      window.switchWorkspaceTab = function () { };
      window.setWorkspaceThinkingScope = function () { };
      window.handleWorkspaceThinkingSearch = function () { };
      window.toggleThinkingTypeFilter = function () { };
      window.resetThinkingTypeFilters = function () { };

      function renderGlobalAgentTable(agents) {
        const container = document.getElementById('global-agent-list');
        if (!container) {
          return;
        }
        if (!agents || agents.length === 0) {
          container.innerHTML = '<div class="empty-state">暂无 Agent 数据</div>';
          return;
        }

        const validAgentIds = new Set(agents.map(agent => agent.id));
        Array.from(pendingAgentRefresh).forEach(id => {
          if (!validAgentIds.has(id)) {
            pendingAgentRefresh.delete(id);
          }
        });

        const cards = agents.map(agent => {
          const capabilities = agent.capabilities && agent.capabilities.length
            ? agent.capabilities.map(cap => escapeHtml(getCapabilityText(cap))).join('、')
            : '未配置';
          const metrics = agent.metrics || null;
          const successRate = typeof metrics?.success_rate === 'number'
            ? Math.round(Math.max(0, Math.min(1, metrics.success_rate)) * 100)
            : null;
          const latencySeconds = typeof metrics?.average_response_ms === 'number'
            ? Math.max(0, Math.round(metrics.average_response_ms / 1000))
            : null;
          const metricsText = metrics
            ? `${successRate !== null ? successRate + '% 成功率' : '成功率未知'} · ${latencySeconds !== null ? latencySeconds + 's 响应' : '响应未知'}`
            : '暂无数据';
          const llmText = agent.llm_model
            ? escapeHtml(`${agent.llm_provider || '自定义'} · ${agent.llm_model}`)
            : '未配置';
          const heartbeat = agent.last_heartbeat_at ? formatTime(agent.last_heartbeat_at) : '--';
          const isEnabled = agent.is_enabled !== false;
          const statusText = isEnabled ? getStatusText(agent.status) : '已停用';
          const agentIdText = escapeHtml(agent.id);
          const displayName = escapeHtml(agent.display_name || agent.id);
          const statusClass = !isEnabled
            ? 'agent-status-disabled'
            : agent.status === 'online'
              ? 'agent-status-online'
              : agent.status === 'busy'
                ? 'agent-status-busy'
                : 'agent-status-offline';
          const isRefreshing = pendingAgentRefresh.has(agent.id);
          const refreshText = isRefreshing ? '刷新中...' : '刷新';
          const statusDetail = agent.status_detail ? escapeHtml(agent.status_detail) : '';
          const toggleLabel = isEnabled ? '停用' : '启用';
          const cardClasses = 'agent-config-card' + (isEnabled ? '' : ' agent-disabled');

          return `
            <div class="${cardClasses}">
              <div class="agent-card-header">
                <div class="agent-card-title">
                  <div class="global-agent-name">${displayName}</div>
                  <div class="global-agent-meta">ID: ${agentIdText}</div>
                </div>
                <span class="agent-status-badge ${statusClass}">${statusText}</span>
              </div>
              ${statusDetail ? `<div class="global-agent-meta">${statusDetail}</div>` : ''}
              <div class="agent-card-body">
              <div class="agent-card-section">
                <div class="agent-card-section-title">能力</div>
                <div>${capabilities}</div>
              </div>
              <div class="agent-card-section">
                <div class="agent-card-section-title">LLM 配置</div>
                <div>${llmText}</div>
              </div>
                <div class="agent-card-section">
                  <div class="agent-card-section-title">运行指标</div>
                  <div>${metricsText}</div>
                </div>
                <div class="agent-card-section">
                  <div class="agent-card-section-title">最近心跳</div>
                  <div>${heartbeat}</div>
                </div>
              </div>
              <div class="global-agent-actions">
                <button class="mcp-card-btn"
                  data-agent-id="${agentIdText}"
                  data-enable="${isEnabled ? 'false' : 'true'}"
                  onclick="toggleAgentEnabled(this.getAttribute('data-agent-id'), this.getAttribute('data-enable'))">${toggleLabel}</button>
                <button class="mcp-card-btn ghost"
                  data-agent-id="${agentIdText}"
                  onclick="refreshAgent(this.getAttribute('data-agent-id'))"
                  ${isRefreshing ? 'disabled' : ''}>${refreshText}</button>
                <button class="mcp-card-btn"
                  data-agent-id="${agentIdText}"
                  onclick="editAgent(this.getAttribute('data-agent-id'))">编辑</button>
                <button class="mcp-card-btn danger"
                  data-agent-id="${agentIdText}"
                  onclick="deleteAgent(this.getAttribute('data-agent-id'))">删除</button>
              </div>
            </div>
          `;
        }).join('');

        container.innerHTML = cards;
      }

      function buildTaskDependencyGraph(tasks) {
        const graph = new Map();
        if (!Array.isArray(tasks)) return graph;
        tasks.forEach(task => {
          const deps = Array.isArray(task.dependencies) ? task.dependencies : [];
          graph.set(task.id, { task, deps });
        });
        return graph;
      }

      function buildTaskCard(task) {
        const statusClass = `task-${task.status || 'pending'}`;
        const created = task.created_at ? formatTime(task.created_at) : '';
        const taskTypeLabel = task.labels?.find(l => l.startsWith('type:'))?.replace('type:', '') || '';
        const typeText = {
          requirement: '需求',
          bug: '缺陷',
          documentation: '文档',
          misc: '杂项'
        }[taskTypeLabel] || '';
        const typeBadge = typeText ? `<span class="badge badge-info">${typeText}</span>` : '';
        const assignedText = task.assigned_to ? `➡ ${escapeHtml(task.assigned_to)}` : '待分配';
        const metaLine = task.dependencies?.length ? `<div class="task-meta">依赖：${task.dependencies.length} 个</div>` : '';

        return `
        <div class="task-card ${statusClass}" data-task-id="${escapeHtml(task.id)}">
          <div class="task-header">
            <span class="task-state">${escapeHtml(getTaskStatusLabel(task.status))}</span>
            <span class="task-time">${created}</span>
          </div>
          <div class="task-body">
            <div class="task-title">${escapeHtml(task.title || '任务')} ${typeBadge}</div>
            <div class="task-sub-row">
              <div class="task-sub">${assignedText}</div>
              <button class="link-button task-inline-action" data-action="openTaskDetailModal" data-task-id="${escapeHtml(task.id)}">详情</button>
            </div>
            ${metaLine}
          </div>
        </div>
      `;
      }

      function applyAssistDelta(payload) {
        if (!payload) return;
        if (payload.type === 'created' && payload.assist) {
          allAssists = [payload.assist, ...allAssists];
        } else if (payload.type === 'updated' && payload.assist) {
          allAssists = allAssists.map(item => item.id === payload.assist.id ? payload.assist : item);
        } else if (payload.type === 'deleted' && payload.id) {
          allAssists = allAssists.filter(item => item.id !== payload.id);
        }
      }

      function renderAssists() {
        const container = document.getElementById('assist-list');
        if (!container) return;
        const visible = Array.isArray(allAssists) ? allAssists.filter(a => {
          if (currentSessionId) {
            return a.sessionId === currentSessionId;
          }
          return true;
        }) : [];
        if (!visible.length) {
          container.innerHTML = '<div class="empty-state">暂无协助请求</div>';
          return;
        }
        const cards = visible.slice(0, 50).map(req => buildAssistCard(req)).join('');
        container.innerHTML = cards;
      }

      function buildAssistCard(req) {
        const statusClass = `assist-${req.state || 'requested'}`;
        const created = req.createdAt ? formatTime(req.createdAt) : '';
        const header = `${req.assignedTo ? `➡ ${escapeHtml(req.assignedTo)}` : '待分配'} · ${escapeHtml(req.priority || 'normal')}`;
        const meta = [];
        if (req.taskId) meta.push(`任务 ${escapeHtml(req.taskId)}`);
        if (req.targetAgentId) meta.push(`目标 ${escapeHtml(req.targetAgentId)}`);
        if (Array.isArray(req.requiredCapabilities) && req.requiredCapabilities.length) {
          meta.push(`能力：${req.requiredCapabilities.map(escapeHtml).join(', ')}`);
        }
        const managerHint = req.context?.history?.some(h => h.details?.manager_required) || req.context?.details?.manager_required;
        const managerBadge = managerHint ? '<span class="badge badge-warning">待经理协调</span>' : '';
        const metaLine = meta.length ? `<div class="assist-meta">${meta.join(' · ')}</div>` : '';
        return `
        <div class="assist-card ${statusClass}">
          <div class="assist-header">
            <span class="assist-state">${escapeHtml(req.state || 'requested')}</span>
            <span class="assist-time">${created}</span>
          </div>
          <div class="assist-body">
            <div class="assist-title">${escapeHtml(req.description || '协助请求')} ${managerBadge}</div>
            <div class="assist-sub">${header}</div>
            ${metaLine}
          </div>
        </div>
      `;
      }
      const ACE_ACTIVITY_TYPES = [
        { key: 'index', title: '索引刷新', hint: '保持索引最新' },
        { key: 'search', title: '语义搜索', hint: '最近的查询' },
        { key: 'test', title: '连接检测', hint: '可用性状态' }
      ];

      function hasChineseText(text) {
        return /[\u4e00-\u9fff]/.test(text || '');
      }

      function buildDescriptionSnippet(text, max = 24) {
        if (!text) {
          return '';
        }
        const sanitized = text.replace(/\s+/g, ' ').trim();
        if (!sanitized) {
          return '';
        }
        return sanitized.length > max ? sanitized.slice(0, max) + '…' : sanitized;
      }

      function getTaskDisplayTitle(task) {
        if (!task) {
          return '任务';
        }
        const rawTitle = (task.title || '').trim();
        if (rawTitle && hasChineseText(rawTitle)) {
          return rawTitle;
        }
        const intent = (task.intent || '').trim().toLowerCase();
        const mapped = TASK_INTENT_LABELS[intent];
        if (mapped) {
          const snippet = buildDescriptionSnippet(task.description || task.intent || '');
          return snippet ? `${mapped}：${snippet}` : mapped;
        }
        if (rawTitle) {
          return rawTitle;
        }
        if (intent) {
          return mapped || intent;
        }
        return task.id || '任务';
      }
      function formatTaskScopeLabel(scope) {
        if (!scope) {
          return '未指定';
        }
        const normalized = scope.toLowerCase();
        return TASK_SCOPE_LABELS[normalized] || scope;
      }

      function formatPriorityLabel(priority) {
        if (!priority) {
          return '中';
        }
        const map = {
          high: '高',
          medium: '中',
          low: '低',
          critical: '紧急'
        };
        const normalized = String(priority).toLowerCase();
        return map[normalized] || priority.toString();
      }

      function formatPriorityClass(priority) {
        if (typeof priority === 'string') {
          const normalized = priority.toLowerCase();
          if (normalized === 'critical' || normalized === 'urgent') {
            return 'priority-critical';
          }
          if (normalized === 'high') {
            return 'priority-high';
          }
          if (normalized === 'medium') {
            return 'priority-medium';
          }
          if (normalized === 'low') {
            return 'priority-low';
          }
        }
        const numeric = Number(priority);
        if (!Number.isFinite(numeric) || numeric <= 0) {
          return 'priority-none';
        }
        if (numeric >= 9) {
          return 'priority-critical';
        }
        if (numeric >= 7) {
          return 'priority-high';
        }
        if (numeric >= 4) {
          return 'priority-medium';
        }
        return 'priority-low';
      }
      function handleMentionInputEvent() {
        const input = document.getElementById('message-input');
        if (!input) {
          return;
        }
        const caret = input.selectionStart || 0;
        const beforeText = input.value.slice(0, caret);
        const match = beforeText.match(/@([a-zA-Z0-9_\\-]*)$/);
        if (match) {
          mentionState.active = true;
          mentionState.startIndex = caret - match[0].length;
          mentionState.prefix = (match[1] || '').toLowerCase();
          showMentionSuggestions(mentionState.prefix);
        } else {
          hideMentionSuggestions();
        }
      }

      function showMentionSuggestions(prefix) {
        const container = document.getElementById('mention-suggestions');
        if (!container) {
          return;
        }
        if (mentionState.hideTimer) {
          clearTimeout(mentionState.hideTimer);
          mentionState.hideTimer = null;
        }
        const normalizedPrefix = (prefix || '').toLowerCase();
        const filtered = (allAgents || [])
          .filter(agent => agent.is_enabled !== false)
          .filter(agent => {
            const id = (agent.id || '').toLowerCase();
            const name = (agent.display_name || '').toLowerCase();
            if (!normalizedPrefix) {
              return true;
            }
            return id.includes(normalizedPrefix) || name.includes(normalizedPrefix);
          }).slice(0, 6);

        if (!filtered.length) {
          hideMentionSuggestions();
          return;
        }

        const items = filtered.map(agent => {
          const displayName = escapeHtml(agent.display_name || agent.id);
          const agentId = escapeHtml(agent.id);
          return `
            <button type="button" class="mention-suggestion-item" onclick="insertMention('${agentId}')">
              <strong>${displayName} (${agentId})</strong>
              <span class="mention-suggestion-role">${escapeHtml(getStatusText(agent.status))}</span>
            </button>
          `;
        }).join('');
        container.innerHTML = '<div class="mention-suggestion-header">选择要 @ 的 Agent</div>' + items;
        container.style.display = 'block';
      }

      function hideMentionSuggestions() {
        const container = document.getElementById('mention-suggestions');
        mentionState.active = false;
        mentionState.startIndex = -1;
        mentionState.prefix = '';
        if (container) {
          container.style.display = 'none';
          container.innerHTML = '';
        }
      }

      window.insertMention = function (agentId) {
        const input = document.getElementById('message-input');
        if (!input) {
          return;
        }
        const caret = input.selectionStart || 0;
        const start = mentionState.active && mentionState.startIndex >= 0
          ? mentionState.startIndex
          : caret;
        const before = input.value.slice(0, start);
        const after = input.value.slice(caret);
        const insertion = '@' + agentId + ' ';
        input.value = before + insertion + after;
        const newCaret = before.length + insertion.length;
        input.setSelectionRange(newCaret, newCaret);
        input.focus();
        hideMentionSuggestions();
      };

      function initMentionInput() {
        const input = document.getElementById('message-input');
        const container = document.getElementById('mention-suggestions');
        if (!input || !container) {
          return;
        }
        input.addEventListener('keyup', handleMentionInputEvent);
        input.addEventListener('click', handleMentionInputEvent);
        input.addEventListener('blur', () => {
          mentionState.hideTimer = window.setTimeout(() => hideMentionSuggestions(), 150);
        });
        container.addEventListener('mousedown', (event) => {
          event.preventDefault();
        });
      }
      let allMcpServers = [];
      const mcpToolsCache = new Map();
      const mcpServerStatus = new Map();
      const pendingAgentRefresh = new Set();
      const pendingMcpRefresh = new Set();
      let currentMcpServerEditId = null;
      const WORKSPACE_THINKING_LIMIT = 120;
      let pendingCreateSessionId = null;
      let pendingDeleteSessionId = null;
      let sessionIdToAutoSelect = null;
      let blackboardSessions = [];
      let latestTaskMetrics = null;
      let latestTaskMetricsSessionId = null;
      let latestManagerRun = null;
      let taskMetricsRefreshTimer = null;
      const messageInputEl = document.getElementById('message-input');
      if (messageInputEl) {
        messageInputEl.addEventListener('input', handleMessageInputChange);
        messageInputEl.addEventListener('blur', handleMessageInputChange);
        let messageInputComposing = false;
        messageInputEl.addEventListener('compositionstart', () => {
          messageInputComposing = true;
        });
        messageInputEl.addEventListener('compositionend', () => {
          messageInputComposing = false;
        });
        messageInputEl.addEventListener('keydown', (event) => {
          if (messageInputComposing || event.isComposing) {
            return;
          }
          if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
          }
        });
      }

      function renderBlackboardSessions(sessions) {
        const select = document.getElementById('session-select');
        const currentLabel = document.getElementById('blackboard-current-session');
        if (!select || !currentLabel) {
          return;
        }
        if (!sessions || sessions.length === 0) {
          select.innerHTML = '<option value="">暂无会话</option>';
          select.disabled = true;
          currentLabel.textContent = '--';
          return;
        }
        select.disabled = false;
        const activeSessionId = currentSessionId && sessions.some(session => session.id === currentSessionId)
          ? currentSessionId
          : sessions[0].id;
        select.innerHTML = sessions.map(session => {
          const label = escapeHtml(session.id);
          const selected = session.id === activeSessionId ? ' selected' : '';
          return '<option value="' + label + '"' + selected + '>' + label + '</option>';
        }).join('');
        select.value = activeSessionId || '';
        currentLabel.textContent = activeSessionId ? escapeHtml(activeSessionId) : '--';
      }

      function clampText(value, max = 40) {
        if (!value) {
          return '';
        }
        const next = String(value).trim();
        return next.length > max ? next.slice(0, max) + '…' : next;
      }

      function resetTaskMetricsTile(hintText = '等待任务数据') {
        const tile = document.getElementById('gov-summary-task-health');
        if (!tile) {
          return;
        }
        const valueEl = tile.querySelector('.summary-tile-value');
        const metaEl = tile.querySelector('.summary-tile-meta');
        if (valueEl) valueEl.textContent = '--';
        if (metaEl) metaEl.textContent = hintText;
      }

      function renderTaskMetrics(metrics) {
        const tile = document.getElementById('gov-summary-task-health');
        if (!tile) {
          return;
        }
        const valueEl = tile.querySelector('.summary-tile-value');
        const metaEl = tile.querySelector('.summary-tile-meta');
        const activeSession = currentSessionId || null;

        if (!metrics) {
          latestTaskMetrics = null;
          latestTaskMetricsSessionId = null;
          if (valueEl) valueEl.textContent = '--';
          if (metaEl) metaEl.textContent = activeSession ? '等待任务数据' : '等待任务数据';
          return;
        }

        const metricSessionId = metrics.session_id ?? null;
        const metricScope = metrics.scope || (metricSessionId ? 'session' : 'global');

        if (activeSession) {
          if (!metricSessionId) {
            return;
          }
          if (metricSessionId !== activeSession) {
            return;
          }
        } else if (metricSessionId && metricScope === 'session') {
          return;
        }

        latestTaskMetrics = metrics;
        latestTaskMetricsSessionId = metricSessionId;

        if (valueEl) {
          valueEl.textContent = `${metrics.running}/${metrics.total}`;
        }
        if (metaEl) {
          if (metrics.last_timeout) {
            metaEl.textContent = clampText(metrics.last_timeout.message, 48);
          } else {
            metaEl.textContent = `排队 ${metrics.queued} · 阻塞 ${metrics.blocked}`;
          }
        }
        renderManagerStatusStrip();
      }

      window.switchBlackboardSession = function (sessionId) {
        setCurrentSession(sessionId || null, { reason: 'manual-switch' });
      };

      // Utility functions
      function padTimeUnit(value) {
        return value < 10 ? '0' + value : String(value);
      }

      function formatAbsoluteTime(timestamp) {
        if (!timestamp) {
          return '未知';
        }
        const date = new Date(timestamp);
        if (Number.isNaN(date.getTime())) {
          return '未知';
        }
        const year = date.getFullYear();
        const month = padTimeUnit(date.getMonth() + 1);
        const day = padTimeUnit(date.getDate());
        const hours = padTimeUnit(date.getHours());
        const minutes = padTimeUnit(date.getMinutes());
        const seconds = padTimeUnit(date.getSeconds());
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      }

      function formatAbsoluteWithRelative(timestamp, emptyText = '未设置') {
        if (!timestamp) {
          return emptyText;
        }
        const absolute = formatAbsoluteTime(timestamp);
        const relative = formatTime(timestamp);
        return `${absolute} · ${relative}`;
      }

      function formatTime(timestamp) {
        if (!timestamp) return '未知';
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) return days + '天前';
        if (hours > 0) return hours + '小时前';
        if (minutes > 0) return minutes + '分钟前';
        return '刚刚';
      }

      function syncBlackboardEventEntries(messages) {
        const scoped = Array.isArray(messages) ? messages : [];
        blackboardEventEntries = scoped
          .filter(msg => getMessageVisibilityValue(msg) === 'event_log')
          .map(msg => ({
            id: msg.id,
            sourceLabel: getAgentName(msg.agent_id),
            severity: deriveEventSeverityFromMessage(msg),
            title: clampText(msg.content || '', 96),
            metaParts: buildEventMetaPartsFromMessage(msg),
            timestamp: msg.created_at || Date.now(),
            category: 'system'
          }));
      }

      function addOrchestrationEvent(entry) {
        if (!entry) {
          return;
        }
        const normalized = {
          category: entry.category || 'system',
          ...entry
        };
        orchestrationEvents.unshift(normalized);
        if (orchestrationEvents.length > MAX_ORCHESTRATION_EVENTS) {
          orchestrationEvents.pop();
        }
      }
      function getPriorityWeightValue(priority) {
        if (priority === 'high') return 3;
        if (priority === 'medium') return 2;
        return 1;
      }

      function handleMessageInputChange() {
        const input = document.getElementById('message-input');
        if (!input) {
          return;
        }
      }

      function handleSchedulerEvent(payload) {
        if (!payload) {
          return;
        }
        const sessionId = payload.sessionId ?? payload.session_id ?? null;
        const taskId = payload.taskId ?? payload.task_id ?? null;
        const agentId = payload.agentId ?? payload.agent_id ?? null;
        const metadata = payload.metadata || {};
        const parts = [];
        if (sessionId) {
          parts.push(`会话 ${sessionId}`);
        }
        if (taskId) {
          parts.push(`任务 ${taskId}`);
        }
        if (agentId) {
          parts.push(`Agent ${agentId}`);
        }
        if (payload.reason) {
          parts.push(payload.reason);
        }
        if (metadata.degraded) {
          parts.push('降级模式');
        }
        const title = formatSchedulerTitle(payload);
        addOrchestrationEvent({
          id: `scheduler-${payload.timestamp || Date.now()}-${taskId || Math.random()}`,
          sourceLabel: 'Scheduler',
          severity: mapSchedulerSeverity(payload.type),
          title,
          metaParts: parts.length ? parts : ['系统事件'],
          timestamp: payload.timestamp || Date.now(),
          category: 'scheduler'
        });
      }

      function mapSchedulerSeverity(type) {
        switch (type) {
          case 'assigned':
            return 'success';
          case 'queued':
            return 'info';
          case 'reassigned':
          case 'skipped':
            return 'warning';
          case 'agent_offline':
            return 'critical';
          case 'assist_required':
            return 'warning';
          case 'human_required':
            return 'critical';
          default:
            return 'info';
        }
      }

      function formatSchedulerTitle(payload) {
        switch (payload?.type) {
          case 'assigned':
            if (payload.metadata?.degraded) {
              return '降级指派';
            }
            return '已分配任务';
          case 'reassigned':
            return '重新分配任务';
          case 'queued':
            return '等待可用 Agent';
          case 'agent_offline':
            return '检测到 Agent 离线';
          case 'assist_required':
            return '任务等待协助';
          case 'human_required':
            return '需要人工接管';
          case 'skipped':
          default:
            return '调度器更新';
        }
      }

      function handleSentinelEvent(payload) {
        if (!payload) {
          return;
        }
        const taskId = payload.taskId ?? payload.task_id ?? null;
        const agentId = payload.agentId ?? payload.agent_id ?? null;
        const parts = [];
        if (taskId) {
          parts.push(`任务 ${taskId}`);
        }
        if (agentId) {
          parts.push(`Agent ${agentId}`);
        }
        addOrchestrationEvent({
          id: `sentinel-${payload.timestamp || Date.now()}-${payload.type}`,
          sourceLabel: 'Sentinel',
          severity: mapSentinelSeverity(payload.severity),
          title: payload.message || formatSentinelTitle(payload.type),
          metaParts: parts.length ? parts : ['系统巡检'],
          timestamp: payload.timestamp || Date.now(),
          category: 'sentinel'
        });
      }

      function mapSentinelSeverity(level) {
        if (level === 'warning') {
          return 'warning';
        }
        if (level === 'critical') {
          return 'critical';
        }
        return 'info';
      }

      function formatSentinelTitle(type) {
        switch (type) {
          case 'phase_timeout':
            return '阶段运行超时';
          case 'task_stalled':
            return '任务超时';
          case 'defect_loop':
            return '缺陷未闭环';
          case 'agent_offline':
            return 'Agent 离线';
          case 'human_required':
            return '需要人工接管';
          case 'assist_required':
            return '任务需要协助';
          default:
            return '巡检提醒';
        }
      }

      function derivePersonaFromTask(task) {
        if (!task) {
          return null;
        }
        const role = extractRoleFromLabels(task.labels);
        if (role) {
          const personaKey = mapRoleToPersona(role);
          if (personaKey) {
            return {
              key: personaKey,
              label: formatPersonaLabel(personaKey, role)
            };
          }
        }
        if (task.intent) {
          const personaFromIntent = mapIntentToPersona(task.intent);
          if (personaFromIntent) {
            return {
              key: personaFromIntent,
              label: formatPersonaLabel(personaFromIntent, task.intent)
            };
          }
        }
        return null;
      }

      function derivePersonaFromAgent(agent) {
        if (!agent || !Array.isArray(agent.roles)) {
          return null;
        }
        for (const role of agent.roles) {
          const persona = mapRoleToPersona(role);
          if (persona) {
            return {
              key: persona,
              label: formatPersonaLabel(persona, role)
            };
          }
        }
        return null;
      }

      function mapRoleToPersona(role) {
        if (!role) {
          return null;
        }
        const normalized = role.toLowerCase();
        if (ROLE_PERSONA_MAP[normalized]) {
          return ROLE_PERSONA_MAP[normalized];
        }
        return null;
      }

      function formatPersonaLabel(persona, role) {
        const base = PERSONA_LABELS[persona] || persona;
        if (!role) {
          return base;
        }
        const normalized = role.toLowerCase();
        const roleLabel = ROLE_DISPLAY_LABELS[normalized] || normalized;
        return `${base} · ${roleLabel}`;
      }

      function extractRoleFromLabels(labels) {
        if (!Array.isArray(labels)) {
          return null;
        }
        for (const label of labels) {
          if (label.startsWith('role:')) {
            return label.replace('role:', '');
          }
        }
        return null;
      }

      function mapIntentToPersona(intent) {
        if (!intent) {
          return null;
        }
        const normalized = intent.toLowerCase();
        if (normalized.includes('clarify') || normalized.includes('plan') || normalized.includes('approve')) {
          return 'lead';
        }
        if (normalized.includes('review') || normalized.includes('qa') || normalized.includes('signoff')) {
          return 'reviewer';
        }
        if (
          normalized.includes('implement') ||
          normalized.includes('write') ||
          normalized.includes('execute') ||
          normalized.includes('fix') ||
          normalized.includes('run') ||
          normalized.includes('bug') ||
          normalized.includes('defect')
        ) {
          return 'executor';
        }
        return null;
      }

      function openReferenceTarget(type, id) {
        if (!type || !id) {
          return;
        }
        if (type === 'task') {
          window.openTaskDetailModal(id);
          return;
        }
        if (type === 'file') {
          focusFileChangePanel();
          const numeric = Number(id);
          if (!Number.isNaN(numeric)) {
            window.toggleFileChangeDetail(numeric);
          }
          return;
        }
      }

      // Render messages
      /**
       * 渲染消息列表（主函数）
       * @param {Array} messages - 消息数组
       */
      function renderMessages(messages) {
        allMessages = Array.isArray(messages) ? messages : [];
        const container = document.getElementById('messages-list');
        const wasAtBottom = isAtBottom(container);

        // 1. 处理和过滤消息
        const filteredMessages = processAndFilterMessages();
        latestManagerRun = deriveLatestManagerRun(filteredMessages);

        // 2. 渲染消息或空状态
        if (filteredMessages.length === 0) {
          renderEmptyState(container);
          return;
        }

        // 3. 生成并更新 DOM
        container.innerHTML = filteredMessages.map(buildMessageCard).join('');

        // 4. 处理滚动逻辑
        handleMessageScrolling(container, wasAtBottom);

        // 5. 更新相关 UI
        renderManagerStatusStrip();
        rerenderWorkspaceIfVisible();
      }

      /**
       * 处理和过滤消息
       * @returns {Array} 过滤后的消息数组
       */
      function processAndFilterMessages() {
        // 获取当前会话的消息
        const scopedMessages = currentSessionId
          ? allMessages.filter(m => (m.session_id || null) === currentSessionId)
          : [];

        syncBlackboardEventEntries(scopedMessages);

        // 过滤可见消息
        let filtered = scopedMessages
          .filter(m => getMessageVisibilityValue(m) === 'blackboard')
          .filter(m => {
            const category = getMessageCategoryValue(m);
            if (category === 'automation') return false;
            if (category === 'system_event') {
              return m.agent_id === 'manager_llm' || Boolean(m.payload?.source_message_id);
            }
            return true;
          });

        // 搜索过滤
        if (currentSearchQuery) {
          filtered = filtered.filter(m => {
            const content = m.content.toLowerCase();
            const agentName = getAgentName(m.agent_id).toLowerCase();
            return content.includes(currentSearchQuery) || agentName.includes(currentSearchQuery);
          });
        }

        // 排序：旧消息在前
        return [...filtered].sort((a, b) => a.created_at - b.created_at);
      }

      /**
       * 渲染空状态
       * @param {HTMLElement} container - 容器元素
       */
      function renderEmptyState(container) {
        container.innerHTML = currentSessionId
          ? '<div class="empty-state">当前会话暂无消息</div>'
          : '<div class="empty-state">请选择一个会话开始协作</div>';
        hideNewMessageButton();
      }

      /**
       * 构建单个消息卡片
       * @param {Object} msg - 消息对象
       * @returns {string} HTML 字符串
       */
      function buildMessageCard(msg) {
        const agentName = getAgentName(msg.agent_id);
        const avatarColor = getAgentAvatarColor(msg.agent_id);
        const avatarLetter = agentName.charAt(0).toUpperCase();
        const isUserMessage = msg.agent_id === 'user';

        // 构建消息的各个部分
        const replyHtml = buildMessageReplyHTML(msg);
        const quotedHtml = buildMessageQuotedHTML(msg);
        const backlogHtml = buildMessageBacklogHTML(msg);
        const contextRefsHtml = buildMessageContextRefsHTML(msg);
        const attachmentsHtml = buildMessageAttachmentsHTML(msg);
        const directBadge = buildMessageDirectBadge(msg);
        const instanceBadge = ''; // 实例标记（预留）

        return `
          <div class="message-item${isUserMessage ? ' user-message' : ''}">
            <div class="message-avatar message-avatar-${avatarColor}">${avatarLetter}</div>
            <div class="message-content">
              <div class="message-header">
                <div style="display:flex;align-items:center;gap:4px;">
                  <span class="message-author">${agentName}</span>
                  ${msg.payload?.status === 'streaming' ? '<span class="message-typing">· 输入中…</span>' : ''}
                  ${buildMessagePersonaBadge(msg)}
                  ${instanceBadge}
                  ${directBadge}
                </div>
                <span class="message-time">${formatTime(msg.created_at)}</span>
              </div>
              <div class="message-bubble message-bubble-${avatarColor}">
                ${msg.priority === 'high' ? '<div style="margin-bottom:6px;"><span class="badge badge-error">高优先级</span></div>' : ''}
                ${replyHtml}
                ${quotedHtml}
                <div class="message-text">${formatMessageContent(msg)}</div>
                ${backlogHtml}
                ${contextRefsHtml}
                ${attachmentsHtml}
                <div class="message-actions">
                  ${!isUserMessage ? `<button class="message-action-btn" data-msg-id="${msg.id}" onclick="handleReplyMessage('${msg.id}')">回复</button>` : ''}
                  <button class="message-action-btn" data-msg-id="${msg.id}" onclick="handleQuoteMessage('${msg.id}')">引用</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      /**
       * 构建消息回复 HTML
       * @param {Object} msg - 消息对象
       * @returns {string} HTML 字符串
       */
      function buildMessageReplyHTML(msg) {
        if (!msg.reply_to) return '';

        const repliedMsg = allMessages.find(m => m.id === msg.reply_to);
        if (!repliedMsg) return '';

        const repliedAgentName = getAgentName(repliedMsg.agent_id);
        const repliedContent = repliedMsg.content.length > 50
          ? repliedMsg.content.substring(0, 50) + '...'
          : repliedMsg.content;

        return `
          <div class="message-reply">
            <div class="message-reply-author">回复 @${repliedAgentName}:</div>
            <div class="message-reply-content">${repliedContent}</div>
          </div>
        `;
      }

      /**
       * 构建消息引用 HTML
       * @param {Object} msg - 消息对象
       * @returns {string} HTML 字符串
       */
      function buildMessageQuotedHTML(msg) {
        const parsedReferences = parseMessageReferences(msg);
        const quotedReference = parsedReferences.find(ref => ref.type === 'message');
        if (!quotedReference) return '';

        const quotedMsg = allMessages.find(m => m.id === quotedReference.id);
        if (!quotedMsg) return '';

        const quotedAgentName = getAgentName(quotedMsg.agent_id);
        const quotedContent = quotedMsg.content.length > 100
          ? quotedMsg.content.substring(0, 100) + '...'
          : quotedMsg.content;

        return `
          <div class="message-quoted">
            <div class="message-quoted-author">引用 @${quotedAgentName}:</div>
            <div class="message-quoted-content">${quotedContent}</div>
          </div>
        `;
      }

      /**
       * 构建消息任务积压 HTML
       * @param {Object} msg - 消息对象
       * @returns {string} HTML 字符串
       */
      function buildMessageBacklogHTML(msg) {
        const backlogSummary = deriveMessageTaskBacklog(msg);
        return backlogSummary ? buildBacklogSummarySnippet(backlogSummary) : '';
      }

      function formatMessageContent(msg) {
        const base = msg && msg.content ? msg.content : '';
        const mentions = Array.isArray(msg?.mentions) ? msg.mentions.filter(Boolean) : [];
        const escapedBase = escapeHtml(base);

        // 处理agent回复的思考过程折叠
        if (msg.agent_id && msg.agent_id !== 'user' && msg.category === 'agent_response') {
          return formatAgentMessageWithThinking(base);
        // 处理agent回复的思考过程折叠
        if (msg.agent_id && msg.agent_id !== 'user' && msg.category === 'agent_response') {
          return formatAgentMessageWithThinking(base);
        }        }        if (msg?.agent_id === 'user' && mentions.length === 1) {
          // 如果内容已经以 @ 开头且匹配提及，则不再重复添加前缀
          const normalizedBase = base.trim();
          const mentionId = mentions[0];
          const label = getAgentName(mentionId);
          if (normalizedBase.startsWith('@')) {
            return escapedBase;
          }
          return `@${escapeHtml(label)} ${escapedBase}`;
        }
        return escapedBase;
      }

      /**
       * 构建消息上下文引用 HTML
       * @param {Object} msg - 消息对象
       * @returns {string} HTML 字符串
       */
      function buildMessageContextRefsHTML(msg) {
        const contextRefs = Array.isArray(msg.payload?.context_refs) ? msg.payload.context_refs : [];
        if (!contextRefs.length) return '';

        return `<div class="message-reference-cards">${contextRefs.map(ref =>
          `<div class="message-ref-card">上下文：${escapeHtml(ref)}</div>`
        ).join('')}</div>`;
      }

      /**
       * 构建消息附件 HTML
       * @param {Object} msg - 消息对象
       * @returns {string} HTML 字符串
       */
      function buildMessageAttachmentsHTML(msg) {
        const parsedReferences = parseMessageReferences(msg);
        const attachmentReferences = parsedReferences.filter(ref => ref.type !== 'message');
        if (!attachmentReferences.length) return '';

        return `<div class="message-reference-cards">
          ${attachmentReferences.map(buildMessageReferenceCard).filter(Boolean).join('')}
        </div>`;
      }

      /**
       * 处理消息滚动逻辑
       * @param {HTMLElement} container - 容器元素
       * @param {boolean} wasAtBottom - 渲染前是否在底部
       */
      function handleMessageScrolling(container, wasAtBottom) {
        setTimeout(() => {
          if (!isUserScrolling || wasAtBottom) {
            scrollToBottom(container, false);
            hasNewMessages = false;
            hideNewMessageButton();
          } else {
            hasNewMessages = true;
            showNewMessageButton();
          }
        }, 0);
      }

      function deriveLatestManagerRun(messages) {
        const managerMessages = (messages || []).filter(m => m && m.agent_id === 'manager_llm');
        if (!managerMessages.length) {
          return null;
        }
        const latest = managerMessages.reduce((acc, cur) => {
          const ts = cur.updated_at || cur.created_at || 0;
          const accTs = acc.updated_at || acc.created_at || 0;
          return ts > accTs ? cur : acc;
        });
        const payload = latest.payload || {};
        const statusRaw = payload.status || 'completed';
        let status = 'completed';
        if (statusRaw === 'streaming') {
          status = 'processing';
        } else if (statusRaw === 'fallback') {
          status = 'fallback';
        } else if (statusRaw === 'error') {
          status = 'failed';
        }
        return {
          status,
          attempt: payload.attempt || payload.try || null,
          lastError: payload.last_error || null,
          updatedAt: latest.updated_at || latest.created_at || Date.now(),
          referenceMessageId: latest.id
        };
      }

      // Agent interaction functions
      window.selectAgent = function (agentId, event) {
        if (!agentId) {
          return;
        }
        if (event) event.stopPropagation();
        selectedAgentId = agentId;

        document.querySelectorAll('.agent-card').forEach(card => {
          const cardAgentId = card.getAttribute('data-agent-id');
          card.classList.toggle('selected', cardAgentId === agentId);
        });

        console.log('[MinimalPanel] Selected agent:', agentId);
        const agent = allAgents.find(a => a.id === agentId);
        renderWorkspace(agent || null);
      };

      window.editAgent = function (agentId) {
        console.log('[MinimalPanel] Edit agent:', agentId);
        const agent = allAgents.find(a => a.id === agentId);
        if (!agent) {
          console.error('[MinimalPanel] Agent not found:', agentId);
          return;
        }

        const form = document.getElementById('form-add-agent');
        if (!form) {
          return;
        }
        form.querySelector('[name="id"]').value = agent.id;
        form.querySelector('[name="id"]').disabled = true;
        form.querySelector('[name="display_name"]').value = agent.display_name || agent.id;
        setSelectedRoles(form, agent.roles || []);
        setSelectedCapabilities(form, agent.capabilities || []);
        setSelectedToolPermissions(form, agent.tool_permissions || []);
        form.querySelector('[name="llm_provider"]').value = agent.llm_provider || '';
        form.querySelector('[name="llm_model"]').value = agent.llm_model || '';
        form.querySelector('[name="llm_api_key"]').value = agent.llm_api_key || '';
        form.querySelector('[name="llm_base_url"]').value = agent.llm_base_url || '';
        handleProviderChange();

        const modal = document.getElementById('modal-add-agent');
        if (modal) {
          modal.querySelector('.modal-title').textContent = '编辑 Agent';
          const submitBtn = modal.querySelector('[data-action="submitAddAgent"]');
          if (submitBtn) {
            submitBtn.setAttribute('data-action', 'submitEditAgent');
            submitBtn.setAttribute('data-agent-id', agentId);
            submitBtn.textContent = '保存';
          }
        }
        window.openModal('modal-add-agent');
      };

      window.deleteAgent = function (agentId) {
        console.log('[MinimalPanel] Delete agent:', agentId);
        vscode.postMessage({ type: 'delete_agent', data: { id: agentId } });
      };

      window.refreshAgent = function (agentId) {
        if (!agentId) {
          return;
        }
        pendingAgentRefresh.add(agentId);
        renderGlobalAgentTable(allAgents);
        vscode.postMessage({
          type: 'refresh_agent_llm',
          data: { id: agentId }
        });
      };

      window.toggleAgentEnabled = function (agentId, nextState) {
        if (!agentId) {
          return;
        }
        const enabled =
          typeof nextState === 'string'
            ? nextState === 'true'
            : !!nextState;
        vscode.postMessage({
          type: 'toggle_agent_enabled',
          data: { id: agentId, enabled }
        });
      };

      // Main Tab Switching
      window.switchMainTab = function (tab, evt) {
        currentMainTab = tab;
        document.querySelectorAll('.main-tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.main-tab-content').forEach(content => content.classList.remove('active'));

        const mainTabTrigger = (evt && evt.target) || document.querySelector(".main-tab-button[data-main-tab='" + tab + "']");
        if (mainTabTrigger) {
          mainTabTrigger.classList.add('active');
        }
        const tabContent = document.getElementById('main-tab-' + tab);
        if (tabContent) {
          tabContent.classList.add('active');
        }

        // Load data for the selected tab
        if (tab === 'workspace') {
          // Agent 工作台数据会通过事件自动更新
        } else if (tab === 'global') {
          refreshGlobalConfigData();
        }
      };

      let currentGlobalConfigTab = 'agents';

      window.switchGlobalConfigTab = function (tab) {
        currentGlobalConfigTab = tab;
        document.querySelectorAll('.global-config-tab').forEach(btn => {
          if (btn.getAttribute('data-global-tab') === tab) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        document.querySelectorAll('.global-tab-content').forEach(content => {
          if (content.id === 'global-tab-' + tab) {
            content.classList.add('active');
          } else {
            content.classList.remove('active');
          }
        });

        if (tab === 'agents') {
          console.log('[MinimalPanel] Switching to agents tab, requesting agents data');
          vscode.postMessage({ type: 'get_agents' });
        } else if (tab === 'mcp') {
          vscode.postMessage({ type: 'get_mcp_servers' });
        }
      };

      window.switchGlobalConfigTab(currentGlobalConfigTab);

      function refreshGlobalConfigData() {
        window.switchGlobalConfigTab(currentGlobalConfigTab);
        vscode.postMessage({ type: 'get_mcp_servers' });
      }

      window.openGlobalAgentTab = function () {
        window.switchMainTab('global');
        window.switchGlobalConfigTab('agents');
      };

      window.openCreateSessionModal = function () {
        pendingCreateSessionId = 'session-' + Date.now();
        const preview = document.getElementById('session-create-preview');
        if (preview) {
          preview.textContent = pendingCreateSessionId;
        }
        window.openModal('modal-create-session');
      };

      window.confirmCreateSession = function () {
        if (!pendingCreateSessionId) {
          return;
        }
        sessionIdToAutoSelect = pendingCreateSessionId;
        vscode.postMessage({ type: 'create_session', data: { id: pendingCreateSessionId } });
        pendingCreateSessionId = null;
        window.closeModal();
      };

      window.openDeleteSessionModal = function () {
        if (!currentSessionId) {
          vscode.postMessage({ type: 'show_info', message: '暂无可删除的会话' });
          return;
        }
        pendingDeleteSessionId = currentSessionId;
        const preview = document.getElementById('session-delete-preview');
        if (preview) {
          preview.textContent = pendingDeleteSessionId;
        }
        window.openModal('modal-delete-session');
      };

      window.confirmDeleteSession = function () {
        if (!pendingDeleteSessionId) {
          window.closeModal();
          return;
        }
        vscode.postMessage({ type: 'delete_session', data: { id: pendingDeleteSessionId } });
        pendingDeleteSessionId = null;
        window.closeModal();
      };

      window.applyMessageTemplate = function (content) {
        const input = document.getElementById('message-input');
        if (!input) {
          return;
        }
        input.value = content || '';
        handleMessageInputChange();
      };

      window.focusTaskInList = function (taskId) {
        if (!taskId) {
          return;
        }
        const el = document.querySelector(`[data-task-id="${taskId}"]`);
        if (el && typeof el.scrollIntoView === 'function') {
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      };

      window.openTaskDetailModal = function (taskId) {
        const task = getTaskById(taskId);
        if (!task) {
          vscode.postMessage({ type: 'show_info', message: '未找到任务 ' + (taskId || '') });
          return;
        }
        console.log('[MinimalPanel] Task detail requested:', taskId);
        renderTaskDetailModal(task);
        openModal('modal-task-detail');
      };

      window.openTaskDependencyModal = function (taskId) {
        window.openTaskDetailModal(taskId);
      };
      function renderTaskDetailModal(task) {
        const titleEl = document.getElementById('task-detail-title');
        const bodyEl = document.getElementById('task-detail-body');
        if (titleEl) {
          titleEl.textContent = task.title || `任务 ${task.id}`;
        }
        if (!bodyEl) {
          return;
        }
        const status = getTaskStatusLabel(task.status);
        const priority = formatPriorityLabel(task.priority);
        const assignee = task.assigned_to || '未指派';
        const created = task.created_at ? formatTime(task.created_at) : '';
        const deps = Array.isArray(task.dependencies) && task.dependencies.length
          ? task.dependencies.map(id => `<span class="badge badge-secondary">#${escapeHtml(id)}</span>`).join(' ')
          : '无';
        const labels = Array.isArray(task.labels) && task.labels.length
          ? task.labels.map(l => `<span class="badge badge-info">${escapeHtml(l)}</span>`).join(' ')
          : '无';
        const scope = task.scope || 'workspace';
        bodyEl.innerHTML = `
          <div style="display:flex; flex-direction:column; gap:12px;">
            <div class="task-detail-section">
              <div class="task-detail-title">${escapeHtml(task.title || '任务')}</div>
              <div class="task-detail-subtitle">${escapeHtml(task.intent || '')}</div>
              <div class="task-detail-badges">
                <span class="badge badge-secondary">状态：${escapeHtml(status)}</span>
                <span class="badge badge-secondary">优先级：${escapeHtml(priority)}</span>
                <span class="badge badge-secondary">指派：${escapeHtml(assignee)}</span>
                <span class="badge badge-secondary">范围：${escapeHtml(scope)}</span>
              </div>
              <div class="task-detail-meta-grid">
                <div class="task-detail-meta-item">
                  <div class="label">创建时间</div>
                  <div class="value">${escapeHtml(created || '—')}</div>
                </div>
                <div class="task-detail-meta-item">
                  <div class="label">依赖</div>
                  <div class="value">${deps}</div>
                </div>
                <div class="task-detail-meta-item">
                  <div class="label">标签</div>
                  <div class="value">${labels}</div>
                </div>
              </div>
            </div>
            <div class="task-detail-section">
              <div class="task-detail-label">描述</div>
              <div class="task-detail-desc">${escapeHtml(task.description || '暂无描述')}</div>
            </div>
          </div>
        `;
      }

      window.pauseTask = function (taskId) {
        if (!taskId) {
          return;
        }
        vscode.postMessage({ type: 'pause_task', data: { id: taskId } });
      };

      window.resumeTask = function (taskId) {
        if (!taskId) {
          return;
        }
        vscode.postMessage({ type: 'resume_task', data: { id: taskId } });
      };


      window.switchBlackboardView = function (view) {
        currentBlackboardView = view;
        document.querySelectorAll('.sub-tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.sub-tab-content').forEach(content => content.classList.remove('active'));

        const subTabTrigger = (typeof event !== 'undefined' && event && event.target) || document.querySelector(".sub-tab-button[onclick*='" + view + "']");
        if (subTabTrigger) {
          subTabTrigger.classList.add('active');
        }
        document.getElementById('blackboard-' + view).classList.add('active');

        // Load data for the selected view
        if (view === 'discussion') {
          if (!currentSessionId) {
            updateStatus('请先创建或选择一个会话');
            return;
          }
          requestMessagesSnapshot('tab-switch');
        } else if (view === 'tools') {
          renderToolRuns();
          if (currentSessionId) {
            requestToolRunsSnapshot();
          }
        } else if (view === 'notifications') {
          vscode.postMessage({ type: 'get_notifications', data: {} });
        }
      };

      // Message Search
      let currentSearchQuery = '';

      window.searchMessages = function (query) {
        currentSearchQuery = query.toLowerCase();
        renderMessages(allMessages);
      };

      // Handle Reply Message
      window.handleReplyMessage = function (messageId) {
        const message = allMessages.find(m => m.id === messageId);
        if (message) {
          replyToMessage = message;
          quotedMessage = null;
          renderReplyIndicator();
          document.getElementById('message-input').focus();
        }
      };

      // Handle Quote Message
      window.handleQuoteMessage = function (messageId) {
        const message = allMessages.find(m => m.id === messageId);
        if (message) {
          quotedMessage = message;
          replyToMessage = null;
          renderReplyIndicator();
          document.getElementById('message-input').focus();
        }
      };

      // Render Reply Indicator
      function renderReplyIndicator() {
        const container = document.getElementById('reply-indicator');
        if (!replyToMessage && !quotedMessage) {
          container.innerHTML = '';
          return;
        }

        const msg = replyToMessage || quotedMessage;
        const agentName = getAgentName(msg.agent_id);
        const isReply = !!replyToMessage;
        const action = isReply ? '回复' : '引用';
        const cssClass = isReply ? 'is-reply' : 'is-quote';

        container.innerHTML = `
          <div class="reply-indicator ${cssClass}">
            <span class="reply-indicator-text">${action} @${agentName}: ${msg.content.substring(0, 50)}...</span>
            <button class="reply-indicator-close" onclick="cancelReply()">×</button>
          </div>
        `;
      }

      // Cancel Reply
      window.cancelReply = function () {
        replyToMessage = null;
        quotedMessage = null;
        renderReplyIndicator();
      };

      // Send Message
      window.sendMessage = function () {
        const input = document.getElementById('message-input');
        const content = input.value.trim();

        if (!currentSessionId) {
          ensureActiveSession();
        }

        if (!content) return;

        handleMessageInputChange();
        const messageData = {
          content: content,
          priority: 'normal',
          session_id: currentSessionId
        };
        const mentions = extractMentionsFromText(content);
        if (mentions.length) {
          messageData.mentions = mentions;
        }

        if (replyToMessage) {
          messageData.reply_to = replyToMessage.id;
        }

        if (quotedMessage) {
          const referenceTokens = [buildReferenceToken('message', quotedMessage.id)];
          messageData.references = JSON.stringify(referenceTokens);
        }

        vscode.postMessage({
          type: 'send_message',
          data: messageData
        });
        requestMessagesSnapshot('post-message');

        input.value = '';
        cancelReply();
        hideMentionSuggestions();
        handleMessageInputChange();
      };

      window.sendWorkspaceMessage = function () {
        if (!currentSessionId || !selectedAgentId) {
          updateStatus('请先选择会话和 Agent');
          return;
        }
        const input = document.getElementById('workspace-input');
        if (!input) return;
        const content = input.value.trim();
        if (!content) return;
        vscode.postMessage({
          type: 'send_message',
          data: {
            content,
            session_id: currentSessionId,
            mentions: [selectedAgentId],
            visibility: 'blackboard'
          }
        });
        input.value = '';
      };

      // 倒计时更新函数
      let countdownIntervals = [];

      function updateCountdowns() {
        const now = Date.now();
        document.querySelectorAll('[data-countdown]').forEach(el => {
          const timeoutAt = parseInt(el.getAttribute('data-countdown'));
          const timeLeft = timeoutAt - now;

          if (timeLeft <= 0) {
            el.textContent = '已超时';
            el.style.color = '#f44336';
          } else {
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            el.textContent = `剩余 ${minutes} 分 ${seconds} 秒`;
          }
        });
      }
      vscode.postMessage({
        data: {
          agentId: 'user'
        }
      });

      let allNotifications = [];

      function formatDuration(ms) {
        if (!ms || ms <= 0) {
          return '--';
        }
        const minutes = Math.floor(ms / 60000);
        if (minutes === 0) {
          return Math.max(1, Math.round(ms / 1000)) + ' 秒';
        }
        if (minutes >= 60) {
          const hours = Math.floor(minutes / 60);
          const remain = minutes % 60;
          return hours + ' 小时' + (remain > 0 ? ' ' + remain + ' 分' : '');
        }
        return minutes + ' 分';
      }

      function renderNotifications(notifications) {
        allNotifications = Array.isArray(notifications) ? notifications : [];
        const container = document.getElementById('notifications-list');
        let scopedNotifications = allNotifications;

        if (!scopedNotifications.length) {
          container.innerHTML = '<div class="empty-state">暂无通知</div>';
          return;
        }

        const badge = document.getElementById('notification-stats');
        if (badge) badge.textContent = scopedNotifications.length ? `${scopedNotifications.length}` : '';

        // Sort: unread first, then by created_at desc
        const sortedNotifications = [...scopedNotifications].sort((a, b) => {
          if (!a.read && b.read) return -1;
          if (a.read && !b.read) return 1;
          return b.created_at - a.created_at;
        });

        container.innerHTML = sortedNotifications.map(notif => {
          const isUnread = !notif.read;
          const levelText = notif.level === 'info'
            ? '信息'
            : notif.level === 'success'
              ? '成功'
              : notif.level === 'warning'
                ? '警告'
                : '错误';
          const levelBadgeClass = notif.level === 'info'
            ? 'info'
            : notif.level === 'success'
              ? 'success'
              : notif.level === 'warning'
                ? 'warning'
                : 'error';
          return `
            <div class="notification-card ${isUnread ? 'unread' : ''}" data-notification-id="${notif.id}" data-action="handleNotificationClick">
              <div class="notification-header">
                ${isUnread ? '<div class="notification-unread-dot"></div>' : ''}
                <div style="flex: 1;">
                  <span class="badge badge-${levelBadgeClass}">${levelText}</span>
                  <div class="notification-title">${notif.title}</div>
                </div>
              </div>
              <div class="notification-message">${notif.message}</div>
              <div class="notification-time">${formatTime(notif.created_at)}</div>
            </div>
          `;
        }).join('');
      }

      window.markNotificationAsRead = function (notificationId) {
        vscode.postMessage({
          type: 'mark_notification_read',
          data: { notificationId }
        });
      };

      window.handleNotificationClick = function (notificationId) {
        if (!notificationId) {
          return;
        }
        const normalizedId = String(notificationId);
        const notification = allNotifications.find(item => String(item.id) === normalizedId);
        if (!notification) {
          return;
        }
        if (!notification.read) {
          window.markNotificationAsRead(notification.id);
        }
        const metadata = notification.metadata || {};
        const targetSessionId = metadata.session_id || notification.session_id || null;
        const taskTarget = metadata.task_id || null;
        if (targetSessionId && targetSessionId !== currentSessionId) {
          if (taskTarget) {
            pendingTaskFocusId = taskTarget;
          }
        }
        setCurrentSession(targetSessionId, { reason: 'notification-jump', forceRender: true, forceFetch: true });
        window.switchMainTab('blackboard');
        return;
      }

      window.switchMainTab('blackboard');
      function formatToolRunStatus(status) {
        const map = {
          running: '执行中',
          succeeded: '已完成',
          failed: '失败'
        };
        return map[status] || status || '未知状态';
      }

      function formatToolRunDuration(run) {
        if (!run || !run.started_at || !run.completed_at) {
          return run && run.status === 'running' ? '执行中' : '—';
        }
        const diff = run.completed_at - run.started_at;
        if (diff <= 0) {
          return '—';
        }
        if (diff >= 60000) {
          return (diff / 60000).toFixed(1) + ' 分钟';
        }
        return Math.round(diff / 1000) + ' 秒';
      }

      function getAceRunType(run) {
        if (!run) {
          return null;
        }
        if (run.tool_name && run.tool_name.startsWith('ace:')) {
          const [, type] = run.tool_name.split(':');
          if (type) {
            return type;
          }
        }
        if (run.command?.startsWith('search')) {
          return 'search';
        }
        if (run.command?.includes('index')) {
          return 'index';
        }
        if (run.command?.includes('test')) {
          return 'test';
        }
        return null;
      }

      function getAceRunField(run, field) {
        if (!run) {
          return null;
        }
        const candidates = [run.input, run.output];
        for (const source of candidates) {
          if (!source) {
            continue;
          }
          if (source[field]) {
            return source[field];
          }
          if (source.metadata && source.metadata[field]) {
            return source.metadata[field];
          }
        }
        return null;
      }

      function updateAceHealthItem(prefix, summary) {
        const valueEl = document.getElementById(`ace-health-${prefix}-value`);
        const metaEl = document.getElementById(`ace-health-${prefix}-meta`);
        if (!valueEl || !metaEl) {
          return;
        }
        if (!summary) {
          valueEl.textContent = '--';
          valueEl.classList.remove('warning');
          metaEl.textContent = '等待运行';
          metaEl.classList.remove('warning');
          return;
        }
        valueEl.textContent = formatToolRunStatus(summary.status);
        const timestamp = summary.completedAt || summary.startedAt || null;
        let metaText = timestamp ? formatAbsoluteWithRelative(timestamp, '等待运行') : '等待运行';
        if (prefix === 'search' && summary.query) {
          metaText += ` · ${clampText(summary.query, 32)}`;
        }
        if (prefix === 'index' && summary.stats && typeof summary.stats.new_blobs === 'number') {
          metaText += ` · 新增 ${summary.stats.new_blobs}`;
        }
        metaEl.textContent = metaText;
        valueEl.classList.toggle('warning', summary.status === 'failed');
        metaEl.classList.toggle('warning', summary.status === 'failed');
      }

      function renderAceStateOverview() {
        const state = typeof aceStateData !== 'undefined' && aceStateData ? aceStateData : null;
        updateAceHealthItem('index', state?.lastIndex || null);
        updateAceHealthItem('search', state?.lastSearch || null);
        const failureValue = document.getElementById('ace-health-failure-value');
        const failureMeta = document.getElementById('ace-health-failure-meta');
        const failureDetail = document.getElementById('ace-health-failure-detail');
        if (!failureValue || !failureMeta || !failureDetail) {
          return;
        }
        const streak = state?.failureStreak ?? 0;
        if (streak > 0) {
          failureValue.textContent = `${streak} 次连续失败`;
          failureValue.classList.add('warning');
          const failureAt = state?.lastFailureAt || state?.updatedAt || null;
          failureMeta.textContent = failureAt ? formatAbsoluteWithRelative(failureAt, '最近出现失败') : '最近出现失败';
          failureMeta.classList.add('warning');
          if (state?.lastFailureMessage) {
            failureDetail.textContent = state.lastFailureMessage;
            failureDetail.classList.remove('hidden');
          } else {
            failureDetail.textContent = '';
            failureDetail.classList.add('hidden');
          }
        } else {
          failureValue.textContent = '运行正常';
          failureValue.classList.remove('warning');
          failureMeta.textContent = '最近未出现失败';
          failureMeta.classList.remove('warning');
          failureDetail.textContent = '';
          failureDetail.classList.add('hidden');
        }
        renderManagerStatusStrip();
      }

      function buildAceActivityCard(meta, run) {
        if (!run) {
          return `
          <div class="ace-activity-card">
            <div class="ace-activity-card-head">
              <h4>${meta.title}</h4>
              <span class="ace-activity-status">
                <span class="ace-activity-dot"></span>暂无记录
              </span>
            </div>
            <div class="ace-activity-meta">${meta.hint}</div>
            <div class="ace-activity-body">
              <div class="ace-activity-empty">尚未执行</div>
            </div>
          </div>
        `;
        }
        const status = run.status || 'running';
        const statusText = formatToolRunStatus(status);
        const timestamp = run.completed_at || run.started_at || run.created_at || Date.now();
        const when = formatTime(timestamp);
        const projectRoot = getAceRunField(run, 'projectRoot');
        const detailLines = [];
        if (projectRoot) {
          detailLines.push(`目录：${escapeHtml(clampText(projectRoot, 48))}`);
        }
        if (meta.key === 'search') {
          const query = getAceRunField(run, 'query');
          if (query) {
            detailLines.push(`关键词：${escapeHtml(clampText(query, 60))}`);
          }
          if (run.output?.message) {
            detailLines.push(escapeHtml(run.output.message));
          } else if (run.error) {
            detailLines.push(`错误：${escapeHtml(run.error)}`);
          }
        } else if (meta.key === 'index') {
          const stats = run.output?.stats || run.output?.metadata?.stats;
          if (stats) {
            const parts = [];
            if (typeof stats.total_blobs === 'number') {
              parts.push(`总片段 ${stats.total_blobs}`);
            }
            if (typeof stats.new_blobs === 'number') {
              parts.push(`新增 ${stats.new_blobs}`);
            }
            if (parts.length) {
              detailLines.push(parts.join(' · '));
            }
          }
          if (run.output?.message) {
            detailLines.push(escapeHtml(run.output.message));
          } else if (run.error) {
            detailLines.push(`错误：${escapeHtml(run.error)}`);
          }
        } else if (meta.key === 'test') {
          const message = run.output?.message || run.error;
          if (message) {
            detailLines.push(escapeHtml(message));
          }
        }
        if (!detailLines.length) {
          detailLines.push(meta.hint);
        }

        return `
        <div class="ace-activity-card">
          <div class="ace-activity-card-head">
            <h4>${meta.title}</h4>
            <span class="ace-activity-status status-${status}">
              <span class="ace-activity-dot"></span>${statusText}
            </span>
          </div>
          <div class="ace-activity-meta"><strong>${escapeHtml(when)}</strong>${projectRoot ? ' · ' + escapeHtml(clampText(projectRoot, 36)) : ''}</div>
          <div class="ace-activity-body">
            ${detailLines.map(line => `<div>${line}</div>`).join('')}
          </div>
        </div>
      `;
      }

      function renderAceActivity() {
        const container = document.getElementById('ace-activity-list');
        if (!container) {
          return;
        }
        const latestByType = new Map();
        const toolRuns = typeof allToolRuns !== 'undefined' && Array.isArray(allToolRuns) ? allToolRuns : [];
        toolRuns.forEach(run => {
          if (!run || (run.runner !== 'ace' && !(run.tool_name && run.tool_name.startsWith('ace:')))) {
            return;
          }
          const type = getAceRunType(run);
          if (!type) {
            return;
          }
          const timestamp = run.completed_at || run.started_at || run.created_at || 0;
          const existing = latestByType.get(type);
          if (!existing || timestamp > existing.timestamp) {
            latestByType.set(type, { run, timestamp });
          }
        });
        const cards = ACE_ACTIVITY_TYPES.map(meta => buildAceActivityCard(meta, latestByType.get(meta.key)?.run || null));
        container.innerHTML = cards.join('');
      }
      renderAceActivity();
      renderAceStateOverview();
      renderManagerStatusStrip();

      function renderManagerStatusStrip() {
        const managerCard = document.getElementById('manager-status-primary');
        if (managerCard) {
          const dotEl = document.getElementById('manager-status-dot');
          const nameEl = document.getElementById('manager-status-name');
          const modelEl = document.getElementById('manager-status-model');
          const updatedEl = document.getElementById('manager-status-updated');
          const profile = managerLLMConfig || null;

          if (!profile || !profile.model || !profile.api_key) {
            if (nameEl) nameEl.textContent = '尚未配置经理';
            if (dotEl) {
              dotEl.classList.remove('online', 'processing');
              dotEl.classList.add('offline');
            }
            if (modelEl) modelEl.textContent = '模型：--';
            if (updatedEl) updatedEl.textContent = '';
          } else {
            if (nameEl) {
              nameEl.textContent = `${profile.provider || '自定义'} · ${profile.model}`;
            }
            if (dotEl) {
              dotEl.classList.remove('offline', 'processing');
              if (latestManagerRun && latestManagerRun.status === 'processing') {
                dotEl.classList.add('processing');
              } else {
                dotEl.classList.add('online');
              }
            }
            if (modelEl) modelEl.textContent = profile.base_url ? clampText(profile.base_url, 32) : '默认 API';
            if (updatedEl) {
              const timeText = profile.updated_at
                ? formatTime(profile.updated_at)
                : '';
              const runStatus = latestManagerRun
                ? formatManagerRunStatus(latestManagerRun)
                : '';
              updatedEl.textContent = runStatus ? `${runStatus} · ${timeText}` : timeText;
            }
          }
        }

        const queueCard = document.getElementById('manager-status-queue');
        if (queueCard) {
          const valueEl = queueCard.querySelector('.manager-status-value');
          const metaSpans = queueCard.querySelectorAll('.manager-status-meta span');
          if (!latestTaskMetrics) {
            if (valueEl) valueEl.textContent = '-- / --';
            if (metaSpans[0]) metaSpans[0].textContent = '排队 --';
            if (metaSpans[1]) metaSpans[1].textContent = '阻塞 --';
          } else {
            if (valueEl) valueEl.textContent = `${latestTaskMetrics.running}/${latestTaskMetrics.total}`;
            if (metaSpans[0]) metaSpans[0].textContent = `排队 ${latestTaskMetrics.queued}`;
            if (metaSpans[1]) metaSpans[1].textContent = `阻塞 ${latestTaskMetrics.blocked}`;
          }
        }

        const aceValueEl = document.getElementById('manager-status-ace-value');
        const aceMeta = document.getElementById('manager-status-ace-meta');
        if (aceValueEl && aceMeta) {
          const spans = aceMeta.querySelectorAll('span');
          const aceState = typeof aceStateData !== 'undefined' ? aceStateData : null;
          if (!aceState || !aceState.lastIndex) {
            aceValueEl.textContent = '等待索引';
            if (spans[0]) spans[0].textContent = '尚未运行';
            if (spans[1]) spans[1].textContent = '';
          } else {
            const lastIndex = aceState.lastIndex;
            aceValueEl.textContent = lastIndex.status === 'succeeded'
              ? '索引最新'
              : lastIndex.status === 'failed'
                ? '索引失败'
                : '索引中';
            if (spans[0]) {
              spans[0].textContent = lastIndex.completedAt
                ? formatTime(lastIndex.completedAt)
                : '刚刚';
            }
            if (spans[1]) {
              spans[1].textContent = aceState.failureStreak > 0
                ? `连续失败 ${aceState.failureStreak}`
                : `项目 ${aceState.projectRoot || '当前工作区'}`;
            }
          }
        }
        const healthCard = document.getElementById('manager-status-queue');
        if (healthCard && typeof allToolRuns !== 'undefined' && Array.isArray(allToolRuns)) {
          const recentFailure = allToolRuns.find(run => run.status === 'failed');
          const metaSpans = healthCard.querySelectorAll('.manager-status-meta span');
          if (recentFailure && metaSpans[1]) {
            metaSpans[1].textContent = `最近失败：${escapeHtml(recentFailure.tool_name)}`;
          }
        }
      }

      function formatManagerRunStatus(run) {
        if (!run) {
          return '';
        }
        const labels = {
          processing: '处理中',
          completed: '完成',
          fallback: '已兜底',
          failed: '失败'
        };
        const pieces = [];
        if (run.status) {
          pieces.push(labels[run.status] || run.status);
        }
        if (run.attempt) {
          pieces.push(`#${run.attempt}`);
        }
        if (run.lastError) {
          pieces.push(clampText(run.lastError, 24));
        }
        return pieces.join(' · ');
      }

      function renderToolRunLog(run) {
        if (!run) {
          return '暂无日志';
        }
        const fragments = [];
        if (run.output?.stdout) {
          fragments.push('stdout:\n' + escapeHtml(run.output.stdout));
        }
        if (run.output?.stderr) {
          fragments.push('stderr:\n' + escapeHtml(run.output.stderr));
        }
        if (run.output && typeof run.output === 'object') {
          const cloned = { ...run.output };
          delete cloned.stdout;
          delete cloned.stderr;
          if (Object.keys(cloned).length) {
            fragments.push('输出:\n' + escapeHtml(JSON.stringify(cloned, null, 2)));
          }
        } else if (typeof run.output === 'string' && run.output.trim()) {
          fragments.push('输出:\n' + escapeHtml(run.output));
        }
        if (run.error) {
          fragments.push('error:\n' + escapeHtml(run.error));
        }
        const attachments = run.output?.attachments;
        if (attachments?.files?.length) {
          fragments.push('files:\n' + attachments.files.map(file => `• ${escapeHtml(file)}`).join('\n'));
        }
        if (attachments?.links?.length) {
          fragments.push('links:\n' + attachments.links.map(link => `• ${escapeHtml(link)}`).join('\n'));
        }
        if (!fragments.length) {
          return '暂无日志';
        }
        return fragments.join('\n\n');
      }

      function buildToolRunCard(run) {
        const statusText = formatToolRunStatus(run.status);
        const started = run.started_at ? formatTime(run.started_at) : '—';
        const duration = formatToolRunDuration(run);
        const owner = run.agent_id || run.created_by || '未知';
        const ownerName = getAgentName(owner);
        const logId = `tool-log-${run.id}`;
        const command = run.command || (run.input?.command) || '—';
        const taskId = run.task_id || '—';
        const sessionTag = run.session_id ? `会话：${escapeHtml(run.session_id)}` : '会话：全局';
        const showRetry = run.status === 'failed';
        const instanceLabel = ''; // 实例标签（预留）
        return `
          <div class="tool-run-card status-${escapeHtml(run.status || 'unknown')}" data-run-id="${escapeHtml(run.id)}">
            <div class="tool-run-head">
              <div>
                <span class="tool-run-name">${escapeHtml(run.tool_name || '工具')}</span>
                <span class="tool-run-meta">${statusText}</span>
                <span class="tool-run-meta">发起：${escapeHtml(ownerName)}</span>
                <span class="tool-run-meta">${sessionTag}</span>
                ${instanceLabel}
              </div>
              <div class="tool-run-actions">
                <button class="link-button" data-action="toggleToolRunLog" data-log-id="${logId}">查看日志</button>
                ${showRetry ? `<button class="link-button" data-action="rerunTool" data-run-id="${escapeHtml(run.id)}">重试</button>` : ''}
              </div>
            </div>
            <div class="tool-run-body">
              <div>命令：${escapeHtml(command)}</div>
              <div>任务：${escapeHtml(taskId)}</div>
              <div>开始：${escapeHtml(started)}</div>
              <div>耗时：${escapeHtml(duration)}</div>
            </div>
            <div class="tool-run-log" id="${logId}">${renderToolRunLog(run)}</div>
          </div>
        `;
      }

      function renderToolRuns() {
        const container = document.getElementById('tool-run-list');
        const stats = document.getElementById('tool-run-stats');
        if (!container) {
          return;
        }
        const runs = (allToolRuns || []).filter(run => {
          if (!currentSessionId) {
            return true;
          }
          // 当前会话或全局 ACE 运行都展示
          return (run.session_id || null) === currentSessionId || run.runner === 'ace';
        });
        const filtered = runs.filter(run => toolRunStatusFilter === 'all' ? true : run.status === toolRunStatusFilter);
        if (stats) {
          stats.textContent = runs.length ? `${filtered.length}/${runs.length}` : '';
        }
        document.querySelectorAll('.tool-run-filter-btn').forEach(btn => {
          const status = btn.getAttribute('data-status') || 'all';
          btn.classList.toggle('active', status === toolRunStatusFilter);
        });
        if (!filtered.length) {
          container.innerHTML = '<div class="empty-state">暂无工具执行记录</div>';
          return;
        }
        container.innerHTML = filtered.map(run => buildToolRunCard(run)).join('');
      }

      function renderAssists() {
        const container = document.getElementById('assist-list');
        if (!container) return;
        const visible = Array.isArray(allAssists) ? allAssists.filter(a => {
          if (currentSessionId) {
            return a.sessionId === currentSessionId;
          }
          return true;
        }) : [];
        if (!visible.length) {
          container.innerHTML = '<div class="empty-state">暂无协助请求</div>';
          return;
        }
        const cards = visible.slice(0, 50).map(req => buildAssistCard(req)).join('');
        container.innerHTML = cards;
      }

      function buildAssistCard(req) {
        const statusClass = `assist-${req.state || 'requested'}`;
        const created = req.createdAt ? formatTime(req.createdAt) : '';
        const header = `${req.assignedTo ? `➡ ${escapeHtml(req.assignedTo)}` : '待分配'} · ${escapeHtml(req.priority || 'normal')}`;
        const meta = [];
        if (req.taskId) meta.push(`任务 ${escapeHtml(req.taskId)}`);
        if (req.targetAgentId) meta.push(`目标 ${escapeHtml(req.targetAgentId)}`);
        if (Array.isArray(req.requiredCapabilities) && req.requiredCapabilities.length) {
          meta.push(`能力：${req.requiredCapabilities.map(escapeHtml).join(', ')}`);
        }
        const metaLine = meta.length ? `<div class="assist-meta">${meta.join(' · ')}</div>` : '';
        return `
        <div class="assist-card ${statusClass}">
          <div class="assist-header">
            <span class="assist-state">${escapeHtml(req.state || 'requested')}</span>
            <span class="assist-time">${created}</span>
          </div>
          <div class="assist-body">
            <div class="assist-title">${escapeHtml(req.description || '协助请求')}</div>
            <div class="assist-sub">${header}</div>
            ${metaLine}
          </div>
        </div>
      `;
      }

      window.setToolRunStatusFilter = function (filter) {
        if (!filter) {
          return;
        }
        if (filter === toolRunStatusFilter) {
          return;
        }
        toolRunStatusFilter = filter;
        renderToolRuns();
      };

      // 工具/MCP 相关方法暴露给按钮
      window.requestToolRunsSnapshot = requestToolRunsSnapshot;
      window.runToolCommand = runToolCommand;
      window.runMcpPing = runMcpPing;
      window.runMcpTool = runMcpTool;
      window.refreshMcpTools = refreshMcpTools;
      window.handleMcpServerChange = handleMcpServerChange;

      /**
       * 渲染 MCP 服务器列表（主函数）
       * @param {Array} servers - 服务器数组
       */
      function renderMcpServers(servers) {
        allMcpServers = Array.isArray(servers) ? servers : [];
        const container = document.getElementById('mcp-server-list');
        const statsEl = document.getElementById('mcp-server-stats');

        if (!container) return;

        // 1. 清理无效的缓存
        cleanupMcpCaches();

        // 2. 更新统计信息
        updateMcpServerStats(statsEl);

        // 3. 渲染服务器列表或空状态
        if (allMcpServers.length === 0) {
          renderMcpEmptyState(container);
          return;
        }

        container.innerHTML = allMcpServers.map(buildMcpServerCard).join('');
      }

      /**
       * 清理无效的 MCP 缓存
       */
      function cleanupMcpCaches() {
        const validIds = new Set(allMcpServers.map(server => server.id));

        Array.from(mcpToolsCache.keys()).forEach(id => {
          if (!validIds.has(id)) mcpToolsCache.delete(id);
        });

        Array.from(pendingMcpRefresh).forEach(id => {
          if (!validIds.has(id)) pendingMcpRefresh.delete(id);
        });
      }

      /**
       * 更新 MCP 服务器统计信息
       * @param {HTMLElement} statsEl - 统计元素
       */
      function updateMcpServerStats(statsEl) {
        if (!statsEl) return;

        const enabledCount = allMcpServers.filter(s => s.enabled).length;
        const availableCount = allMcpServers.filter(s => {
          const status = mcpServerStatus.get(s.id);
          return s.enabled && status?.available;
        }).length;

        if (enabledCount > 0) {
          statsEl.textContent = `${availableCount}/${enabledCount} 在线`;
        } else if (allMcpServers.length > 0) {
          statsEl.textContent = '全部已停用';
        } else {
          statsEl.textContent = '';
        }
      }

      /**
       * 渲染 MCP 空状态
       * @param {HTMLElement} container - 容器元素
       */
      function renderMcpEmptyState(container) {
        container.innerHTML =
          '<div class="empty-state">暂无 MCP Server 配置' +
          '<div class="mcp-empty-cta">' +
          '<button class="mcp-btn" data-action="openMcpAddModal">立即添加</button>' +
          '</div></div>';
      }

      /**
       * 构建单个 MCP 服务器卡片
       * @param {Object} server - 服务器对象
       * @returns {string} HTML 字符串
       */
      function buildMcpServerCard(server) {
        const statusInfo = mcpServerStatus.get(server.id);
        const isEnabled = server.enabled !== false;

        // 构建各个部分
        const statusBadge = buildMcpServerStatusBadge(isEnabled, statusInfo);
        const serverInfo = buildMcpServerInfo(server);
        const toolsSummary = buildMcpServerToolsSummary(server, statusInfo);
        const actions = buildMcpServerActions(server, isEnabled, statusInfo);
        const stateHint = isEnabled ? '' :
          '<div class="global-agent-meta">此 Server 已停用，启用后即可重新连接并刷新状态</div>';

        const cardClasses = 'mcp-server-card' + (isEnabled ? '' : ' disabled');

        return `
          <div class="${cardClasses}">
            <div class="mcp-card-header">
              <div class="mcp-card-title">${escapeHtml(server.name)}</div>
              ${statusBadge}
            </div>
            <div class="mcp-card-body">
              ${serverInfo}
              ${stateHint}
              ${toolsSummary}
            </div>
            <div class="mcp-card-actions">
              ${actions}
            </div>
          </div>
        `;
      }

      /**
       * 构建 MCP 服务器状态徽章
       * @param {boolean} isEnabled - 是否启用
       * @param {Object} statusInfo - 状态信息
       * @returns {string} HTML 字符串
       */
      function buildMcpServerStatusBadge(isEnabled, statusInfo) {
        if (!isEnabled) {
          return '<span class="mcp-badge disabled">已停用</span>';
        }
        if (statusInfo?.available) {
          return '<span class="mcp-badge enabled">可用</span>';
        }
        return `<span class="mcp-badge disabled">${escapeHtml(statusInfo?.error || '不可用')}</span>`;
      }

      /**
       * 构建 MCP 服务器信息
       * @param {Object} server - 服务器对象
       * @returns {string} HTML 字符串
       */
      function buildMcpServerInfo(server) {
        const argsPreview = (server.args || []).join(' ');
        const envPreview = server.env ? Object.keys(server.env).join(', ') : '';
        const statusInfo = mcpServerStatus.get(server.id);
        const statusToolCount = typeof statusInfo?.toolCount === 'number' ? statusInfo.toolCount : null;

        let html = `<div>${escapeHtml(server.command)}${argsPreview ? ' ' + escapeHtml(argsPreview) : ''}</div>`;

        if (server.description) {
          html += `<div>${escapeHtml(server.description)}</div>`;
        }
        if (envPreview) {
          html += `<div>Env: ${escapeHtml(envPreview)}</div>`;
        }

        html += `<div class="global-agent-meta">工具缓存：${statusToolCount !== null ? statusToolCount + ' 个' : '未知'}</div>`;

        return html;
      }

      /**
       * 构建 MCP 服务器工具列表摘要
       * @param {Object} server - 服务器对象
       * @param {Object} statusInfo - 状态信息
       * @returns {string} HTML 字符串
       */
      function buildMcpServerToolsSummary(server, statusInfo) {
        const tools = mcpToolsCache.get(server.id);

        if (!tools) {
          return '<div class="global-agent-meta">工具列表将自动加载，保存后稍候查看</div>';
        }

        const toolItems = Array.isArray(tools) && tools.length > 0
          ? tools.map(tool => {
            const toolName = tool.name || tool.id || '(未命名)';
            const fullText = toolName + (tool.description ? '：' + tool.description : '');
            return `<div class="mcp-tool-item" title="${escapeHtml(fullText)}">` +
              `${escapeHtml(toolName)}${tool.description ? '：' + escapeHtml(tool.description) : ''}` +
              `</div>`;
          }).join('')
          : '<div class="global-agent-meta">暂无工具配置</div>';

        return `<details style="margin-top: 8px;"><summary>工具列表 (${tools.length})</summary>${toolItems}</details>`;
      }

      /**
       * 构建 MCP 服务器操作按钮
       * @param {Object} server - 服务器对象
       * @param {boolean} isEnabled - 是否启用
       * @param {Object} statusInfo - 状态信息
       * @returns {string} HTML 字符串
       */
      function buildMcpServerActions(server, isEnabled, statusInfo) {
        const isRefreshing = pendingMcpRefresh.has(server.id);
        const refreshDisabled = isRefreshing || !isEnabled;
        const refreshText = isRefreshing ? '刷新中...' : '刷新';
        const toggleLabel = isEnabled ? '停用' : '启用';
        const toggleNext = isEnabled ? 'false' : 'true';

        return `
          <button class="mcp-card-btn" data-action="toggleMcpServer" data-mcp-id="${server.id}" data-enable="${toggleNext}">${toggleLabel}</button>
          <button class="mcp-card-btn ghost" data-action="refreshMcpServer" data-mcp-id="${server.id}"${refreshDisabled ? ' disabled' : ''}>${refreshText}</button>
          <button class="mcp-card-btn" data-action="editMcpServer" data-mcp-id="${server.id}">编辑</button>
          <button class="mcp-card-btn danger" data-action="deleteMcpServer" data-mcp-id="${server.id}">删除</button>
        `;
      }

      function getMcpServerById(serverId) {
        if (!serverId) {
          return null;
        }
        return (allMcpServers || []).find(server => server.id === serverId) || null;
      }

      window.openMcpConfigModal = function (mode = 'create', serverId = null) {
        const modal = document.getElementById('modal-mcp-config');
        const textarea = document.getElementById('mcp-config-json');
        const errorEl = document.getElementById('mcp-config-error');
        const titleEl = document.getElementById('mcp-config-title');
        if (!modal || !textarea || !errorEl || !titleEl) {
          return;
        }
        errorEl.textContent = '';
        currentMcpServerEditId = mode === 'edit' ? serverId : null;
        const target = serverId ? getMcpServerById(serverId) : null;
        if (mode === 'edit' && target) {
          titleEl.textContent = '编辑 MCP Server - ' + target.name;
          const payload = {
            name: target.name,
            description: target.description || '',
            command: target.command,
            args: target.args || [],
            env: target.env || {},
            enabled: target.enabled,
            is_default: target.is_default
          };
          textarea.value = JSON.stringify(payload, null, 2);
        } else {
          titleEl.textContent = '新增 MCP Server';
          textarea.value = JSON.stringify({
            name: 'mcp-server',
            description: '',
            command: 'python',
            args: ['-m', 'my_mcp.entry'],
            env: {},
            enabled: true,
            is_default: allMcpServers.length === 0
          }, null, 2);
        }
        window.openModal('modal-mcp-config');
      };

      function normalizeMcpConfigPayload(input, allowImplicitDefault) {
        const toConfig = (raw, fallbackName) => {
          if (!raw || typeof raw !== 'object' || Array.isArray(raw)) {
            throw new Error('配置必须是对象');
          }
          const name = (raw.name ?? fallbackName ?? '').toString().trim();
          const command = (raw.command ?? '').toString().trim();
          if (!name || !command) {
            throw new Error('name 和 command 为必填项');
          }
          const args = Array.isArray(raw.args) ? raw.args.map(arg => String(arg)) : [];
          let env;
          if (raw.env !== undefined) {
            if (!raw.env || typeof raw.env !== 'object' || Array.isArray(raw.env)) {
              throw new Error('env 必须是对象');
            }
            env = Object.fromEntries(Object.entries(raw.env).map(([key, value]) => [String(key), String(value)]));
          }
          return {
            name,
            description: raw.description ? String(raw.description) : undefined,
            command,
            args,
            env,
            enabled: raw.enabled !== false,
            is_default: !!raw.is_default
          };
        };

        if (input && typeof input === 'object' && !Array.isArray(input) && input.mcpServers && typeof input.mcpServers === 'object' && !Array.isArray(input.mcpServers)) {
          const entries = Object.entries(input.mcpServers).map(([key, value]) => toConfig(value, key));
          if (entries.length === 0) {
            throw new Error('mcpServers 为空');
          }
          if (allowImplicitDefault && !entries.some(item => item.is_default)) {
            entries[0].is_default = true;
          }
          return entries;
        }
        return [toConfig(input)];
      }

      window.submitMcpConfig = function () {
        const textarea = document.getElementById('mcp-config-json');
        const errorEl = document.getElementById('mcp-config-error');
        if (!textarea || !errorEl) {
          return;
        }
        errorEl.textContent = '';
        let parsed;
        try {
          parsed = JSON.parse(textarea.value);
        } catch (error) {
          errorEl.textContent = 'JSON 解析失败：' + (error instanceof Error ? error.message : error);
          return;
        }

        let configs = [];
        try {
          configs = normalizeMcpConfigPayload(parsed, allMcpServers.length === 0 && !currentMcpServerEditId);
        } catch (error) {
          errorEl.textContent = error instanceof Error ? error.message : String(error);
          return;
        }

        if (currentMcpServerEditId) {
          if (configs.length !== 1) {
            errorEl.textContent = '编辑模式仅支持单个 MCP Server 配置';
            return;
          }
          vscode.postMessage({
            type: 'update_mcp_server',
            data: { id: currentMcpServerEditId, config: configs[0] }
          });
        } else {
          configs.forEach((config) => {
            vscode.postMessage({
              type: 'create_mcp_server',
              data: { config }
            });
          });
        }
        window.closeModal();
      };

      window.refreshMcpServer = function (serverId) {
        if (!serverId) {
          return;
        }
        pendingMcpRefresh.add(Number(serverId));
        renderMcpServers(allMcpServers);
        vscode.postMessage({
          type: 'refresh_mcp_server_status',
          data: { id: Number(serverId) }
        });
      };

      window.toggleMcpServer = function (serverId, enableValue) {
        if (!serverId) {
          return;
        }
        const enabled =
          typeof enableValue === 'string'
            ? enableValue === 'true'
            : !!enableValue;
        vscode.postMessage({
          type: 'toggle_mcp_server',
          data: { id: Number(serverId), enabled }
        });
      };

      const FILE_CHANGE_NO_TASK_KEY = '__no_task__';
      let fileChangeFilter = 'all';
      let fileChangeViewMode = 'timeline';
      let fileChangeTaskFilter = '';
      let fileChangeAgentFilter = '';
      const expandedFileChanges = new Set();

      function renderFileChanges(changes) {
        allFileChanges = Array.isArray(changes) ? changes : [];
        const container = document.getElementById('file-changes-list');
        const statsEl = document.getElementById('file-change-stats');
        if (!container) {
          return;
        }

        const baseChanges = currentSessionId
          ? allFileChanges.filter(change => (change.session_id || null) === currentSessionId)
          : [];

        const filtered = baseChanges.filter(change => {
          if (fileChangeFilter !== 'all' && change.change_type !== fileChangeFilter) {
            return false;
          }
          if (fileChangeTaskFilter && !(String(change.task_id ?? '')).includes(fileChangeTaskFilter)) {
            return false;
          }
          if (fileChangeAgentFilter && !(String(change.agent_id ?? '')).includes(fileChangeAgentFilter)) {
            return false;
          }
          return true;
        });

        const sorted = filtered
          .slice()
          .sort((a, b) => (b.created_at || 0) - (a.created_at || 0));

        if (statsEl) {
          if (baseChanges.length === 0) {
            statsEl.textContent = '0 条';
          } else if (sorted.length === 0) {
            statsEl.textContent = '0/' + baseChanges.length + ' 条';
          } else if (fileChangeViewMode === 'task') {
            const uniqueTasks = new Set(
              sorted.map(change => getTaskGroupKey(change.task_id))
            );
            statsEl.textContent = uniqueTasks.size + ' 个任务';
          } else if (
            fileChangeFilter === 'all' &&
            !fileChangeTaskFilter &&
            !fileChangeAgentFilter
          ) {
            statsEl.textContent = baseChanges.length + ' 条';
          } else {
            statsEl.textContent = sorted.length + '/' + baseChanges.length + ' 条';
          }
        }

        if (sorted.length === 0) {
          if (!currentSessionId) {
            container.innerHTML = '<div class="empty-state">请选择一个会话以查看文件变更</div>';
          } else if (baseChanges.length === 0) {
            container.innerHTML =
              '<div class="empty-state">当前会话尚未产生文件变更。若 Agent 已完成产物，可直接在工作区查看或等待写文件工具记录。</div>';
          } else {
            container.innerHTML = '<div class="empty-state">当前筛选条件下没有记录</div>';
          }
          return;
        }

        if (fileChangeViewMode === 'task') {
          container.innerHTML = buildFileChangeTaskView(sorted);
          return;
        }

        container.innerHTML = sorted
          .slice(0, 8)
          .map(change => buildFileChangeItem(change))
          .join('');
      }

      function buildFileChangeItem(change) {
        const badgeColor =
          change.change_type === 'create'
            ? '#4caf50'
            : change.change_type === 'delete'
              ? '#f44336'
              : '#2196f3';

        const lineSummary = change.line_changes
          ? '+' + change.line_changes.added + ' / -' + change.line_changes.removed
          : '';

        const isExpanded = expandedFileChanges.has(change.id);

        return [
          '<div class="file-change-item" data-change-id="' + change.id + '">',
          '<div class="file-change-item-header">',
          '<div>',
          '<div class="file-path">' + escapeHtml(change.file_path) + '</div>',
          '<div style="font-size: 11px; color: var(--vscode-descriptionForeground);">' +
          (lineSummary ? lineSummary + ' • ' : '') + formatTime(change.created_at) +
          '</div>',
          '</div>',
          '<span class="badge" style="background-color: ' + badgeColor + '; color: white;">' + change.change_type + '</span>',
          '</div>',
          '<div style="font-size: 12px; color: var(--vscode-foreground); margin-top: 6px;">' + escapeHtml(change.reason || '自动记录') + '</div>',
          '<div class="file-change-actions">',
          '<button class="file-change-action-btn" data-action="toggleFileChangeDetail" data-change-id="' + change.id + '">' +
          (isExpanded ? '收起详情' : '查看详情') +
          '</button>',
          '<button class="file-change-action-btn" data-action="openFileChange" data-change-id="' + change.id + '">打开文件</button>',
          '<button class="file-change-action-btn" data-action="copyFileChangeDiff" data-change-id="' + change.id + '">复制 diff</button>',
          '<button class="file-change-action-btn" data-action="rollbackFileChange" data-change-id="' + change.id + '">回滚</button>',
          '</div>',
          isExpanded
            ? '<div class="file-change-detail">' +
            '<div style="font-size: 11px; color: var(--vscode-descriptionForeground); margin-bottom: 6px;">变更 ID: ' + change.id + '</div>' +
            '<div class="file-change-diff">' + formatDiffHtml(change.diff) + '</div>' +
            '</div>'
            : '',
          '</div>'
        ].join('');
      }

      function focusFileChangePanel() {
        const rightSidebar = document.getElementById('right-sidebar');
        if (rightSidebar && rightSidebar.classList.contains('collapsed')) {
          rightSidebar.classList.remove('collapsed');
          const toggleBtn = rightSidebar.querySelector('.collapse-btn');
          if (toggleBtn) {
            toggleBtn.textContent = '▶';
          }
        }

        const panel = document.getElementById('panel-file-changes');
        if (!panel) {
          return;
        }
        if (panel.classList.contains('collapsed')) {
          panel.classList.remove('collapsed');
          panel.style.flex = '1';
          panel.style.height = '';
          const btn = panel.querySelector('.panel-collapse-btn');
          if (btn) {
            btn.textContent = '▼';
          }
        }
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      function formatDiffHtml(diffText) {
        if (!diffText) {
          return '<div class="diff-line">没有可预览的 diff</div>';
        }
        return diffText.split(/\r?\n/).map(line => {
          let cls = 'diff-line';
          if (line.startsWith('+')) {
            cls += ' diff-line-add';
          } else if (line.startsWith('-')) {
            cls += ' diff-line-remove';
          } else if (line.startsWith('@@')) {
            cls += ' diff-line-hunk';
          }
          return '<div class="' + cls + '">' + escapeHtml(line) + '</div>';
        }).join('');
      }

      function buildFileChangeTaskView(changes) {
        const grouped = new Map();
        changes.forEach(change => {
          const key = getTaskGroupKey(change.task_id);
          if (!grouped.has(key)) {
            const label = key === FILE_CHANGE_NO_TASK_KEY
              ? '未关联任务'
              : '任务 ' + String(change.task_id);
            grouped.set(key, { display: label, items: [] });
          }
          grouped.get(key).items.push(change);
        });

        const entries = Array.from(grouped.values())
          .map(group => {
            const sortedItems = group.items
              .slice()
              .sort((a, b) => (b.created_at || 0) - (a.created_at || 0));
            const latestItem = sortedItems.length > 0 ? sortedItems[0] : null;
            return {
              display: group.display,
              items: sortedItems,
              latest: latestItem && latestItem.created_at ? latestItem.created_at : 0
            };
          })
          .sort((a, b) => b.latest - a.latest)
          .slice(0, 5);

        if (entries.length === 0) {
          return '<div class="empty-state">当前筛选条件下没有任务</div>';
        }

        return entries
          .map(entry => buildFileChangeTaskGroup(entry.display, entry.items))
          .join('');
      }

      function buildFileChangeTaskGroup(taskDisplayId, items) {
        if (!items || items.length === 0) {
          return '';
        }

        const latestTime = items[0] && items[0].created_at
          ? formatTime(items[0].created_at)
          : '未知时间';

        const stats = { create: 0, modify: 0, delete: 0 };
        items.forEach(item => {
          if (stats[item.change_type] !== undefined) {
            stats[item.change_type] += 1;
          }
        });
        const summaryParts = [];
        if (stats.create) summaryParts.push('新增 ' + stats.create);
        if (stats.modify) summaryParts.push('修改 ' + stats.modify);
        if (stats.delete) summaryParts.push('删除 ' + stats.delete);
        const summaryText = summaryParts.length ? summaryParts.join(' / ') : '暂无统计';

        const agentIds = Array.from(new Set(items.map(item => item.agent_id).filter(Boolean)));
        let agentSummaryText = agentIds.length
          ? 'Agent：' + agentIds.slice(0, 3).join(', ')
          : 'Agent：暂无';
        if (agentIds.length > 3) {
          agentSummaryText += ' 等 ' + agentIds.length + ' 个';
        }

        const listHtml = items
          .slice(0, 3)
          .map(item => buildFileChangeItem(item))
          .join('');

        const remainder = items.length - 3;
        const remainderText = remainder > 0
          ? '<div class="task-group-more">还有 ' + remainder + ' 条变更，打开任务可查看全部</div>'
          : '';

        return [
          '<div class="file-change-task-group">',
          '<div class="task-group-header">',
          '<div class="task-group-title">' + escapeHtml(taskDisplayId) + '</div>',
          '<span class="task-group-meta">' + escapeHtml(summaryText) + ' • 最近 ' + escapeHtml(latestTime) + '</span>',
          '</div>',
          '<div class="task-group-agent">' + escapeHtml(agentSummaryText) + '</div>',
          '<div class="task-group-list">',
          listHtml || '<div class="empty-state">暂无记录</div>',
          remainderText,
          '</div>',
          '</div>'
        ].join('');
      }

      function getTaskGroupKey(taskId) {
        if (taskId === undefined || taskId === null || taskId === '') {
          return FILE_CHANGE_NO_TASK_KEY;
        }
        return String(taskId);
      }

      window.toggleFileChangeDetail = function (changeId) {
        const numericId = Number(changeId);
        if (Number.isNaN(numericId)) {
          return;
        }
        if (expandedFileChanges.has(numericId)) {
          expandedFileChanges.delete(numericId);
        } else {
          expandedFileChanges.add(numericId);
        }
        renderFileChanges(allFileChanges);
      };

      window.copyFileChangeDiff = function (changeId) {
        const numericId = Number(changeId);
        if (Number.isNaN(numericId)) {
          return;
        }
        const change = allFileChanges.find(item => item.id === numericId);
        if (!change) {
          vscode.postMessage({
            type: 'show_info',
            message: '未找到变更 ' + numericId
          });
          return;
        }
        const diffText = change.diff || '没有可预览的 diff';
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(diffText).then(() => {
            vscode.postMessage({
              type: 'show_info',
              message: '已复制变更 ' + numericId + ' 的 diff'
            });
          }).catch(() => {
            vscode.postMessage({
              type: 'show_info',
              message: '复制失败，请手动复制'
            });
          });
        } else {
          vscode.postMessage({
            type: 'show_info',
            message: '当前环境不支持剪贴板，请手动复制'
          });
        }
      };

      window.rollbackFileChange = function (changeId) {
        const numericId = Number(changeId);
        if (Number.isNaN(numericId)) {
          return;
        }
        vscode.postMessage({
          type: 'rollback_file_change',
          data: { changeId: numericId }
        });
      };

      window.openFileChange = function (changeId) {
        const numericId = Number(changeId);
        if (Number.isNaN(numericId)) {
          return;
        }
        vscode.postMessage({
          type: 'open_file_change',
          data: { changeId: numericId }
        });
      };

      window.setFileChangeFilter = function (filter) {
        if (!['all', 'create', 'modify', 'delete'].includes(filter)) {
          filter = 'all';
        }
        fileChangeFilter = filter;
        expandedFileChanges.clear();
        document.querySelectorAll('.file-change-filter-btn').forEach(btn => {
          const value = btn.getAttribute('data-filter') || 'all';
          btn.classList.toggle('active', value === filter);
        });
        renderFileChanges(allFileChanges);
      };

      window.setFileChangeTaskFilter = function (value, options = {}) {
        const normalized = value || '';
        fileChangeTaskFilter = normalized;
        if (!options.skipInputSync) {
          const input = document.getElementById('file-change-task-filter');
          if (input && input.value !== normalized) {
            input.value = normalized;
          }
        }
        expandedFileChanges.clear();
        renderFileChanges(allFileChanges);
        renderTasks(allTasks);
      };

      window.setFileChangeAgentFilter = function (value) {
        fileChangeAgentFilter = value || '';
        expandedFileChanges.clear();
        renderFileChanges(allFileChanges);
      };

      window.filterFileChangesByTask = function (taskId) {
        const normalized = taskId ? String(taskId) : '';
        const nextValue = normalized && normalized === fileChangeTaskFilter ? '' : normalized;
        focusFileChangePanel();
        if (fileChangeViewMode !== 'timeline') {
          window.setFileChangeView('timeline');
          // setFileChangeView already re-renders; task filter update follows
        }
        window.setFileChangeTaskFilter(nextValue);
      };

      window.setFileChangeView = function (viewMode) {
        const allowed = ['timeline', 'task'];
        if (!allowed.includes(viewMode)) {
          viewMode = 'timeline';
        }
        const changed = fileChangeViewMode !== viewMode;
        fileChangeViewMode = viewMode;
        if (changed) {
          expandedFileChanges.clear();
        }
        document.querySelectorAll('.file-change-view-btn').forEach(btn => {
          const value = btn.getAttribute('data-view') || 'timeline';
          btn.classList.toggle('active', value === viewMode);
        });
        renderFileChanges(allFileChanges);
      };    // 接收消息
      window.addEventListener('message', event => {
        const message = event.data;
        console.log('[MinimalPanel] Received message:', message.type);

        switch (message.type) {
          case 'agents_data':
          case 'agents_update':
            updateStatus('Agents loaded');
            renderAgents(message.data);
            break;
          case 'agent_refresh_status':
            if (message.data && message.data.id) {
              pendingAgentRefresh.delete(message.data.id);
              renderGlobalAgentTable(allAgents);
              if (message.data.success) {
                updateStatus('Agent 刷新成功');
              } else if (message.data.error) {
                updateStatus('Agent 刷新失败：' + message.data.error);
              }
            }
            break;

          case 'tasks_data':
          case 'tasks_update':
            updateStatus('Tasks loaded');
            renderTasks(message.data);
            if (message.type === 'tasks_update') {
              scheduleTaskMetricsRefresh();
            }
            break;

          case 'messages_data':
          case 'messages_update':
            console.log('[MinimalPanel] Messages loaded:', message.data.length);
            renderMessages(message.data);
            updateStatus('Messages loaded: ' + message.data.length);
            break;

          case 'blackboard_message':
            console.log('[MinimalPanel] Received real-time message:', message.data);
            if (message.data) {
              allMessages.push(message.data);
              renderMessages(allMessages);
            }
            break;

          case 'notifications_data':
          case 'notifications_update':
            console.log('[MinimalPanel] Notifications loaded:', message.data.length);
            renderNotifications(message.data);
            break;

          case 'tool_runs_data':
          case 'tool_runs_update':
            allToolRuns = Array.isArray(message.data) ? message.data : [];
            renderToolRuns();
            renderAceActivity();
            rerenderWorkspaceIfVisible();
            break;

          case 'assists_data':
          case 'assist_update':
            if (message.type === 'assists_data') {
              allAssists = Array.isArray(message.data) ? message.data : [];
            } else if (message.data) {
              applyAssistDelta(message.data);
            }
            renderAssists();
            break;
          case 'manager_llm_test_result':
            if (message.data?.success) {
              updateManagerLLMStatusBanner('测试成功：' + (message.data.message || '已响应'), 'success');
            } else {
              updateManagerLLMStatusBanner('测试失败：' + (message.data?.message || '未知错误'), 'error');
            }
            break;

          case 'sessions_data':
          case 'sessions_update':
            console.log('[MinimalPanel] Sessions loaded:', Array.isArray(message.data) ? message.data.length : 0);
            applySessionsPayload(message.data);
            break;
          case 'thinking_logs_data':
          case 'thinking_logs_update':
            console.log('[MinimalPanel] Thinking logs loaded:', Array.isArray(message.data) ? message.data.length : 0);
            allThinkingLogs = Array.isArray(message.data) ? message.data : [];
            if (selectedAgentId) {
              const currentAgent = allAgents.find(agent => agent.id === selectedAgentId);
              renderWorkspace(currentAgent || null);
            }
            break;
          case 'task_metrics_update':
            renderTaskMetrics(message.data || null);
            break;
          case 'llm_stream_update':
            handleLlmStreamMessage(message.data);
            break;

          case 'file_changes_update':
            console.log('[MinimalPanel] File changes update:', message.data.length);
            renderFileChanges(message.data);
            break;
          case 'file_changes_data':
            console.log('[MinimalPanel] File changes loaded:', message.data.length);
            renderFileChanges(message.data);
            break;
          case 'mcp_servers_update':
          case 'mcp_servers_data':
            console.log('[MinimalPanel] MCP servers loaded:', Array.isArray(message.data) ? message.data.length : 0);
            renderMcpServers(message.data);
            allMcpServers = Array.isArray(message.data) ? message.data : [];
            renderMcpServerSelect();
            renderMcpToolSelect(getSelectedMcpServerId());
            break;
          case 'mcp_tools_data':
            if (message.data && typeof message.data.serverId === 'number') {
              mcpToolsCache.set(message.data.serverId, message.data.tools || []);
              renderMcpServers(allMcpServers);
              const currentServerId = getSelectedMcpServerId();
              if (currentServerId === message.data.serverId) {
                renderMcpToolSelect(currentServerId);
              }
            }
            break;
          case 'mcp_server_status':
            if (message.data && typeof message.data.serverId === 'number') {
              mcpServerStatus.set(message.data.serverId, {
                available: !!message.data.available,
                error: message.data.error || null,
                toolCount: typeof message.data.toolCount === 'number' ? message.data.toolCount : null
              });
              pendingMcpRefresh.delete(message.data.serverId);
              renderMcpServers(allMcpServers);
            }
            break;
          case 'mcp_tool_result':
            renderMcpToolResult(message.data || null);
            break;

          case 'task_backlog_update':
            taskBacklogSummaries = Array.isArray(message.data) ? message.data : [];
            renderTasks(allTasks);
            break;
          case 'scheduler_event':
            handleSchedulerEvent(message.data);
            break;
          case 'sentinel_event':
            handleSentinelEvent(message.data);
            break;
          case 'ace_config':
            handleAceConfigPayload(message.data);
            break;
          case 'ace_config_error':
            updateAceStatusBanner(message.data?.message || '加载 ACE 配置失败', 'error');
            updateAceStatusIndicator(false, '配置错误');
            break;
          case 'manager_llm_config':
            handleManagerLLMConfigPayload(message.data);
            break;
          case 'manager_llm_config_error':
            updateManagerLLMStatusBanner(message.data?.message || '加载经理 LLM 配置失败', 'error');
            break;
          case 'ace_state_update':
            aceStateData = message.data || null;
            renderAceStateOverview();
            break;
          case 'ace_refresh_status':
            updateAceStatusBanner(message.data?.message || '', message.data?.success ? 'success' : 'error');
            if (message.data?.success) {
              updateAceStatusIndicator(true, '已连接');
            }
            break;
          case 'ace_search_result':
            if (aceSearchResultEl) {
              if (message.data?.success) {
                aceSearchResultEl.textContent = message.data.result || '无结果';
              } else {
                aceSearchResultEl.textContent = message.data?.message || '搜索失败';
              }
            }
            break;
          case 'ace_test_connection_result':
            if (message.data?.success) {
              updateAceStatusBanner('连接测试成功', 'success');
              updateAceStatusIndicator(true, '已连接');
            } else {
              updateAceStatusBanner(message.data?.message || '连接测试失败', 'error');
              updateAceStatusIndicator(false, '连接失败');
            }
            break;
          case 'ace_config_saved':
            if (message.data?.success) {
              updateAceStatusBanner('ACE 配置已保存', 'success');
              // 重新加载配置以更新状态
              vscode.postMessage({ type: 'get_ace_config' });
            } else {
              updateAceStatusBanner(message.data?.message || '保存配置失败', 'error');
            }
            break;
          case 'sensitive_command_confirmation_required':
            // 显示敏感命令确认弹窗
            if (message.data) {
              window.showSensitiveConfirmModal(message.data);
            }
            break;
          default:
            console.warn('[MinimalPanel] Unknown message type:', message.type);
        }
      });

      function handleLlmStreamMessage(payload) {
        if (!payload) {
          return;
        }
        
        // 处理思考过程折叠
        let processedContent = payload.content;
        if (payload.content && typeof window.processThinkingContent === 'function') {
          processedContent = window.processThinkingContent(payload.content);
        }
        
        // 保存LLM回复到对话历史
        if (payload.status === 'done' && payload.content && payload.session_id) {
          // 发送消息到后端保存到对话历史
          const messageData = {
            content: processedContent, // 使用处理后的内容
            priority: 'normal',
            session_id: payload.session_id,
            agent_id: payload.agent_id,
            category: 'agent_summary', // 使用现有的类型
            visibility: 'blackboard',
            task_id: payload.task_id
          };
          
          vscode.postMessage({
            type: 'send_message',
            data: messageData
          });
        }
        
        const key = payload.task_id || ('agent:' + (payload.agent_id || 'unknown'));
        if (payload.status === 'done' || payload.status === 'error') {
          llmStreamStates.delete(key);
        } else {
          llmStreamStates.set(key, {
            ...payload,
            content: processedContent, // 使用处理后的内容
            updatedAt: payload.timestamp || Date.now()
          });
        }
        if (selectedAgentId) {
          const currentAgent = allAgents.find(agent => agent.id === selectedAgentId);
          renderWorkspace(currentAgent || null);
        }
      }

      // 侧边栏收起/展开功能
      window.toggleLeftSidebar = function () {
        const sidebar = document.getElementById('left-sidebar');
        const btn = sidebar.querySelector('.collapse-btn');
        sidebar.classList.toggle('collapsed');
        btn.textContent = sidebar.classList.contains('collapsed') ? '▶' : '◀';
        console.log('[MinimalPanel] Left sidebar toggled');
      };

      window.toggleRightSidebar = function () {
        const sidebar = document.getElementById('right-sidebar');
        const btn = sidebar.querySelector('.collapse-btn');
        sidebar.classList.toggle('collapsed');
        btn.textContent = sidebar.classList.contains('collapsed') ? '◀' : '▶';
        console.log('[MinimalPanel] Right sidebar toggled');
      };

      // 面板折叠/展开功能
      window.togglePanel = function (event) {
        const target = event.target.closest('[data-panel]');
        if (!target) return;

        const panelId = target.getAttribute('data-panel');
        const panel = document.getElementById(panelId);
        if (!panel) return;

        const isCollapsing = !panel.classList.contains('collapsed');

        if (isCollapsing) {
          // 折叠：移除自定义高度，让 CSS 类控制
          panel.style.height = '';
          panel.style.flex = '';
          panel.classList.add('collapsed');
        } else {
          // 展开：恢复默认 flex
          panel.classList.remove('collapsed');
          panel.style.flex = '1';
          panel.style.height = '';
        }

        const btn = panel.querySelector('.panel-collapse-btn');
        if (btn) {
          btn.textContent = panel.classList.contains('collapsed') ? '▶' : '▼';
        }
        console.log('[MinimalPanel] Panel toggled:', panelId, isCollapsing ? 'collapsed' : 'expanded');
      };

      // LLM Provider 切换处理
      function handleProviderChange() {
        const provider = document.getElementById('agent-llm-provider').value;
        const modelInput = document.getElementById('agent-llm-model');
        const baseUrlGroup = document.getElementById('base-url-group');
        const baseUrlInput = document.getElementById('agent-llm-base-url');
        const baseUrlHint = document.getElementById('base-url-hint');
        const modelHint = document.getElementById('model-hint');
        const apiKeyHint = document.getElementById('api-key-hint');

        const preset = LLM_PRESETS[provider];
        if (!preset) return;

        // 检查当前模型是否属于当前 provider 的模型列表
        const currentModel = modelInput.value.trim();
        const isValidModel = currentModel === '' ||
          !preset.models.includes(currentModel);

        // 如果当前模型不属于当前 provider，或者为空，设置为默认模型
        if (isValidModel && preset.defaultModel) {
          modelInput.value = preset.defaultModel;
        }

        // 检查当前 Base URL 是否是某个 preset 的默认值
        const currentBaseUrl = baseUrlInput.value.trim();
        const isPresetBaseUrl = currentBaseUrl === '' ||
          Object.values(LLM_PRESETS).some(p => p.baseURL === currentBaseUrl);

        // Base URL 输入（始终显示，允许覆盖）
        baseUrlGroup.style.display = 'block';

        // 如果是空的或者是其他 preset 的默认值，更新为当前 provider 的 Base URL
        if (isPresetBaseUrl) {
          if (preset.baseURL) {
            baseUrlInput.value = preset.baseURL;
            baseUrlInput.placeholder = preset.baseURL;
            if (baseUrlHint) {
              baseUrlHint.textContent = `默认：${preset.baseURL}，可按需修改`;
            }
          } else {
            baseUrlInput.value = '';
            baseUrlInput.placeholder = 'https://your-api-endpoint.com/v1';
            if (baseUrlHint) {
              baseUrlHint.textContent = '请输入符合 OpenAI 协议的接口地址';
            }
          }
        } else if (baseUrlHint) {
          // 用户自定义的 Base URL，保持不变
          baseUrlHint.textContent = '已自定义 Base URL，可根据需要修改';
        }

        // 更新提示信息
        if (preset.models.length > 0) {
          modelHint.textContent = '可选模型：' + preset.models.join(', ');
        } else {
          modelHint.textContent = '请输入自定义模型名称';
        }

        apiKeyHint.textContent = '必填：用于调用 ' + preset.name + ' API';
        renderModelSuggestions(provider);
      }

      // 监听 provider 变化
      const providerSelect = document.getElementById('agent-llm-provider');
      if (providerSelect) {
        providerSelect.addEventListener('change', handleProviderChange);
        renderModelSuggestions(providerSelect.value);
      }

      function renderModelSuggestions(provider) {
        const container = document.getElementById('model-suggestion-chips');
        if (!container) {
          return;
        }
        const preset = LLM_PRESETS[provider];
        if (!preset || preset.models.length === 0) {
          container.innerHTML = '<span class="form-hint">无推荐模型，可自定义填写</span>';
          return;
        }
        container.innerHTML = preset.models.map(model => (
          '<button type="button" class="chip" data-action="applyModelSuggestion" data-model="' + escapeHtml(model) + '">' +
          escapeHtml(model) +
          '</button>'
        )).join('');
      }

      window.applyModelSuggestion = function (model) {
        if (!model) {
          return;
        }
        const input = document.getElementById('agent-llm-model');
        if (!input) {
          return;
        }
        input.value = model;
      };

      /**
       * 初始化 Agent 添加弹窗
       * @param {HTMLElement} modal - 模态弹窗元素
       */
      function initializeAgentModal(modal) {
        if (!modal) return;

        try {
          // 初始化 LLM provider 提示
          handleProviderChange();

          const form = modal.querySelector('form');
          if (!form) return;

          const submitBtn = modal.querySelector('[data-action="submitEditAgent"], [data-action="submitAddAgent"]');
          const isEditing = submitBtn?.getAttribute('data-action') === 'submitEditAgent';

          // 如果是新增模式，重置所有选择
          if (!isEditing) {
            setSelectedRoles(form, []);
            setSelectedCapabilities(form, []);
            setSelectedToolPermissions(form, []);
          }
        } catch (error) {
          console.error('[MinimalPanel] Error initializing agent modal:', error);
        }
      }

      /**
       * 聚焦到模态弹窗的第一个输入框
       * @param {HTMLElement} modal - 模态弹窗元素
       */
      function focusFirstInput(modal) {
        if (!modal) return;

        setTimeout(() => {
          try {
            const firstInput = modal.querySelector('input, textarea, select');
            if (firstInput && typeof firstInput.focus === 'function') {
              firstInput.focus();
            }
          } catch (error) {
            console.warn('[MinimalPanel] Error focusing first input:', error);
          }
        }, 100);
      }

      /**
       * 打开模态弹窗
       * 根据弹窗类型进行相应的初始化
       * @param {string} modalId - 模态弹窗的 ID
       */
      window.openModal = function (modalId) {
        if (!modalId || typeof modalId !== 'string') {
          console.error('[MinimalPanel] Invalid modal ID:', modalId);
          return;
        }

        console.log('[MinimalPanel] Opening modal:', modalId);

        const modal = document.getElementById(modalId);
        if (!modal) {
          console.error('[MinimalPanel] Modal not found:', modalId);
          return;
        }

        try {
          // 显示弹窗
          modal.classList.add('show');

          // 根据弹窗类型进行初始化
          if (modalId === 'modal-add-agent') {
            initializeAgentModal(modal);
          }

          // 聚焦到第一个输入框
          focusFirstInput(modal);
        } catch (error) {
          console.error('[MinimalPanel] Error opening modal:', modalId, error);
        }
      };

      /**
       * 重置 Agent 添加弹窗的状态
       * @param {HTMLElement} modal - 模态弹窗元素
       */
      function resetAgentModalState(modal) {
        if (!modal) return;

        const form = modal.querySelector('form');
        if (!form) return;

        // 重置标题为"添加 Agent"
        const titleEl = modal.querySelector('.modal-title');
        if (titleEl) {
          titleEl.textContent = '添加 Agent';
        }

        // 重置提交按钮状态
        const submitBtn = modal.querySelector('[data-action="submitEditAgent"], [data-action="submitAddAgent"]');
        if (submitBtn) {
          submitBtn.setAttribute('data-action', 'submitAddAgent');
          submitBtn.removeAttribute('data-agent-id');
          submitBtn.textContent = '确定';
        }

        // 恢复 ID 输入框可编辑
        const idInput = form.querySelector('[name="id"]');
        if (idInput) {
          idInput.disabled = false;
        }

        // 重置所有选择状态
        setSelectedRoles(form, []);
        setSelectedCapabilities(form, []);
        setSelectedToolPermissions(form, []);
      }

      /**
       * 清空表单数据
       * @param {HTMLElement} modal - 模态弹窗元素
       */
      function clearModalForm(modal) {
        if (!modal) return;

        const form = modal.querySelector('form');
        if (form) {
          form.reset();
          setSelectedRoles(form, []);
          setSelectedToolPermissions(form, []);
        }
      }

      /**
       * 重置特定模态弹窗的状态
       * @param {HTMLElement} modal - 模态弹窗元素
       */
      function resetModalSpecificState(modal) {
        if (!modal) return;

        const modalId = modal.id;

        // 重置 Agent 添加弹窗
        if (modalId === 'modal-add-agent') {
          resetAgentModalState(modal);
        }

        // 重置任务详情弹窗
        if (modalId === 'modal-task-detail') {
          currentTaskDetail = null;
        }

        // 重置任务依赖弹窗
        if (modalId === 'modal-task-dependency') {
          currentTaskDependencyDetail = null;
        }

        // 重置 MCP 配置弹窗
        if (modalId === 'modal-mcp-config') {
          currentMcpServerEditId = null;
          const errorInput = document.getElementById('mcp-config-error');
          if (errorInput) {
            errorInput.textContent = '';
          }
        }
      }

      /**
       * 关闭所有打开的模态弹窗
       * 清空表单数据并重置各弹窗的特定状态
       */
      window.closeModal = function () {
        console.log('[MinimalPanel] Closing modal');
        const modals = document.querySelectorAll('.modal-overlay.show');

        if (!modals || modals.length === 0) {
          console.warn('[MinimalPanel] No open modals found');
          return;
        }

        modals.forEach(modal => {
          try {
            // 移除显示类
            modal.classList.remove('show');

            // 清空表单
            clearModalForm(modal);

            // 重置特定弹窗状态
            resetModalSpecificState(modal);
          } catch (error) {
            console.error('[MinimalPanel] Error closing modal:', modal.id, error);
          }
        });
      };

      // 敏感命令确认相关变量
      let pendingSensitiveCommand = null;

      // 显示敏感命令确认弹窗
      window.showSensitiveConfirmModal = function (commandData) {
        pendingSensitiveCommand = commandData;
        const modal = document.getElementById('modal-sensitive-confirm');
        if (!modal) return;

        // 填充命令信息
        const commandDisplay = document.getElementById('sensitive-command-display');
        if (commandDisplay) {
          commandDisplay.textContent = commandData.command || '未知命令';
        }

        // 填充匹配的关键字
        const keywordsDisplay = document.getElementById('sensitive-keywords-display');
        if (keywordsDisplay) {
          keywordsDisplay.innerHTML = '';
          if (commandData.matchedKeywords && commandData.matchedKeywords.length > 0) {
            commandData.matchedKeywords.forEach(keyword => {
              const tag = document.createElement('span');
              tag.className = 'keyword-tag';
              tag.textContent = keyword;
              keywordsDisplay.appendChild(tag);
            });
          } else {
            keywordsDisplay.textContent = '无';
          }
        }

        // 填充风险等级
        const riskDisplay = document.getElementById('sensitive-risk-level-display');
        if (riskDisplay) {
          const riskLevel = commandData.riskLevel || 'medium';
          const riskText = {
            high: '高风险',
            medium: '中风险',
            low: '低风险'
          }[riskLevel] || '未知';
          riskDisplay.textContent = riskText;
          riskDisplay.className = `risk-level-display ${riskLevel}`;
        }

        // 填充操作来源
        const sourceDisplay = document.getElementById('sensitive-source-display');
        if (sourceDisplay) {
          const source = commandData.source || '未知';
          const runner = commandData.runner || '';
          sourceDisplay.textContent = runner ? `${source} (${runner})` : source;
        }

        // 显示弹窗
        modal.classList.add('show');
      };

      // 关闭敏感命令确认弹窗
      window.closeSensitiveModal = function () {
        const modal = document.getElementById('modal-sensitive-confirm');
        if (modal) {
          modal.classList.remove('show');
        }
        pendingSensitiveCommand = null;
      };

      // 确认执行敏感命令
      window.confirmSensitiveCommand = function () {
        if (!pendingSensitiveCommand) {
          window.closeSensitiveModal();
          return;
        }

        // 重新发送工具执行请求，带上 confirmed: true
        vscode.postMessage({
          type: 'run_tool_command',
          data: {
            command: pendingSensitiveCommand.command,
            confirmed: true,
            session_id: pendingSensitiveCommand.sessionId,
            task_id: pendingSensitiveCommand.taskId
          }
        });

        window.closeSensitiveModal();
        updateStatus('已确认执行敏感命令');
      };

      // 初始化标签云事件监听器
      function initTagCloudListeners() {
        // 能力标签点击事件
        document.querySelectorAll('#agent-capabilities-cloud .tag-chip').forEach(chip => {
          chip.addEventListener('click', function () {
            this.classList.toggle('selected');
          });
        });

      }

      window.addCustomCapability = function () {
        const value = typeof prompt === 'function' ? (prompt('输入自定义能力标签') || '').trim() : '';
        if (!value) {
          return;
        }
        const container = document.getElementById('agent-capabilities-cloud');
        if (!container) {
          return;
        }
        const existing = container.querySelector(`[data-capability="${value}"]`);
        if (existing) {
          existing.classList.add('selected');
          return;
        }
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'tag-chip capability selected';
        chip.setAttribute('data-capability', value);
        chip.textContent = value;
        chip.addEventListener('click', function () {
          this.classList.toggle('selected');
        });
        container.appendChild(chip);
      };

      window.removeCustomCapability = function (capability) {
        if (!capability) {
          return;
        }
        const container = document.getElementById('agent-capabilities-cloud');
        if (!container) {
          return;
        }
        const target = container.querySelector(`[data-capability="${capability}"]`);
        if (target) {
          target.remove();
        }
      };

      // 页面加载时初始化
      initTagCloudListeners();

      // ESC 键关闭
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          window.closeModal();
        }
      });

      window.addEventListener('beforeunload', () => { });

      // 添加 Agent
      window.addAgent = function () {
        console.log('[MinimalPanel] Add agent clicked');
        const form = document.getElementById('form-add-agent');
        if (form) {
          form.reset();
          const idInput = form.querySelector('[name="id"]');
          if (idInput) {
            idInput.disabled = false;
          }
          setSelectedCapabilities(form, []);
        }
        const modal = document.getElementById('modal-add-agent');
        if (modal) {
          modal.querySelector('.modal-title').textContent = '添加 Agent';
          const submitBtn = modal.querySelector('.modal-footer .btn-primary');
          if (submitBtn) {
            submitBtn.setAttribute('data-action', 'submitAddAgent');
            submitBtn.removeAttribute('data-agent-id');
            submitBtn.textContent = '确定';
          }
        }
        handleProviderChange();
        updateStatus('Opening add agent modal...');
        window.openModal('modal-add-agent');
      };

      /**
       * 提交添加 Agent 表单
       * 验证表单数据，收集 Agent 信息，发送到后端
       */
      window.submitAddAgent = function () {
        console.log('[MinimalPanel] Submit add agent');

        try {
          const form = document.getElementById('form-add-agent');
          if (!form) {
            console.error('[MinimalPanel] Agent form not found');
            updateStatus('表单加载失败');
            return;
          }

          // 验证表单有效性
          if (!form.checkValidity()) {
            form.reportValidity();
            return;
          }

          // 收集表单数据
          const formData = new FormData(form);
          const capabilities = getSelectedCapabilities(form);

          // 验证能力标签
          if (!capabilities || capabilities.length === 0) {
            updateStatus('请至少选择一个能力标签');
            const firstCap = form.querySelector('#agent-capabilities-cloud .tag-chip');
            if (firstCap) {
              firstCap.focus();
            }
            return;
          }

          // 构建 Agent 数据对象
          const agentData = {
            id: formData.get('id'),
            display_name: formData.get('display_name'),
            capabilities,
            capability_tags: capabilities,
            llm_provider: formData.get('llm_provider'),
            llm_model: formData.get('llm_model'),
            llm_api_key: formData.get('llm_api_key') || undefined,
            llm_base_url: formData.get('llm_base_url') || undefined
          };

          console.log('[MinimalPanel] Agent data:', agentData);
          updateStatus('Creating agent...');

          // 发送到后端
          vscode.postMessage({
            type: 'create_agent',
            data: agentData
          });

          // 关闭模态弹窗
          window.closeModal();
        } catch (error) {
          console.error('[MinimalPanel] Error submitting agent:', error);
          updateStatus('提交 Agent 失败: ' + (error?.message || '未知错误'));
        }
      };

      /**
       * 提交编辑 Agent 表单
       * 验证表单数据，收集更新的 Agent 信息，发送到后端
       */
      window.submitEditAgent = function () {
        console.log('[MinimalPanel] Submit edit agent');

        try {
          const form = document.getElementById('form-add-agent');
          if (!form) {
            console.error('[MinimalPanel] Agent form not found');
            updateStatus('表单加载失败');
            return;
          }

          const submitBtn = document.querySelector('[data-action="submitEditAgent"]');
          if (!submitBtn) {
            console.error('[MinimalPanel] Submit button not found');
            updateStatus('提交按钮加载失败');
            return;
          }

          const agentId = submitBtn.getAttribute('data-agent-id');
          if (!agentId) {
            console.error('[MinimalPanel] Agent ID not found');
            updateStatus('Agent ID 缺失');
            return;
          }

          // 验证表单有效性
          if (!form.checkValidity()) {
            form.reportValidity();
            return;
          }

          // 收集表单数据
          const formData = new FormData(form);
          const capabilities = getSelectedCapabilities(form);

          // 验证能力标签
          if (!capabilities || capabilities.length === 0) {
            updateStatus('请至少选择一个能力标签');
            const firstCap = form.querySelector('#agent-capabilities-cloud .tag-chip');
            if (firstCap) {
              firstCap.focus();
            }
            return;
          }

          // 构建更新的 Agent 数据对象
          const agentData = {
            id: agentId,
            display_name: formData.get('display_name'),
            capabilities,
            capability_tags: capabilities,
            llm_provider: formData.get('llm_provider'),
            llm_model: formData.get('llm_model'),
            llm_api_key: formData.get('llm_api_key') || undefined,
            llm_base_url: formData.get('llm_base_url') || undefined
          };

          console.log('[MinimalPanel] Update agent data:', agentData);
          updateStatus('Updating agent...');

          // 发送到后端
          vscode.postMessage({
            type: 'update_agent',
            data: agentData
          });

          // 关闭模态弹窗
          window.closeModal();
        } catch (error) {
          console.error('[MinimalPanel] Error submitting edit agent:', error);
          updateStatus('更新 Agent 失败: ' + (error?.message || '未知错误'));
        }
      };

      // 面板拖动调整大小功能
      let isDragging = false;
      let currentResizer = null;
      let currentPanel = null;
      let startY = 0;
      let startHeight = 0;

      document.querySelectorAll('.panel-resizer').forEach(resizer => {
        resizer.addEventListener('mousedown', (e) => {
          isDragging = true;
          currentResizer = resizer;
          const targetId = resizer.getAttribute('data-target');
          currentPanel = document.getElementById(targetId);

          if (!currentPanel) return;

          startY = e.clientY;
          startHeight = currentPanel.offsetHeight;

          currentResizer.classList.add('dragging');
          document.body.style.cursor = 'ns-resize';
          document.body.style.userSelect = 'none';

          e.preventDefault();
        });
      });

      // 输入区域拖动调整大小功能
      const MIN_INPUT_HEIGHT = 100;
      const MAX_INPUT_HEIGHT = 360;

      let isInputResizing = false;
      let inputArea = null;
      let inputStartY = 0;
      let inputStartHeight = 0;

      const inputResizeHandle = document.getElementById('input-resize-handle');
      if (inputResizeHandle) {
        inputResizeHandle.addEventListener('mousedown', (e) => {
          isInputResizing = true;
          inputArea = document.getElementById('message-textarea-wrapper');

          if (!inputArea) return;

          inputStartY = e.clientY;
          inputStartHeight = inputArea.offsetHeight;

          inputResizeHandle.classList.add('dragging');
          document.body.style.cursor = 'ns-resize';
          document.body.style.userSelect = 'none';

          e.preventDefault();
        });
      }

      document.addEventListener('mousemove', (e) => {
        if (isDragging && currentPanel) {
          const deltaY = e.clientY - startY;
          const newHeight = startHeight + deltaY;

          // 限制最小高度
          if (newHeight >= 100) {
            currentPanel.style.flex = 'none';
            currentPanel.style.height = newHeight + 'px';
          }
        }

        if (isInputResizing && inputArea) {
          const deltaY = inputStartY - e.clientY; // 反向，因为是从下往上拖
          const newHeight = inputStartHeight + deltaY;

          const clampedHeight = Math.max(MIN_INPUT_HEIGHT, Math.min(newHeight, MAX_INPUT_HEIGHT));
          inputArea.style.height = clampedHeight + 'px';
        }
      });

      document.addEventListener('mouseup', () => {
        if (isDragging) {
          isDragging = false;
          if (currentResizer) {
            currentResizer.classList.remove('dragging');
          }
          currentResizer = null;
          currentPanel = null;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }

        if (isInputResizing) {
          isInputResizing = false;
          if (inputResizeHandle) {
            inputResizeHandle.classList.remove('dragging');
          }
          inputArea = null;
          document.body.style.cursor = '';
          document.body.style.userSelect = '';
        }
      });

      // 消息搜索输入框事件监听
      const messageSearchInput = document.getElementById('message-search');
      if (messageSearchInput) {
        messageSearchInput.addEventListener('input', (e) => {
          window.searchMessages(e.target.value);
        });
      }
      initMentionInput();

      // 消息列表滚动监听
      const messagesContainer = document.getElementById('messages-list');
      if (messagesContainer) {
        messagesContainer.addEventListener('scroll', () => {
          if (isAtBottom(messagesContainer)) {
            // User scrolled to bottom
            isUserScrolling = false;
            hasNewMessages = false;
            hideNewMessageButton();
          } else {
            // User scrolled away from bottom
            isUserScrolling = true;
          }
        });
      }

      // 事件委托
      /**
       * 主事件委托处理器
       * 处理所有 data-action 属性的点击事件
       */
      document.addEventListener('click', (e) => {
        try {
          const target = e.target;
          if (!target || !(target instanceof HTMLElement)) {
            return;
          }

          // 获取 data-action 元素
          const actionElement = target.closest('[data-action]');
          if (!actionElement || !(actionElement instanceof HTMLElement)) {
            return;
          }

          const action = actionElement.getAttribute('data-action');
          if (!action || typeof action !== 'string') {
            console.warn('[MinimalPanel] Invalid action:', action);
            return;
          }

          console.log('[MinimalPanel] Action clicked:', action);

          if (action === 'togglePanel') {
            window.togglePanel(e);
          } else if (action === 'closeModal') {
            window.closeModal();
          } else if (action === 'closeSensitiveModal') {
            window.closeSensitiveModal();
          } else if (action === 'confirmSensitiveCommand') {
            window.confirmSensitiveCommand();
          } else if (action === 'submitAddAgent') {
            window.submitAddAgent();
          } else if (action === 'submitEditAgent') {
            window.submitEditAgent();
          } else if (action === 'selectAgent') {
            const agentId = actionElement.getAttribute('data-agent-id') || '';
            if (agentId) {
              window.selectAgent(agentId, e);
            }
          } else if (action === 'openGlobalAgentTab') {
            window.openGlobalAgentTab();
          } else if (action === 'handleNotificationClick') {
            const notificationId = actionElement.getAttribute('data-notification-id') || '';
            window.handleNotificationClick(notificationId);
          } else if (action === 'openCreateSessionModal') {
            window.openCreateSessionModal();
          } else if (action === 'confirmCreateSession') {
            window.confirmCreateSession();
          } else if (action === 'openDeleteSessionModal') {
            window.openDeleteSessionModal();
          } else if (action === 'confirmDeleteSession') {
            window.confirmDeleteSession();
          } else if (action === 'setFileChangeFilter') {
            const filter = actionElement.getAttribute('data-filter') || 'all';
            window.setFileChangeFilter(filter);
          } else if (action === 'applyMessageTemplate') {
            window.applyMessageTemplate(templateId);
          } else if (action === 'openReferenceTarget') {
            const refType = actionElement.getAttribute('data-reference-type') || '';
            const refId = actionElement.getAttribute('data-reference-id') || '';
            openReferenceTarget(refType, refId);
            const taskId = actionElement.getAttribute('data-task-id') || '';
          } else if (action === 'openTaskDetailModal') {
            const taskId = actionElement.getAttribute('data-task-id') || '';
            window.openTaskDetailModal(taskId);
          } else if (action === 'openTaskDependencyModal') {
            const taskId = actionElement.getAttribute('data-task-id') || '';
            window.openTaskDependencyModal(taskId);
          } else if (action === 'focusTaskInList') {
            const taskId = actionElement.getAttribute('data-task-id') || '';
            window.focusTaskInList(taskId);
          } else if (action === 'focusBacklogSummary') {
            const summaryId = actionElement.getAttribute('data-summary-id') || '';
            focusBacklogSummary(summaryId || null);
          } else if (action === 'clearBacklogFilter') {
            focusBacklogSummary(null);
          } else if (action === 'setFileChangeView') {
            const view = actionElement.getAttribute('data-view') || 'timeline';
            window.setFileChangeView(view);
          } else if (action === 'filterFileChangesByTask') {
            const taskId = actionElement.getAttribute('data-task-id') || '';
            window.filterFileChangesByTask(taskId);
          } else if (action === 'pauseTask') {
            const taskId = actionElement.getAttribute('data-task-id') || '';
            if (taskId) {
              window.pauseTask(taskId);
            }
          } else if (action === 'rerunTool') {
            const runId = actionElement.getAttribute('data-run-id') || '';
            if (runId) {
              vscode.postMessage({ type: 'rerun_tool', data: { run_id: runId } });
            }
          } else if (action === 'toggleToolRunLog') {
            const logId = actionElement.getAttribute('data-log-id');
            if (logId) {
              const el = document.getElementById(logId);
              if (el) {
                el.classList.toggle('visible');
              }
            }
          } else if (action === 'resumeTask') {
            const taskId = actionElement.getAttribute('data-task-id') || '';
            if (taskId) {
              window.resumeTask(taskId);
            }
          } else if (action === 'switchWorkspaceTab') {
            const tab = actionElement.getAttribute('data-workspace-tab') || 'overview';
            window.switchWorkspaceTab(tab);
          } else if (action === 'setWorkspaceScope') {
            const scope = actionElement.getAttribute('data-scope') || 'all';
            window.setWorkspaceThinkingScope(scope);
          } else if (action === 'toggleThinkingTypeFilter') {
            const filterKey = actionElement.getAttribute('data-filter-key') || '';
            window.toggleThinkingTypeFilter(filterKey || actionElement);
          } else if (action === 'resetThinkingTypeFilters') {
            window.resetThinkingTypeFilters();
          } else if (action === 'openMcpAddModal') {
            window.openMcpConfigModal('create');
          } else if (action === 'refreshMcpServer') {
            const serverId = Number(actionElement.getAttribute('data-mcp-id'));
            if (!Number.isNaN(serverId)) {
              window.refreshMcpServer(serverId);
            }
          } else if (action === 'toggleMcpServer') {
            const serverId = Number(actionElement.getAttribute('data-mcp-id'));
            if (!Number.isNaN(serverId)) {
              const enableValue = actionElement.getAttribute('data-enable') || 'false';
              window.toggleMcpServer(serverId, enableValue);
            }
          } else if (action === 'addCustomCapability') {
            window.addCustomCapability();
          } else if (action === 'removeCustomCapability') {
            const capability = actionElement.getAttribute('data-capability') || '';
            window.removeCustomCapability(capability);
          } else if (action === 'applyModelSuggestion') {
            const model = actionElement.getAttribute('data-model') || '';
            window.applyModelSuggestion(model);
          } else if (action === 'refreshWorkspace') {
            window.refreshWorkspace();
          } else if (action === 'editMcpServer') {
            const serverId = Number(actionElement.getAttribute('data-mcp-id'));
            if (!Number.isNaN(serverId)) {
              window.openMcpConfigModal('edit', serverId);
            }
          } else if (action === 'deleteMcpServer') {
            const serverId = Number(actionElement.getAttribute('data-mcp-id'));
            if (!Number.isNaN(serverId)) {
              const confirmed = window.confirm('确定要删除该 MCP Server 吗？此操作不可撤销。');
              if (confirmed) {
                vscode.postMessage({
                  type: 'delete_mcp_server',
                  data: { id: serverId }
                });
              }
            }
          } else if (action === 'toggleFileChangeDetail') {
            const changeId = Number(actionElement.getAttribute('data-change-id'));
            if (!Number.isNaN(changeId)) {
              window.toggleFileChangeDetail(changeId);
            }
          } else if (action === 'openFileChange') {
            const changeId = Number(actionElement.getAttribute('data-change-id'));
            if (!Number.isNaN(changeId)) {
              window.openFileChange(changeId);
            }
          } else if (action === 'copyFileChangeDiff') {
            const changeId = Number(actionElement.getAttribute('data-change-id'));
            if (!Number.isNaN(changeId)) {
              window.copyFileChangeDiff(changeId);
            }
          } else if (action === 'rollbackFileChange') {
            const changeId = Number(actionElement.getAttribute('data-change-id'));
            if (!Number.isNaN(changeId)) {
              window.rollbackFileChange(changeId);
            }
          } else if (action === 'toggleThinkingEntry') {
            const entryId = actionElement.getAttribute('data-entry-id') || '';
            if (typeof window.toggleThinkingEntry === 'function') {
              window.toggleThinkingEntry(entryId || actionElement);
            }
          } else if (typeof window[action] === 'function') {
            try {
              window[action](e);
            } catch (error) {
              console.error('[MinimalPanel] Error executing action:', action, error);
            }
          } else {
            console.warn('[MinimalPanel] Unknown action or function not found:', action);
          }
        } catch (error) {
          console.error('[MinimalPanel] Error in click event handler:', error);
        }
      });


      // 接收来自后端的消息
      // ✅ 旧的测试代码已清理，现在使用新的标签切换逻辑（switchMainTab, switchBlackboardView）
      // ✅ 消息监听器已在上方统一处理，不需要重复添加

      // 自动加载初始数据
      console.log('[MinimalPanel] Loading initial data...');

      // 基础配置数据
      vscode.postMessage({ type: 'get_agents' });
      vscode.postMessage({ type: 'get_sessions' });
      vscode.postMessage({ type: 'get_mcp_servers' });
      vscode.postMessage({ type: 'get_ace_config' });
      vscode.postMessage({ type: 'get_ace_state' });
      vscode.postMessage({ type: 'get_manager_llm_config' });

      // 任务相关数据
      vscode.postMessage({ type: 'get_tasks' });
      vscode.postMessage({ type: 'get_task_backlogs' });
      requestTaskMetrics();

      // 会话相关数据（如果有当前会话）
      if (typeof currentSessionId !== 'undefined' && currentSessionId) {
        const payload = { sessionId: currentSessionId };
        vscode.postMessage({ type: 'get_messages', data: payload });
        vscode.postMessage({ type: 'get_notifications', data: payload });
        vscode.postMessage({ type: 'get_assists', data: payload });
        vscode.postMessage({ type: 'get_tool_runs', data: payload });
        vscode.postMessage({ type: 'get_file_changes', data: payload });
      }
    })();
  </script>
</body>

</html>/**
 * 思考过程折叠功能
 * 用于优化消息面板显示，将agent的思考过程折叠隐藏
 */

// 添加CSS样式
function addThinkingStyles() {
  if (document.getElementById('thinking-styles')) {
    return; // 已经添加过了
  }

  const styleElement = document.createElement('style');
  styleElement.id = 'thinking-styles';
  styleElement.textContent = `
    .thinking-section {
      margin: 8px 0;
    }
    .thinking-toggle:hover {
      color: var(--vscode-foreground) !important;
    }
    .thinking-step:last-child {
      margin-bottom: 0 !important;
    }
    .final-summary {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  `;
  document.head.appendChild(styleElement);
}

/**
 * 格式化agent消息，折叠思考过程
 * @param {string} content - 原始消息内容
 * @returns {string} 格式化后的HTML
 */
function formatAgentMessageWithThinking(content) {
  if (!content) return '';
  
  // 检测思考过程标记
  const thinkingRegex = /<thinking>([\s\S]*?)<\/thinking>/gi;
  const thinkingMatches = content.match(thinkingRegex);
  
  if (!thinkingMatches || thinkingMatches.length === 0) {
    // 没有思考过程，直接返回内容
    return escapeHtml(content);
  }
  
  // 提取思考过程和最终内容
  let finalContent = content;
  const thinkingContents = [];
  
  thinkingMatches.forEach(match => {
    // 移除thinking标签，保留内容
    const thinkingContent = match.replace(/<\/?thinking>/gi, '').trim();
    if (thinkingContent) {
      thinkingContents.push(thinkingContent);
    }
    // 从最终内容中移除思考过程
    finalContent = finalContent.replace(match, '');
  });
  
  // 清理最终内容（移除多余的空行）
  finalContent = finalContent.replace(/\n\s*\n/g, '\n').trim();
  
  const hasThinking = thinkingContents.length > 0;
  const thinkingId = `thinking-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
  
  let html = '';
  
  // 如果有思考过程，添加折叠的思考内容
  if (hasThinking) {
    html += `
      <div class="thinking-section">
        <div class="thinking-toggle" onclick="toggleThinking('${thinkingId}')" style="cursor: pointer; margin-bottom: 8px; color: var(--vscode-descriptionForeground); font-size: 12px;">
          <span id="${thinkingId}-icon">▶</span>
          <span>思考过程 (${thinkingContents.length} 步)</span>
        </div>
        <div id="${thinkingId}-content" class="thinking-content" style="display: none; margin-bottom: 12px; padding: 12px; background: var(--vscode-textBlockQuote-background); border-left: 3px solid var(--vscode-textBlockQuote-border); border-radius: 4px; font-size: 12px; line-height: 1.4;">
          ${thinkingContents.map((thinking, index) => 
            `<div class="thinking-step" style="margin-bottom: 8px;">
              <div class="thinking-step-header" style="font-weight: bold; color: var(--vscode-foreground); margin-bottom: 4px;">步骤 ${index + 1}:</div>
              <div class="thinking-step-content" style="color: var(--vscode-descriptionForeground); white-space: pre-wrap;">${escapeHtml(thinking)}</div>
            </div>`
          ).join('')}
        </div>
      </div>
    `;
  }
  
  // 添加最终总结内容
  if (finalContent) {
    html += `
      <div class="final-summary" style="padding: 12px; background: var(--vscode-editor-background); border: 1px solid var(--vscode-panel-border); border-radius: 4px; margin-top: 8px;">
        <div class="summary-header" style="font-weight: bold; color: var(--vscode-foreground); margin-bottom: 8px; font-size: 13px;">📋 总结</div>
        <div class="summary-content" style="color: var(--vscode-foreground); line-height: 1.5; white-space: pre-wrap;">${escapeHtml(finalContent)}</div>
      </div>
    `;
  }
  
  return html;
}

/**
 * 切换思考过程显示/隐藏
 * @param {string} thinkingId - 思考过程ID
 */
function toggleThinking(thinkingId) {
  const content = document.getElementById(`${thinkingId}-content`);
  const icon = document.getElementById(`${thinkingId}-icon`);
  
  if (content && icon) {
    const isHidden = content.style.display === 'none';
    content.style.display = isHidden ? 'block' : 'none';
    icon.textContent = isHidden ? '▼' : '▶';
  }
}

// 初始化样式
addThinkingStyles();
