# 验证与观测清单（WS6）

> 目标：零兼容、零残留，覆盖经理/MCP/ACE/任务/协助全链路，可重复执行。

## 0. 预置
- 工作区 `.arranger/arranger.db`、全局 `~/.arranger/system-setting.db` 已迁移；StateStore 已初始化。
- 经理 LLM 配置有效（单模型）；敏感关键字至少包含 1 条（action=confirm）。
- MCP server 配置可用；ACE base_url/token 已填，索引目录为当前工作区。

## 1. 回放脚本（手动顺序）
1) 打开插件 → 新建会话 → 发送用户消息“请写一个脚本”  
   - 期望：黑板出现经理流式回复，生成任务，指派 agent。
2) 触发自动 ACE 刷新  
   - 新任务创建后黑板播报“自动刷新上下文索引”；tool_runs 出现 `ace:index`；通知一条 info。
3) 手动运行 MCP 工具  
   - 在工具面板选择 server/tool，执行；blackboard 记录“已触发 MCP 工具”；tool_runs 状态为 succeeded。
4) 敏感命令拦截  
   - 执行包含敏感词的命令，未确认时抛错并记录 `state:sensitive_operation_log`；确认后可执行。
5) 任务调度并发/依赖  
   - 创建 3+ 任务，验证 queued→assigned 排序（优先级×难度），并发每 agent=1，serialized scope 生效。
6) 协助流程  
   - 发起协助请求，完成/取消后任务历史与黑板、通知更新。

## 2. 指标与日志
- 任务成功率：统计 `tasks` 表 status=completed / total，记录到报告。
- 经理成功率：统计黑板 manager_llm 消息 payload.status（completed/fallback/failed）。
- ACE 延迟：`tool_runs` 中 `ace:index/search` 的 duration_ms。
- MCP 成功率：`tool_runs` runner=mcp 成功/失败数。
- 敏感操作：`state_sensitive_operation_logs` 最新 10 条，确认拦截是否按 action 处理。

## 3. UI 检查点
- 顶栏状态条：经理点亮/处理中、任务队列数字、ACE 最近状态（失败时显示连续失败）。
- 消息区：经理/agent 流式输出、输入中标记；工具/自动化播报均在黑板。
- 通知中心：默认展示所有，无筛选。

## 4. 结果与问题处理
- 将上述步骤截图/日志（含 `tool_runs`、敏感日志查询结果）整理为回归报告。
- 发现问题：直接修复并更新本清单；不可留兼容分支或 TODO。
