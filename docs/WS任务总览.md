# WS 任务总览（零兼容版）

> 原则：零兼容、零残留。发现废弃/旧逻辑立即删除；所有状态以 StateStore/DB 为唯一事实源；完成即打 ✅，未完用 ⬜。严禁 mock。

| 编号 | 工作项 | 范围 / 要点（尽量细） | 开发要求（严禁兼容/残留） | 状态 |
| --- | --- | --- | --- | --- |
| WS1-1 | Schema/迁移收口 | 列出废弃字段/表（含 message_type、Workflow 相关索引/表），编写迁移步骤与校验用例；确认黑板/工具/协助/ACE 等全走新表与 StateStore | 不留任何兼容分支/索引；迁移文档+检查脚本；旧代码/DDL 直接清理 | ✅ |
| WS2-2 | 备用模型切换 & 指标 | 配置主/备模型，达到失败阈值自动切换并通知；记录成功率/失败率/耗时到 StateStore/DB；曝光指标查询接口 | 禁止 mock；真实链路调用；文档化配置与指标字段；无旧路径 | ⬜（暂停多 LLM，需按单模型重试+指标重述方案） |
| WS2-3 | 经理状态摘要 UI | 黑板/顶部状态条展示“处理中/完成/失败/重试”等摘要；显示 attempt/last_error；模型切换提示 | 基于现有 payload 渲染；无旧 UI 兼容代码；样式简洁 | ✅ |
| WS3-1 | 状态转移钩子 | 任务状态写 StateStore，transition 历史+事件+通知；完成/失败自动解阻/阻塞依赖 | transitionTaskStatus/sync 已落地，保持统一事件；无重复路径 | ✅ |
| WS3-2 | 并行/队列限制 | 会话总并发=MAX；每 Agent 并发=1；serialized scope/sibling；queued→assigned 调度排序（优先级×难度） | 验证并可配置；不保留旧并发逻辑；必要时补测试/脚本 | ✅ |
| WS3-3 | 自动脚本 | 经理/任务触发 ACE 刷新、测试重跑等自动脚本；写 tool_runs/黑板/通知；支持 run_after/delay | 真实执行，禁止 mock；复用 ToolExecutionService；敏感命令需确认 | ✅ |
| WS3-4 | 敏感命令确认/审批 | 执行前对敏感命令人工确认/审批，记录日志/事件；黑板/通知可追踪；可配置敏感关键字 | 清理旧审批残留；流程全量落库+事件；零兼容 | ✅ |
| WS3-5 | 工具播报/通知 | ToolRun 黑板播报 + 通知（含 MCP/ACE），统一 StateStore；状态/错误可见 | 已完成，保持一致性 | ✅ |
| WS3-6 | 协助机制 | AssistRequest StateStore + 黑板/通知；完成/取消回写任务历史；支持@目标 Agent | 已完成，保持无兼容代码 | ✅ |
| WS3-7 | 指派/调度策略 | 指派评分=能力标签+推理档位+成本+难度，优先级/延迟纳入调度；queued/assigned 排序规则 | 已完成；如需调优修改评分函数；禁止回退旧逻辑 | ✅ |
| WS4-1 | MCP/ACE 联动 | manager/agent 决策可触发 MCP/ACE 工具；写 tool_runs；黑板/通知同步；选择 server/工具/参数 | 基于 ToolExecutionService；敏感确认可复用；无旧路径 | ✅ |
| WS4-2 | ACE 自动化 | 新任务检查索引过期→自动刷新/提示；contextRefs 展示在 UI；失败/过期通知 | 真实 ACE 调用；状态走 StateStore；无本地缓存兼容 | ✅（已补充周期检测/通知、contextRefs 渲染） |
| WS5-1 | UI 状态订阅 | 黑板/任务/协助/工具/通知全基于 StateStore 事件；顶部状态条摘要关键健康（经理、ACE、队列） | 删除旧 UI/事件路径；简洁展示；状态组件订阅新事件 | ✅（顶栏新增工具失败摘要；消息支持 contextRefs） |
| WS6-1 | 验证与观测 | 全链路回放脚本；指标（任务成功率、ACE 延迟、经理成功率）；回归清单/报告 | 禁用 mock；提供脚本/报告；发现问题即修并更新本表 | ✅ |
| WS7-1 | 协助协调模式 | 非经理发起且点名协助默认需经理确认，黑板/通知提示“待经理协调”；支持备注到 assist.context | 零兼容，落库到 StateStore；黑板播报；可配置标记 | ⬜ |
| WS7-2 | 任务类型/拆分提示 | 经理拆分时标注任务类型（需求/缺陷/文档/杂项），写入 labels/metadata，兜底创建任务时也带 type | 无兼容路径；标签/metadata 落库；UI 不依赖旧字段 | ⬜ |

> 完成全部 ⬜ 项后，进入全量联调与回归测试，问题立刻修复并更新本表。
