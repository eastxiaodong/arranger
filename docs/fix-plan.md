# 核心业务修复方案（表格清单）

| 序号 | 项目 | 目标/内容 | 当前状态 | 说明/备注 |
| --- | --- | --- | --- | --- |
| 1 | 指派规则 | 仅指派给“启用 + 非离线 + LLM 配置齐全”的 Agent，避免无效/离线指派 | ✅ 完成 | 经理/自动指派/降级均过滤停用、离线及缺 LLM 配置的 Agent |
| 2 | 任务依赖编排 | 同一功能链按顺序创建任务，后续任务依赖前一个；依赖完成后自动解锁到队列再调度 | ✅ 完成 | 创建时有依赖即置阻塞；前序完成解阻入队，失败向下游阻塞 |
| 3 | ACE 写入（输出） | 任务完成后将结果写入 ACE 索引，并在黑板/工作台提示“已同步” | ✅ 完成 | 完成任务触发 ACE refresh，ToolRun/黑板/通知提示成功/失败 |
| 4 | ACE 检索（输入） | 任务领取前从 ACE 检索同任务/标签上下文，提示 Agent 前置产出 | ✅ 完成 | assigned/运行前自动检索，结果/错误写 metadata+黑板+通知，避免重复 |
| 5 | 跨批次依赖归并 | 同一会话/功能目标的多批任务，自动串依赖到未完成的上游任务 | ✅ 完成 | 创建时自动补同 session/plan/goal 未完成任务为依赖，阻塞/解阻闭环 |
| 6 | 并发/容量控制 | Busy 允许指派，但需简单并发上限/配额，避免过载 | ✅ 完成 | 会话/Agent 并发限流，不可用 Agent 自动解指派回队并告警 |
| 7 | 全局 Agent 状态持久化 | 从全局配置库读取 Agent 列表/状态/metrics，指派和 UI 用真实数据 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 8 | ACE 状态显示 | ACE 状态/活动节点中文提示，指示索引/搜索进度 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 9 | 中文化 | 所有徽章/标签/提示统一中文 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 10 | MCP 调用与回显 | Agent/用户可触发 MCP 工具，结果实时回填工作台/黑板（tool_runs 统一记录） | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 11 | 命令/终端/Web 工具 | 统一命令执行（run_tool_command）、Web 获取等工具调用链，返回值落黑板/工作台 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 12 | ACE 串联（索引/检索提示） | 任务完成写入 ACE 索引，领取前自动检索上下文并提示 Agent；索引/搜索过程有提示节点 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 13 | 跨批次依赖归并 | 同一功能/会话的多批任务自动补充 dependencies，串联前后序阶段 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 14 | 并发/容量控制 | 调度器对 Agent 并发任务数限流，busy 状态下避免过载 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 15 | 全局 Agent 数据贯通 | 指派/状态/metrics 一致来源于全局配置库，UI/调度用真实持久数据 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 16 | 工具/MCP 回显完善 | 工具运行节点（含 Web/命令/MCP）统一在工作台/黑板展示中文状态/错误 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 17 | 状态编排层（SSOT） | 任务/协助/工具日志/敏感策略/Agent 健康统一写 StateStore 并事件广播 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 18 | 调度经理池/降级 | 经理池健康检查、轮值，Sentinel 触发降级/接管；黑板透明播报 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 19 | 协助链路/反馈 | Assist 全链路与用户反馈（任务/过程/优先级）写入状态并影响调度 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 20 | 任务状态机对齐 | 状态机与文档（pending/active/blocked/needs-confirm/finalizing/done/...）一致 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 21 | 敏感命令/风险控制 | 工具执行敏感关键字策略统一进状态层，黑板提示确认/拦截情况 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 22 | Agent 健康/降级播报 | Agent 心跳、错误计数写入状态；掉线/失败时自动重指派并播报 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |
| 23 | 代码债务清理 | 全部功能落地后，逐行清理废弃/遗留/过期的 HTML/CSS/JS/DOM 等，消除代码债 | ⏳ 待验证 | 标记为待验证，需逐条核对实现 |

## 现场排查记录（/Users/xie/code/none_test/.arranger/arranger.db）
- tool_runs：仅 ACE 索引运行且落在 `session_id=global`，业务会话 `session-default` 无工具运行，Agent 工作台看不到任务相关运行。
- tasks：仅 `task_1763477415431_b5h1`（session-default，指派 gemini-2.5-pro，状态 pending），state_task_states 同步正常。
- blackboard：`session-default` 3 条，`global` 2 条（ACE 索引）；工作台按会话过滤，任务/消息/ToolRun/Thinking 需落在业务会话。
- thinking_logs：当前库无记录，ToolRun 也未落入业务会话，导致 Agent 工作台时间线缺任务相关活动。
