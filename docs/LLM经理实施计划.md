# LLM 经理调度实施计划（全面版）

> 目标：将当前 Arranger 原型扩展为“团队经理 + 多 Agents + 统一工具层”的正式可用系统。本计划覆盖数据/服务/UI 各层的改造，当全部任务完成后，系统即可支撑真实团队协作流程。

---

## 0. 现状综述（2025.02 更新）
- **黑板与消息**：黑板消息/通知完全流式显示；`message_type` 列与前端概念已移除，黑板依赖 `category/agent_id` 区分用户/系统。消息写入 DB + StateStore，事件推送稳定。
- **经理配置/播报**：Manager LLM 支持流式输出同一气泡，未返回结构化决策时会兜底建任务；任务创建会根据内容估算难度/优先级并写入标签/metadata。尚需更多决策/指派验证。
- **状态层**：`StateStore` 已与 DB 同步，`state_task_states` / `state_assist_requests` 落库，Task/Assist/ToolRuns/ACE 状态均走 StateStore 事件。
- **任务/工具**：TaskService/AssistService/ToolExecutionService 改为 StateStore+DB；自动指派基于能力标签/推理档位可用，但需用难度标签再调优；工具/MCP 运行记录可写 DB 与 UI。
- **ACE 集成**：配置/索引/搜索可用，运行状态写 StateStore；尚未与调度深度联动（后续 WS4）。

---

## 1. 总体策略
1. **StateStore 先行**：以状态层为唯一事实源，重建任务/协助/工具日志等数据表及事件流，淘汰 Workflow 旧逻辑。
2. **经理闭环调度**：经理 LLM 需要根据黑板消息自动拆解任务、指派 Agent、跟踪协助与工具执行，形成“输入→决策→状态→播报”的闭环。
3. **UI 实时反映**：黑板、任务面板、工作台等 UI 完全基于状态层事件渲染；顶部状态条、ACE 活动卡持续同步健康度。
4. **真实链路验证**：每阶段完结时都要通过真实项目消息或脚本验证链路，禁止使用 mock。
5. **零兼容负债**：所有改造必须是“完整替换”而非“新旧兼容”；一旦新方案取代旧逻辑，必须立即清理废弃代码、迁移脚本及文档，确保代码库简洁可读、质量一致。

---

## 2. 工作分解（Workstreams）

| 编号 | 工作流 | 目标 | 主要交付物 | 依赖 |
| --- | --- | --- | --- | --- |
| WS1 | 状态层与数据基座 | 统一任务/协助/工具日志/ACE/反馈等 Schema，StateStore+DB 同步；提供查询/订阅 API | 新版 `state.store.ts`、数据库迁移脚本、`state:*` 事件约定文档 | 无 |
| WS2 | 经理调度链路 | 监听所有黑板输入→调用经理 LLM→生成结构化决策→写入状态层→播报，并处理失败/降级 | `ManagerOrchestratorService` 扩展、决策 schema、降级策略 | WS1 |
| WS3 | 任务/协助执行 | 决策结果驱动 `TaskService` / `Assist` / `ToolExecution`，实现自动指派、协助申请、优先级调整等 | 任务/协助服务改造、状态同步、自动化钩子 | WS1、WS2 |
| WS4 | 工具/MCP/ACE 联动 | 所有工具调用（含 MCP）经 `ToolExecutionService` 写入状态层，敏感命令确认、ACE 上下文自动引用 | 工具执行回写、敏感策略 UI、ACE contextRefs 集成 | WS1 |
| WS5 | UI 与播报 | 黑板、任务面板、工具列表、顶部状态条完全基于状态层；新增经理播报卡片、任务/协助概览 | Webview 更新、状态订阅模块、交互文案 | WS1、WS2、WS3 |
| WS6 | 验证与观测 | 真机链路演练、日志与指标（任务成功率、索引健康、经理响应成功率），并提供回归脚本 | 演示脚本、测试用例、监控面板 | 所有 WS |

---

## 3. 详细任务清单

### WS1：状态层与数据基座
1. **Schema 设计**  
   - 任务（task_states+tasks 表）、协助（assist_requests）、工具日志（tool_runs）、敏感策略、ACE 状态等字段定义；清理 Workflow 遗留表。  
   - 输出：《StateStore Schema v2》文档 + SQL 迁移脚本。
2. **StateStore 改造**  
   - Map 改为读写数据库；所有 CRUD 统一由 StateStore 暴露方法。  
   - 在 `state.store.ts` 增加数据库引用、持久化逻辑、事件派发。
   - ✅ 已完成：落地 `state_task_states` / `state_assist_requests` 表，StateStore 初始化即与数据库同步并持久化任务与协助记录。
3. **服务接入**  
   - `TaskService` / `MessageService` / `ToolExecutionService` / `AceContextService` 改为调用 StateStore，不再各自维护缓存。  
   - ✅ `ToolExecutionService` 运行记录改为 StateStore/新表，并统一事件广播。  
   - ✅ 协助链路新增 `AssistService`（StateStore + 黑板 + 通知），替换旧协助逻辑。  
   - ✅ **Schema/兼容清理**：`message_type` 列/概念彻底移除（前后端与 DB），Workflow 兼容逻辑清理完毕，黑板/通知/工具日志均走新表与事件。  
   - ✅ **WS1 验收**：迁移说明与废弃字段清单已就绪，验证用例覆盖任务/协助/工具日志/ACE 状态/敏感策略，本阶段标记为 Done。

### WS2：经理调度链路
1. **消息解析**  
   - 支持识别普通消息、回复、引用、@Agent/@manager；构造统一的 `ManagerIntent` 对象。  
   - 安全策略：过滤私密命令、限制重复触发频率。
2. **LLM 调用策略**  
   - System Prompt 模板 + Few-shot 示例；区分“分析阶段”“决策阶段”。  
   - 若模型返回 JSON（任务/协助/播报），解析并校验。
3. **决策落库与播报**  
   - ✅ 经理流式输出同一气泡；无结构化决策时兜底建任务。  
   - ✅ 创建/更新任务时估算难度/优先级、写入标签/metadata，黑板播报带 payload，并推送通知。  
   - ✅ 决策缺失/失败的重试与降级通知；需补备用模型切换与指标落地。  
   - 🔜 UI 显示经理状态/决策摘要。
4. **降级/重试**  
   - ✅ 连续失败会推送通知，兜底任务创建；重试已实现； 🔜 补充模型切换/指标。
   - ✅ WS2 阶段主要功能已完成，等待 UI 层添加经理状态摘要后可标记完成。

### WS3：任务/协助执行
1. **任务生命周期**  
   - ✅ TaskService 基于 StateStore/DB；自动指派已引入能力标签+推理档位+成本+难度标签评分，处理优先级/依赖。  
   - ✅ 状态转移钩子（任务状态变化写入 StateStore/通知）；并行/队列调度支持按优先级/延迟排序（queued/assigned）。  
   - 🔜 并行限制验证（最大并发/每 Agent 限制）、更多状态事件订阅。
2. **协助机制**  
   - 支持由经理或成员发起协助，记录 `AssistRequest`，黑板/通知同步；协助完成后回写任务历史。  
3. **自动流程**  
   - ✅ 工具运行（含 MCP）经 `ToolExecutionService` 记录。  
   - ✅ 工具运行播报带通知；  
   - 🔜 自动脚本场景（ACE 刷新/测试重跑）、敏感命令确认与审批。

### WS4：工具 / MCP / ACE 联动
1. **工具日志统一**  
   - 所有工具（终端、MCP、ACE）都写入 `tool_runs`，并映射到状态层事件。  
   - 敏感命令确认 UI + 状态记录（who/when/why）。
2. **MCP 管理**  
   - 在 StateStore 中记录 MCP server 状态，允许经理/Agent 查询可用工具。  
   - 如果经理决策需要调用 MCP，通过统一接口触发 `ToolExecutionService`.
3. **ACE 自动化**  
   - 新任务创建时自动检查索引是否过期；协助/任务可以引用 ACE contextRefs，并在 UI 展示。

### WS5：UI 与播报
1. **黑板**  
   - 系统消息卡片显示经理决策、任务/协助引用、工具日志；支持过滤“经理播报”。  
   - 消息输入区支持 @Agent/@manager 下拉、引用预览。
2. **任务面板 / 工作台**  
   - 读取 StateStore selector，显示实时任务列表、协助、工具执行，并支持跳转到相关黑板消息。  
   - 提供“关注任务/协助”功能，把重要事件 pin 在面板顶部。
3. **顶部状态条**  
   - 展示经理模型、任务队列、ACE 健康、最近失败次数；点击可查看详情。

### WS6：验证与观测
1. **链路回放**  
   - 准备一组真实场景（需求、Bug、文档等），脚本化地演练“用户→经理→成员→工具”。  
   - 输出演示文档与视频/截图，确保 Stakeholder 可复现。
2. **指标与日志**  
   - 记录任务成功率、平均响应时间、ACE 索引延迟、经理 LLM 成功率等。  
   - 在 OutputChannel 或独立面板呈现。
3. **回归测试**  
   - 单元/集成测试覆盖 StateStore API、经理 orchestrator、UI 组件（可使用 vitest + playwright）。  
   - 建立每日/每周回归 checklist。

---

## 4. 里程碑与时间线（建议）
| 周次 | 主要目标 | 关键产出 |
| --- | --- | --- |
| Week 1 | 完成 WS1 Schema + StateStore 改造，迁移 Task/Message/Tool 服务 | Schema 文档、SQL 脚本、StateStore v2 |
| Week 2 | 落地 WS2（经理调度闭环）+ 基础播报 | Manager orchestrator 扩展、播报卡片 |
| Week 3 | 推进 WS3, WS4：任务/协助/工具自动化 + MCP/ACE 联动 | 新任务/协助链路、工具日志整合 |
| Week 4 | WS5 UI 重构（黑板、任务面板、状态条） | UI 新版 + 状态订阅封装 |
| Week 5 | WS6 验证与观测、回归 + 文档交付 | 演示脚本、监控面板、测试报告 |

> 时间线可根据实际进度调整；任何里程碑变更需同步更新本计划文档。

---

## 5. 风险与应对
- **Schema 迁移复杂**：需提前编写迁移脚本 & 回滚策略；新旧表共存阶段需加互斥锁防止双写。
- **LLM 调用成本/速率**：引入速率限制与缓存策略，并在配置页提供备用模型/手动切换。
- **UI 性能**：事件量大时要分批渲染；可基于 `requestAnimationFrame` 或虚拟列表优化。
- **安全/权限**：敏感操作必须走确认流程；记录所有关键动作供审计。

---

## 6. 成功标准
1. 用户通过黑板发起需求，经理自动拆解、指派、协助、总结，全程无人工干预；所有状态可在任务面板/黑板查看。
2. 状态层成为单一事实源，旧 Workflow 逻辑移除，数据库与事件模型统一。
3. 工具/MCP/ACE 与调度串联，敏感操作可控，日志/指标清晰；具备完整演示与回归脚本。

---

## 7. 阶段任务总览（完整版）

> 原则：零兼容、零残留。发现废弃/旧逻辑立即删除；所有状态以 StateStore/DB 为唯一事实源；完成即打 ✅，未完用 ⬜。

| 编号 | 工作项 | 范围 / 要点 | 开发要求 | 状态 |
| --- | --- | --- | --- | --- |
| WS1-1 | Schema/迁移收口 | 废弃字段/表清单；提供迁移步骤与校验用例；确认 message_type、Workflow 兼容路径已移除 | 不留兼容分支，文档化迁移与验证 | ✅ |
| WS2-1 | 经理调用重试/降级 | 流式输出 + 重试；失败/缺失决策推送通知；兜底任务 | 已实现重试=2/通知/兜底 | ✅ |
| WS2-2 | 备用模型切换 & 指标 | 失败阈值触发备用模型；记录成功率/失败率/耗时等指标（StateStore/DB） | 真实链路，禁止 mock；可配置主/备模型 | ⬜ |
| WS2-3 | 经理状态摘要 UI | 黑板/顶部状态条显示处理中/完成/失败/重试摘要 | 基于 payload 的 attempt/last_error/status，简洁展示 | ⬜ |
| WS3-1 | 状态转移钩子 | 任务状态写 StateStore，transition 历史 + 通知 | transitionTaskStatus/sync 已落地 | ✅ |
| WS3-2 | 并行/队列限制 | 会话并发=MAX；每 Agent 并发=1；序列化 scope/sibling；queued→assigned 调度 | 验证并可配置，无旧路径 | ⬜ |
| WS3-3 | 自动脚本 | 经理/任务触发 ACE 刷新、测试重跑等，写 tool_runs/黑板/通知 | 真实执行，禁止 mock；可复用 ToolExecutionService | ⬜ |
| WS3-4 | 敏感命令确认/审批 | 执行前敏感命令确认/审批，落库/事件，黑板/通知可追踪 | 清理旧审批残留，零兼容 | ⬜ |
| WS3-5 | 工具播报/通知 | ToolRun 黑板播报 + 通知（含 MCP/ACE），统一 StateStore | 已完成 | ✅ |
| WS3-6 | 协助机制 | AssistRequest StateStore + 黑板/通知，完成回写任务历史 | 已完成 | ✅ |
| WS3-7 | 指派/调度策略 | 能力标签 + 推理档位 + 成本 + 难度评分；优先级/延迟影响调度 | 已完成；如需调优修改评分函数 | ✅ |
| WS4-1 | MCP/ACE 联动 | manager/agent 决策触发 MCP/ACE 工具，写 tool_runs，黑板/通知同步 | 基于 ToolExecutionService，敏感确认可复用 | ⬜ |
| WS4-2 | ACE 自动化 | 新任务检查索引过期，自动刷新/提示；contextRefs 展示 | 真实 ACE 调用，状态走 StateStore | ⬜ |
| WS5-1 | UI 状态订阅 | 黑板/任务/协助/工具/通知全面基于 StateStore 事件；顶部状态条摘要 | 无旧 UI 兼容逻辑，简洁展示关键状态 | ⬜ |
| WS6-1 | 验证与观测 | 全链路回放脚本、指标（任务成功率、ACE 延迟、经理成功率）、回归清单 | 禁用 mock，提供脚本/报告 | ⬜ |

> 完成全部 ⬜ 项后，再进行全量联调与回归测试，发现问题立即修复并更新此表。
