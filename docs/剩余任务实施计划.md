# 剩余任务实施计划（基于 WS 任务总览）

> 更新时间：2025-11-17
> 原则：零兼容、零残留。以 StateStore/DB 为唯一事实源

---

## 当前完成状态

### ✅ 已完成

| 编号 | 工作项 | 完成内容 |
|------|--------|----------|
| WS1-1 | Schema/迁移收口 | 投票治理移除、数据库重构、StateStore 实现 |
| WS2-1 | 经理调用重试/降级 | 流式输出、失败通知、兜底任务创建、重试机制 |
| WS3-1 | 状态转移钩子 | 任务状态写 StateStore、transition 历史、事件通知 |
| WS3-5 | 工具播报/通知 | ToolRun 黑板播报、通知、StateStore 集成 |
| WS3-6 | 协助机制 | AssistService 实现、StateStore 集成、通知 |
| WS3-7 | 指派/调度策略 | 评分算法、能力标签、推理档位、成本评估 |
| WS1-2 | 多LLM智能编排系统（第一阶段） | SchedulerService、FailoverService、经理池轮值 |
| WS3-4 | 敏感命令确认/审批 | 敏感关键字检测、确认弹窗、日志记录 |

**新增完成（今日）：**
- ✅ 协助机制服务（AssistService）完整实现
- ✅ 敏感关键字管理（KeywordPolicyService）完整实现
- ✅ 默认敏感关键字配置（20+ 关键字）
- ✅ 风险评估功能（log/confirm/block）
- ✅ 敏感命令确认弹窗（前端UI）
- ✅ SchedulerService（多维度评分算法）
- ✅ FailoverService（故障降级和经理池轮值）

---

## ⬜ 待完成任务（按 WS 编号）

### WS2：经理调度链路

#### WS2-2：备用模型切换 & 指标（高优先级）
**范围：**
- 配置主/备模型
- 达到失败阈值自动切换并通知
- 记录成功率/失败率/耗时到 StateStore/DB
- 曝光指标查询接口

**开发要求：**
- 禁止 mock，真实链路调用
- 文档化配置与指标字段
- 无旧路径

**任务清单：**
- [ ] 在 ManagerLLMService 中添加备用模型配置
- [ ] 实现故障检测和自动切换逻辑
- [ ] 添加指标记录（成功率、失败率、响应时间）
- [ ] 创建指标查询 API
- [ ] 添加模型切换通知

**预计时间：** 2 天

---

#### WS2-3：经理状态摘要 UI（中优先级）
**范围：**
- 黑板/顶部状态条展示"处理中/完成/失败/重试"等摘要
- 显示 attempt/last_error
- 模型切换提示

**开发要求：**
- 基于现有 payload 渲染
- 无旧 UI 兼容代码
- 样式简洁

**任务清单：**
- [ ] 创建经理状态组件
- [ ] 在顶部状态条显示经理状态
- [ ] 在黑板显示经理决策卡片
- [ ] 添加模型切换提示
- [ ] 显示重试次数和错误信息

**预计时间：** 1-2 天

---

### WS3：任务/协助执行

#### WS3-2：并行/队列限制（高优先级）
**范围：**
- 会话总并发=MAX
- 每 Agent 并发=1
- serialized scope/sibling
- queued→assigned 调度排序（优先级×难度）

**开发要求：**
- 验证并可配置
- 不保留旧并发逻辑
- 必要时补测试/脚本

**任务清单：**
- [ ] 实现全局并发限制配置
- [ ] 实现每 Agent 并发限制
- [ ] 实现任务队列管理
- [ ] 实现优先级排序算法
- [ ] 添加配置 UI
- [ ] 编写验证脚本

**预计时间：** 2-3 天

---

#### WS3-3：自动脚本（中优先级）
**范围：**
- 经理/任务触发 ACE 刷新、测试重跑等自动脚本
- 写 tool_runs/黑板/通知
- 支持 run_after/delay

**开发要求：**
- 真实执行，禁止 mock
- 复用 ToolExecutionService
- 敏感命令需确认

**任务清单：**
- [ ] 定义自动脚本触发条件
- [ ] 实现脚本调度逻辑
- [ ] 集成 ToolExecutionService
- [ ] 添加延迟执行支持
- [ ] 添加脚本配置 UI

**预计时间：** 2 天

---

#### WS3-4：敏感命令确认/审批（高优先级）⭐
**范围：**
- 执行前对敏感命令人工确认/审批
- 记录日志/事件
- 黑板/通知可追踪
- 可配置敏感关键字

**开发要求：**
- 清理旧审批残留
- 流程全量落库+事件
- 零兼容

**任务清单：**
- [ ] 在 ToolExecutionService 中集成 KeywordPolicyService
- [ ] 实现执行前风险评估
- [ ] 创建确认弹窗 UI
- [ ] 实现确认/拒绝流程
- [ ] 记录敏感操作日志
- [ ] 创建敏感关键字配置 UI
- [ ] 添加审计日志查看功能

**预计时间：** 2-3 天

---

### WS4：工具 / MCP / ACE 联动

#### WS4-1：MCP/ACE 联动（中优先级）
**范围：**
- manager/agent 决策可触发 MCP/ACE 工具
- 写 tool_runs
- 黑板/通知同步
- 选择 server/工具/参数

**开发要求：**
- 基于 ToolExecutionService
- 敏感确认可复用
- 无旧路径

**任务清单：**
- [ ] 实现经理决策触发 MCP 工具
- [ ] 实现 Agent 决策触发 ACE 工具
- [ ] 统一工具调用接口
- [ ] 添加工具选择 UI
- [ ] 完善工具执行日志

**预计时间：** 2 天

---

#### WS4-2：ACE 自动化（低优先级）
**范围：**
- 新任务检查索引过期→自动刷新/提示
- contextRefs 展示在 UI
- 失败/过期通知

**开发要求：**
- 真实 ACE 调用
- 状态走 StateStore
- 无本地缓存兼容

**任务清单：**
- [ ] 实现索引过期检查
- [ ] 实现自动刷新触发
- [ ] 添加 contextRefs UI 展示
- [ ] 添加索引状态通知

**预计时间：** 1-2 天

---

### WS5：UI 与播报

#### WS5-1：UI 状态订阅（中优先级）
**范围：**
- 黑板/任务/协助/工具/通知全基于 StateStore 事件
- 顶部状态条摘要关键健康（经理、ACE、队列）

**开发要求：**
- 删除旧 UI/事件路径
- 简洁展示
- 状态组件订阅新事件

**任务清单：**
- [ ] 重构黑板事件订阅
- [ ] 重构任务面板事件订阅
- [ ] 重构工作台事件订阅
- [ ] 实现顶部状态条
- [ ] 显示经理/ACE/队列健康度
- [ ] 清理旧事件监听代码

**预计时间：** 3-4 天

---

### WS6：验证与观测

#### WS6-1：验证与观测（低优先级）
**范围：**
- 全链路回放脚本
- 指标（任务成功率、ACE 延迟、经理成功率）
- 回归清单/报告

**开发要求：**
- 禁用 mock
- 提供脚本/报告
- 发现问题即修并更新

**任务清单：**
- [ ] 编写端到端测试脚本
- [ ] 实现指标收集
- [ ] 创建监控面板
- [ ] 编写回归测试清单
- [ ] 生成测试报告

**预计时间：** 3-4 天

---

## 实施优先级排序

### 🔥 本周必须完成（高优先级）

1. **WS3-4：敏感命令确认/审批** ⭐
   - 这是安全控制的核心
   - KeywordPolicyService 已实现，需要集成
   - 预计 2-3 天

2. **WS3-2：并行/队列限制**
   - 防止系统过载
   - 确保任务调度合理
   - 预计 2-3 天

### 📅 下周计划（中优先级）

3. **WS2-2：备用模型切换 & 指标**
   - 提高系统可靠性
   - 预计 2 天

4. **WS2-3：经理状态摘要 UI**
   - 提升用户体验
   - 预计 1-2 天

5. **WS3-3：自动脚本**
   - 自动化工作流
   - 预计 2 天

### 📋 后续计划（低优先级）

6. **WS4-1：MCP/ACE 联动** - 2 天
7. **WS4-2：ACE 自动化** - 1-2 天
8. **WS5-1：UI 状态订阅** - 3-4 天
9. **WS6-1：验证与观测** - 3-4 天

---

## 总体时间估算

- **高优先级任务：** 4-6 天
- **中优先级任务：** 5-6 天
- **低优先级任务：** 9-12 天

**总计：** 18-24 天（约 3.5-5 周）

---

## 下一步行动

### 立即开始（今天/明天）
1. **WS3-4：敏感命令确认/审批**
   - 在 ToolExecutionService 中集成 KeywordPolicyService
   - 创建确认弹窗 UI
   - 实现确认/拒绝流程

### 本周内完成
2. **WS3-2：并行/队列限制**
   - 实现并发限制配置
   - 实现任务队列管理

---

## 关键差异说明

**与 WS任务总览.md 的对比：**
- ✅ 保持了"零兼容、零残留"原则
- ✅ 任务编号和范围完全一致
- ✅ 增加了详细的任务清单
- ✅ 增加了时间估算和优先级
- ✅ 更适合日常跟踪和执行

**建议使用方式：**
- **WS任务总览.md** - 作为权威参考和验收标准
- **剩余任务实施计划.md** - 作为日常执行和进度跟踪

---

> **注意：** 完成每个任务后，需要同时更新两个文档的状态标记。
